{"data":"aW1wb3J0IHsgZ29vZ2xlU2hlZXRzU2VydmljZSB9IGZyb20gIi4vZ29vZ2xlLXNoZWV0cyIKaW1wb3J0IHsgcmFuZG9tVVVJRCB9IGZyb20gImNyeXB0byIKaW1wb3J0IHsgcGVyZm9ybWFuY2VNb25pdG9yIH0gZnJvbSAiLi9wZXJmb3JtYW5jZS1tb25pdG9yIgppbXBvcnQgeyBEYXRhVmFsaWRhdG9yLCBWYWxpZGF0aW9uRXJyb3IgfSBmcm9tICIuL2RhdGEtdmFsaWRhdGlvbiIKaW1wb3J0IHsgcmVkaXNDYWNoZSwgQ0FDSEVfS0VZUywgQ0FDSEVfVFRMIH0gZnJvbSAiLi9yZWRpcy1jYWNoZS1pbXByb3ZlZCIKCi8vIEludGVyZmFjZXMgbWFudGlkYXMgcGFyYSBjb21wYXRpYmlsaWRhZGUKZXhwb3J0IGludGVyZmFjZSBXYXJlaG91c2UgewogIGlkOiBzdHJpbmcKICBuYW1lOiBzdHJpbmcKfQoKZXhwb3J0IGludGVyZmFjZSBBaXNsZSB7CiAgaWQ6IHN0cmluZwogIHdhcmVob3VzZUlkOiBzdHJpbmcKICBuYW1lOiBzdHJpbmcKICBub3Rlczogc3RyaW5nCiAgY2FwYWNpdHk6IG51bWJlcgogIHN0b3JhZ2VUeXBlOiAicGFsbGV0IiB8ICJzaGVsZiIKICBzaGVsZkxldmVsczogbnVtYmVyCn0KCmV4cG9ydCBpbnRlcmZhY2UgUGFsbGV0IHsKICBpZDogc3RyaW5nCiAgYWlzbGVJZDogc3RyaW5nCiAgcG9zaXRpb246IG51bWJlcgogIGVhbjogc3RyaW5nIHwgbnVsbCAvLyBJRCBkbyBwcm9kdXRvCiAgcHJvZHVjdE5hbWU6IHN0cmluZyB8IG51bGwKICBjYXRlZ29yeTogc3RyaW5nIHwgbnVsbAogIGVhbjEzOiBzdHJpbmcgfCBudWxsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICBsYXN0VmVyaWZpZWQ6IERhdGUgfCBudWxsCn0KCmV4cG9ydCBpbnRlcmZhY2UgU2hlbGYgewogIGlkOiBzdHJpbmcKICBhaXNsZUlkOiBzdHJpbmcKICBwb3NpdGlvbjogbnVtYmVyCiAgbGV2ZWw6IG51bWJlcgogIGVhbjogc3RyaW5nIHwgbnVsbCAvLyBJRCBkbyBwcm9kdXRvCiAgcHJvZHVjdE5hbWU6IHN0cmluZyB8IG51bGwKICBjYXRlZ29yeTogc3RyaW5nIHwgbnVsbAogIGVhbjEzOiBzdHJpbmcgfCBudWxsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICBvY2N1cGFuY3lQZXJjZW50YWdlOiBudW1iZXIKICBsYXN0VmVyaWZpZWQ6IERhdGUgfCBudWxsCn0KCmV4cG9ydCBpbnRlcmZhY2UgU2VhcmNoUmVzdWx0IHsKICBwYWxsZXRJZDogc3RyaW5nCiAgcG9zaXRpb246IG51bWJlcgogIGxldmVsPzogbnVtYmVyCiAgZWFuOiBzdHJpbmcKICBwcm9kdWN0TmFtZTogc3RyaW5nCiAgYWlzbGVOYW1lOiBzdHJpbmcKICB3YXJlaG91c2VOYW1lOiBzdHJpbmcKICB3YXJlaG91c2VJZDogc3RyaW5nCiAgYWlzbGVJZDogc3RyaW5nCiAgc3RvcmFnZVR5cGU6ICJwYWxsZXQiIHwgInNoZWxmIgogIG9jY3VwYW5jeVBlcmNlbnRhZ2U/OiBudW1iZXIKICBlYW4xMz86IHN0cmluZyAvLyBFQU4gcmVhbCBkbyBwcm9kdXRvCn0KCmV4cG9ydCBpbnRlcmZhY2UgQWRkcmVzc1NlYXJjaFJlc3VsdCB7CiAgaWQ6IHN0cmluZwogIGFkZHJlc3M6IHN0cmluZwogIHdhcmVob3VzZUlkOiBzdHJpbmcKICB3YXJlaG91c2VOYW1lOiBzdHJpbmcKICBhaXNsZUlkOiBzdHJpbmcKICBhaXNsZU5hbWU6IHN0cmluZwogIHBvc2l0aW9uOiBudW1iZXIKICBsZXZlbD86IG51bWJlcgogIHN0b3JhZ2VUeXBlOiAicGFsbGV0IiB8ICJzaGVsZiIKICBwcm9kdWN0TmFtZT86IHN0cmluZwogIGVhbj86IHN0cmluZyAvLyBJRCBkbyBwcm9kdXRvCiAgZWFuMTM/OiBzdHJpbmcgLy8gRUFOIHJlYWwgZG8gcHJvZHV0bwogIG9jY3VwYW5jeVBlcmNlbnRhZ2U/OiBudW1iZXIKfQoKLy8gRnVuw6fDo28gcGFyYSBjb252ZXJ0ZXIgc3RyaW5nIHBhcmEgRGF0ZSBvdSBudWxsCmZ1bmN0aW9uIHBhcnNlRGF0ZShkYXRlU3RyaW5nOiBzdHJpbmcgfCBudWxsKTogRGF0ZSB8IG51bGwgewogIGlmICghZGF0ZVN0cmluZyB8fCBkYXRlU3RyaW5nLnRyaW0oKSA9PT0gIiIpIHJldHVybiBudWxsCiAgdHJ5IHsKICAgIHJldHVybiBuZXcgRGF0ZShkYXRlU3RyaW5nKQogIH0gY2F0Y2ggewogICAgcmV0dXJuIG51bGwKICB9Cn0KCi8vIEZ1bsOnw7VlcyBkZSBjb252ZXJzw6NvIGVudHJlIGZvcm1hdG9zCmZ1bmN0aW9uIGNvbnZlcnRXYXJlaG91c2VGcm9tU2hlZXQocm93OiBhbnkpOiBXYXJlaG91c2UgewogIHJldHVybiB7CiAgICBpZDogcm93LmlkLAogICAgbmFtZTogcm93Lm5hbWUsCiAgfQp9CgpmdW5jdGlvbiBjb252ZXJ0QWlzbGVGcm9tU2hlZXQocm93OiBhbnkpOiBBaXNsZSB7CiAgcmV0dXJuIHsKICAgIGlkOiByb3cuaWQsCiAgICB3YXJlaG91c2VJZDogcm93LndhcmVob3VzZUlkLAogICAgbmFtZTogcm93Lm5hbWUsCiAgICBub3Rlczogcm93Lm5vdGVzIHx8ICIiLAogICAgY2FwYWNpdHk6IE51bWJlci5wYXJzZUludChyb3cuY2FwYWNpdHkpIHx8IDAsCiAgICBzdG9yYWdlVHlwZTogcm93LnN0b3JhZ2VUeXBlID09PSAic2hlbGYiID8gInNoZWxmIiA6ICJwYWxsZXQiLAogICAgc2hlbGZMZXZlbHM6IE51bWJlci5wYXJzZUludChyb3cuc2hlbGZMZXZlbHMpIHx8IDEsCiAgfQp9CgpmdW5jdGlvbiBjb252ZXJ0UGFsbGV0RnJvbVNoZWV0KHJvdzogYW55KTogUGFsbGV0IHsKICByZXR1cm4gewogICAgaWQ6IHJvdy5pZCwKICAgIGFpc2xlSWQ6IHJvdy5haXNsZUlkLAogICAgcG9zaXRpb246IE51bWJlci5wYXJzZUludChyb3cucG9zaXRpb24pIHx8IDAsCiAgICBlYW46IHJvdy5lYW4gfHwgbnVsbCwgLy8gSUQgZG8gcHJvZHV0bwogICAgcHJvZHVjdE5hbWU6IHJvdy5wcm9kdWN0TmFtZSB8fCBudWxsLAogICAgY2F0ZWdvcnk6IHJvdy5jYXRlZ29yeSB8fCBudWxsLAogICAgZWFuMTM6IHJvdy5lYW4xMyB8fCBudWxsLCAvLyBFQU4gcmVhbCBkbyBwcm9kdXRvCiAgICBsYXN0VmVyaWZpZWQ6IHBhcnNlRGF0ZShyb3cubGFzdFZlcmlmaWVkKSwKICB9Cn0KCmZ1bmN0aW9uIGNvbnZlcnRTaGVsZkZyb21TaGVldChyb3c6IGFueSk6IFNoZWxmIHsKICByZXR1cm4gewogICAgaWQ6IHJvdy5pZCwKICAgIGFpc2xlSWQ6IHJvdy5haXNsZUlkLAogICAgcG9zaXRpb246IE51bWJlci5wYXJzZUludChyb3cucG9zaXRpb24pIHx8IDAsCiAgICBsZXZlbDogTnVtYmVyLnBhcnNlSW50KHJvdy5sZXZlbCkgfHwgMSwKICAgIGVhbjogcm93LmVhbiB8fCBudWxsLCAvLyBJRCBkbyBwcm9kdXRvCiAgICBwcm9kdWN0TmFtZTogcm93LnByb2R1Y3ROYW1lIHx8IG51bGwsCiAgICBjYXRlZ29yeTogcm93LmNhdGVnb3J5IHx8IG51bGwsCiAgICBlYW4xMzogcm93LmVhbjEzIHx8IG51bGwsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgIG9jY3VwYW5jeVBlcmNlbnRhZ2U6IE51bWJlci5wYXJzZUludChyb3cub2NjdXBhbmN5UGVyY2VudGFnZSkgfHwgMCwKICAgIGxhc3RWZXJpZmllZDogcGFyc2VEYXRlKHJvdy5sYXN0VmVyaWZpZWQpLAogIH0KfQoKLy8gRnVuw6fDo28gcGFyYSBwYXJzZWFyIGVuZGVyZcOnbyBubyBmb3JtYXRvIEExN1IxUDIgb3UgQTE3UjFQQTIKZnVuY3Rpb24gcGFyc2VBZGRyZXNzKGFkZHJlc3M6IHN0cmluZyk6IHsKICB3YXJlaG91c2VOdW1iZXI6IG51bWJlcgogIGFpc2xlTnVtYmVyOiBudW1iZXIKICBwb3NpdGlvbjogbnVtYmVyCiAgbGV2ZWw/OiBudW1iZXIKfSB8IG51bGwgewogIHRyeSB7CiAgICAvLyBWYWxpZGFyIGZvcm1hdG8gcHJpbWVpcm8KICAgIGNvbnN0IHZhbGlkYXRpb24gPSBEYXRhVmFsaWRhdG9yLnZhbGlkYXRlQWRkcmVzcyhhZGRyZXNzKQogICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHsKICAgICAgY29uc29sZS5lcnJvcigiRW5kZXJlw6dvIGludsOhbGlkbzoiLCB2YWxpZGF0aW9uLmVycm9ycykKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICAvLyBSZW1vdmVyIGVzcGHDp29zIGUgY29udmVydGVyIHBhcmEgbWFpw7pzY3VsbwogICAgY29uc3QgY2xlYW5BZGRyZXNzID0gYWRkcmVzcy50cmltKCkudG9VcHBlckNhc2UoKQoKICAgIC8vIFJlZ2V4IHBhcmEgY2FwdHVyYXIgbyBwYWRyw6NvIEFbbsO6bWVyb11SW27Dum1lcm9dUFtuw7ptZXJvXSBvcGNpb25hbG1lbnRlIHNlZ3VpZG8gZGUgQVtuw7ptZXJvXQogICAgY29uc3QgcmVnZXggPSAvXkEoXGQrKVIoXGQrKVAoXGQrKSg/OkEoXGQrKSk/JC8KICAgIGNvbnN0IG1hdGNoID0gY2xlYW5BZGRyZXNzLm1hdGNoKHJlZ2V4KQoKICAgIGlmICghbWF0Y2gpIHsKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBjb25zdCB3YXJlaG91c2VOdW1iZXIgPSBOdW1iZXIucGFyc2VJbnQobWF0Y2hbMV0pCiAgICBjb25zdCBhaXNsZU51bWJlciA9IE51bWJlci5wYXJzZUludChtYXRjaFsyXSkKICAgIGNvbnN0IHBvc2l0aW9uID0gTnVtYmVyLnBhcnNlSW50KG1hdGNoWzNdKQogICAgY29uc3QgbGV2ZWwgPSBtYXRjaFs0XSA/IE51bWJlci5wYXJzZUludChtYXRjaFs0XSkgOiB1bmRlZmluZWQKCiAgICByZXR1cm4gewogICAgICB3YXJlaG91c2VOdW1iZXIsCiAgICAgIGFpc2xlTnVtYmVyLAogICAgICBwb3NpdGlvbiwKICAgICAgbGV2ZWwsCiAgICB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gcGFyc2VhciBlbmRlcmXDp286IiwgZXJyb3IpCiAgICByZXR1cm4gbnVsbAogIH0KfQoKLy8gRnVuw6fDtWVzIHByaW5jaXBhaXMgY29tIGNhY2hlIG1lbGhvcmFkbwpleHBvcnQgY29uc3QgZ2V0V2FyZWhvdXNlcyA9IGFzeW5jICgpOiBQcm9taXNlPFdhcmVob3VzZVtdPiA9PiB7CiAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbigiZ2V0V2FyZWhvdXNlcyIsIGFzeW5jICgpID0+IHsKICAgIHRyeSB7CiAgICAgIC8vIFRlbnRhciBidXNjYXIgZG8gY2FjaGUgcHJpbWVpcm8KICAgICAgY29uc3QgY2FjaGVkID0gYXdhaXQgcmVkaXNDYWNoZS5nZXQ8V2FyZWhvdXNlW10+KENBQ0hFX0tFWVMuV0FSRUhPVVNFUykKICAgICAgaWYgKGNhY2hlZCkgewogICAgICAgIHBlcmZvcm1hbmNlTW9uaXRvci5yZWNvcmRDYWNoZUhpdCgpCiAgICAgICAgcmV0dXJuIGNhY2hlZAogICAgICB9CgogICAgICBwZXJmb3JtYW5jZU1vbml0b3IucmVjb3JkQ2FjaGVNaXNzKCkKICAgICAgY29uc3Qgcm93cyA9IGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuZ2V0V2FyZWhvdXNlcygpCiAgICAgIGNvbnN0IHdhcmVob3VzZXMgPSByb3dzLm1hcChjb252ZXJ0V2FyZWhvdXNlRnJvbVNoZWV0KQoKICAgICAgLy8gU2FsdmFyIG5vIGNhY2hlCiAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuc2V0KENBQ0hFX0tFWVMuV0FSRUhPVVNFUywgd2FyZWhvdXNlcywgQ0FDSEVfVFRMLkxPTkcpCgogICAgICByZXR1cm4gd2FyZWhvdXNlcwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBidXNjYXIgZ2FscMO1ZXM6IiwgZXJyb3IpCiAgICAgIHJldHVybiBbXQogICAgfQogIH0pCn0KCmV4cG9ydCBjb25zdCBnZXRXYXJlaG91c2VCeUlkID0gYXN5bmMgKGlkOiBzdHJpbmcpOiBQcm9taXNlPFdhcmVob3VzZSB8IHVuZGVmaW5lZD4gPT4gewogIHRyeSB7CiAgICAvLyBUZW50YXIgYnVzY2FyIGRvIGNhY2hlIHByaW1laXJvCiAgICBjb25zdCBjYWNoZWQgPSBhd2FpdCByZWRpc0NhY2hlLmdldDxXYXJlaG91c2U+KENBQ0hFX0tFWVMuV0FSRUhPVVNFKGlkKSkKICAgIGlmIChjYWNoZWQpIHsKICAgICAgcmV0dXJuIGNhY2hlZAogICAgfQoKICAgIGNvbnN0IHdhcmVob3VzZXMgPSBhd2FpdCBnZXRXYXJlaG91c2VzKCkKICAgIGNvbnN0IHdhcmVob3VzZSA9IHdhcmVob3VzZXMuZmluZCgodykgPT4gdy5pZCA9PT0gaWQpCgogICAgaWYgKHdhcmVob3VzZSkgewogICAgICBhd2FpdCByZWRpc0NhY2hlLnNldChDQUNIRV9LRVlTLldBUkVIT1VTRShpZCksIHdhcmVob3VzZSwgQ0FDSEVfVFRMLkxPTkcpCiAgICB9CgogICAgcmV0dXJuIHdhcmVob3VzZQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGJ1c2NhciBnYWxww6NvIHBvciBJRDoiLCBlcnJvcikKICAgIHJldHVybiB1bmRlZmluZWQKICB9Cn0KCmV4cG9ydCBjb25zdCBnZXRBaXNsZXNCeVdhcmVob3VzZSA9IGFzeW5jICh3YXJlaG91c2VJZDogc3RyaW5nKTogUHJvbWlzZTxBaXNsZVtdPiA9PiB7CiAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbihgZ2V0QWlzbGVzQnlXYXJlaG91c2U6JHt3YXJlaG91c2VJZH1gLCBhc3luYyAoKSA9PiB7CiAgICB0cnkgewogICAgICAvLyBUZW50YXIgYnVzY2FyIGRvIGNhY2hlIHByaW1laXJvCiAgICAgIGNvbnN0IGNhY2hlZCA9IGF3YWl0IHJlZGlzQ2FjaGUuZ2V0PEFpc2xlW10+KENBQ0hFX0tFWVMuQUlTTEVTX0JZX1dBUkVIT1VTRSh3YXJlaG91c2VJZCkpCiAgICAgIGlmIChjYWNoZWQpIHsKICAgICAgICBwZXJmb3JtYW5jZU1vbml0b3IucmVjb3JkQ2FjaGVIaXQoKQogICAgICAgIHJldHVybiBjYWNoZWQKICAgICAgfQoKICAgICAgcGVyZm9ybWFuY2VNb25pdG9yLnJlY29yZENhY2hlTWlzcygpCiAgICAgIGNvbnN0IHJvd3MgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmdldEFpc2xlc0J5V2FyZWhvdXNlKHdhcmVob3VzZUlkKQogICAgICBjb25zdCBhaXNsZXMgPSByb3dzLm1hcChjb252ZXJ0QWlzbGVGcm9tU2hlZXQpCgogICAgICAvLyBTYWx2YXIgbm8gY2FjaGUKICAgICAgYXdhaXQgcmVkaXNDYWNoZS5zZXQoQ0FDSEVfS0VZUy5BSVNMRVNfQllfV0FSRUhPVVNFKHdhcmVob3VzZUlkKSwgYWlzbGVzLCBDQUNIRV9UVEwuTUVESVVNKQoKICAgICAgLy8gQ2FjaGUgaW5kaXZpZHVhbCBwYXJhIGNhZGEgYWlzbGUKICAgICAgY29uc3QgY2FjaGVQcm9taXNlcyA9IGFpc2xlcy5tYXAoKGFpc2xlKSA9PiByZWRpc0NhY2hlLnNldChDQUNIRV9LRVlTLkFJU0xFKGFpc2xlLmlkKSwgYWlzbGUsIENBQ0hFX1RUTC5NRURJVU0pKQogICAgICBhd2FpdCBQcm9taXNlLmFsbChjYWNoZVByb21pc2VzKQoKICAgICAgcmV0dXJuIGFpc2xlcwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBidXNjYXIgcnVhczoiLCBlcnJvcikKICAgICAgcmV0dXJuIFtdCiAgICB9CiAgfSkKfQoKZXhwb3J0IGNvbnN0IGdldEFpc2xlQnlJZCA9IGFzeW5jIChpZDogc3RyaW5nKTogUHJvbWlzZTxBaXNsZSB8IHVuZGVmaW5lZD4gPT4gewogIHRyeSB7CiAgICAvLyBUZW50YXIgYnVzY2FyIGRvIGNhY2hlIHByaW1laXJvCiAgICBjb25zdCBjYWNoZWQgPSBhd2FpdCByZWRpc0NhY2hlLmdldDxBaXNsZT4oQ0FDSEVfS0VZUy5BSVNMRShpZCkpCiAgICBpZiAoY2FjaGVkKSB7CiAgICAgIHJldHVybiBjYWNoZWQKICAgIH0KCiAgICBjb25zdCByb3cgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmdldEFpc2xlQnlJZChpZCkKICAgIGNvbnN0IGFpc2xlID0gcm93ID8gY29udmVydEFpc2xlRnJvbVNoZWV0KHJvdykgOiB1bmRlZmluZWQKCiAgICBpZiAoYWlzbGUpIHsKICAgICAgYXdhaXQgcmVkaXNDYWNoZS5zZXQoQ0FDSEVfS0VZUy5BSVNMRShpZCksIGFpc2xlLCBDQUNIRV9UVEwuTUVESVVNKQogICAgfQoKICAgIHJldHVybiBhaXNsZQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGJ1c2NhciBydWEgcG9yIElEOiIsIGVycm9yKQogICAgcmV0dXJuIHVuZGVmaW5lZAogIH0KfQoKZXhwb3J0IGNvbnN0IGdldFBhbGxldHNCeUFpc2xlID0gYXN5bmMgKGFpc2xlSWQ6IHN0cmluZyk6IFByb21pc2U8UGFsbGV0W10+ID0+IHsKICByZXR1cm4gcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKGBnZXRQYWxsZXRzQnlBaXNsZToke2Fpc2xlSWR9YCwgYXN5bmMgKCkgPT4gewogICAgdHJ5IHsKICAgICAgLy8gVGVudGFyIGJ1c2NhciBkbyBjYWNoZSBwcmltZWlybwogICAgICBjb25zdCBjYWNoZWQgPSBhd2FpdCByZWRpc0NhY2hlLmdldDxQYWxsZXRbXT4oQ0FDSEVfS0VZUy5QQUxMRVRTX0JZX0FJU0xFKGFpc2xlSWQpKQogICAgICBpZiAoY2FjaGVkKSB7CiAgICAgICAgcGVyZm9ybWFuY2VNb25pdG9yLnJlY29yZENhY2hlSGl0KCkKICAgICAgICByZXR1cm4gY2FjaGVkCiAgICAgIH0KCiAgICAgIHBlcmZvcm1hbmNlTW9uaXRvci5yZWNvcmRDYWNoZU1pc3MoKQogICAgICBjb25zdCByb3dzID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5nZXRQYWxsZXRzQnlBaXNsZShhaXNsZUlkKQogICAgICBjb25zdCBwYWxsZXRzID0gcm93cy5tYXAoY29udmVydFBhbGxldEZyb21TaGVldCkKCiAgICAgIC8vIFNhbHZhciBubyBjYWNoZQogICAgICBhd2FpdCByZWRpc0NhY2hlLnNldChDQUNIRV9LRVlTLlBBTExFVFNfQllfQUlTTEUoYWlzbGVJZCksIHBhbGxldHMsIENBQ0hFX1RUTC5TSE9SVCkKCiAgICAgIHJldHVybiBwYWxsZXRzCiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGJ1c2NhciBwYWxldGVzOiIsIGVycm9yKQogICAgICByZXR1cm4gW10KICAgIH0KICB9KQp9CgpleHBvcnQgY29uc3QgZ2V0U2hlbHZlc0J5QWlzbGUgPSBhc3luYyAoYWlzbGVJZDogc3RyaW5nKTogUHJvbWlzZTxTaGVsZltdPiA9PiB7CiAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbihgZ2V0U2hlbHZlc0J5QWlzbGU6JHthaXNsZUlkfWAsIGFzeW5jICgpID0+IHsKICAgIHRyeSB7CiAgICAgIC8vIFRlbnRhciBidXNjYXIgZG8gY2FjaGUgcHJpbWVpcm8KICAgICAgY29uc3QgY2FjaGVkID0gYXdhaXQgcmVkaXNDYWNoZS5nZXQ8U2hlbGZbXT4oQ0FDSEVfS0VZUy5TSEVMVkVTX0JZX0FJU0xFKGFpc2xlSWQpKQogICAgICBpZiAoY2FjaGVkKSB7CiAgICAgICAgcGVyZm9ybWFuY2VNb25pdG9yLnJlY29yZENhY2hlSGl0KCkKICAgICAgICByZXR1cm4gY2FjaGVkCiAgICAgIH0KCiAgICAgIHBlcmZvcm1hbmNlTW9uaXRvci5yZWNvcmRDYWNoZU1pc3MoKQogICAgICBjb25zdCByb3dzID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5nZXRTaGVsdmVzQnlBaXNsZShhaXNsZUlkKQogICAgICBjb25zdCBzaGVsdmVzID0gcm93cy5tYXAoY29udmVydFNoZWxmRnJvbVNoZWV0KQoKICAgICAgLy8gU2FsdmFyIG5vIGNhY2hlCiAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuc2V0KENBQ0hFX0tFWVMuU0hFTFZFU19CWV9BSVNMRShhaXNsZUlkKSwgc2hlbHZlcywgQ0FDSEVfVFRMLlNIT1JUKQoKICAgICAgcmV0dXJuIHNoZWx2ZXMKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYnVzY2FyIHByYXRlbGVpcmFzOiIsIGVycm9yKQogICAgICByZXR1cm4gW10KICAgIH0KICB9KQp9CgpleHBvcnQgY29uc3QgZ2V0UGFsbGV0QnlJZCA9IGFzeW5jIChpZDogc3RyaW5nKTogUHJvbWlzZTxQYWxsZXQgfCB1bmRlZmluZWQ+ID0+IHsKICB0cnkgewogICAgLy8gVGVudGFyIGJ1c2NhciBkbyBjYWNoZSBwcmltZWlybwogICAgY29uc3QgY2FjaGVkID0gYXdhaXQgcmVkaXNDYWNoZS5nZXQ8UGFsbGV0PihDQUNIRV9LRVlTLlBBTExFVChpZCkpCiAgICBpZiAoY2FjaGVkKSB7CiAgICAgIHJldHVybiBjYWNoZWQKICAgIH0KCiAgICBjb25zdCByb3cgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmdldFBhbGxldEJ5SWQoaWQpCiAgICBjb25zdCBwYWxsZXQgPSByb3cgPyBjb252ZXJ0UGFsbGV0RnJvbVNoZWV0KHJvdykgOiB1bmRlZmluZWQKCiAgICBpZiAocGFsbGV0KSB7CiAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuc2V0KENBQ0hFX0tFWVMuUEFMTEVUKGlkKSwgcGFsbGV0LCBDQUNIRV9UVEwuU0hPUlQpCiAgICB9CgogICAgcmV0dXJuIHBhbGxldAogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGJ1c2NhciBwYWxldGUgcG9yIElEOiIsIGVycm9yKQogICAgcmV0dXJuIHVuZGVmaW5lZAogIH0KfQoKZXhwb3J0IGNvbnN0IGdldFNoZWxmQnlJZCA9IGFzeW5jIChpZDogc3RyaW5nKTogUHJvbWlzZTxTaGVsZiB8IHVuZGVmaW5lZD4gPT4gewogIHRyeSB7CiAgICAvLyBUZW50YXIgYnVzY2FyIGRvIGNhY2hlIHByaW1laXJvCiAgICBjb25zdCBjYWNoZWQgPSBhd2FpdCByZWRpc0NhY2hlLmdldDxTaGVsZj4oQ0FDSEVfS0VZUy5TSEVMRihpZCkpCiAgICBpZiAoY2FjaGVkKSB7CiAgICAgIHJldHVybiBjYWNoZWQKICAgIH0KCiAgICBjb25zdCByb3dzID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5nZXRTaGVsdmVzQnlBaXNsZSgiIikKICAgIGNvbnN0IHNoZWxmUm93ID0gcm93cy5maW5kKChyKSA9PiByLmlkID09PSBpZCkKICAgIGNvbnN0IHNoZWxmID0gc2hlbGZSb3cgPyBjb252ZXJ0U2hlbGZGcm9tU2hlZXQoc2hlbGZSb3cpIDogdW5kZWZpbmVkCgogICAgaWYgKHNoZWxmKSB7CiAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuc2V0KENBQ0hFX0tFWVMuU0hFTEYoaWQpLCBzaGVsZiwgQ0FDSEVfVFRMLlNIT1JUKQogICAgfQoKICAgIHJldHVybiBzaGVsZgogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGJ1c2NhciBwcmF0ZWxlaXJhIHBvciBJRDoiLCBlcnJvcikKICAgIHJldHVybiB1bmRlZmluZWQKICB9Cn0KCi8vIE5vdmEgZnVuw6fDo28gcGFyYSBidXNjYXIgcG9yIGVuZGVyZcOnbyBjb20gY2FjaGUKZXhwb3J0IGNvbnN0IGZpbmRCeUFkZHJlc3MgPSBhc3luYyAoYWRkcmVzczogc3RyaW5nKTogUHJvbWlzZTxBZGRyZXNzU2VhcmNoUmVzdWx0IHwgbnVsbD4gPT4gewogIHJldHVybiBwZXJmb3JtYW5jZU1vbml0b3IudHJhY2tPcGVyYXRpb24oYGZpbmRCeUFkZHJlc3M6JHthZGRyZXNzfWAsIGFzeW5jICgpID0+IHsKICAgIHRyeSB7CiAgICAgIC8vIFRlbnRhciBidXNjYXIgZG8gY2FjaGUgcHJpbWVpcm8KICAgICAgY29uc3QgY2FjaGVLZXkgPSBDQUNIRV9LRVlTLlNFQVJDSF9CWV9BRERSRVNTKGFkZHJlc3MpCiAgICAgIGNvbnN0IGNhY2hlZCA9IGF3YWl0IHJlZGlzQ2FjaGUuZ2V0PEFkZHJlc3NTZWFyY2hSZXN1bHQ+KGNhY2hlS2V5KQogICAgICBpZiAoY2FjaGVkKSB7CiAgICAgICAgcGVyZm9ybWFuY2VNb25pdG9yLnJlY29yZENhY2hlSGl0KCkKICAgICAgICByZXR1cm4gY2FjaGVkCiAgICAgIH0KCiAgICAgIHBlcmZvcm1hbmNlTW9uaXRvci5yZWNvcmRDYWNoZU1pc3MoKQogICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIEJ1c2NhbmRvIGVuZGVyZcOnbzogJHthZGRyZXNzfWApCgogICAgICAvLyBQYXJzZWFyIG8gZW5kZXJlw6dvCiAgICAgIGNvbnN0IHBhcnNlZCA9IHBhcnNlQWRkcmVzcyhhZGRyZXNzKQogICAgICBpZiAoIXBhcnNlZCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbREFUQV0gRm9ybWF0byBkZSBlbmRlcmXDp28gaW52w6FsaWRvOiAke2FkZHJlc3N9YCkKICAgICAgICByZXR1cm4gbnVsbAogICAgICB9CgogICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIEVuZGVyZcOnbyBwYXJzZWFkbzpgLCBwYXJzZWQpCgogICAgICAvLyBCdXNjYXIgdG9kb3Mgb3MgZ2FscMO1ZXMKICAgICAgY29uc3Qgd2FyZWhvdXNlcyA9IGF3YWl0IGdldFdhcmVob3VzZXMoKQoKICAgICAgLy8gRW5jb250cmFyIG8gZ2FscMOjbyBwZWxvIG7Dum1lcm8gKGFzc3VtaW5kbyBxdWUgbyBub21lIGNvbnTDqW0gbyBuw7ptZXJvKQogICAgICBjb25zdCB3YXJlaG91c2UgPSB3YXJlaG91c2VzLmZpbmQoKHcpID0+IHsKICAgICAgICBjb25zdCB3YXJlaG91c2VOdW1iZXIgPSB3Lm5hbWUubWF0Y2goL1xkKy8pCiAgICAgICAgcmV0dXJuIHdhcmVob3VzZU51bWJlciAmJiBOdW1iZXIucGFyc2VJbnQod2FyZWhvdXNlTnVtYmVyWzBdKSA9PT0gcGFyc2VkLndhcmVob3VzZU51bWJlcgogICAgICB9KQoKICAgICAgaWYgKCF3YXJlaG91c2UpIHsKICAgICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIEdhbHDDo28gQSR7cGFyc2VkLndhcmVob3VzZU51bWJlcn0gbsOjbyBlbmNvbnRyYWRvYCkKICAgICAgICByZXR1cm4gbnVsbAogICAgICB9CgogICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIEdhbHDDo28gZW5jb250cmFkbzogJHt3YXJlaG91c2UubmFtZX1gKQoKICAgICAgLy8gQnVzY2FyIHJ1YXMgZG8gZ2FscMOjbwogICAgICBjb25zdCBhaXNsZXMgPSBhd2FpdCBnZXRBaXNsZXNCeVdhcmVob3VzZSh3YXJlaG91c2UuaWQpCgogICAgICAvLyBFbmNvbnRyYXIgYSBydWEgcGVsbyBuw7ptZXJvCiAgICAgIGNvbnN0IGFpc2xlID0gYWlzbGVzLmZpbmQoKGEpID0+IHsKICAgICAgICBjb25zdCBhaXNsZU51bWJlciA9IGEubmFtZS5tYXRjaCgvXGQrLykKICAgICAgICByZXR1cm4gYWlzbGVOdW1iZXIgJiYgTnVtYmVyLnBhcnNlSW50KGFpc2xlTnVtYmVyWzBdKSA9PT0gcGFyc2VkLmFpc2xlTnVtYmVyCiAgICAgIH0pCgogICAgICBpZiAoIWFpc2xlKSB7CiAgICAgICAgY29uc29sZS5sb2coYFtEQVRBXSBSdWEgUiR7cGFyc2VkLmFpc2xlTnVtYmVyfSBuw6NvIGVuY29udHJhZGEgbm8gZ2FscMOjbyAke3dhcmVob3VzZS5uYW1lfWApCiAgICAgICAgcmV0dXJuIG51bGwKICAgICAgfQoKICAgICAgY29uc29sZS5sb2coYFtEQVRBXSBSdWEgZW5jb250cmFkYTogJHthaXNsZS5uYW1lfSwgdGlwbzogJHthaXNsZS5zdG9yYWdlVHlwZX1gKQoKICAgICAgbGV0IHJlc3VsdDogQWRkcmVzc1NlYXJjaFJlc3VsdCB8IG51bGwgPSBudWxsCgogICAgICAvLyBTZSB0ZW0gbsOtdmVsIGVzcGVjaWZpY2FkbywgYnVzY2FyIHByYXRlbGVpcmEKICAgICAgaWYgKHBhcnNlZC5sZXZlbCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKGFpc2xlLnN0b3JhZ2VUeXBlICE9PSAic2hlbGYiKSB7CiAgICAgICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIFJ1YSAke2Fpc2xlLm5hbWV9IG7Do28gw6kgY29uZmlndXJhZGEgcGFyYSBwcmF0ZWxlaXJhc2ApCiAgICAgICAgICByZXR1cm4gbnVsbAogICAgICAgIH0KCiAgICAgICAgY29uc3Qgc2hlbHZlcyA9IGF3YWl0IGdldFNoZWx2ZXNCeUFpc2xlKGFpc2xlLmlkKQogICAgICAgIGNvbnN0IHNoZWxmID0gc2hlbHZlcy5maW5kKChzKSA9PiBzLnBvc2l0aW9uID09PSBwYXJzZWQucG9zaXRpb24gJiYgcy5sZXZlbCA9PT0gcGFyc2VkLmxldmVsKQoKICAgICAgICBpZiAoIXNoZWxmKSB7CiAgICAgICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIFByYXRlbGVpcmEgUCR7cGFyc2VkLnBvc2l0aW9ufUEke3BhcnNlZC5sZXZlbH0gbsOjbyBlbmNvbnRyYWRhIG5hIHJ1YSAke2Fpc2xlLm5hbWV9YCkKICAgICAgICAgIHJldHVybiBudWxsCiAgICAgICAgfQoKICAgICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIFByYXRlbGVpcmEgZW5jb250cmFkYTpgLCBzaGVsZikKCiAgICAgICAgcmVzdWx0ID0gewogICAgICAgICAgaWQ6IHNoZWxmLmlkLAogICAgICAgICAgYWRkcmVzczogYWRkcmVzcy50b1VwcGVyQ2FzZSgpLAogICAgICAgICAgd2FyZWhvdXNlSWQ6IHdhcmVob3VzZS5pZCwKICAgICAgICAgIHdhcmVob3VzZU5hbWU6IHdhcmVob3VzZS5uYW1lLAogICAgICAgICAgYWlzbGVJZDogYWlzbGUuaWQsCiAgICAgICAgICBhaXNsZU5hbWU6IGFpc2xlLm5hbWUsCiAgICAgICAgICBwb3NpdGlvbjogc2hlbGYucG9zaXRpb24sCiAgICAgICAgICBsZXZlbDogc2hlbGYubGV2ZWwsCiAgICAgICAgICBzdG9yYWdlVHlwZTogInNoZWxmIiwKICAgICAgICAgIHByb2R1Y3ROYW1lOiBzaGVsZi5wcm9kdWN0TmFtZSB8fCB1bmRlZmluZWQsCiAgICAgICAgICBlYW46IHNoZWxmLmVhbiB8fCB1bmRlZmluZWQsIC8vIElEIGRvIHByb2R1dG8KICAgICAgICAgIGVhbjEzOiBzaGVsZi5lYW4xMyB8fCB1bmRlZmluZWQsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgICAgICAgIG9jY3VwYW5jeVBlcmNlbnRhZ2U6IHNoZWxmLm9jY3VwYW5jeVBlcmNlbnRhZ2UsCiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIEJ1c2NhciBwYWxldGUKICAgICAgICBpZiAoYWlzbGUuc3RvcmFnZVR5cGUgIT09ICJwYWxsZXQiKSB7CiAgICAgICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIFJ1YSAke2Fpc2xlLm5hbWV9IG7Do28gw6kgY29uZmlndXJhZGEgcGFyYSBwYWxldGVzYCkKICAgICAgICAgIHJldHVybiBudWxsCiAgICAgICAgfQoKICAgICAgICBjb25zdCBwYWxsZXRzID0gYXdhaXQgZ2V0UGFsbGV0c0J5QWlzbGUoYWlzbGUuaWQpCiAgICAgICAgY29uc3QgcGFsbGV0ID0gcGFsbGV0cy5maW5kKChwKSA9PiBwLnBvc2l0aW9uID09PSBwYXJzZWQucG9zaXRpb24pCgogICAgICAgIGlmICghcGFsbGV0KSB7CiAgICAgICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIFBhbGV0ZSBQJHtwYXJzZWQucG9zaXRpb259IG7Do28gZW5jb250cmFkbyBuYSBydWEgJHthaXNsZS5uYW1lfWApCiAgICAgICAgICByZXR1cm4gbnVsbAogICAgICAgIH0KCiAgICAgICAgY29uc29sZS5sb2coYFtEQVRBXSBQYWxldGUgZW5jb250cmFkbzpgLCBwYWxsZXQpCgogICAgICAgIHJlc3VsdCA9IHsKICAgICAgICAgIGlkOiBwYWxsZXQuaWQsCiAgICAgICAgICBhZGRyZXNzOiBhZGRyZXNzLnRvVXBwZXJDYXNlKCksCiAgICAgICAgICB3YXJlaG91c2VJZDogd2FyZWhvdXNlLmlkLAogICAgICAgICAgd2FyZWhvdXNlTmFtZTogd2FyZWhvdXNlLm5hbWUsCiAgICAgICAgICBhaXNsZUlkOiBhaXNsZS5pZCwKICAgICAgICAgIGFpc2xlTmFtZTogYWlzbGUubmFtZSwKICAgICAgICAgIHBvc2l0aW9uOiBwYWxsZXQucG9zaXRpb24sCiAgICAgICAgICBzdG9yYWdlVHlwZTogInBhbGxldCIsCiAgICAgICAgICBwcm9kdWN0TmFtZTogcGFsbGV0LnByb2R1Y3ROYW1lIHx8IHVuZGVmaW5lZCwKICAgICAgICAgIGVhbjogcGFsbGV0LmVhbiB8fCB1bmRlZmluZWQsIC8vIElEIGRvIHByb2R1dG8KICAgICAgICAgIGVhbjEzOiBwYWxsZXQuZWFuMTMgfHwgdW5kZWZpbmVkLCAvLyBFQU4gcmVhbCBkbyBwcm9kdXRvCiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBTYWx2YXIgbm8gY2FjaGUKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuc2V0KGNhY2hlS2V5LCByZXN1bHQsIENBQ0hFX1RUTC5TSE9SVCkKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdAogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBidXNjYXIgcG9yIGVuZGVyZcOnbzoiLCBlcnJvcikKICAgICAgcmV0dXJuIG51bGwKICAgIH0KICB9KQp9CgpleHBvcnQgY29uc3QgYWRkV2FyZWhvdXNlID0gYXN5bmMgKG5hbWU6IHN0cmluZyk6IFByb21pc2U8V2FyZWhvdXNlPiA9PiB7CiAgdHJ5IHsKICAgIC8vIFZhbGlkYXIgZGFkb3MKICAgIGNvbnN0IHZhbGlkYXRpb24gPSBEYXRhVmFsaWRhdG9yLnZhbGlkYXRlV2FyZWhvdXNlKHsgbmFtZSB9KQogICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHsKICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcih2YWxpZGF0aW9uLmVycm9yc1swXS5tZXNzYWdlLCB2YWxpZGF0aW9uLmVycm9yc1swXS5maWVsZCkKICAgIH0KCiAgICBjb25zdCBuZXdXYXJlaG91c2UgPSB7CiAgICAgIGlkOiByYW5kb21VVUlEKCksCiAgICAgIG5hbWU6IG5hbWUudHJpbSgpLAogICAgfQoKICAgIGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuYWRkV2FyZWhvdXNlKG5ld1dhcmVob3VzZSkKCiAgICAvLyBJbnZhbGlkYXIgY2FjaGUKICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuV0FSRUhPVVNFUykKICAgIGF3YWl0IHJlZGlzQ2FjaGUuc2V0KENBQ0hFX0tFWVMuV0FSRUhPVVNFKG5ld1dhcmVob3VzZS5pZCksIG5ld1dhcmVob3VzZSwgQ0FDSEVfVFRMLkxPTkcpCgogICAgcmV0dXJuIG5ld1dhcmVob3VzZQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGNyaWFyIGdhbHDDo286IiwgZXJyb3IpCiAgICB0aHJvdyBlcnJvcgogIH0KfQoKZXhwb3J0IGNvbnN0IGFkZEFpc2xlID0gYXN5bmMgKAogIHdhcmVob3VzZUlkOiBzdHJpbmcsCiAgbmFtZTogc3RyaW5nLAogIG5vdGVzOiBzdHJpbmcgfCBudWxsID0gbnVsbCwKICBjYXBhY2l0eSA9IDAsCiAgc3RvcmFnZVR5cGU6ICJwYWxsZXQiIHwgInNoZWxmIiA9ICJwYWxsZXQiLAogIHNoZWxmTGV2ZWxzID0gMSwKKTogUHJvbWlzZTxBaXNsZT4gPT4gewogIHRyeSB7CiAgICAvLyBWYWxpZGFyIGRhZG9zCiAgICBjb25zdCB2YWxpZGF0aW9uID0gRGF0YVZhbGlkYXRvci52YWxpZGF0ZUFpc2xlKHsKICAgICAgbmFtZSwKICAgICAgd2FyZWhvdXNlSWQsCiAgICAgIHN0b3JhZ2VUeXBlLAogICAgICBjYXBhY2l0eSwKICAgICAgc2hlbGZMZXZlbHMsCiAgICB9KQogICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHsKICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcih2YWxpZGF0aW9uLmVycm9yc1swXS5tZXNzYWdlLCB2YWxpZGF0aW9uLmVycm9yc1swXS5maWVsZCkKICAgIH0KCiAgICBjb25zdCBuZXdBaXNsZSA9IHsKICAgICAgaWQ6IHJhbmRvbVVVSUQoKSwKICAgICAgd2FyZWhvdXNlSWQ6IHdhcmVob3VzZUlkLAogICAgICBuYW1lOiBuYW1lLnRyaW0oKSwKICAgICAgbm90ZXM6IG5vdGVzPy50cmltKCkgfHwgIiIsCiAgICAgIGNhcGFjaXR5OiBjYXBhY2l0eS50b1N0cmluZygpLAogICAgICBzdG9yYWdlVHlwZSwKICAgICAgc2hlbGZMZXZlbHM6IHNoZWxmTGV2ZWxzLnRvU3RyaW5nKCksCiAgICB9CgogICAgYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5hZGRBaXNsZShuZXdBaXNsZSkKCiAgICBjb25zdCBhaXNsZSA9IGNvbnZlcnRBaXNsZUZyb21TaGVldCh7IC4uLm5ld0Fpc2xlLCBjYXBhY2l0eSwgc2hlbGZMZXZlbHMgfSkKCiAgICAvLyBJbnZhbGlkYXIgY2FjaGUKICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuQUlTTEVTX0JZX1dBUkVIT1VTRSh3YXJlaG91c2VJZCkpCiAgICBhd2FpdCByZWRpc0NhY2hlLnNldChDQUNIRV9LRVlTLkFJU0xFKGFpc2xlLmlkKSwgYWlzbGUsIENBQ0hFX1RUTC5NRURJVU0pCgogICAgcmV0dXJuIGFpc2xlCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gY3JpYXIgcnVhOiIsIGVycm9yKQogICAgdGhyb3cgZXJyb3IKICB9Cn0KCmV4cG9ydCBjb25zdCB1cGRhdGVBaXNsZU5vdGVzID0gYXN5bmMgKGFpc2xlSWQ6IHN0cmluZywgbm90ZXM6IHN0cmluZyk6IFByb21pc2U8QWlzbGUgfCBudWxsPiA9PiB7CiAgdHJ5IHsKICAgIGlmICghYWlzbGVJZCB8fCBhaXNsZUlkLnRyaW0oKSA9PT0gIiIpIHsKICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcigiYWlzbGVJZCDDqSBvYnJpZ2F0w7NyaW8gcGFyYSBhdHVhbGl6YXIgb2JzZXJ2YcOnw7VlcyIpCiAgICB9CgogICAgY29uc3QgZXhpc3RpbmdBaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZChhaXNsZUlkKQogICAgaWYgKCFleGlzdGluZ0Fpc2xlKSB7CiAgICAgIHJldHVybiBudWxsCiAgICB9CgogICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UudXBkYXRlQWlzbGVOb3RlcyhhaXNsZUlkLCBub3RlcykKCiAgICBpZiAoc3VjY2VzcykgewogICAgICBjb25zdCB1cGRhdGVkQWlzbGUgPSB7CiAgICAgICAgLi4uZXhpc3RpbmdBaXNsZSwKICAgICAgICBub3Rlczogbm90ZXMsCiAgICAgIH0KCiAgICAgIC8vIEF0dWFsaXphciBjYWNoZQogICAgICBhd2FpdCByZWRpc0NhY2hlLnNldChDQUNIRV9LRVlTLkFJU0xFKGFpc2xlSWQpLCB1cGRhdGVkQWlzbGUsIENBQ0hFX1RUTC5NRURJVU0pCiAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuQUlTTEVTX0JZX1dBUkVIT1VTRShleGlzdGluZ0Fpc2xlLndhcmVob3VzZUlkKSkKCiAgICAgIHJldHVybiB1cGRhdGVkQWlzbGUKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGF0dWFsaXphciBvYnNlcnZhw6fDtWVzIGRhIHJ1YToiLCBlcnJvcikKICAgIHJldHVybiBudWxsCiAgfQp9CgpleHBvcnQgY29uc3QgdXBkYXRlQWlzbGVDYXBhY2l0eSA9IGFzeW5jIChhaXNsZUlkOiBzdHJpbmcsIGNhcGFjaXR5OiBudW1iZXIpOiBQcm9taXNlPEFpc2xlIHwgbnVsbD4gPT4gewogIHRyeSB7CiAgICBpZiAoIWFpc2xlSWQgfHwgYWlzbGVJZC50cmltKCkgPT09ICIiKSB7CiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoImFpc2xlSWQgw6kgb2JyaWdhdMOzcmlvIHBhcmEgYXR1YWxpemFyIGNhcGFjaWRhZGUiKQogICAgfQoKICAgIGNvbnN0IGV4aXN0aW5nQWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQoYWlzbGVJZCkKICAgIGlmICghZXhpc3RpbmdBaXNsZSkgewogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLnVwZGF0ZUFpc2xlQ2FwYWNpdHkoYWlzbGVJZCwgY2FwYWNpdHkudG9TdHJpbmcoKSkKCiAgICBpZiAoc3VjY2VzcykgewogICAgICBjb25zdCB1cGRhdGVkQWlzbGUgPSB7CiAgICAgICAgLi4uZXhpc3RpbmdBaXNsZSwKICAgICAgICBjYXBhY2l0eTogY2FwYWNpdHksCiAgICAgIH0KCiAgICAgIC8vIEF0dWFsaXphciBjYWNoZQogICAgICBhd2FpdCByZWRpc0NhY2hlLnNldChDQUNIRV9LRVlTLkFJU0xFKGFpc2xlSWQpLCB1cGRhdGVkQWlzbGUsIENBQ0hFX1RUTC5NRURJVU0pCiAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuQUlTTEVTX0JZX1dBUkVIT1VTRShleGlzdGluZ0Fpc2xlLndhcmVob3VzZUlkKSkKCiAgICAgIHJldHVybiB1cGRhdGVkQWlzbGUKICAgIH0KCiAgICByZXR1cm4gbnVsbAogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGF0dWFsaXphciBjYXBhY2lkYWRlIGRhIHJ1YToiLCBlcnJvcikKICAgIHJldHVybiBudWxsCiAgfQp9CgpleHBvcnQgY29uc3QgdXBkYXRlQWlzbGVTdG9yYWdlQ29uZmlnID0gYXN5bmMgKAogIGFpc2xlSWQ6IHN0cmluZywKICBzdG9yYWdlVHlwZTogInBhbGxldCIgfCAic2hlbGYiLAogIHNoZWxmTGV2ZWxzOiBudW1iZXIsCik6IFByb21pc2U8QWlzbGUgfCBudWxsPiA9PiB7CiAgdHJ5IHsKICAgIGlmICghYWlzbGVJZCB8fCBhaXNsZUlkLnRyaW0oKSA9PT0gIiIpIHsKICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcigiYWlzbGVJZCDDqSBvYnJpZ2F0w7NyaW8gcGFyYSBhdHVhbGl6YXIgY29uZmlndXJhw6fDo28iKQogICAgfQoKICAgIGNvbnN0IGV4aXN0aW5nQWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQoYWlzbGVJZCkKICAgIGlmICghZXhpc3RpbmdBaXNsZSkgewogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLnVwZGF0ZUFpc2xlU3RvcmFnZUNvbmZpZyhhaXNsZUlkLCBzdG9yYWdlVHlwZSwgc2hlbGZMZXZlbHMudG9TdHJpbmcoKSkKCiAgICBpZiAoc3VjY2VzcykgewogICAgICBjb25zdCB1cGRhdGVkQWlzbGUgPSB7CiAgICAgICAgLi4uZXhpc3RpbmdBaXNsZSwKICAgICAgICBzdG9yYWdlVHlwZSwKICAgICAgICBzaGVsZkxldmVscywKICAgICAgfQoKICAgICAgLy8gQXR1YWxpemFyIGNhY2hlCiAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuc2V0KENBQ0hFX0tFWVMuQUlTTEUoYWlzbGVJZCksIHVwZGF0ZWRBaXNsZSwgQ0FDSEVfVFRMLk1FRElVTSkKICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5BSVNMRVNfQllfV0FSRUhPVVNFKGV4aXN0aW5nQWlzbGUud2FyZWhvdXNlSWQpKQoKICAgICAgcmV0dXJuIHVwZGF0ZWRBaXNsZQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYXR1YWxpemFyIGNvbmZpZ3VyYcOnw6NvIGRhIHJ1YToiLCBlcnJvcikKICAgIHJldHVybiBudWxsCiAgfQp9CgpleHBvcnQgY29uc3QgYWRkUGFsbGV0ID0gYXN5bmMgKGFpc2xlSWQ6IHN0cmluZywgcG9zaXRpb246IG51bWJlcik6IFByb21pc2U8UGFsbGV0PiA9PiB7CiAgdHJ5IHsKICAgIGNvbnNvbGUubG9nKGBbREFUQV0gVGVudGFuZG8gYWRpY2lvbmFyIHBhbGV0ZSAtIGFpc2xlSWQ6ICR7YWlzbGVJZH0sIHBvc2l0aW9uOiAke3Bvc2l0aW9ufWApCgogICAgaWYgKCFhaXNsZUlkKSB7CiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoImFpc2xlSWQgw6kgb2JyaWdhdMOzcmlvIHBhcmEgY3JpYXIgdW0gcGFsZXRlIikKICAgIH0KCiAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZChhaXNsZUlkKQogICAgaWYgKCFhaXNsZSkgewogICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKGBSdWEgY29tIElEICR7YWlzbGVJZH0gbsOjbyBlbmNvbnRyYWRhYCkKICAgIH0KCiAgICBjb25zb2xlLmxvZyhgW0RBVEFdIFJ1YSBlbmNvbnRyYWRhOiAke2Fpc2xlLm5hbWV9LCB0aXBvOiAke2Fpc2xlLnN0b3JhZ2VUeXBlfWApCgogICAgaWYgKGFpc2xlLnN0b3JhZ2VUeXBlICE9PSAicGFsbGV0IikgewogICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKGBFc3RhIHJ1YSBlc3TDoSBjb25maWd1cmFkYSBwYXJhICR7YWlzbGUuc3RvcmFnZVR5cGV9LCBuw6NvIHBhcmEgcGFsZXRlc2ApCiAgICB9CgogICAgY29uc3QgbmV3UGFsbGV0ID0gewogICAgICBpZDogcmFuZG9tVVVJRCgpLAogICAgICBhaXNsZUlkOiBhaXNsZUlkLAogICAgICBwb3NpdGlvbjogcG9zaXRpb24udG9TdHJpbmcoKSwKICAgICAgZWFuOiAiIiwgLy8gSUQgZG8gcHJvZHV0bwogICAgICBwcm9kdWN0TmFtZTogIiIsCiAgICAgIGNhdGVnb3J5OiAiIiwKICAgICAgZWFuMTM6ICIiLCAvLyBFQU4gcmVhbCBkbyBwcm9kdXRvCiAgICAgIGxhc3RWZXJpZmllZDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLAogICAgfQoKICAgIGNvbnNvbGUubG9nKGBbREFUQV0gQ3JpYW5kbyBwYWxldGU6YCwgbmV3UGFsbGV0KQoKICAgIGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuYWRkUGFsbGV0KG5ld1BhbGxldCkKCiAgICBjb25zdCBwYWxsZXQgPSBjb252ZXJ0UGFsbGV0RnJvbVNoZWV0KHsgLi4ubmV3UGFsbGV0LCBwb3NpdGlvbiB9KQoKICAgIC8vIEludmFsaWRhciBjYWNoZQogICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5QQUxMRVRTX0JZX0FJU0xFKGFpc2xlSWQpKQogICAgYXdhaXQgcmVkaXNDYWNoZS5zZXQoQ0FDSEVfS0VZUy5QQUxMRVQocGFsbGV0LmlkKSwgcGFsbGV0LCBDQUNIRV9UVEwuU0hPUlQpCgogICAgY29uc29sZS5sb2coYFtEQVRBXSBQYWxldGUgY3JpYWRvIGNvbSBzdWNlc3NvYCkKCiAgICByZXR1cm4gcGFsbGV0CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gY3JpYXIgcGFsZXRlOiIsIGVycm9yKQogICAgdGhyb3cgZXJyb3IKICB9Cn0KCmV4cG9ydCBjb25zdCBhZGRTaGVsZiA9IGFzeW5jIChhaXNsZUlkOiBzdHJpbmcsIHBvc2l0aW9uOiBudW1iZXIsIGxldmVsOiBudW1iZXIpOiBQcm9taXNlPFNoZWxmPiA9PiB7CiAgdHJ5IHsKICAgIGNvbnNvbGUubG9nKGBbREFUQV0gVGVudGFuZG8gYWRpY2lvbmFyIHByYXRlbGVpcmEgLSBhaXNsZUlkOiAke2Fpc2xlSWR9LCBwb3NpdGlvbjogJHtwb3NpdGlvbn0sIGxldmVsOiAke2xldmVsfWApCgogICAgaWYgKCFhaXNsZUlkKSB7CiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoImFpc2xlSWQgw6kgb2JyaWdhdMOzcmlvIHBhcmEgY3JpYXIgdW1hIHByYXRlbGVpcmEiKQogICAgfQoKICAgIGNvbnN0IGFpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKGFpc2xlSWQpCiAgICBpZiAoIWFpc2xlKSB7CiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoYFJ1YSBjb20gSUQgJHthaXNsZUlkfSBuw6NvIGVuY29udHJhZGFgKQogICAgfQoKICAgIGNvbnNvbGUubG9nKGBbREFUQV0gUnVhIGVuY29udHJhZGE6ICR7YWlzbGUubmFtZX0sIHRpcG86ICR7YWlzbGUuc3RvcmFnZVR5cGV9YCkKCiAgICBpZiAoYWlzbGUuc3RvcmFnZVR5cGUgIT09ICJzaGVsZiIpIHsKICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihgRXN0YSBydWEgZXN0w6EgY29uZmlndXJhZGEgcGFyYSAke2Fpc2xlLnN0b3JhZ2VUeXBlfSwgbsOjbyBwYXJhIHByYXRlbGVpcmFzYCkKICAgIH0KCiAgICBjb25zdCBuZXdTaGVsZiA9IHsKICAgICAgaWQ6IHJhbmRvbVVVSUQoKSwKICAgICAgYWlzbGVJZDogYWlzbGVJZCwKICAgICAgcG9zaXRpb246IHBvc2l0aW9uLnRvU3RyaW5nKCksCiAgICAgIGxldmVsOiBsZXZlbC50b1N0cmluZygpLAogICAgICBlYW46ICIiLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgIHByb2R1Y3ROYW1lOiAiIiwKICAgICAgY2F0ZWdvcnk6ICIiLAogICAgICBlYW4xMzogIiIsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgICAgb2NjdXBhbmN5UGVyY2VudGFnZTogIjAiLAogICAgICBsYXN0VmVyaWZpZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgIH0KCiAgICBjb25zb2xlLmxvZyhgW0RBVEFdIENyaWFuZG8gcHJhdGVsZWlyYTpgLCBuZXdTaGVsZikKCiAgICBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmFkZFNoZWxmKG5ld1NoZWxmKQoKICAgIGNvbnN0IHNoZWxmID0gY29udmVydFNoZWxmRnJvbVNoZWV0KHsgLi4ubmV3U2hlbGYsIHBvc2l0aW9uLCBsZXZlbCwgb2NjdXBhbmN5UGVyY2VudGFnZTogMCB9KQoKICAgIC8vIEludmFsaWRhciBjYWNoZQogICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5TSEVMVkVTX0JZX0FJU0xFKGFpc2xlSWQpKQogICAgYXdhaXQgcmVkaXNDYWNoZS5zZXQoQ0FDSEVfS0VZUy5TSEVMRihzaGVsZi5pZCksIHNoZWxmLCBDQUNIRV9UVEwuU0hPUlQpCgogICAgY29uc29sZS5sb2coYFtEQVRBXSBQcmF0ZWxlaXJhIGNyaWFkYSBjb20gc3VjZXNzb2ApCgogICAgcmV0dXJuIHNoZWxmCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gY3JpYXIgcHJhdGVsZWlyYToiLCBlcnJvcikKICAgIHRocm93IGVycm9yCiAgfQp9CgpleHBvcnQgY29uc3QgdXBkYXRlUGFsbGV0ID0gYXN5bmMgKAogIHBhbGxldElkOiBzdHJpbmcsCiAgZWFuOiBzdHJpbmcsCiAgcHJvZHVjdE5hbWU6IHN0cmluZywKICBjYXRlZ29yeT86IHN0cmluZywKICBlYW4xMz86IHN0cmluZywKKTogUHJvbWlzZTxQYWxsZXQgfCBudWxsPiA9PiB7CiAgdHJ5IHsKICAgIC8vIFZhbGlkYXIgZGFkb3MgZG8gcHJvZHV0bwogICAgY29uc3QgdmFsaWRhdGlvbiA9IERhdGFWYWxpZGF0b3IudmFsaWRhdGVQcm9kdWN0KHsgZWFuLCBwcm9kdWN0TmFtZSB9KQogICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHsKICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcih2YWxpZGF0aW9uLmVycm9yc1swXS5tZXNzYWdlLCB2YWxpZGF0aW9uLmVycm9yc1swXS5maWVsZCkKICAgIH0KCiAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS51cGRhdGVQYWxsZXQocGFsbGV0SWQsIHsKICAgICAgZWFuLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgIHByb2R1Y3ROYW1lLAogICAgICBjYXRlZ29yeTogY2F0ZWdvcnkgfHwgIiIsCiAgICAgIGVhbjEzOiBlYW4xMyB8fCAiIiwgLy8gRUFOIHJlYWwgZG8gcHJvZHV0bwogICAgICBsYXN0VmVyaWZpZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgIH0pCgogICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgY29uc3QgcGFsbGV0ID0gYXdhaXQgZ2V0UGFsbGV0QnlJZChwYWxsZXRJZCkKCiAgICAgIGlmIChwYWxsZXQpIHsKICAgICAgICAvLyBJbnZhbGlkYXIgY2FjaGVzIHJlbGFjaW9uYWRvcwogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuUEFMTEVUU19CWV9BSVNMRShwYWxsZXQuYWlzbGVJZCkpCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWxQYXR0ZXJuKENBQ0hFX0tFWVMuUEFUVEVSTlMuU0VBUkNIKQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuRFVQTElDQVRFRF9FQU5TKQogICAgICB9CiAgICAgIHJldHVybiBwYWxsZXQgfHwgbnVsbAogICAgfQogICAgcmV0dXJuIG51bGwKICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBhdHVhbGl6YXIgcGFsZXRlOiIsIGVycm9yKQogICAgcmV0dXJuIG51bGwKICB9Cn0KCmV4cG9ydCBjb25zdCB1cGRhdGVTaGVsZiA9IGFzeW5jICgKICBzaGVsZklkOiBzdHJpbmcsCiAgZWFuOiBzdHJpbmcsCiAgcHJvZHVjdE5hbWU6IHN0cmluZywKICBvY2N1cGFuY3lQZXJjZW50YWdlOiBudW1iZXIsCiAgY2F0ZWdvcnk/OiBzdHJpbmcsCiAgZWFuMTM/OiBzdHJpbmcsCik6IFByb21pc2U8U2hlbGYgfCBudWxsPiA9PiB7CiAgdHJ5IHsKICAgIC8vIFZhbGlkYXIgZGFkb3MgZG8gcHJvZHV0bwogICAgY29uc3QgdmFsaWRhdGlvbiA9IERhdGFWYWxpZGF0b3IudmFsaWRhdGVQcm9kdWN0KHsgZWFuLCBwcm9kdWN0TmFtZSwgb2NjdXBhbmN5UGVyY2VudGFnZSB9KQogICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHsKICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcih2YWxpZGF0aW9uLmVycm9yc1swXS5tZXNzYWdlLCB2YWxpZGF0aW9uLmVycm9yc1swXS5maWVsZCkKICAgIH0KCiAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS51cGRhdGVTaGVsZihzaGVsZklkLCB7CiAgICAgIGVhbiwgLy8gSUQgZG8gcHJvZHV0bwogICAgICBwcm9kdWN0TmFtZSwKICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5IHx8ICIiLAogICAgICBlYW4xMzogZWFuMTMgfHwgIiIsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgICAgb2NjdXBhbmN5UGVyY2VudGFnZTogb2NjdXBhbmN5UGVyY2VudGFnZS50b1N0cmluZygpLAogICAgICBsYXN0VmVyaWZpZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgIH0pCgogICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgY29uc3Qgc2hlbGYgPSBhd2FpdCBnZXRTaGVsZkJ5SWQoc2hlbGZJZCkKCiAgICAgIGlmIChzaGVsZikgewogICAgICAgIC8vIEludmFsaWRhciBjYWNoZXMgcmVsYWNpb25hZG9zCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5TSEVMVkVTX0JZX0FJU0xFKHNoZWxmLmFpc2xlSWQpKQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsUGF0dGVybihDQUNIRV9LRVlTLlBBVFRFUk5TLlNFQVJDSCkKICAgICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbChDQUNIRV9LRVlTLkRVUExJQ0FURURfRUFOUykKICAgICAgfQogICAgICByZXR1cm4gc2hlbGYKICAgIH0KICAgIHJldHVybiBudWxsCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYXR1YWxpemFyIHByYXRlbGVpcmE6IiwgZXJyb3IpCiAgICByZXR1cm4gbnVsbAogIH0KfQoKZXhwb3J0IGNvbnN0IHZlcmlmeVBhbGxldCA9IGFzeW5jIChwYWxsZXRJZDogc3RyaW5nKTogUHJvbWlzZTxQYWxsZXQgfCBudWxsPiA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLnVwZGF0ZVBhbGxldChwYWxsZXRJZCwgewogICAgICBsYXN0VmVyaWZpZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgIH0pCgogICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgY29uc3QgcGFsbGV0ID0gYXdhaXQgZ2V0UGFsbGV0QnlJZChwYWxsZXRJZCkKICAgICAgaWYgKHBhbGxldCkgewogICAgICAgIC8vIEF0dWFsaXphciBjYWNoZQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuc2V0KENBQ0hFX0tFWVMuUEFMTEVUKHBhbGxldElkKSwgcGFsbGV0LCBDQUNIRV9UVEwuU0hPUlQpCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5QQUxMRVRTX0JZX0FJU0xFKHBhbGxldC5haXNsZUlkKSkKICAgICAgfQogICAgICByZXR1cm4gcGFsbGV0IHx8IG51bGwKICAgIH0KICAgIHJldHVybiBudWxsCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gdmVyaWZpY2FyIHBhbGV0ZToiLCBlcnJvcikKICAgIHJldHVybiBudWxsCiAgfQp9CgpleHBvcnQgY29uc3QgdmVyaWZ5U2hlbGYgPSBhc3luYyAoc2hlbGZJZDogc3RyaW5nKTogUHJvbWlzZTxTaGVsZiB8IG51bGw+ID0+IHsKICB0cnkgewogICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UudXBkYXRlU2hlbGYoc2hlbGZJZCwgewogICAgICBsYXN0VmVyaWZpZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgIH0pCgogICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgY29uc3Qgc2hlbGYgPSBhd2FpdCBnZXRTaGVsZkJ5SWQoc2hlbGZJZCkKICAgICAgaWYgKHNoZWxmKSB7CiAgICAgICAgLy8gQXR1YWxpemFyIGNhY2hlCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5zZXQoQ0FDSEVfS0VZUy5TSEVMRihzaGVsZklkKSwgc2hlbGYsIENBQ0hFX1RUTC5TSE9SVCkKICAgICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbChDQUNIRV9LRVlTLlNIRUxWRVNfQllfQUlTTEUoc2hlbGYuYWlzbGVJZCkpCiAgICAgIH0KICAgICAgcmV0dXJuIHNoZWxmCiAgICB9CiAgICByZXR1cm4gbnVsbAogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIHZlcmlmaWNhciBwcmF0ZWxlaXJhOiIsIGVycm9yKQogICAgcmV0dXJuIG51bGwKICB9Cn0KCmV4cG9ydCBjb25zdCBkZWxldGVQYWxsZXQgPSBhc3luYyAocGFsbGV0SWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gPT4gewogIHRyeSB7CiAgICBjb25zb2xlLmxvZyhgW0RBVEFdIFRlbnRhbmRvIGV4Y2x1aXIgcGFsZXRlOiAke3BhbGxldElkfWApCgogICAgLy8gQnVzY2FyIHBhbGV0ZSBhbnRlcyBkZSBleGNsdWlyIHBhcmEgaW52YWxpZGFyIGNhY2hlCiAgICBjb25zdCBwYWxsZXQgPSBhd2FpdCBnZXRQYWxsZXRCeUlkKHBhbGxldElkKQoKICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuZGVsZXRlUGFsbGV0KHBhbGxldElkKQoKICAgIGlmIChyZXN1bHQgJiYgcGFsbGV0KSB7CiAgICAgIC8vIEludmFsaWRhciBjYWNoZXMgcmVsYWNpb25hZG9zCiAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuUEFMTEVUKHBhbGxldElkKSkKICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5QQUxMRVRTX0JZX0FJU0xFKHBhbGxldC5haXNsZUlkKSkKICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWxQYXR0ZXJuKENBQ0hFX0tFWVMuUEFUVEVSTlMuU0VBUkNIKQogICAgfQoKICAgIGNvbnNvbGUubG9nKGBbREFUQV0gUmVzdWx0YWRvIGRhIGV4Y2x1c8OjbyBkbyBwYWxldGU6ICR7cmVzdWx0fWApCiAgICByZXR1cm4gcmVzdWx0CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gZXhjbHVpciBwYWxldGU6IiwgZXJyb3IpCiAgICByZXR1cm4gZmFsc2UKICB9Cn0KCmV4cG9ydCBjb25zdCBkZWxldGVTaGVsZiA9IGFzeW5jIChzaGVsZklkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+ID0+IHsKICB0cnkgewogICAgY29uc29sZS5sb2coYFtEQVRBXSBUZW50YW5kbyBleGNsdWlyIHByYXRlbGVpcmE6ICR7c2hlbGZJZH1gKQoKICAgIC8vIEJ1c2NhciBwcmF0ZWxlaXJhIGFudGVzIGRlIGV4Y2x1aXIgcGFyYSBpbnZhbGlkYXIgY2FjaGUKICAgIGNvbnN0IHNoZWxmID0gYXdhaXQgZ2V0U2hlbGZCeUlkKHNoZWxmSWQpCgogICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5kZWxldGVTaGVsZihzaGVsZklkKQoKICAgIGlmIChyZXN1bHQgJiYgc2hlbGYpIHsKICAgICAgLy8gSW52YWxpZGFyIGNhY2hlcyByZWxhY2lvbmFkb3MKICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5TSEVMRihzaGVsZklkKSkKICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5TSEVMVkVTX0JZX0FJU0xFKHNoZWxmLmFpc2xlSWQpKQogICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbFBhdHRlcm4oQ0FDSEVfS0VZUy5QQVRURVJOUy5TRUFSQ0gpCiAgICB9CgogICAgY29uc29sZS5sb2coYFtEQVRBXSBSZXN1bHRhZG8gZGEgZXhjbHVzw6NvIGRhIHByYXRlbGVpcmE6ICR7cmVzdWx0fWApCiAgICByZXR1cm4gcmVzdWx0CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gZXhjbHVpciBwcmF0ZWxlaXJhOiIsIGVycm9yKQogICAgcmV0dXJuIGZhbHNlCiAgfQp9CgpleHBvcnQgY29uc3QgZGVsZXRlQWlzbGVzQnlXYXJlaG91c2UgPSBhc3luYyAod2FyZWhvdXNlSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4gPT4gewogIHRyeSB7CiAgICBjb25zdCBhaXNsZXMgPSBhd2FpdCBnZXRBaXNsZXNCeVdhcmVob3VzZSh3YXJlaG91c2VJZCkKICAgIGZvciAoY29uc3QgYWlzbGUgb2YgYWlzbGVzKSB7CiAgICAgIGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuZGVsZXRlUGFsbGV0c0J5QWlzbGUoYWlzbGUuaWQpCiAgICAgIGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuZGVsZXRlU2hlbHZlc0J5QWlzbGUoYWlzbGUuaWQpCiAgICB9CiAgICBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmRlbGV0ZUFpc2xlc0J5V2FyZWhvdXNlKHdhcmVob3VzZUlkKQoKICAgIC8vIEludmFsaWRhciBjYWNoZXMgcmVsYWNpb25hZG9zCiAgICBhd2FpdCByZWRpc0NhY2hlLmRlbChDQUNIRV9LRVlTLkFJU0xFU19CWV9XQVJFSE9VU0Uod2FyZWhvdXNlSWQpKQogICAgYXdhaXQgcmVkaXNDYWNoZS5kZWxQYXR0ZXJuKENBQ0hFX0tFWVMuUEFUVEVSTlMuV0FSRUhPVVNFKHdhcmVob3VzZUlkKSkKICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBleGNsdWlyIHJ1YXMgZG8gZ2FscMOjbzoiLCBlcnJvcikKICB9Cn0KCmV4cG9ydCBjb25zdCBkZWxldGVQYWxsZXRzQnlBaXNsZSA9IGFzeW5jIChhaXNsZUlkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+ID0+IHsKICB0cnkgewogICAgYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5kZWxldGVQYWxsZXRzQnlBaXNsZShhaXNsZUlkKQoKICAgIC8vIEludmFsaWRhciBjYWNoZQogICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5QQUxMRVRTX0JZX0FJU0xFKGFpc2xlSWQpKQogICAgYXdhaXQgcmVkaXNDYWNoZS5kZWxQYXR0ZXJuKENBQ0hFX0tFWVMuUEFUVEVSTlMuQUlTTEUoYWlzbGVJZCkpCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gZXhjbHVpciBwYWxldGVzIGRhIHJ1YToiLCBlcnJvcikKICB9Cn0KCmV4cG9ydCBjb25zdCBkZWxldGVTaGVsdmVzQnlBaXNsZSA9IGFzeW5jIChhaXNsZUlkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+ID0+IHsKICB0cnkgewogICAgYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5kZWxldGVTaGVsdmVzQnlBaXNsZShhaXNsZUlkKQoKICAgIC8vIEludmFsaWRhciBjYWNoZQogICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5TSEVMVkVTX0JZX0FJU0xFKGFpc2xlSWQpKQogICAgYXdhaXQgcmVkaXNDYWNoZS5kZWxQYXR0ZXJuKENBQ0hFX0tFWVMuUEFUVEVSTlMuQUlTTEUoYWlzbGVJZCkpCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gZXhjbHVpciBwcmF0ZWxlaXJhcyBkYSBydWE6IiwgZXJyb3IpCiAgfQp9CgpleHBvcnQgY29uc3QgZGVsZXRlV2FyZWhvdXNlID0gYXN5bmMgKHdhcmVob3VzZUlkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+ID0+IHsKICB0cnkgewogICAgYXdhaXQgZGVsZXRlQWlzbGVzQnlXYXJlaG91c2Uod2FyZWhvdXNlSWQpCiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmRlbGV0ZVdhcmVob3VzZSh3YXJlaG91c2VJZCkKCiAgICBpZiAocmVzdWx0KSB7CiAgICAgIC8vIEludmFsaWRhciBjYWNoZXMgcmVsYWNpb25hZG9zCiAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuV0FSRUhPVVNFUykKICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5XQVJFSE9VU0Uod2FyZWhvdXNlSWQpKQogICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbFBhdHRlcm4oQ0FDSEVfS0VZUy5QQVRURVJOUy5XQVJFSE9VU0Uod2FyZWhvdXNlSWQpKQogICAgfQoKICAgIHJldHVybiByZXN1bHQKICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBleGNsdWlyIGdhbHDDo286IiwgZXJyb3IpCiAgICByZXR1cm4gZmFsc2UKICB9Cn0KCmV4cG9ydCBjb25zdCBkZWxldGVBaXNsZSA9IGFzeW5jIChhaXNsZUlkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+ID0+IHsKICB0cnkgewogICAgY29uc29sZS5sb2coYFtEQVRBXSBUZW50YW5kbyBleGNsdWlyIHJ1YTogJHthaXNsZUlkfWApCgogICAgLy8gQnVzY2FyIGFpc2xlIGFudGVzIGRlIGV4Y2x1aXIgcGFyYSBpbnZhbGlkYXIgY2FjaGUKICAgIGNvbnN0IGFpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKGFpc2xlSWQpCgogICAgLy8gUHJpbWVpcm8gZXhjbHVpciB0b2RvcyBvcyBwYWxldGVzIGUgcHJhdGVsZWlyYXMgZGEgcnVhCiAgICBjb25zb2xlLmxvZyhgW0RBVEFdIEV4Y2x1aW5kbyBwYWxldGVzIGRhIHJ1YS4uLmApCiAgICBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmRlbGV0ZVBhbGxldHNCeUFpc2xlKGFpc2xlSWQpCgogICAgY29uc29sZS5sb2coYFtEQVRBXSBFeGNsdWluZG8gcHJhdGVsZWlyYXMgZGEgcnVhLi4uYCkKICAgIGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuZGVsZXRlU2hlbHZlc0J5QWlzbGUoYWlzbGVJZCkKCiAgICAvLyBEZXBvaXMgZXhjbHVpciBhIHJ1YQogICAgY29uc29sZS5sb2coYFtEQVRBXSBFeGNsdWluZG8gYSBydWEuLi5gKQogICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5kZWxldGVBaXNsZShhaXNsZUlkKQoKICAgIGlmIChyZXN1bHQgJiYgYWlzbGUpIHsKICAgICAgLy8gSW52YWxpZGFyIGNhY2hlcyByZWxhY2lvbmFkb3MKICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5BSVNMRShhaXNsZUlkKSkKICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5BSVNMRVNfQllfV0FSRUhPVVNFKGFpc2xlLndhcmVob3VzZUlkKSkKICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWxQYXR0ZXJuKENBQ0hFX0tFWVMuUEFUVEVSTlMuQUlTTEUoYWlzbGVJZCkpCiAgICB9CgogICAgY29uc29sZS5sb2coYFtEQVRBXSBSZXN1bHRhZG8gZGEgZXhjbHVzw6NvIGRhIHJ1YTogJHtyZXN1bHR9YCkKICAgIHJldHVybiByZXN1bHQKICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBleGNsdWlyIHJ1YToiLCBlcnJvcikKICAgIHJldHVybiBmYWxzZQogIH0KfQoKZXhwb3J0IGNvbnN0IHJlb3JkZXJQYWxsZXRzID0gYXN5bmMgKGFpc2xlSWQ6IHN0cmluZywgbmV3UGFsbGV0T3JkZXJJZHM6IHN0cmluZ1tdKTogUHJvbWlzZTxib29sZWFuPiA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IG5ld09yZGVyID0gbmV3UGFsbGV0T3JkZXJJZHMubWFwKChpZCwgaW5kZXgpID0+ICh7CiAgICAgIGlkLAogICAgICBwb3NpdGlvbjogaW5kZXggKyAxLAogICAgfSkpCgogICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5yZW9yZGVyUGFsbGV0cyhhaXNsZUlkLCBuZXdPcmRlcikKCiAgICBpZiAocmVzdWx0KSB7CiAgICAgIC8vIEludmFsaWRhciBjYWNoZQogICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbChDQUNIRV9LRVlTLlBBTExFVFNfQllfQUlTTEUoYWlzbGVJZCkpCiAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsUGF0dGVybihDQUNIRV9LRVlTLlBBVFRFUk5TLkFJU0xFKGFpc2xlSWQpKQogICAgfQoKICAgIHJldHVybiByZXN1bHQKICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcigiRXJybyBhbyByZW9yZGVuYXIgcGFsZXRlczoiLCBlcnJvcikKICAgIHJldHVybiBmYWxzZQogIH0KfQoKZXhwb3J0IGNvbnN0IGZpbmRQcm9kdWN0QnlFQU4gPSBhc3luYyAoZWFuOiBzdHJpbmcpOiBQcm9taXNlPFNlYXJjaFJlc3VsdFtdPiA9PiB7CiAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbihgZmluZFByb2R1Y3RCeUVBTjoke2Vhbn1gLCBhc3luYyAoKSA9PiB7CiAgICB0cnkgewogICAgICAvLyBUZW50YXIgYnVzY2FyIGRvIGNhY2hlIHByaW1laXJvCiAgICAgIGNvbnN0IGNhY2hlS2V5ID0gQ0FDSEVfS0VZUy5TRUFSQ0hfQllfRUFOKGVhbikKICAgICAgY29uc3QgY2FjaGVkID0gYXdhaXQgcmVkaXNDYWNoZS5nZXQ8U2VhcmNoUmVzdWx0W10+KGNhY2hlS2V5KQogICAgICBpZiAoY2FjaGVkKSB7CiAgICAgICAgcGVyZm9ybWFuY2VNb25pdG9yLnJlY29yZENhY2hlSGl0KCkKICAgICAgICByZXR1cm4gY2FjaGVkCiAgICAgIH0KCiAgICAgIHBlcmZvcm1hbmNlTW9uaXRvci5yZWNvcmRDYWNoZU1pc3MoKQogICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5maW5kUHJvZHVjdEJ5RUFOKGVhbikKCiAgICAgIGNvbnN0IHNlYXJjaFJlc3VsdHMgPSByZXN1bHRzLm1hcCgocmVzdWx0KSA9PiB7CiAgICAgICAgY29uc3Qgd2FyZWhvdXNlSWQgPSByZXN1bHQuYWlzbGVJZCAmJiB0eXBlb2YgcmVzdWx0LmFpc2xlSWQgPT09ICJzdHJpbmciID8gcmVzdWx0LmFpc2xlSWQuc3BsaXQoIi0iKVswXSA6ICIiCgogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwYWxsZXRJZDogcmVzdWx0LmlkLAogICAgICAgICAgcG9zaXRpb246IE51bWJlci5wYXJzZUludChyZXN1bHQucG9zaXRpb24pIHx8IDAsCiAgICAgICAgICBsZXZlbDogImxldmVsIiBpbiByZXN1bHQgPyBOdW1iZXIucGFyc2VJbnQocmVzdWx0LmxldmVsIGFzIHN0cmluZykgOiB1bmRlZmluZWQsCiAgICAgICAgICBlYW46IHJlc3VsdC5lYW4sIC8vIElEIGRvIHByb2R1dG8KICAgICAgICAgIHByb2R1Y3ROYW1lOiByZXN1bHQucHJvZHVjdE5hbWUgfHwgIk4vQSIsCiAgICAgICAgICBhaXNsZU5hbWU6IHJlc3VsdC5haXNsZU5hbWUsCiAgICAgICAgICB3YXJlaG91c2VOYW1lOiByZXN1bHQud2FyZWhvdXNlTmFtZSwKICAgICAgICAgIHdhcmVob3VzZUlkOiB3YXJlaG91c2VJZCwKICAgICAgICAgIGFpc2xlSWQ6IHJlc3VsdC5haXNsZUlkLAogICAgICAgICAgc3RvcmFnZVR5cGU6IHJlc3VsdC5zdG9yYWdlVHlwZSBhcyAicGFsbGV0IiB8ICJzaGVsZiIsCiAgICAgICAgICBvY2N1cGFuY3lQZXJjZW50YWdlOgogICAgICAgICAgICAib2NjdXBhbmN5UGVyY2VudGFnZSIgaW4gcmVzdWx0ID8gTnVtYmVyLnBhcnNlSW50KHJlc3VsdC5vY2N1cGFuY3lQZXJjZW50YWdlIGFzIHN0cmluZykgOiB1bmRlZmluZWQsCiAgICAgICAgICBlYW4xMzogcmVzdWx0LmVhbjEzIHx8IHVuZGVmaW5lZCwgLy8gRUFOIHJlYWwgZG8gcHJvZHV0bwogICAgICAgIH0KICAgICAgfSkKCiAgICAgIC8vIFNhbHZhciBubyBjYWNoZQogICAgICBhd2FpdCByZWRpc0NhY2hlLnNldChjYWNoZUtleSwgc2VhcmNoUmVzdWx0cywgQ0FDSEVfVFRMLlNIT1JUKQoKICAgICAgcmV0dXJuIHNlYXJjaFJlc3VsdHMKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYnVzY2FyIHByb2R1dG8gcG9yIEVBTjoiLCBlcnJvcikKICAgICAgcmV0dXJuIFtdCiAgICB9CiAgfSkKfQoKLy8gRnVuw6fDo28gbWVsaG9yYWRhIHBhcmEgYnVzY2FyIHdhcmVob3VzZSBJRApleHBvcnQgY29uc3QgZmluZFdhcmVob3VzZUlkQnlBaXNsZUlkID0gYXN5bmMgKGFpc2xlSWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IGFpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKGFpc2xlSWQpCiAgICByZXR1cm4gYWlzbGU/LndhcmVob3VzZUlkIHx8ICIiCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYnVzY2FyIHdhcmVob3VzZSBJRDoiLCBlcnJvcikKICAgIHJldHVybiAiIgogIH0KfQoKZXhwb3J0IGNvbnN0IGdldER1cGxpY2F0ZWRFQU5zID0gYXN5bmMgKCk6IFByb21pc2U8U2V0PHN0cmluZz4+ID0+IHsKICByZXR1cm4gcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKCJnZXREdXBsaWNhdGVkRUFOcyIsIGFzeW5jICgpID0+IHsKICAgIHRyeSB7CiAgICAgIC8vIFRlbnRhciBidXNjYXIgZG8gY2FjaGUgcHJpbWVpcm8KICAgICAgY29uc3QgY2FjaGVkID0gYXdhaXQgcmVkaXNDYWNoZS5nZXQ8c3RyaW5nW10+KENBQ0hFX0tFWVMuRFVQTElDQVRFRF9FQU5TKQogICAgICBpZiAoY2FjaGVkKSB7CiAgICAgICAgcGVyZm9ybWFuY2VNb25pdG9yLnJlY29yZENhY2hlSGl0KCkKICAgICAgICByZXR1cm4gbmV3IFNldChjYWNoZWQpCiAgICAgIH0KCiAgICAgIHBlcmZvcm1hbmNlTW9uaXRvci5yZWNvcmRDYWNoZU1pc3MoKQogICAgICBjb25zdCBkdXBsaWNhdGVkU2V0ID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5nZXREdXBsaWNhdGVkRUFOcygpCiAgICAgIGNvbnN0IGR1cGxpY2F0ZWRBcnJheSA9IEFycmF5LmZyb20oZHVwbGljYXRlZFNldCkKCiAgICAgIC8vIFNhbHZhciBubyBjYWNoZQogICAgICBhd2FpdCByZWRpc0NhY2hlLnNldChDQUNIRV9LRVlTLkRVUExJQ0FURURfRUFOUywgZHVwbGljYXRlZEFycmF5LCBDQUNIRV9UVEwuTUVESVVNKQoKICAgICAgcmV0dXJuIGR1cGxpY2F0ZWRTZXQKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYnVzY2FyIEVBTnMgZHVwbGljYWRvczoiLCBlcnJvcikKICAgICAgcmV0dXJuIG5ldyBTZXQoKQogICAgfQogIH0pCn0KCmV4cG9ydCBjb25zdCB1bmFzc2lnblByb2R1Y3RGcm9tUGFsbGV0ID0gYXN5bmMgKHBhbGxldElkOiBzdHJpbmcpOiBQcm9taXNlPFBhbGxldCB8IG51bGw+ID0+IHsKICB0cnkgewogICAgY29uc29sZS5sb2coYFtEQVRBXSBSZW1vdmVuZG8gcHJvZHV0byBkbyBwYWxldGU6ICR7cGFsbGV0SWR9YCkKCiAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS51cGRhdGVQYWxsZXQocGFsbGV0SWQsIHsKICAgICAgZWFuOiAiIiwgLy8gSUQgZG8gcHJvZHV0bwogICAgICBwcm9kdWN0TmFtZTogIiIsCiAgICAgIGNhdGVnb3J5OiAiIiwKICAgICAgZWFuMTM6ICIiLCAvLyBFQU4gcmVhbCBkbyBwcm9kdXRvCiAgICAgIGxhc3RWZXJpZmllZDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLAogICAgfSkKCiAgICBpZiAoc3VjY2VzcykgewogICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIFByb2R1dG8gcmVtb3ZpZG8gZG8gcGFsZXRlIGNvbSBzdWNlc3NvYCkKICAgICAgY29uc3QgcGFsbGV0ID0gYXdhaXQgZ2V0UGFsbGV0QnlJZChwYWxsZXRJZCkKCiAgICAgIGlmIChwYWxsZXQpIHsKICAgICAgICAvLyBJbnZhbGlkYXIgY2FjaGVzIHJlbGFjaW9uYWRvcwogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuUEFMTEVUU19CWV9BSVNMRShwYWxsZXQuYWlzbGVJZCkpCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWxQYXR0ZXJuKENBQ0hFX0tFWVMuUEFUVEVSTlMuU0VBUkNIKQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuRFVQTElDQVRFRF9FQU5TKQogICAgICB9CgogICAgICByZXR1cm4gcGFsbGV0IHx8IG51bGwKICAgIH0KICAgIHJldHVybiBudWxsCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gcmVtb3ZlciBwcm9kdXRvIGRvIHBhbGV0ZToiLCBlcnJvcikKICAgIHJldHVybiBudWxsCiAgfQp9CgpleHBvcnQgY29uc3QgdW5hc3NpZ25Qcm9kdWN0RnJvbVNoZWxmID0gYXN5bmMgKHNoZWxmSWQ6IHN0cmluZyk6IFByb21pc2U8U2hlbGYgfCBudWxsPiA9PiB7CiAgdHJ5IHsKICAgIGNvbnNvbGUubG9nKGBbREFUQV0gUmVtb3ZlbmRvIHByb2R1dG8gZGEgcHJhdGVsZWlyYTogJHtzaGVsZklkfWApCgogICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UudXBkYXRlU2hlbGYoc2hlbGZJZCwgewogICAgICBlYW46ICIiLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgIHByb2R1Y3ROYW1lOiAiIiwKICAgICAgY2F0ZWdvcnk6ICIiLAogICAgICBlYW4xMzogIiIsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgICAgb2NjdXBhbmN5UGVyY2VudGFnZTogIjAiLAogICAgICBsYXN0VmVyaWZpZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgIH0pCgogICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgY29uc29sZS5sb2coYFtEQVRBXSBQcm9kdXRvIHJlbW92aWRvIGRhIHByYXRlbGVpcmEgY29tIHN1Y2Vzc29gKQogICAgICBjb25zdCBzaGVsZiA9IGF3YWl0IGdldFNoZWxmQnlJZChzaGVsZklkKQoKICAgICAgaWYgKHNoZWxmKSB7CiAgICAgICAgLy8gSW52YWxpZGFyIGNhY2hlcyByZWxhY2lvbmFkb3MKICAgICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbChDQUNIRV9LRVlTLlNIRUxWRVNfQllfQUlTTEUoc2hlbGYuYWlzbGVJZCkpCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWxQYXR0ZXJuKENBQ0hFX0tFWVMuUEFUVEVSTlMuU0VBUkNIKQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuRFVQTElDQVRFRF9FQU5TKQogICAgICB9CgogICAgICByZXR1cm4gc2hlbGYKICAgIH0KICAgIHJldHVybiBudWxsCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gcmVtb3ZlciBwcm9kdXRvIGRhIHByYXRlbGVpcmE6IiwgZXJyb3IpCiAgICByZXR1cm4gbnVsbAogIH0KfQo="}