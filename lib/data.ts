{"data":"aW1wb3J0IHsgZ29vZ2xlU2hlZXRzU2VydmljZSB9IGZyb20gIi4vZ29vZ2xlLXNoZWV0cyIKaW1wb3J0IHsgcmFuZG9tVVVJRCB9IGZyb20gImNyeXB0byIKaW1wb3J0IHsgcGVyZm9ybWFuY2VNb25pdG9yIH0gZnJvbSAiLi9wZXJmb3JtYW5jZS1tb25pdG9yIgoKLy8gSW50ZXJmYWNlcyBtYW50aWRhcyBwYXJhIGNvbXBhdGliaWxpZGFkZQpleHBvcnQgaW50ZXJmYWNlIFdhcmVob3VzZSB7CiAgaWQ6IHN0cmluZwogIG5hbWU6IHN0cmluZwp9CgpleHBvcnQgaW50ZXJmYWNlIEFpc2xlIHsKICBpZDogc3RyaW5nCiAgd2FyZWhvdXNlSWQ6IHN0cmluZwogIG5hbWU6IHN0cmluZwogIG5vdGVzOiBzdHJpbmcKICBjYXBhY2l0eTogbnVtYmVyCiAgc3RvcmFnZVR5cGU6ICJwYWxsZXQiIHwgInNoZWxmIgogIHNoZWxmTGV2ZWxzOiBudW1iZXIKfQoKZXhwb3J0IGludGVyZmFjZSBQYWxsZXQgewogIGlkOiBzdHJpbmcKICBhaXNsZUlkOiBzdHJpbmcKICBwb3NpdGlvbjogbnVtYmVyCiAgZWFuOiBzdHJpbmcgfCBudWxsIC8vIElEIGRvIHByb2R1dG8KICBwcm9kdWN0TmFtZTogc3RyaW5nIHwgbnVsbAogIGNhdGVnb3J5OiBzdHJpbmcgfCBudWxsCiAgZWFuMTM6IHN0cmluZyB8IG51bGwgLy8gRUFOIHJlYWwgZG8gcHJvZHV0bwogIGxhc3RWZXJpZmllZDogRGF0ZSB8IG51bGwKfQoKZXhwb3J0IGludGVyZmFjZSBTaGVsZiB7CiAgaWQ6IHN0cmluZwogIGFpc2xlSWQ6IHN0cmluZwogIHBvc2l0aW9uOiBudW1iZXIKICBsZXZlbDogbnVtYmVyCiAgZWFuOiBzdHJpbmcgfCBudWxsIC8vIElEIGRvIHByb2R1dG8KICBwcm9kdWN0TmFtZTogc3RyaW5nIHwgbnVsbAogIGNhdGVnb3J5OiBzdHJpbmcgfCBudWxsCiAgZWFuMTM6IHN0cmluZyB8IG51bGwgLy8gRUFOIHJlYWwgZG8gcHJvZHV0bwogIG9jY3VwYW5jeVBlcmNlbnRhZ2U6IG51bWJlcgogIGxhc3RWZXJpZmllZDogRGF0ZSB8IG51bGwKfQoKZXhwb3J0IGludGVyZmFjZSBTZWFyY2hSZXN1bHQgewogIHBhbGxldElkOiBzdHJpbmcKICBwb3NpdGlvbjogbnVtYmVyCiAgbGV2ZWw/OiBudW1iZXIKICBlYW46IHN0cmluZwogIHByb2R1Y3ROYW1lOiBzdHJpbmcKICBhaXNsZU5hbWU6IHN0cmluZwogIHdhcmVob3VzZU5hbWU6IHN0cmluZwogIHdhcmVob3VzZUlkOiBzdHJpbmcKICBhaXNsZUlkOiBzdHJpbmcKICBzdG9yYWdlVHlwZTogInBhbGxldCIgfCAic2hlbGYiCiAgb2NjdXBhbmN5UGVyY2VudGFnZT86IG51bWJlcgogIGVhbjEzPzogc3RyaW5nIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KfQoKZXhwb3J0IGludGVyZmFjZSBBZGRyZXNzU2VhcmNoUmVzdWx0IHsKICBpZDogc3RyaW5nCiAgYWRkcmVzczogc3RyaW5nCiAgd2FyZWhvdXNlSWQ6IHN0cmluZwogIHdhcmVob3VzZU5hbWU6IHN0cmluZwogIGFpc2xlSWQ6IHN0cmluZwogIGFpc2xlTmFtZTogc3RyaW5nCiAgcG9zaXRpb246IG51bWJlcgogIGxldmVsPzogbnVtYmVyCiAgc3RvcmFnZVR5cGU6ICJwYWxsZXQiIHwgInNoZWxmIgogIHByb2R1Y3ROYW1lPzogc3RyaW5nCiAgZWFuPzogc3RyaW5nIC8vIElEIGRvIHByb2R1dG8KICBlYW4xMz86IHN0cmluZyAvLyBFQU4gcmVhbCBkbyBwcm9kdXRvCiAgb2NjdXBhbmN5UGVyY2VudGFnZT86IG51bWJlcgp9CgovLyBOb3ZhcyBpbnRlcmZhY2VzIHBhcmEgZ2V0V2FyZWhvdXNlRGF0YQpleHBvcnQgaW50ZXJmYWNlIFdhcmVob3VzZURhdGEgewogIGlkOiBzdHJpbmcKICBuYW1lOiBzdHJpbmcKICBhaXNsZXM6IEFpc2xlRGF0YVtdCn0KCmV4cG9ydCBpbnRlcmZhY2UgQWlzbGVEYXRhIHsKICBpZDogc3RyaW5nCiAgcG9zaXRpb246IG51bWJlcgogIHN0b3JhZ2VUeXBlOiAicGFsbGV0IiB8ICJzaGVsZiIKICBwYWxsZXRzPzogUGFsbGV0RGF0YVtdCiAgc2hlbHZlcz86IFNoZWxmRGF0YVtdCn0KCmV4cG9ydCBpbnRlcmZhY2UgUGFsbGV0RGF0YSB7CiAgaWQ6IHN0cmluZwogIHBvc2l0aW9uOiBudW1iZXIKICBlYW46IHN0cmluZyB8IG51bGwKICBwcm9kdWN0TmFtZTogc3RyaW5nIHwgbnVsbAp9CgpleHBvcnQgaW50ZXJmYWNlIFNoZWxmRGF0YSB7CiAgaWQ6IHN0cmluZwogIHBvc2l0aW9uOiBudW1iZXIKICBsZXZlbHM6IFNoZWxmTGV2ZWxEYXRhW10KfQoKZXhwb3J0IGludGVyZmFjZSBTaGVsZkxldmVsRGF0YSB7CiAgaWQ6IHN0cmluZwogIGxldmVsOiBudW1iZXIKICBlYW46IHN0cmluZyB8IG51bGwKICBwcm9kdWN0TmFtZTogc3RyaW5nIHwgbnVsbAp9CgovLyBGdW7Dp8OjbyBwYXJhIGNvbnZlcnRlciBzdHJpbmcgcGFyYSBEYXRlIG91IG51bGwKZnVuY3Rpb24gcGFyc2VEYXRlKGRhdGVTdHJpbmc6IHN0cmluZyB8IG51bGwpOiBEYXRlIHwgbnVsbCB7CiAgaWYgKCFkYXRlU3RyaW5nIHx8IGRhdGVTdHJpbmcudHJpbSgpID09PSAiIikgcmV0dXJuIG51bGwKICB0cnkgewogICAgcmV0dXJuIG5ldyBEYXRlKGRhdGVTdHJpbmcpCiAgfSBjYXRjaCB7CiAgICByZXR1cm4gbnVsbAogIH0KfQoKLy8gRnVuw6fDtWVzIGRlIGNvbnZlcnPDo28gZW50cmUgZm9ybWF0b3MKZnVuY3Rpb24gY29udmVydFdhcmVob3VzZUZyb21TaGVldChyb3c6IGFueSk6IFdhcmVob3VzZSB7CiAgcmV0dXJuIHsKICAgIGlkOiByb3cuaWQsCiAgICBuYW1lOiByb3cubmFtZSwKICB9Cn0KCmZ1bmN0aW9uIGNvbnZlcnRBaXNsZUZyb21TaGVldChyb3c6IGFueSk6IEFpc2xlIHsKICByZXR1cm4gewogICAgaWQ6IHJvdy5pZCwKICAgIHdhcmVob3VzZUlkOiByb3cud2FyZWhvdXNlSWQsCiAgICBuYW1lOiByb3cubmFtZSwKICAgIG5vdGVzOiByb3cubm90ZXMgfHwgIiIsCiAgICBjYXBhY2l0eTogTnVtYmVyLnBhcnNlSW50KHJvdy5jYXBhY2l0eSkgfHwgMCwKICAgIHN0b3JhZ2VUeXBlOiByb3cuc3RvcmFnZVR5cGUgPT09ICJzaGVsZiIgPyAic2hlbGYiIDogInBhbGxldCIsCiAgICBzaGVsZkxldmVsczogTnVtYmVyLnBhcnNlSW50KHJvdy5zaGVsZkxldmVscykgfHwgMSwKICB9Cn0KCmZ1bmN0aW9uIGNvbnZlcnRQYWxsZXRGcm9tU2hlZXQocm93OiBhbnkpOiBQYWxsZXQgewogIHJldHVybiB7CiAgICBpZDogcm93LmlkLAogICAgYWlzbGVJZDogcm93LmFpc2xlSWQsCiAgICBwb3NpdGlvbjogTnVtYmVyLnBhcnNlSW50KHJvdy5wb3NpdGlvbikgfHwgMCwKICAgIGVhbjogcm93LmVhbiB8fCBudWxsLCAvLyBJRCBkbyBwcm9kdXRvCiAgICBwcm9kdWN0TmFtZTogcm93LnByb2R1Y3ROYW1lIHx8IG51bGwsCiAgICBjYXRlZ29yeTogcm93LmNhdGVnb3J5IHx8IG51bGwsCiAgICBlYW4xMzogcm93LmVhbjEzIHx8IG51bGwsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgIGxhc3RWZXJpZmllZDogcGFyc2VEYXRlKHJvdy5sYXN0VmVyaWZpZWQpLAogIH0KfQoKZnVuY3Rpb24gY29udmVydFNoZWxmRnJvbVNoZWV0KHJvdzogYW55KTogU2hlbGYgewogIHJldHVybiB7CiAgICBpZDogcm93LmlkLAogICAgYWlzbGVJZDogcm93LmFpc2xlSWQsCiAgICBwb3NpdGlvbjogTnVtYmVyLnBhcnNlSW50KHJvdy5wb3NpdGlvbikgfHwgMCwKICAgIGxldmVsOiBOdW1iZXIucGFyc2VJbnQocm93LmxldmVsKSB8fCAxLAogICAgZWFuOiByb3cuZWFuIHx8IG51bGwsIC8vIElEIGRvIHByb2R1dG8KICAgIHByb2R1Y3ROYW1lOiByb3cucHJvZHVjdE5hbWUgfHwgbnVsbCwKICAgIGNhdGVnb3J5OiByb3cuY2F0ZWdvcnkgfHwgbnVsbCwKICAgIGVhbjEzOiByb3cuZWFuMTMgfHwgbnVsbCwgLy8gRUFOIHJlYWwgZG8gcHJvZHV0bwogICAgb2NjdXBhbmN5UGVyY2VudGFnZTogTnVtYmVyLnBhcnNlSW50KHJvdy5vY2N1cGFuY3lQZXJjZW50YWdlKSB8fCAwLAogICAgbGFzdFZlcmlmaWVkOiBwYXJzZURhdGUocm93Lmxhc3RWZXJpZmllZCksCiAgfQp9CgovLyBGdW7Dp8OjbyBwYXJhIHBhcnNlYXIgZW5kZXJlw6dvIG5vIGZvcm1hdG8gQTE3UjFQMiBvdSBBMTdSMVBBMgpmdW5jdGlvbiBwYXJzZUFkZHJlc3MoYWRkcmVzczogc3RyaW5nKTogewogIHdhcmVob3VzZU51bWJlcjogbnVtYmVyCiAgYWlzbGVOdW1iZXI6IG51bWJlcgogIHBvc2l0aW9uOiBudW1iZXIKICBsZXZlbD86IG51bWJlcgp9IHwgbnVsbCB7CiAgdHJ5IHsKICAgIC8vIFJlbW92ZXIgZXNwYcOnb3MgZSBjb252ZXJ0ZXIgcGFyYSBtYWnDunNjdWxvCiAgICBjb25zdCBjbGVhbkFkZHJlc3MgPSBhZGRyZXNzLnRyaW0oKS50b1VwcGVyQ2FzZSgpCgogICAgLy8gUmVnZXggcGFyYSBjYXB0dXJhciBvIHBhZHLDo28gQVtuw7ptZXJvXVJbbsO6bWVyb11QW27Dum1lcm9dIG9wY2lvbmFsbWVudGUgc2VndWlkbyBkZSBBW27Dum1lcm9dCiAgICBjb25zdCByZWdleCA9IC9eQShcZCspUihcZCspUChcZCspKD86QShcZCspKT8kLwogICAgY29uc3QgbWF0Y2ggPSBjbGVhbkFkZHJlc3MubWF0Y2gocmVnZXgpCgogICAgaWYgKCFtYXRjaCkgewogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGNvbnN0IHdhcmVob3VzZU51bWJlciA9IE51bWJlci5wYXJzZUludChtYXRjaFsxXSkKICAgIGNvbnN0IGFpc2xlTnVtYmVyID0gTnVtYmVyLnBhcnNlSW50KG1hdGNoWzJdKQogICAgY29uc3QgcG9zaXRpb24gPSBOdW1iZXIucGFyc2VJbnQobWF0Y2hbM10pCiAgICBjb25zdCBsZXZlbCA9IG1hdGNoWzRdID8gTnVtYmVyLnBhcnNlSW50KG1hdGNoWzRdKSA6IHVuZGVmaW5lZAoKICAgIHJldHVybiB7CiAgICAgIHdhcmVob3VzZU51bWJlciwKICAgICAgYWlzbGVOdW1iZXIsCiAgICAgIHBvc2l0aW9uLAogICAgICBsZXZlbCwKICAgIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBwYXJzZWFyIGVuZGVyZcOnbzoiLCBlcnJvcikKICAgIHJldHVybiBudWxsCiAgfQp9CgovLyBGdW7Dp8O1ZXMgcHJpbmNpcGFpcwpleHBvcnQgY29uc3QgZ2V0V2FyZWhvdXNlcyA9IGFzeW5jICgpOiBQcm9taXNlPFdhcmVob3VzZVtdPiA9PiB7CiAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbigiZ2V0V2FyZWhvdXNlcyIsIGFzeW5jICgpID0+IHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJvd3MgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmdldFdhcmVob3VzZXMoKQogICAgICByZXR1cm4gcm93cy5tYXAoY29udmVydFdhcmVob3VzZUZyb21TaGVldCkKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYnVzY2FyIGdhbHDDtWVzOiIsIGVycm9yKQogICAgICByZXR1cm4gW10KICAgIH0KICB9KQp9CgpleHBvcnQgY29uc3QgZ2V0V2FyZWhvdXNlQnlJZCA9IGFzeW5jIChpZDogc3RyaW5nKTogUHJvbWlzZTxXYXJlaG91c2UgfCB1bmRlZmluZWQ+ID0+IHsKICB0cnkgewogICAgY29uc3Qgd2FyZWhvdXNlcyA9IGF3YWl0IGdldFdhcmVob3VzZXMoKQogICAgcmV0dXJuIHdhcmVob3VzZXMuZmluZCgodykgPT4gdy5pZCA9PT0gaWQpCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYnVzY2FyIGdhbHDDo28gcG9yIElEOiIsIGVycm9yKQogICAgcmV0dXJuIHVuZGVmaW5lZAogIH0KfQoKZXhwb3J0IGNvbnN0IGdldEFpc2xlc0J5V2FyZWhvdXNlID0gYXN5bmMgKHdhcmVob3VzZUlkOiBzdHJpbmcpOiBQcm9taXNlPEFpc2xlW10+ID0+IHsKICByZXR1cm4gcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKGBnZXRBaXNsZXNCeVdhcmVob3VzZToke3dhcmVob3VzZUlkfWAsIGFzeW5jICgpID0+IHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJvd3MgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmdldEFpc2xlc0J5V2FyZWhvdXNlKHdhcmVob3VzZUlkKQogICAgICByZXR1cm4gcm93cy5tYXAoY29udmVydEFpc2xlRnJvbVNoZWV0KQogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBidXNjYXIgcnVhczoiLCBlcnJvcikKICAgICAgcmV0dXJuIFtdCiAgICB9CiAgfSkKfQoKZXhwb3J0IGNvbnN0IGdldEFpc2xlQnlJZCA9IGFzeW5jIChpZDogc3RyaW5nKTogUHJvbWlzZTxBaXNsZSB8IHVuZGVmaW5lZD4gPT4gewogIHRyeSB7CiAgICBjb25zdCByb3cgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmdldEFpc2xlQnlJZChpZCkKICAgIHJldHVybiByb3cgPyBjb252ZXJ0QWlzbGVGcm9tU2hlZXQocm93KSA6IHVuZGVmaW5lZAogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGJ1c2NhciBydWEgcG9yIElEOiIsIGVycm9yKQogICAgcmV0dXJuIHVuZGVmaW5lZAogIH0KfQoKZXhwb3J0IGNvbnN0IGdldFBhbGxldHNCeUFpc2xlID0gYXN5bmMgKGFpc2xlSWQ6IHN0cmluZyk6IFByb21pc2U8UGFsbGV0W10+ID0+IHsKICByZXR1cm4gcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKGBnZXRQYWxsZXRzQnlBaXNsZToke2Fpc2xlSWR9YCwgYXN5bmMgKCkgPT4gewogICAgdHJ5IHsKICAgICAgY29uc3Qgcm93cyA9IGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuZ2V0UGFsbGV0c0J5QWlzbGUoYWlzbGVJZCkKICAgICAgcmV0dXJuIHJvd3MubWFwKGNvbnZlcnRQYWxsZXRGcm9tU2hlZXQpCiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGJ1c2NhciBwYWxldGVzOiIsIGVycm9yKQogICAgICByZXR1cm4gW10KICAgIH0KICB9KQp9CgpleHBvcnQgY29uc3QgZ2V0U2hlbHZlc0J5QWlzbGUgPSBhc3luYyAoYWlzbGVJZDogc3RyaW5nKTogUHJvbWlzZTxTaGVsZltdPiA9PiB7CiAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbihgZ2V0U2hlbHZlc0J5QWlzbGU6JHthaXNsZUlkfWAsIGFzeW5jICgpID0+IHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJvd3MgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmdldFNoZWx2ZXNCeUFpc2xlKGFpc2xlSWQpCiAgICAgIHJldHVybiByb3dzLm1hcChjb252ZXJ0U2hlbGZGcm9tU2hlZXQpCiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGJ1c2NhciBwcmF0ZWxlaXJhczoiLCBlcnJvcikKICAgICAgcmV0dXJuIFtdCiAgICB9CiAgfSkKfQoKZXhwb3J0IGNvbnN0IGdldFBhbGxldEJ5SWQgPSBhc3luYyAoaWQ6IHN0cmluZyk6IFByb21pc2U8UGFsbGV0IHwgdW5kZWZpbmVkPiA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IHJvdyA9IGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuZ2V0UGFsbGV0QnlJZChpZCkKICAgIHJldHVybiByb3cgPyBjb252ZXJ0UGFsbGV0RnJvbVNoZWV0KHJvdykgOiB1bmRlZmluZWQKICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBidXNjYXIgcGFsZXRlIHBvciBJRDoiLCBlcnJvcikKICAgIHJldHVybiB1bmRlZmluZWQKICB9Cn0KCmV4cG9ydCBjb25zdCBnZXRTaGVsZkJ5SWQgPSBhc3luYyAoaWQ6IHN0cmluZyk6IFByb21pc2U8U2hlbGYgfCB1bmRlZmluZWQ+ID0+IHsKICB0cnkgewogICAgY29uc3Qgcm93cyA9IGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuZ2V0U2hlbHZlc0J5QWlzbGUoIiIpCiAgICBjb25zdCBzaGVsZlJvdyA9IHJvd3MuZmluZCgocikgPT4gci5pZCA9PT0gaWQpCiAgICByZXR1cm4gc2hlbGZSb3cgPyBjb252ZXJ0U2hlbGZGcm9tU2hlZXQoc2hlbGZSb3cpIDogdW5kZWZpbmVkCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYnVzY2FyIHByYXRlbGVpcmEgcG9yIElEOiIsIGVycm9yKQogICAgcmV0dXJuIHVuZGVmaW5lZAogIH0KfQoKLy8gTm92YSBmdW7Dp8OjbyBwYXJhIGJ1c2NhciBwb3IgZW5kZXJlw6dvCmV4cG9ydCBjb25zdCBmaW5kQnlBZGRyZXNzID0gYXN5bmMgKGFkZHJlc3M6IHN0cmluZyk6IFByb21pc2U8QWRkcmVzc1NlYXJjaFJlc3VsdCB8IG51bGw+ID0+IHsKICByZXR1cm4gcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKGBmaW5kQnlBZGRyZXNzOiR7YWRkcmVzc31gLCBhc3luYyAoKSA9PiB7CiAgICB0cnkgewogICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIEJ1c2NhbmRvIGVuZGVyZcOnbzogJHthZGRyZXNzfWApCgogICAgICAvLyBQYXJzZWFyIG8gZW5kZXJlw6dvCiAgICAgIGNvbnN0IHBhcnNlZCA9IHBhcnNlQWRkcmVzcyhhZGRyZXNzKQogICAgICBpZiAoIXBhcnNlZCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbREFUQV0gRm9ybWF0byBkZSBlbmRlcmXDp28gaW52w6FsaWRvOiAke2FkZHJlc3N9YCkKICAgICAgICByZXR1cm4gbnVsbAogICAgICB9CgogICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIEVuZGVyZcOnbyBwYXJzZWFkbzpgLCBwYXJzZWQpCgogICAgICAvLyBCdXNjYXIgdG9kb3Mgb3MgZ2FscMO1ZXMKICAgICAgY29uc3Qgd2FyZWhvdXNlcyA9IGF3YWl0IGdldFdhcmVob3VzZXMoKQoKICAgICAgLy8gRW5jb250cmFyIG8gZ2FscMOjbyBwZWxvIG7Dum1lcm8gKGFzc3VtaW5kbyBxdWUgbyBub21lIGNvbnTDqW0gbyBuw7ptZXJvKQogICAgICBjb25zdCB3YXJlaG91c2UgPSB3YXJlaG91c2VzLmZpbmQoKHcpID0+IHsKICAgICAgICBjb25zdCB3YXJlaG91c2VOdW1iZXIgPSB3Lm5hbWUubWF0Y2goL1xkKy8pCiAgICAgICAgcmV0dXJuIHdhcmVob3VzZU51bWJlciAmJiBOdW1iZXIucGFyc2VJbnQod2FyZWhvdXNlTnVtYmVyWzBdKSA9PT0gcGFyc2VkLndhcmVob3VzZU51bWJlcgogICAgICB9KQoKICAgICAgaWYgKCF3YXJlaG91c2UpIHsKICAgICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIEdhbHDDo28gQSR7cGFyc2VkLndhcmVob3VzZU51bWJlcn0gbsOjbyBlbmNvbnRyYWRvYCkKICAgICAgICByZXR1cm4gbnVsbAogICAgICB9CgogICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIEdhbHDDo28gZW5jb250cmFkbzogJHt3YXJlaG91c2UubmFtZX1gKQoKICAgICAgLy8gQnVzY2FyIHJ1YXMgZG8gZ2FscMOjbwogICAgICBjb25zdCBhaXNsZXMgPSBhd2FpdCBnZXRBaXNsZXNCeVdhcmVob3VzZSh3YXJlaG91c2UuaWQpCgogICAgICAvLyBFbmNvbnRyYXIgYSBydWEgcGVsbyBuw7ptZXJvCiAgICAgIGNvbnN0IGFpc2xlID0gYWlzbGVzLmZpbmQoKGEpID0+IHsKICAgICAgICBjb25zdCBhaXNsZU51bWJlciA9IGEubmFtZS5tYXRjaCgvXGQrLykKICAgICAgICByZXR1cm4gYWlzbGVOdW1iZXIgJiYgTnVtYmVyLnBhcnNlSW50KGFpc2xlTnVtYmVyWzBdKSA9PT0gcGFyc2VkLmFpc2xlTnVtYmVyCiAgICAgIH0pCgogICAgICBpZiAoIWFpc2xlKSB7CiAgICAgICAgY29uc29sZS5sb2coYFtEQVRBXSBSdWEgUiR7cGFyc2VkLmFpc2xlTnVtYmVyfSBuw6NvIGVuY29udHJhZGEgbm8gZ2FscMOjbyAke3dhcmVob3VzZS5uYW1lfWApCiAgICAgICAgcmV0dXJuIG51bGwKICAgICAgfQoKICAgICAgY29uc29sZS5sb2coYFtEQVRBXSBSdWEgZW5jb250cmFkYTogJHthaXNsZS5uYW1lfSwgdGlwbzogJHthaXNsZS5zdG9yYWdlVHlwZX1gKQoKICAgICAgLy8gU2UgdGVtIG7DrXZlbCBlc3BlY2lmaWNhZG8sIGJ1c2NhciBwcmF0ZWxlaXJhCiAgICAgIGlmIChwYXJzZWQubGV2ZWwgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmIChhaXNsZS5zdG9yYWdlVHlwZSAhPT0gInNoZWxmIikgewogICAgICAgICAgY29uc29sZS5sb2coYFtEQVRBXSBSdWEgJHthaXNsZS5uYW1lfSBuw6NvIMOpIGNvbmZpZ3VyYWRhIHBhcmEgcHJhdGVsZWlyYXNgKQogICAgICAgICAgcmV0dXJuIG51bGwKICAgICAgICB9CgogICAgICAgIGNvbnN0IHNoZWx2ZXMgPSBhd2FpdCBnZXRTaGVsdmVzQnlBaXNsZShhaXNsZS5pZCkKICAgICAgICBjb25zdCBzaGVsZiA9IHNoZWx2ZXMuZmluZCgocykgPT4gcy5wb3NpdGlvbiA9PT0gcGFyc2VkLnBvc2l0aW9uICYmIHMubGV2ZWwgPT09IHBhcnNlZC5sZXZlbCkKCiAgICAgICAgaWYgKCFzaGVsZikgewogICAgICAgICAgY29uc29sZS5sb2coYFtEQVRBXSBQcmF0ZWxlaXJhIFAke3BhcnNlZC5wb3NpdGlvbn1BJHtwYXJzZWQubGV2ZWx9IG7Do28gZW5jb250cmFkYSBuYSBydWEgJHthaXNsZS5uYW1lfWApCiAgICAgICAgICByZXR1cm4gbnVsbAogICAgICAgIH0KCiAgICAgICAgY29uc29sZS5sb2coYFtEQVRBXSBQcmF0ZWxlaXJhIGVuY29udHJhZGE6YCwgc2hlbGYpCgogICAgICAgIHJldHVybiB7CiAgICAgICAgICBpZDogc2hlbGYuaWQsCiAgICAgICAgICBhZGRyZXNzOiBhZGRyZXNzLnRvVXBwZXJDYXNlKCksCiAgICAgICAgICB3YXJlaG91c2VJZDogd2FyZWhvdXNlLmlkLAogICAgICAgICAgd2FyZWhvdXNlTmFtZTogd2FyZWhvdXNlLm5hbWUsCiAgICAgICAgICBhaXNsZUlkOiBhaXNsZS5pZCwKICAgICAgICAgIGFpc2xlTmFtZTogYWlzbGUubmFtZSwKICAgICAgICAgIHBvc2l0aW9uOiBzaGVsZi5wb3NpdGlvbiwKICAgICAgICAgIGxldmVsOiBzaGVsZi5sZXZlbCwKICAgICAgICAgIHN0b3JhZ2VUeXBlOiAic2hlbGYiLAogICAgICAgICAgcHJvZHVjdE5hbWU6IHNoZWxmLnByb2R1Y3ROYW1lIHx8IHVuZGVmaW5lZCwKICAgICAgICAgIGVhbjogc2hlbGYuZWFuIHx8IHVuZGVmaW5lZCwgLy8gSUQgZG8gcHJvZHV0bwogICAgICAgICAgZWFuMTM6IHNoZWxmLmVhbjEzIHx8IHVuZGVmaW5lZCwgLy8gRUFOIHJlYWwgZG8gcHJvZHV0bwogICAgICAgICAgb2NjdXBhbmN5UGVyY2VudGFnZTogc2hlbGYub2NjdXBhbmN5UGVyY2VudGFnZSwKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQnVzY2FyIHBhbGV0ZQogICAgICAgIGlmIChhaXNsZS5zdG9yYWdlVHlwZSAhPT0gInBhbGxldCIpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKGBbREFUQV0gUnVhICR7YWlzbGUubmFtZX0gbsOjbyDDqSBjb25maWd1cmFkYSBwYXJhIHBhbGV0ZXNgKQogICAgICAgICAgcmV0dXJuIG51bGwKICAgICAgICB9CgogICAgICAgIGNvbnN0IHBhbGxldHMgPSBhd2FpdCBnZXRQYWxsZXRzQnlBaXNsZShhaXNsZS5pZCkKICAgICAgICBjb25zdCBwYWxsZXQgPSBwYWxsZXRzLmZpbmQoKHApID0+IHAucG9zaXRpb24gPT09IHBhcnNlZC5wb3NpdGlvbikKCiAgICAgICAgaWYgKCFwYWxsZXQpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKGBbREFUQV0gUGFsZXRlIFAke3BhcnNlZC5wb3NpdGlvbn0gbsOjbyBlbmNvbnRyYWRvIG5hIHJ1YSAke2Fpc2xlLm5hbWV9YCkKICAgICAgICAgIHJldHVybiBudWxsCiAgICAgICAgfQoKICAgICAgICBjb25zb2xlLmxvZyhgW0RBVEFdIFBhbGV0ZSBlbmNvbnRyYWRvOmAsIHBhbGxldCkKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGlkOiBwYWxsZXQuaWQsCiAgICAgICAgICBhZGRyZXNzOiBhZGRyZXNzLnRvVXBwZXJDYXNlKCksCiAgICAgICAgICB3YXJlaG91c2VJZDogd2FyZWhvdXNlLmlkLAogICAgICAgICAgd2FyZWhvdXNlTmFtZTogd2FyZWhvdXNlLm5hbWUsCiAgICAgICAgICBhaXNsZUlkOiBhaXNsZS5pZCwKICAgICAgICAgIGFpc2xlTmFtZTogYWlzbGUubmFtZSwKICAgICAgICAgIHBvc2l0aW9uOiBwYWxsZXQucG9zaXRpb24sCiAgICAgICAgICBzdG9yYWdlVHlwZTogInBhbGxldCIsCiAgICAgICAgICBwcm9kdWN0TmFtZTogcGFsbGV0LnByb2R1Y3ROYW1lIHx8IHVuZGVmaW5lZCwKICAgICAgICAgIGVhbjogcGFsbGV0LmVhbiB8fCB1bmRlZmluZWQsIC8vIElEIGRvIHByb2R1dG8KICAgICAgICAgIGVhbjEzOiBwYWxsZXQuZWFuMTMgfHwgdW5kZWZpbmVkLCAvLyBFQU4gcmVhbCBkbyBwcm9kdXRvCiAgICAgICAgfQogICAgICB9CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGJ1c2NhciBwb3IgZW5kZXJlw6dvOiIsIGVycm9yKQogICAgICByZXR1cm4gbnVsbAogICAgfQogIH0pCn0KCmV4cG9ydCBjb25zdCBhZGRXYXJlaG91c2UgPSBhc3luYyAobmFtZTogc3RyaW5nKTogUHJvbWlzZTxXYXJlaG91c2U+ID0+IHsKICB0cnkgewogICAgY29uc3QgbmV3V2FyZWhvdXNlID0gewogICAgICBpZDogcmFuZG9tVVVJRCgpLAogICAgICBuYW1lLAogICAgfQoKICAgIGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuYWRkV2FyZWhvdXNlKG5ld1dhcmVob3VzZSkKICAgIHJldHVybiBuZXdXYXJlaG91c2UKICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBjcmlhciBnYWxww6NvOiIsIGVycm9yKQogICAgdGhyb3cgZXJyb3IKICB9Cn0KCmV4cG9ydCBjb25zdCBhZGRBaXNsZSA9IGFzeW5jICgKICB3YXJlaG91c2VJZDogc3RyaW5nLAogIG5hbWU6IHN0cmluZywKICBub3Rlczogc3RyaW5nIHwgbnVsbCA9IG51bGwsCiAgY2FwYWNpdHkgPSAwLAogIHN0b3JhZ2VUeXBlOiAicGFsbGV0IiB8ICJzaGVsZiIgPSAicGFsbGV0IiwKICBzaGVsZkxldmVscyA9IDEsCik6IFByb21pc2U8QWlzbGU+ID0+IHsKICB0cnkgewogICAgaWYgKCF3YXJlaG91c2VJZCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIndhcmVob3VzZUlkIMOpIG9icmlnYXTDs3JpbyBwYXJhIGNyaWFyIHVtYSBydWEiKQogICAgfQoKICAgIGNvbnN0IG5ld0Fpc2xlID0gewogICAgICBpZDogcmFuZG9tVVVJRCgpLAogICAgICB3YXJlaG91c2VJZDogd2FyZWhvdXNlSWQsCiAgICAgIG5hbWU6IG5hbWUudHJpbSgpLAogICAgICBub3Rlczogbm90ZXM/LnRyaW0oKSB8fCAiIiwKICAgICAgY2FwYWNpdHk6IGNhcGFjaXR5LnRvU3RyaW5nKCksCiAgICAgIHN0b3JhZ2VUeXBlLAogICAgICBzaGVsZkxldmVsczogc2hlbGZMZXZlbHMudG9TdHJpbmcoKSwKICAgIH0KCiAgICBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmFkZEFpc2xlKG5ld0Fpc2xlKQogICAgcmV0dXJuIGNvbnZlcnRBaXNsZUZyb21TaGVldCh7IC4uLm5ld0Fpc2xlLCBjYXBhY2l0eSwgc2hlbGZMZXZlbHMgfSkKICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBjcmlhciBydWE6IiwgZXJyb3IpCiAgICB0aHJvdyBlcnJvcgogIH0KfQoKZXhwb3J0IGNvbnN0IHVwZGF0ZUFpc2xlTm90ZXMgPSBhc3luYyAoYWlzbGVJZDogc3RyaW5nLCBub3Rlczogc3RyaW5nKTogUHJvbWlzZTxBaXNsZSB8IG51bGw+ID0+IHsKICB0cnkgewogICAgaWYgKCFhaXNsZUlkIHx8IGFpc2xlSWQudHJpbSgpID09PSAiIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoImFpc2xlSWQgw6kgb2JyaWdhdMOzcmlvIHBhcmEgYXR1YWxpemFyIG9ic2VydmHDp8O1ZXMiKQogICAgfQoKICAgIGNvbnN0IGV4aXN0aW5nQWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQoYWlzbGVJZCkKICAgIGlmICghZXhpc3RpbmdBaXNsZSkgewogICAgICByZXR1cm4gbnVsbAogICAgfQoKICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLnVwZGF0ZUFpc2xlTm90ZXMoYWlzbGVJZCwgbm90ZXMpCgogICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAuLi5leGlzdGluZ0Fpc2xlLAogICAgICAgIG5vdGVzOiBub3RlcywKICAgICAgfQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYXR1YWxpemFyIG9ic2VydmHDp8O1ZXMgZGEgcnVhOiIsIGVycm9yKQogICAgcmV0dXJuIG51bGwKICB9Cn0KCmV4cG9ydCBjb25zdCB1cGRhdGVBaXNsZUNhcGFjaXR5ID0gYXN5bmMgKGFpc2xlSWQ6IHN0cmluZywgY2FwYWNpdHk6IG51bWJlcik6IFByb21pc2U8QWlzbGUgfCBudWxsPiA9PiB7CiAgdHJ5IHsKICAgIGlmICghYWlzbGVJZCB8fCBhaXNsZUlkLnRyaW0oKSA9PT0gIiIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJhaXNsZUlkIMOpIG9icmlnYXTDs3JpbyBwYXJhIGF0dWFsaXphciBjYXBhY2lkYWRlIikKICAgIH0KCiAgICBjb25zdCBleGlzdGluZ0Fpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKGFpc2xlSWQpCiAgICBpZiAoIWV4aXN0aW5nQWlzbGUpIHsKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS51cGRhdGVBaXNsZUNhcGFjaXR5KGFpc2xlSWQsIGNhcGFjaXR5LnRvU3RyaW5nKCkpCgogICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAuLi5leGlzdGluZ0Fpc2xlLAogICAgICAgIGNhcGFjaXR5OiBjYXBhY2l0eSwKICAgICAgfQogICAgfQoKICAgIHJldHVybiBudWxsCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYXR1YWxpemFyIGNhcGFjaWRhZGUgZGEgcnVhOiIsIGVycm9yKQogICAgcmV0dXJuIG51bGwKICB9Cn0KCmV4cG9ydCBjb25zdCB1cGRhdGVBaXNsZVN0b3JhZ2VDb25maWcgPSBhc3luYyAoCiAgYWlzbGVJZDogc3RyaW5nLAogIHN0b3JhZ2VUeXBlOiAicGFsbGV0IiB8ICJzaGVsZiIsCiAgc2hlbGZMZXZlbHM6IG51bWJlciwKKTogUHJvbWlzZTxBaXNsZSB8IG51bGw+ID0+IHsKICB0cnkgewogICAgaWYgKCFhaXNsZUlkIHx8IGFpc2xlSWQudHJpbSgpID09PSAiIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoImFpc2xlSWQgw6kgb2JyaWdhdMOzcmlvIHBhcmEgYXR1YWxpemFyIGNvbmZpZ3VyYcOnw6NvIikKICAgIH0KCiAgICBjb25zdCBleGlzdGluZ0Fpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKGFpc2xlSWQpCiAgICBpZiAoIWV4aXN0aW5nQWlzbGUpIHsKICAgICAgcmV0dXJuIG51bGwKICAgIH0KCiAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS51cGRhdGVBaXNsZVN0b3JhZ2VDb25maWcoYWlzbGVJZCwgc3RvcmFnZVR5cGUsIHNoZWxmTGV2ZWxzLnRvU3RyaW5nKCkpCgogICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAuLi5leGlzdGluZ0Fpc2xlLAogICAgICAgIHN0b3JhZ2VUeXBlLAogICAgICAgIHNoZWxmTGV2ZWxzLAogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG51bGwKICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBhdHVhbGl6YXIgY29uZmlndXJhw6fDo28gZGEgcnVhOiIsIGVycm9yKQogICAgcmV0dXJuIG51bGwKICB9Cn0KCmV4cG9ydCBjb25zdCBhZGRQYWxsZXQgPSBhc3luYyAoYWlzbGVJZDogc3RyaW5nLCBwb3NpdGlvbjogbnVtYmVyKTogUHJvbWlzZTxQYWxsZXQ+ID0+IHsKICB0cnkgewogICAgY29uc29sZS5sb2coYFtEQVRBXSBUZW50YW5kbyBhZGljaW9uYXIgcGFsZXRlIC0gYWlzbGVJZDogJHthaXNsZUlkfSwgcG9zaXRpb246ICR7cG9zaXRpb259YCkKCiAgICBpZiAoIWFpc2xlSWQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJhaXNsZUlkIMOpIG9icmlnYXTDs3JpbyBwYXJhIGNyaWFyIHVtIHBhbGV0ZSIpCiAgICB9CgogICAgY29uc3QgYWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQoYWlzbGVJZCkKICAgIGlmICghYWlzbGUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBSdWEgY29tIElEICR7YWlzbGVJZH0gbsOjbyBlbmNvbnRyYWRhYCkKICAgIH0KCiAgICBjb25zb2xlLmxvZyhgW0RBVEFdIFJ1YSBlbmNvbnRyYWRhOiAke2Fpc2xlLm5hbWV9LCB0aXBvOiAke2Fpc2xlLnN0b3JhZ2VUeXBlfWApCgogICAgaWYgKGFpc2xlLnN0b3JhZ2VUeXBlICE9PSAicGFsbGV0IikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYEVzdGEgcnVhIGVzdMOhIGNvbmZpZ3VyYWRhIHBhcmEgJHthaXNsZS5zdG9yYWdlVHlwZX0sIG7Do28gcGFyYSBwYWxldGVzYCkKICAgIH0KCiAgICBjb25zdCBuZXdQYWxsZXQgPSB7CiAgICAgIGlkOiByYW5kb21VVUlEKCksCiAgICAgIGFpc2xlSWQ6IGFpc2xlSWQsCiAgICAgIHBvc2l0aW9uOiBwb3NpdGlvbi50b1N0cmluZygpLAogICAgICBlYW46ICIiLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgIHByb2R1Y3ROYW1lOiAiIiwKICAgICAgY2F0ZWdvcnk6ICIiLAogICAgICBlYW4xMzogIiIsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgICAgbGFzdFZlcmlmaWVkOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICB9CgogICAgY29uc29sZS5sb2coYFtEQVRBXSBDcmlhbmRvIHBhbGV0ZTpgLCBuZXdQYWxsZXQpCgogICAgYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5hZGRQYWxsZXQobmV3UGFsbGV0KQoKICAgIGNvbnNvbGUubG9nKGBbREFUQV0gUGFsZXRlIGNyaWFkbyBjb20gc3VjZXNzb2ApCgogICAgcmV0dXJuIGNvbnZlcnRQYWxsZXRGcm9tU2hlZXQoeyAuLi5uZXdQYWxsZXQsIHBvc2l0aW9uIH0pCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gY3JpYXIgcGFsZXRlOiIsIGVycm9yKQogICAgdGhyb3cgZXJyb3IKICB9Cn0KCmV4cG9ydCBjb25zdCBhZGRTaGVsZiA9IGFzeW5jIChhaXNsZUlkOiBzdHJpbmcsIHBvc2l0aW9uOiBudW1iZXIsIGxldmVsOiBudW1iZXIpOiBQcm9taXNlPFNoZWxmPiA9PiB7CiAgdHJ5IHsKICAgIGNvbnNvbGUubG9nKGBbREFUQV0gVGVudGFuZG8gYWRpY2lvbmFyIHByYXRlbGVpcmEgLSBhaXNsZUlkOiAke2Fpc2xlSWR9LCBwb3NpdGlvbjogJHtwb3NpdGlvbn0sIGxldmVsOiAke2xldmVsfWApCgogICAgaWYgKCFhaXNsZUlkKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiYWlzbGVJZCDDqSBvYnJpZ2F0w7NyaW8gcGFyYSBjcmlhciB1bWEgcHJhdGVsZWlyYSIpCiAgICB9CgogICAgY29uc3QgYWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQoYWlzbGVJZCkKICAgIGlmICghYWlzbGUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBSdWEgY29tIElEICR7YWlzbGVJZH0gbsOjbyBlbmNvbnRyYWRhYCkKICAgIH0KCiAgICBjb25zb2xlLmxvZyhgW0RBVEFdIFJ1YSBlbmNvbnRyYWRhOiAke2Fpc2xlLm5hbWV9LCB0aXBvOiAke2Fpc2xlLnN0b3JhZ2VUeXBlfWApCgogICAgaWYgKGFpc2xlLnN0b3JhZ2VUeXBlICE9PSAic2hlbGYiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgRXN0YSBydWEgZXN0w6EgY29uZmlndXJhZGEgcGFyYSAke2Fpc2xlLnN0b3JhZ2VUeXBlfSwgbsOjbyBwYXJhIHByYXRlbGVpcmFzYCkKICAgIH0KCiAgICBjb25zdCBuZXdTaGVsZiA9IHsKICAgICAgaWQ6IHJhbmRvbVVVSUQoKSwKICAgICAgYWlzbGVJZDogYWlzbGVJZCwKICAgICAgcG9zaXRpb246IHBvc2l0aW9uLnRvU3RyaW5nKCksCiAgICAgIGxldmVsOiBsZXZlbC50b1N0cmluZygpLAogICAgICBlYW46ICIiLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgIHByb2R1Y3ROYW1lOiAiIiwKICAgICAgY2F0ZWdvcnk6ICIiLAogICAgICBlYW4xMzogIiIsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgICAgb2NjdXBhbmN5UGVyY2VudGFnZTogIjAiLAogICAgICBsYXN0VmVyaWZpZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgIH0KCiAgICBjb25zb2xlLmxvZyhgW0RBVEFdIENyaWFuZG8gcHJhdGVsZWlyYTpgLCBuZXdTaGVsZikKCiAgICBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmFkZFNoZWxmKG5ld1NoZWxmKQoKICAgIGNvbnNvbGUubG9nKGBbREFUQV0gUHJhdGVsZWlyYSBjcmlhZGEgY29tIHN1Y2Vzc29gKQoKICAgIHJldHVybiBjb252ZXJ0U2hlbGZGcm9tU2hlZXQoeyAuLi5uZXdTaGVsZiwgcG9zaXRpb24sIGxldmVsLCBvY2N1cGFuY3lQZXJjZW50YWdlOiAwIH0pCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gY3JpYXIgcHJhdGVsZWlyYToiLCBlcnJvcikKICAgIHRocm93IGVycm9yCiAgfQp9CgpleHBvcnQgY29uc3QgdXBkYXRlUGFsbGV0ID0gYXN5bmMgKAogIHBhbGxldElkOiBzdHJpbmcsCiAgZWFuOiBzdHJpbmcsCiAgcHJvZHVjdE5hbWU6IHN0cmluZywKICBjYXRlZ29yeT86IHN0cmluZywKICBlYW4xMz86IHN0cmluZywKKTogUHJvbWlzZTxQYWxsZXQgfCBudWxsPiA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLnVwZGF0ZVBhbGxldChwYWxsZXRJZCwgewogICAgICBlYW4sIC8vIElEIGRvIHByb2R1dG8KICAgICAgcHJvZHVjdE5hbWUsCiAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeSB8fCAiIiwKICAgICAgZWFuMTM6IGVhbjEzIHx8ICIiLCAvLyBFQU4gcmVhbCBkbyBwcm9kdXRvCiAgICAgIGxhc3RWZXJpZmllZDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLAogICAgfSkKCiAgICBpZiAoc3VjY2VzcykgewogICAgICByZXR1cm4gKGF3YWl0IGdldFBhbGxldEJ5SWQocGFsbGV0SWQpKSB8fCBudWxsCiAgICB9CiAgICByZXR1cm4gbnVsbAogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGF0dWFsaXphciBwYWxldGU6IiwgZXJyb3IpCiAgICByZXR1cm4gbnVsbAogIH0KfQoKZXhwb3J0IGNvbnN0IHVwZGF0ZVNoZWxmID0gYXN5bmMgKAogIHNoZWxmSWQ6IHN0cmluZywKICBlYW46IHN0cmluZywKICBwcm9kdWN0TmFtZTogc3RyaW5nLAogIG9jY3VwYW5jeVBlcmNlbnRhZ2U6IG51bWJlciwKICBjYXRlZ29yeT86IHN0cmluZywKICBlYW4xMz86IHN0cmluZywKKTogUHJvbWlzZTxTaGVsZiB8IG51bGw+ID0+IHsKICB0cnkgewogICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UudXBkYXRlU2hlbGYoc2hlbGZJZCwgewogICAgICBlYW4sIC8vIElEIGRvIHByb2R1dG8KICAgICAgcHJvZHVjdE5hbWUsCiAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeSB8fCAiIiwKICAgICAgZWFuMTM6IGVhbjEzIHx8ICIiLCAvLyBFQU4gcmVhbCBkbyBwcm9kdXRvCiAgICAgIG9jY3VwYW5jeVBlcmNlbnRhZ2U6IG9jY3VwYW5jeVBlcmNlbnRhZ2UudG9TdHJpbmcoKSwKICAgICAgbGFzdFZlcmlmaWVkOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICB9KQoKICAgIGlmIChzdWNjZXNzKSB7CiAgICAgIHJldHVybiBhd2FpdCBnZXRTaGVsZkJ5SWQoc2hlbGZJZCkKICAgIH0KICAgIHJldHVybiBudWxsCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYXR1YWxpemFyIHByYXRlbGVpcmE6IiwgZXJyb3IpCiAgICByZXR1cm4gbnVsbAogIH0KfQoKZXhwb3J0IGNvbnN0IHZlcmlmeVBhbGxldCA9IGFzeW5jIChwYWxsZXRJZDogc3RyaW5nKTogUHJvbWlzZTxQYWxsZXQgfCBudWxsPiA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLnVwZGF0ZVBhbGxldChwYWxsZXRJZCwgewogICAgICBsYXN0VmVyaWZpZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgIH0pCgogICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgcmV0dXJuIChhd2FpdCBnZXRQYWxsZXRCeUlkKHBhbGxldElkKSkgfHwgbnVsbAogICAgfQogICAgcmV0dXJuIG51bGwKICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcigiRXJybyBhbyB2ZXJpZmljYXIgcGFsZXRlOiIsIGVycm9yKQogICAgcmV0dXJuIG51bGwKICB9Cn0KCmV4cG9ydCBjb25zdCB2ZXJpZnlTaGVsZiA9IGFzeW5jIChzaGVsZklkOiBzdHJpbmcpOiBQcm9taXNlPFNoZWxmIHwgbnVsbD4gPT4gewogIHRyeSB7CiAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS51cGRhdGVTaGVsZihzaGVsZklkLCB7CiAgICAgIGxhc3RWZXJpZmllZDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLAogICAgfSkKCiAgICBpZiAoc3VjY2VzcykgewogICAgICByZXR1cm4gYXdhaXQgZ2V0U2hlbGZCeUlkKHNoZWxmSWQpCiAgICB9CiAgICByZXR1cm4gbnVsbAogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIHZlcmlmaWNhciBwcmF0ZWxlaXJhOiIsIGVycm9yKQogICAgcmV0dXJuIG51bGwKICB9Cn0KCmV4cG9ydCBjb25zdCBkZWxldGVQYWxsZXQgPSBhc3luYyAocGFsbGV0SWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gPT4gewogIHRyeSB7CiAgICBjb25zb2xlLmxvZyhgW0RBVEFdIFRlbnRhbmRvIGV4Y2x1aXIgcGFsZXRlOiAke3BhbGxldElkfWApCiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmRlbGV0ZVBhbGxldChwYWxsZXRJZCkKICAgIGNvbnNvbGUubG9nKGBbREFUQV0gUmVzdWx0YWRvIGRhIGV4Y2x1c8OjbyBkbyBwYWxldGU6ICR7cmVzdWx0fWApCiAgICByZXR1cm4gcmVzdWx0CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gZXhjbHVpciBwYWxldGU6IiwgZXJyb3IpCiAgICByZXR1cm4gZmFsc2UKICB9Cn0KCmV4cG9ydCBjb25zdCBkZWxldGVTaGVsZiA9IGFzeW5jIChzaGVsZklkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+ID0+IHsKICB0cnkgewogICAgY29uc29sZS5sb2coYFtEQVRBXSBUZW50YW5kbyBleGNsdWlyIHByYXRlbGVpcmE6ICR7c2hlbGZJZH1gKQogICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5kZWxldGVTaGVsZihzaGVsZklkKQogICAgY29uc29sZS5sb2coYFtEQVRBXSBSZXN1bHRhZG8gZGEgZXhjbHVzw6NvIGRhIHByYXRlbGVpcmE6ICR7cmVzdWx0fWApCiAgICByZXR1cm4gcmVzdWx0CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gZXhjbHVpciBwcmF0ZWxlaXJhOiIsIGVycm9yKQogICAgcmV0dXJuIGZhbHNlCiAgfQp9CgpleHBvcnQgY29uc3QgZGVsZXRlQWlzbGVzQnlXYXJlaG91c2UgPSBhc3luYyAod2FyZWhvdXNlSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4gPT4gewogIHRyeSB7CiAgICBjb25zdCBhaXNsZXMgPSBhd2FpdCBnZXRBaXNsZXNCeVdhcmVob3VzZSh3YXJlaG91c2VJZCkKICAgIGZvciAoY29uc3QgYWlzbGUgb2YgYWlzbGVzKSB7CiAgICAgIGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuZGVsZXRlUGFsbGV0c0J5QWlzbGUoYWlzbGUuaWQpCiAgICAgIGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuZGVsZXRlU2hlbHZlc0J5QWlzbGUoYWlzbGUuaWQpCiAgICB9CiAgICBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmRlbGV0ZUFpc2xlc0J5V2FyZWhvdXNlKHdhcmVob3VzZUlkKQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGV4Y2x1aXIgcnVhcyBkbyBnYWxww6NvOiIsIGVycm9yKQogIH0KfQoKZXhwb3J0IGNvbnN0IGRlbGV0ZVBhbGxldHNCeUFpc2xlID0gYXN5bmMgKGFpc2xlSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4gPT4gewogIHRyeSB7CiAgICBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmRlbGV0ZVBhbGxldHNCeUFpc2xlKGFpc2xlSWQpCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gZXhjbHVpciBwYWxldGVzIGRhIHJ1YToiLCBlcnJvcikKICB9Cn0KCmV4cG9ydCBjb25zdCBkZWxldGVTaGVsdmVzQnlBaXNsZSA9IGFzeW5jIChhaXNsZUlkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+ID0+IHsKICB0cnkgewogICAgYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5kZWxldGVTaGVsdmVzQnlBaXNsZShhaXNsZUlkKQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGV4Y2x1aXIgcHJhdGVsZWlyYXMgZGEgcnVhOiIsIGVycm9yKQogIH0KfQoKZXhwb3J0IGNvbnN0IGRlbGV0ZVdhcmVob3VzZSA9IGFzeW5jICh3YXJlaG91c2VJZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiA9PiB7CiAgdHJ5IHsKICAgIGF3YWl0IGRlbGV0ZUFpc2xlc0J5V2FyZWhvdXNlKHdhcmVob3VzZUlkKQogICAgcmV0dXJuIGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuZGVsZXRlV2FyZWhvdXNlKHdhcmVob3VzZUlkKQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGV4Y2x1aXIgZ2FscMOjbzoiLCBlcnJvcikKICAgIHJldHVybiBmYWxzZQogIH0KfQoKZXhwb3J0IGNvbnN0IGRlbGV0ZUFpc2xlID0gYXN5bmMgKGFpc2xlSWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gPT4gewogIHRyeSB7CiAgICBjb25zb2xlLmxvZyhgW0RBVEFdIFRlbnRhbmRvIGV4Y2x1aXIgcnVhOiAke2Fpc2xlSWR9YCkKCiAgICAvLyBQcmltZWlybyBleGNsdWlyIHRvZG9zIG9zIHBhbGV0ZXMgZSBwcmF0ZWxlaXJhcyBkYSBydWEKICAgIGNvbnNvbGUubG9nKGBbREFUQV0gRXhjbHVpbmRvIHBhbGV0ZXMgZGEgcnVhLi4uYCkKICAgIGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuZGVsZXRlUGFsbGV0c0J5QWlzbGUoYWlzbGVJZCkKCiAgICBjb25zb2xlLmxvZyhgW0RBVEFdIEV4Y2x1aW5kbyBwcmF0ZWxlaXJhcyBkYSBydWEuLi5gKQogICAgYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5kZWxldGVTaGVsdmVzQnlBaXNsZShhaXNsZUlkKQoKICAgIC8vIERlcG9pcyBleGNsdWlyIGEgcnVhCiAgICBjb25zb2xlLmxvZyhgW0RBVEFdIEV4Y2x1aW5kbyBhIHJ1YS4uLmApCiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnb29nbGVTaGVldHNTZXJ2aWNlLmRlbGV0ZUFpc2xlKGFpc2xlSWQpCgogICAgY29uc29sZS5sb2coYFtEQVRBXSBSZXN1bHRhZG8gZGEgZXhjbHVzw6NvIGRhIHJ1YTogJHtyZXN1bHR9YCkKICAgIHJldHVybiByZXN1bHQKICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBleGNsdWlyIHJ1YToiLCBlcnJvcikKICAgIHJldHVybiBmYWxzZQogIH0KfQoKZXhwb3J0IGNvbnN0IHJlb3JkZXJQYWxsZXRzID0gYXN5bmMgKGFpc2xlSWQ6IHN0cmluZywgbmV3UGFsbGV0T3JkZXJJZHM6IHN0cmluZ1tdKTogUHJvbWlzZTxib29sZWFuPiA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IG5ld09yZGVyID0gbmV3UGFsbGV0T3JkZXJJZHMubWFwKChpZCwgaW5kZXgpID0+ICh7CiAgICAgIGlkLAogICAgICBwb3NpdGlvbjogaW5kZXggKyAxLAogICAgfSkpCgogICAgcmV0dXJuIGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UucmVvcmRlclBhbGxldHMoYWlzbGVJZCwgbmV3T3JkZXIpCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gcmVvcmRlbmFyIHBhbGV0ZXM6IiwgZXJyb3IpCiAgICByZXR1cm4gZmFsc2UKICB9Cn0KCmV4cG9ydCBjb25zdCBmaW5kUHJvZHVjdEJ5RUFOID0gYXN5bmMgKGVhbjogc3RyaW5nKTogUHJvbWlzZTxTZWFyY2hSZXN1bHRbXT4gPT4gewogIHJldHVybiBwZXJmb3JtYW5jZU1vbml0b3IudHJhY2tPcGVyYXRpb24oYGZpbmRQcm9kdWN0QnlFQU46JHtlYW59YCwgYXN5bmMgKCkgPT4gewogICAgdHJ5IHsKICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UuZmluZFByb2R1Y3RCeUVBTihlYW4pCgogICAgICByZXR1cm4gcmVzdWx0cy5tYXAoKHJlc3VsdCkgPT4gewogICAgICAgIGNvbnN0IHdhcmVob3VzZUlkID0gcmVzdWx0LmFpc2xlSWQgJiYgdHlwZW9mIHJlc3VsdC5haXNsZUlkID09PSAic3RyaW5nIiA/IHJlc3VsdC5haXNsZUlkLnNwbGl0KCItIilbMF0gOiAiIgoKICAgICAgICByZXR1cm4gewogICAgICAgICAgcGFsbGV0SWQ6IHJlc3VsdC5pZCwKICAgICAgICAgIHBvc2l0aW9uOiBOdW1iZXIucGFyc2VJbnQocmVzdWx0LnBvc2l0aW9uKSB8fCAwLAogICAgICAgICAgbGV2ZWw6ICJsZXZlbCIgaW4gcmVzdWx0ID8gTnVtYmVyLnBhcnNlSW50KHJlc3VsdC5sZXZlbCBhcyBzdHJpbmcpIDogdW5kZWZpbmVkLAogICAgICAgICAgZWFuOiByZXN1bHQuZWFuLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgICAgICBwcm9kdWN0TmFtZTogcmVzdWx0LnByb2R1Y3ROYW1lIHx8ICJOL0EiLAogICAgICAgICAgYWlzbGVOYW1lOiByZXN1bHQuYWlzbGVOYW1lLAogICAgICAgICAgd2FyZWhvdXNlTmFtZTogcmVzdWx0LndhcmVob3VzZU5hbWUsCiAgICAgICAgICB3YXJlaG91c2VJZDogd2FyZWhvdXNlSWQsCiAgICAgICAgICBhaXNsZUlkOiByZXN1bHQuYWlzbGVJZCwKICAgICAgICAgIHN0b3JhZ2VUeXBlOiByZXN1bHQuc3RvcmFnZVR5cGUgYXMgInBhbGxldCIgfCAic2hlbGYiLAogICAgICAgICAgb2NjdXBhbmN5UGVyY2VudGFnZToKICAgICAgICAgICAgIm9jY3VwYW5jeVBlcmNlbnRhZ2UiIGluIHJlc3VsdCA/IE51bWJlci5wYXJzZUludChyZXN1bHQub2NjdXBhbmN5UGVyY2VudGFnZSBhcyBzdHJpbmcpIDogdW5kZWZpbmVkLAogICAgICAgICAgZWFuMTM6IHJlc3VsdC5lYW4xMyB8fCB1bmRlZmluZWQsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgICAgICB9CiAgICAgIH0pCiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGJ1c2NhciBwcm9kdXRvIHBvciBFQU46IiwgZXJyb3IpCiAgICAgIHJldHVybiBbXQogICAgfQogIH0pCn0KCi8vIEZ1bsOnw6NvIG1lbGhvcmFkYSBwYXJhIGJ1c2NhciB3YXJlaG91c2UgSUQKZXhwb3J0IGNvbnN0IGZpbmRXYXJlaG91c2VJZEJ5QWlzbGVJZCA9IGFzeW5jIChhaXNsZUlkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4gPT4gewogIHRyeSB7CiAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZChhaXNsZUlkKQogICAgcmV0dXJuIGFpc2xlPy53YXJlaG91c2VJZCB8fCAiIgogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGJ1c2NhciB3YXJlaG91c2UgSUQ6IiwgZXJyb3IpCiAgICByZXR1cm4gIiIKICB9Cn0KCmV4cG9ydCBjb25zdCBnZXREdXBsaWNhdGVkRUFOcyA9IGFzeW5jICgpOiBQcm9taXNlPFNldDxzdHJpbmc+PiA9PiB7CiAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbigiZ2V0RHVwbGljYXRlZEVBTnMiLCBhc3luYyAoKSA9PiB7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgZ29vZ2xlU2hlZXRzU2VydmljZS5nZXREdXBsaWNhdGVkRUFOcygpCiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGJ1c2NhciBFQU5zIGR1cGxpY2Fkb3M6IiwgZXJyb3IpCiAgICAgIHJldHVybiBuZXcgU2V0KCkKICAgIH0KICB9KQp9CgpleHBvcnQgY29uc3QgdW5hc3NpZ25Qcm9kdWN0RnJvbVBhbGxldCA9IGFzeW5jIChwYWxsZXRJZDogc3RyaW5nKTogUHJvbWlzZTxQYWxsZXQgfCBudWxsPiA9PiB7CiAgdHJ5IHsKICAgIGNvbnNvbGUubG9nKGBbREFUQV0gUmVtb3ZlbmRvIHByb2R1dG8gZG8gcGFsZXRlOiAke3BhbGxldElkfWApCgogICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UudXBkYXRlUGFsbGV0KHBhbGxldElkLCB7CiAgICAgIGVhbjogIiIsIC8vIElEIGRvIHByb2R1dG8KICAgICAgcHJvZHVjdE5hbWU6ICIiLAogICAgICBjYXRlZ29yeTogIiIsCiAgICAgIGVhbjEzOiAiIiwgLy8gRUFOIHJlYWwgZG8gcHJvZHV0bwogICAgICBsYXN0VmVyaWZpZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgIH0pCgogICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgY29uc29sZS5sb2coYFtEQVRBXSBQcm9kdXRvIHJlbW92aWRvIGRvIHBhbGV0ZSBjb20gc3VjZXNzb2ApCiAgICAgIHJldHVybiAoYXdhaXQgZ2V0UGFsbGV0QnlJZChwYWxsZXRJZCkpIHx8IG51bGwKICAgIH0KICAgIHJldHVybiBudWxsCiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gcmVtb3ZlciBwcm9kdXRvIGRvIHBhbGV0ZToiLCBlcnJvcikKICAgIHJldHVybiBudWxsCiAgfQp9CgpleHBvcnQgY29uc3QgdW5hc3NpZ25Qcm9kdWN0RnJvbVNoZWxmID0gYXN5bmMgKHNoZWxmSWQ6IHN0cmluZyk6IFByb21pc2U8U2hlbGYgfCBudWxsPiA9PiB7CiAgdHJ5IHsKICAgIGNvbnNvbGUubG9nKGBbREFUQV0gUmVtb3ZlbmRvIHByb2R1dG8gZGEgcHJhdGVsZWlyYTogJHtzaGVsZklkfWApCgogICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IGdvb2dsZVNoZWV0c1NlcnZpY2UudXBkYXRlU2hlbGYoc2hlbGZJZCwgewogICAgICBlYW46ICIiLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgIHByb2R1Y3ROYW1lOiAiIiwKICAgICAgY2F0ZWdvcnk6ICIiLAogICAgICBlYW4xMzogIiIsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgICAgb2NjdXBhbmN5UGVyY2VudGFnZTogIjAiLAogICAgICBsYXN0VmVyaWZpZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgIH0pCgogICAgaWYgKHN1Y2Nlc3MpIHsKICAgICAgY29uc29sZS5sb2coYFtEQVRBXSBQcm9kdXRvIHJlbW92aWRvIGRhIHByYXRlbGVpcmEgY29tIHN1Y2Vzc29gKQogICAgICByZXR1cm4gYXdhaXQgZ2V0U2hlbGZCeUlkKHNoZWxmSWQpCiAgICB9CiAgICByZXR1cm4gbnVsbAogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIHJlbW92ZXIgcHJvZHV0byBkYSBwcmF0ZWxlaXJhOiIsIGVycm9yKQogICAgcmV0dXJuIG51bGwKICB9Cn0KCi8vIEZ1bsOnw6NvIHBhcmEgYnVzY2FyIGRhZG9zIGNvbXBsZXRvcyBkb3MgZ2FscMO1ZXMKZXhwb3J0IGNvbnN0IGdldFdhcmVob3VzZURhdGEgPSBhc3luYyAoKTogUHJvbWlzZTxXYXJlaG91c2VEYXRhW10+ID0+IHsKICByZXR1cm4gcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKCJnZXRXYXJlaG91c2VEYXRhIiwgYXN5bmMgKCkgPT4gewogICAgdHJ5IHsKICAgICAgY29uc29sZS5sb2coIltEQVRBXSBCdXNjYW5kbyBkYWRvcyBjb21wbGV0b3MgZG9zIGdhbHDDtWVzLi4uIikKCiAgICAgIC8vIEdldCBhbGwgd2FyZWhvdXNlcwogICAgICBjb25zdCB3YXJlaG91c2VzID0gYXdhaXQgZ2V0V2FyZWhvdXNlcygpCiAgICAgIGNvbnN0IHdhcmVob3VzZURhdGE6IFdhcmVob3VzZURhdGFbXSA9IFtdCgogICAgICBmb3IgKGNvbnN0IHdhcmVob3VzZSBvZiB3YXJlaG91c2VzKSB7CiAgICAgICAgY29uc29sZS5sb2coYFtEQVRBXSBQcm9jZXNzYW5kbyBnYWxww6NvOiAke3dhcmVob3VzZS5uYW1lfWApCgogICAgICAgIC8vIEdldCBhaXNsZXMgZm9yIHRoaXMgd2FyZWhvdXNlCiAgICAgICAgY29uc3QgYWlzbGVzID0gYXdhaXQgZ2V0QWlzbGVzQnlXYXJlaG91c2Uod2FyZWhvdXNlLmlkKQogICAgICAgIGNvbnN0IGFpc2xlRGF0YTogQWlzbGVEYXRhW10gPSBbXQoKICAgICAgICBmb3IgKGNvbnN0IGFpc2xlIG9mIGFpc2xlcykgewogICAgICAgICAgY29uc29sZS5sb2coYFtEQVRBXSBQcm9jZXNzYW5kbyBydWE6ICR7YWlzbGUubmFtZX0sIHRpcG86ICR7YWlzbGUuc3RvcmFnZVR5cGV9YCkKCiAgICAgICAgICAvLyBFeHRyYWN0IHBvc2l0aW9uIG51bWJlciBmcm9tIGFpc2xlIG5hbWUgKGUuZy4sICJSdWEgMDEiIC0+IDEpCiAgICAgICAgICBjb25zdCBwb3NpdGlvbk1hdGNoID0gYWlzbGUubmFtZS5tYXRjaCgvXGQrLykKICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gcG9zaXRpb25NYXRjaCA/IE51bWJlci5wYXJzZUludChwb3NpdGlvbk1hdGNoWzBdKSA6IDAKCiAgICAgICAgICBpZiAoYWlzbGUuc3RvcmFnZVR5cGUgPT09ICJwYWxsZXQiKSB7CiAgICAgICAgICAgIC8vIEdldCBwYWxsZXRzIGZvciB0aGlzIGFpc2xlCiAgICAgICAgICAgIGNvbnN0IHBhbGxldHMgPSBhd2FpdCBnZXRQYWxsZXRzQnlBaXNsZShhaXNsZS5pZCkKICAgICAgICAgICAgY29uc3QgcGFsbGV0RGF0YTogUGFsbGV0RGF0YVtdID0gcGFsbGV0cy5tYXAoKHBhbGxldCkgPT4gKHsKICAgICAgICAgICAgICBpZDogcGFsbGV0LmlkLAogICAgICAgICAgICAgIHBvc2l0aW9uOiBwYWxsZXQucG9zaXRpb24sCiAgICAgICAgICAgICAgZWFuOiBwYWxsZXQuZWFuLAogICAgICAgICAgICAgIHByb2R1Y3ROYW1lOiBwYWxsZXQucHJvZHVjdE5hbWUsCiAgICAgICAgICAgIH0pKQoKICAgICAgICAgICAgYWlzbGVEYXRhLnB1c2goewogICAgICAgICAgICAgIGlkOiBhaXNsZS5pZCwKICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICBzdG9yYWdlVHlwZTogInBhbGxldCIsCiAgICAgICAgICAgICAgcGFsbGV0czogcGFsbGV0RGF0YSwKICAgICAgICAgICAgfSkKICAgICAgICAgIH0gZWxzZSBpZiAoYWlzbGUuc3RvcmFnZVR5cGUgPT09ICJzaGVsZiIpIHsKICAgICAgICAgICAgLy8gR2V0IHNoZWx2ZXMgZm9yIHRoaXMgYWlzbGUKICAgICAgICAgICAgY29uc3Qgc2hlbHZlcyA9IGF3YWl0IGdldFNoZWx2ZXNCeUFpc2xlKGFpc2xlLmlkKQoKICAgICAgICAgICAgLy8gR3JvdXAgc2hlbHZlcyBieSBwb3NpdGlvbgogICAgICAgICAgICBjb25zdCBzaGVsZkdyb3VwcyA9IG5ldyBNYXA8bnVtYmVyLCBTaGVsZkxldmVsRGF0YVtdPigpCgogICAgICAgICAgICBmb3IgKGNvbnN0IHNoZWxmIG9mIHNoZWx2ZXMpIHsKICAgICAgICAgICAgICBpZiAoIXNoZWxmR3JvdXBzLmhhcyhzaGVsZi5wb3NpdGlvbikpIHsKICAgICAgICAgICAgICAgIHNoZWxmR3JvdXBzLnNldChzaGVsZi5wb3NpdGlvbiwgW10pCiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBzaGVsZkdyb3Vwcy5nZXQoc2hlbGYucG9zaXRpb24pIS5wdXNoKHsKICAgICAgICAgICAgICAgIGlkOiBzaGVsZi5pZCwKICAgICAgICAgICAgICAgIGxldmVsOiBzaGVsZi5sZXZlbCwKICAgICAgICAgICAgICAgIGVhbjogc2hlbGYuZWFuLAogICAgICAgICAgICAgICAgcHJvZHVjdE5hbWU6IHNoZWxmLnByb2R1Y3ROYW1lLAogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENvbnZlcnQgZ3JvdXBlZCBzaGVsdmVzIHRvIFNoZWxmRGF0YSBhcnJheQogICAgICAgICAgICBjb25zdCBzaGVsZkRhdGE6IFNoZWxmRGF0YVtdID0gQXJyYXkuZnJvbShzaGVsZkdyb3Vwcy5lbnRyaWVzKCkpLm1hcCgoW3Bvc2l0aW9uLCBsZXZlbHNdKSA9PiAoewogICAgICAgICAgICAgIGlkOiBsZXZlbHNbMF0uaWQsIC8vIFVzZSBmaXJzdCBsZXZlbCdzIElEIGFzIHNoZWxmIElECiAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgbGV2ZWxzOiBsZXZlbHMuc29ydCgoYSwgYikgPT4gYS5sZXZlbCAtIGIubGV2ZWwpLCAvLyBTb3J0IGxldmVscyBieSBsZXZlbCBudW1iZXIKICAgICAgICAgICAgfSkpCgogICAgICAgICAgICBhaXNsZURhdGEucHVzaCh7CiAgICAgICAgICAgICAgaWQ6IGFpc2xlLmlkLAogICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgIHN0b3JhZ2VUeXBlOiAic2hlbGYiLAogICAgICAgICAgICAgIHNoZWx2ZXM6IHNoZWxmRGF0YSwKICAgICAgICAgICAgfSkKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHdhcmVob3VzZURhdGEucHVzaCh7CiAgICAgICAgICBpZDogd2FyZWhvdXNlLmlkLAogICAgICAgICAgbmFtZTogd2FyZWhvdXNlLm5hbWUsCiAgICAgICAgICBhaXNsZXM6IGFpc2xlRGF0YS5zb3J0KChhLCBiKSA9PiBhLnBvc2l0aW9uIC0gYi5wb3NpdGlvbiksIC8vIFNvcnQgYWlzbGVzIGJ5IHBvc2l0aW9uCiAgICAgICAgfSkKICAgICAgfQoKICAgICAgY29uc29sZS5sb2coYFtEQVRBXSBEYWRvcyBjb21wbGV0b3MgY2FycmVnYWRvcyBwYXJhICR7d2FyZWhvdXNlRGF0YS5sZW5ndGh9IGdhbHDDtWVzYCkKICAgICAgcmV0dXJuIHdhcmVob3VzZURhdGEKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYnVzY2FyIGRhZG9zIGNvbXBsZXRvcyBkb3MgZ2FscMO1ZXM6IiwgZXJyb3IpCiAgICAgIHJldHVybiBbXQogICAgfQogIH0pCn0K"}