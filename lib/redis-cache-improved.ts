{"data":"aW1wb3J0IFJlZGlzIGZyb20gImlvcmVkaXMiCmltcG9ydCB7IHByb21pc2lmeSB9IGZyb20gInV0aWwiCmltcG9ydCB7IGd6aXAsIGd1bnppcCB9IGZyb20gInpsaWIiCgpjb25zdCBnemlwQXN5bmMgPSBwcm9taXNpZnkoZ3ppcCkKY29uc3QgZ3VuemlwQXN5bmMgPSBwcm9taXNpZnkoZ3VuemlwKQoKLy8gQ29uZmlndXJhw6fDo28gZG8gUmVkaXMgY29tIHJldHJ5IGUgcmVjb25uZWN0CmNvbnN0IHJlZGlzID0gbmV3IFJlZGlzKHByb2Nlc3MuZW52LlJFRElTX1VSTCEsIHsKICByZXRyeURlbGF5T25GYWlsb3ZlcjogMTAwLAogIGVuYWJsZVJlYWR5Q2hlY2s6IGZhbHNlLAogIG1heFJldHJpZXNQZXJSZXF1ZXN0OiAzLAogIGxhenlDb25uZWN0OiB0cnVlLAogIHJlY29ubmVjdE9uRXJyb3I6IChlcnIpID0+IHsKICAgIGNvbnN0IHRhcmdldEVycm9yID0gIlJFQURPTkxZIgogICAgcmV0dXJuIGVyci5tZXNzYWdlLmluY2x1ZGVzKHRhcmdldEVycm9yKQogIH0sCn0pCgovLyBUVExzIGVtIHNlZ3VuZG9zCmV4cG9ydCBjb25zdCBDQUNIRV9UVEwgPSB7CiAgU0hPUlQ6IDUgKiA2MCwgLy8gNSBtaW51dG9zCiAgTUVESVVNOiAxNSAqIDYwLCAvLyAxNSBtaW51dG9zCiAgTE9ORzogNjAgKiA2MCwgLy8gMSBob3JhCiAgVkVSWV9MT05HOiAyNCAqIDYwICogNjAsIC8vIDI0IGhvcmFzCn0gYXMgY29uc3QKCi8vIENoYXZlcyBkZSBjYWNoZSBvcmdhbml6YWRhcwpleHBvcnQgY29uc3QgQ0FDSEVfS0VZUyA9IHsKICAvLyBXYXJlaG91c2VzCiAgV0FSRUhPVVNFUzogIndhcmVob3VzZXM6YWxsIiwKICBXQVJFSE9VU0U6IChpZDogc3RyaW5nKSA9PiBgd2FyZWhvdXNlOiR7aWR9YCwKCiAgLy8gQWlzbGVzCiAgQUlTTEVTX0JZX1dBUkVIT1VTRTogKHdhcmVob3VzZUlkOiBzdHJpbmcpID0+IGBhaXNsZXM6d2FyZWhvdXNlOiR7d2FyZWhvdXNlSWR9YCwKICBBSVNMRTogKGlkOiBzdHJpbmcpID0+IGBhaXNsZToke2lkfWAsCgogIC8vIFBhbGxldHMKICBQQUxMRVRTX0JZX0FJU0xFOiAoYWlzbGVJZDogc3RyaW5nKSA9PiBgcGFsbGV0czphaXNsZToke2Fpc2xlSWR9YCwKICBQQUxMRVQ6IChpZDogc3RyaW5nKSA9PiBgcGFsbGV0OiR7aWR9YCwKCiAgLy8gU2hlbHZlcwogIFNIRUxWRVNfQllfQUlTTEU6IChhaXNsZUlkOiBzdHJpbmcpID0+IGBzaGVsdmVzOmFpc2xlOiR7YWlzbGVJZH1gLAogIFNIRUxGOiAoaWQ6IHN0cmluZykgPT4gYHNoZWxmOiR7aWR9YCwKCiAgLy8gU2VhcmNoCiAgU0VBUkNIX0JZX0VBTjogKGVhbjogc3RyaW5nKSA9PiBgc2VhcmNoOmVhbjoke2Vhbi50b0xvd2VyQ2FzZSgpfWAsCiAgU0VBUkNIX0JZX0FERFJFU1M6IChhZGRyZXNzOiBzdHJpbmcpID0+IGBzZWFyY2g6YWRkcmVzczoke2FkZHJlc3MudG9Mb3dlckNhc2UoKX1gLAogIERVUExJQ0FURURfRUFOUzogImR1cGxpY2F0ZWQ6ZWFucyIsCgogIC8vIFByb2R1Y3RzCiAgUFJPRFVDVF9CWV9FQU46IChlYW46IHN0cmluZykgPT4gYHByb2R1Y3Q6ZWFuOiR7ZWFufWAsCiAgUFJPRFVDVF9CWV9JRDogKGlkOiBzdHJpbmcpID0+IGBwcm9kdWN0OmlkOiR7aWR9YCwKICBQUk9EVUNUX1NFQVJDSDogKHF1ZXJ5OiBzdHJpbmcpID0+IGBwcm9kdWN0OnNlYXJjaDoke3F1ZXJ5LnRvTG93ZXJDYXNlKCl9YCwKCiAgLy8gUGF0dGVybnMgZm9yIGJ1bGsgb3BlcmF0aW9ucwogIFBBVFRFUk5TOiB7CiAgICBXQVJFSE9VU0U6IChpZDogc3RyaW5nKSA9PiBgKndhcmVob3VzZToke2lkfSpgLAogICAgQUlTTEU6IChpZDogc3RyaW5nKSA9PiBgKmFpc2xlOiR7aWR9KmAsCiAgICBQQUxMRVQ6IChpZDogc3RyaW5nKSA9PiBgKnBhbGxldDoke2lkfSpgLAogICAgU0hFTEY6IChpZDogc3RyaW5nKSA9PiBgKnNoZWxmOiR7aWR9KmAsCiAgICBTRUFSQ0g6ICIqc2VhcmNoOioiLAogIH0sCn0gYXMgY29uc3QKCmludGVyZmFjZSBDYWNoZVN0YXRzIHsKICBoaXRzOiBudW1iZXIKICBtaXNzZXM6IG51bWJlcgogIGVycm9yczogbnVtYmVyCiAgdG90YWxPcGVyYXRpb25zOiBudW1iZXIKICBoaXRSYXRlOiBudW1iZXIKICBhdmdSZXNwb25zZVRpbWU6IG51bWJlcgp9CgpjbGFzcyBJbXByb3ZlZFJlZGlzQ2FjaGUgewogIHByaXZhdGUgaXNDb25uZWN0ZWQgPSBmYWxzZQogIHByaXZhdGUgY29ubmVjdGlvblByb21pc2U6IFByb21pc2U8dm9pZD4gfCBudWxsID0gbnVsbAogIHByaXZhdGUgc3RhdHM6IENhY2hlU3RhdHMgPSB7CiAgICBoaXRzOiAwLAogICAgbWlzc2VzOiAwLAogICAgZXJyb3JzOiAwLAogICAgdG90YWxPcGVyYXRpb25zOiAwLAogICAgaGl0UmF0ZTogMCwKICAgIGF2Z1Jlc3BvbnNlVGltZTogMCwKICB9CiAgcHJpdmF0ZSByZXNwb25zZVRpbWVzOiBudW1iZXJbXSA9IFtdCiAgcHJpdmF0ZSByZWFkb25seSBDT01QUkVTU0lPTl9USFJFU0hPTEQgPSAxMDI0IC8vIDFLQgogIHByaXZhdGUgcmVhZG9ubHkgTUFYX1JFVFJZX0FUVEVNUFRTID0gMwogIHByaXZhdGUgcmVhZG9ubHkgUkVUUllfREVMQVkgPSAxMDAwIC8vIDEgc2Vjb25kCgogIGFzeW5jIGNvbm5lY3QoKTogUHJvbWlzZTx2b2lkPiB7CiAgICBpZiAodGhpcy5pc0Nvbm5lY3RlZCkgcmV0dXJuCiAgICBpZiAodGhpcy5jb25uZWN0aW9uUHJvbWlzZSkgcmV0dXJuIHRoaXMuY29ubmVjdGlvblByb21pc2UKCiAgICB0aGlzLmNvbm5lY3Rpb25Qcm9taXNlID0gdGhpcy5fY29ubmVjdFdpdGhSZXRyeSgpCiAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uUHJvbWlzZQogIH0KCiAgcHJpdmF0ZSBhc3luYyBfY29ubmVjdFdpdGhSZXRyeShhdHRlbXB0ID0gMSk6IFByb21pc2U8dm9pZD4gewogICAgdHJ5IHsKICAgICAgYXdhaXQgcmVkaXMucGluZygpCiAgICAgIHRoaXMuaXNDb25uZWN0ZWQgPSB0cnVlCiAgICAgIGNvbnNvbGUubG9nKCLinIUgUmVkaXMgY29uZWN0YWRvIGNvbSBzdWNlc3NvIikKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoYOKdjCBFcnJvIGFvIGNvbmVjdGFyIFJlZGlzICh0ZW50YXRpdmEgJHthdHRlbXB0fSk6YCwgZXJyb3IpCgogICAgICBpZiAoYXR0ZW1wdCA8IHRoaXMuTUFYX1JFVFJZX0FUVEVNUFRTKSB7CiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgdGhpcy5SRVRSWV9ERUxBWSAqIGF0dGVtcHQpKQogICAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0V2l0aFJldHJ5KGF0dGVtcHQgKyAxKQogICAgICB9CgogICAgICB0aGlzLmlzQ29ubmVjdGVkID0gZmFsc2UKICAgICAgdGhpcy5jb25uZWN0aW9uUHJvbWlzZSA9IG51bGwKICAgICAgdGhyb3cgZXJyb3IKICAgIH0KICB9CgogIHByaXZhdGUgYXN5bmMgZW5zdXJlQ29ubmVjdGlvbigpOiBQcm9taXNlPHZvaWQ+IHsKICAgIGlmICghdGhpcy5pc0Nvbm5lY3RlZCkgewogICAgICBhd2FpdCB0aGlzLmNvbm5lY3QoKQogICAgfQogIH0KCiAgcHJpdmF0ZSBzaG91bGRDb21wcmVzcyhkYXRhOiBzdHJpbmcpOiBib29sZWFuIHsKICAgIHJldHVybiBkYXRhLmxlbmd0aCA+IHRoaXMuQ09NUFJFU1NJT05fVEhSRVNIT0xECiAgfQoKICBwcml2YXRlIGFzeW5jIGNvbXByZXNzRGF0YShkYXRhOiBzdHJpbmcpOiBQcm9taXNlPEJ1ZmZlcj4gewogICAgcmV0dXJuIGF3YWl0IGd6aXBBc3luYyhCdWZmZXIuZnJvbShkYXRhLCAidXRmOCIpKQogIH0KCiAgcHJpdmF0ZSBhc3luYyBkZWNvbXByZXNzRGF0YShkYXRhOiBCdWZmZXIpOiBQcm9taXNlPHN0cmluZz4gewogICAgY29uc3QgZGVjb21wcmVzc2VkID0gYXdhaXQgZ3VuemlwQXN5bmMoZGF0YSkKICAgIHJldHVybiBkZWNvbXByZXNzZWQudG9TdHJpbmcoInV0ZjgiKQogIH0KCiAgcHJpdmF0ZSB1cGRhdGVTdGF0cyhpc0hpdDogYm9vbGVhbiwgcmVzcG9uc2VUaW1lOiBudW1iZXIsIGlzRXJyb3IgPSBmYWxzZSk6IHZvaWQgewogICAgdGhpcy5zdGF0cy50b3RhbE9wZXJhdGlvbnMrKwoKICAgIGlmIChpc0Vycm9yKSB7CiAgICAgIHRoaXMuc3RhdHMuZXJyb3JzKysKICAgIH0gZWxzZSBpZiAoaXNIaXQpIHsKICAgICAgdGhpcy5zdGF0cy5oaXRzKysKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuc3RhdHMubWlzc2VzKysKICAgIH0KCiAgICB0aGlzLnJlc3BvbnNlVGltZXMucHVzaChyZXNwb25zZVRpbWUpCiAgICBpZiAodGhpcy5yZXNwb25zZVRpbWVzLmxlbmd0aCA+IDEwMDApIHsKICAgICAgdGhpcy5yZXNwb25zZVRpbWVzID0gdGhpcy5yZXNwb25zZVRpbWVzLnNsaWNlKC0xMDAwKQogICAgfQoKICAgIHRoaXMuc3RhdHMuaGl0UmF0ZSA9IHRoaXMuc3RhdHMudG90YWxPcGVyYXRpb25zID4gMCA/ICh0aGlzLnN0YXRzLmhpdHMgLyB0aGlzLnN0YXRzLnRvdGFsT3BlcmF0aW9ucykgKiAxMDAgOiAwCgogICAgdGhpcy5zdGF0cy5hdmdSZXNwb25zZVRpbWUgPQogICAgICB0aGlzLnJlc3BvbnNlVGltZXMubGVuZ3RoID4gMCA/IHRoaXMucmVzcG9uc2VUaW1lcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHRoaXMucmVzcG9uc2VUaW1lcy5sZW5ndGggOiAwCiAgfQoKICBhc3luYyBnZXQ8VD4oa2V5OiBzdHJpbmcpOiBQcm9taXNlPFQgfCBudWxsPiB7CiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5lbnN1cmVDb25uZWN0aW9uKCkKCiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlZGlzLmdldChrZXkpCiAgICAgIGNvbnN0IHJlc3BvbnNlVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWUKCiAgICAgIGlmICghcmVzdWx0KSB7CiAgICAgICAgdGhpcy51cGRhdGVTdGF0cyhmYWxzZSwgcmVzcG9uc2VUaW1lKQogICAgICAgIHJldHVybiBudWxsCiAgICAgIH0KCiAgICAgIGxldCBkYXRhOiBzdHJpbmcKCiAgICAgIC8vIENoZWNrIGlmIGRhdGEgaXMgY29tcHJlc3NlZCAoc3RhcnRzIHdpdGggZ3ppcCBtYWdpYyBudW1iZXIpCiAgICAgIGlmIChyZXN1bHQuc3RhcnRzV2l0aCgiXHgxZlx4OGIiKSkgewogICAgICAgIGRhdGEgPSBhd2FpdCB0aGlzLmRlY29tcHJlc3NEYXRhKEJ1ZmZlci5mcm9tKHJlc3VsdCwgImJpbmFyeSIpKQogICAgICB9IGVsc2UgewogICAgICAgIGRhdGEgPSByZXN1bHQKICAgICAgfQoKICAgICAgY29uc3QgcGFyc2VkID0gSlNPTi5wYXJzZShkYXRhKQogICAgICB0aGlzLnVwZGF0ZVN0YXRzKHRydWUsIHJlc3BvbnNlVGltZSkKCiAgICAgIHJldHVybiBwYXJzZWQKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGNvbnN0IHJlc3BvbnNlVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWUKICAgICAgdGhpcy51cGRhdGVTdGF0cyhmYWxzZSwgcmVzcG9uc2VUaW1lLCB0cnVlKQogICAgICBjb25zb2xlLmVycm9yKGDinYwgRXJybyBhbyBidXNjYXIgY2FjaGUgWyR7a2V5fV06YCwgZXJyb3IpCiAgICAgIHJldHVybiBudWxsCiAgICB9CiAgfQoKICBhc3luYyBzZXQ8VD4oa2V5OiBzdHJpbmcsIHZhbHVlOiBULCB0dGw6IG51bWJlciA9IENBQ0hFX1RUTC5NRURJVU0pOiBQcm9taXNlPGJvb2xlYW4+IHsKICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCkKCiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLmVuc3VyZUNvbm5lY3Rpb24oKQoKICAgICAgY29uc3Qgc2VyaWFsaXplZCA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKQogICAgICBsZXQgZGF0YVRvU3RvcmU6IHN0cmluZyB8IEJ1ZmZlciA9IHNlcmlhbGl6ZWQKCiAgICAgIC8vIENvbXByZXNzIGlmIGRhdGEgaXMgbGFyZ2UKICAgICAgaWYgKHRoaXMuc2hvdWxkQ29tcHJlc3Moc2VyaWFsaXplZCkpIHsKICAgICAgICBjb25zdCBjb21wcmVzc2VkID0gYXdhaXQgdGhpcy5jb21wcmVzc0RhdGEoc2VyaWFsaXplZCkKICAgICAgICBkYXRhVG9TdG9yZSA9IGNvbXByZXNzZWQudG9TdHJpbmcoImJpbmFyeSIpCiAgICAgIH0KCiAgICAgIGF3YWl0IHJlZGlzLnNldGV4KGtleSwgdHRsLCBkYXRhVG9TdG9yZSkKCiAgICAgIGNvbnN0IHJlc3BvbnNlVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWUKICAgICAgdGhpcy51cGRhdGVTdGF0cyh0cnVlLCByZXNwb25zZVRpbWUpCgogICAgICByZXR1cm4gdHJ1ZQogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgY29uc3QgcmVzcG9uc2VUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZQogICAgICB0aGlzLnVwZGF0ZVN0YXRzKGZhbHNlLCByZXNwb25zZVRpbWUsIHRydWUpCiAgICAgIGNvbnNvbGUuZXJyb3IoYOKdjCBFcnJvIGFvIHNhbHZhciBjYWNoZSBbJHtrZXl9XTpgLCBlcnJvcikKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQoKICBhc3luYyBtZ2V0PFQ+KGtleXM6IHN0cmluZ1tdKTogUHJvbWlzZTwoVCB8IG51bGwpW10+IHsKICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIFtdCgogICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKQoKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuZW5zdXJlQ29ubmVjdGlvbigpCgogICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgcmVkaXMubWdldCguLi5rZXlzKQogICAgICBjb25zdCByZXNwb25zZVRpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lCgogICAgICBjb25zdCBwYXJzZWQgPSBhd2FpdCBQcm9taXNlLmFsbCgKICAgICAgICByZXN1bHRzLm1hcChhc3luYyAocmVzdWx0LCBpbmRleCkgPT4gewogICAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0cyhmYWxzZSwgcmVzcG9uc2VUaW1lIC8ga2V5cy5sZW5ndGgpCiAgICAgICAgICAgIHJldHVybiBudWxsCiAgICAgICAgICB9CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbGV0IGRhdGE6IHN0cmluZwoKICAgICAgICAgICAgaWYgKHJlc3VsdC5zdGFydHNXaXRoKCJceDFmXHg4YiIpKSB7CiAgICAgICAgICAgICAgZGF0YSA9IGF3YWl0IHRoaXMuZGVjb21wcmVzc0RhdGEoQnVmZmVyLmZyb20ocmVzdWx0LCAiYmluYXJ5IikpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGF0YSA9IHJlc3VsdAogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKGRhdGEpCiAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdHModHJ1ZSwgcmVzcG9uc2VUaW1lIC8ga2V5cy5sZW5ndGgpCiAgICAgICAgICAgIHJldHVybiBwYXJzZWQKICAgICAgICAgIH0gY2F0Y2ggKHBhcnNlRXJyb3IpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihg4p2MIEVycm8gYW8gcGFyc2VhciBjYWNoZSBbJHtrZXlzW2luZGV4XX1dOmAsIHBhcnNlRXJyb3IpCiAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdHMoZmFsc2UsIHJlc3BvbnNlVGltZSAvIGtleXMubGVuZ3RoLCB0cnVlKQogICAgICAgICAgICByZXR1cm4gbnVsbAogICAgICAgICAgfQogICAgICAgIH0pLAogICAgICApCgogICAgICByZXR1cm4gcGFyc2VkCiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBjb25zdCByZXNwb25zZVRpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lCiAgICAgIGtleXMuZm9yRWFjaCgoKSA9PiB0aGlzLnVwZGF0ZVN0YXRzKGZhbHNlLCByZXNwb25zZVRpbWUgLyBrZXlzLmxlbmd0aCwgdHJ1ZSkpCiAgICAgIGNvbnNvbGUuZXJyb3IoYOKdjCBFcnJvIGFvIGJ1c2NhciBtw7psdGlwbG9zIGNhY2hlczpgLCBlcnJvcikKICAgICAgcmV0dXJuIGtleXMubWFwKCgpID0+IG51bGwpCiAgICB9CiAgfQoKICBhc3luYyBtc2V0PFQ+KGtleVZhbHVlUGFpcnM6IEFycmF5PHsga2V5OiBzdHJpbmc7IHZhbHVlOiBUOyB0dGw/OiBudW1iZXIgfT4pOiBQcm9taXNlPGJvb2xlYW4+IHsKICAgIGlmIChrZXlWYWx1ZVBhaXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHRydWUKCiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpCgogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5lbnN1cmVDb25uZWN0aW9uKCkKCiAgICAgIGNvbnN0IHBpcGVsaW5lID0gcmVkaXMucGlwZWxpbmUoKQoKICAgICAgZm9yIChjb25zdCB7IGtleSwgdmFsdWUsIHR0bCA9IENBQ0hFX1RUTC5NRURJVU0gfSBvZiBrZXlWYWx1ZVBhaXJzKSB7CiAgICAgICAgY29uc3Qgc2VyaWFsaXplZCA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKQogICAgICAgIGxldCBkYXRhVG9TdG9yZTogc3RyaW5nIHwgQnVmZmVyID0gc2VyaWFsaXplZAoKICAgICAgICBpZiAodGhpcy5zaG91bGRDb21wcmVzcyhzZXJpYWxpemVkKSkgewogICAgICAgICAgY29uc3QgY29tcHJlc3NlZCA9IGF3YWl0IHRoaXMuY29tcHJlc3NEYXRhKHNlcmlhbGl6ZWQpCiAgICAgICAgICBkYXRhVG9TdG9yZSA9IGNvbXByZXNzZWQudG9TdHJpbmcoImJpbmFyeSIpCiAgICAgICAgfQoKICAgICAgICBwaXBlbGluZS5zZXRleChrZXksIHR0bCwgZGF0YVRvU3RvcmUpCiAgICAgIH0KCiAgICAgIGF3YWl0IHBpcGVsaW5lLmV4ZWMoKQoKICAgICAgY29uc3QgcmVzcG9uc2VUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZQogICAgICBrZXlWYWx1ZVBhaXJzLmZvckVhY2goKCkgPT4gdGhpcy51cGRhdGVTdGF0cyh0cnVlLCByZXNwb25zZVRpbWUgLyBrZXlWYWx1ZVBhaXJzLmxlbmd0aCkpCgogICAgICByZXR1cm4gdHJ1ZQogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgY29uc3QgcmVzcG9uc2VUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZQogICAgICBrZXlWYWx1ZVBhaXJzLmZvckVhY2goKCkgPT4gdGhpcy51cGRhdGVTdGF0cyhmYWxzZSwgcmVzcG9uc2VUaW1lIC8ga2V5VmFsdWVQYWlycy5sZW5ndGgsIHRydWUpKQogICAgICBjb25zb2xlLmVycm9yKGDinYwgRXJybyBhbyBzYWx2YXIgbcO6bHRpcGxvcyBjYWNoZXM6YCwgZXJyb3IpCiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0KCiAgYXN5bmMgZGVsKGtleTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7CiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLmVuc3VyZUNvbm5lY3Rpb24oKQogICAgICBhd2FpdCByZWRpcy5kZWwoa2V5KQogICAgICByZXR1cm4gdHJ1ZQogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgY29uc29sZS5lcnJvcihg4p2MIEVycm8gYW8gZGVsZXRhciBjYWNoZSBbJHtrZXl9XTpgLCBlcnJvcikKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQoKICBhc3luYyBkZWxQYXR0ZXJuKHBhdHRlcm46IHN0cmluZyk6IFByb21pc2U8bnVtYmVyPiB7CiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLmVuc3VyZUNvbm5lY3Rpb24oKQoKICAgICAgY29uc3Qga2V5cyA9IGF3YWl0IHJlZGlzLmtleXMocGF0dGVybikKICAgICAgaWYgKGtleXMubGVuZ3RoID09PSAwKSByZXR1cm4gMAoKICAgICAgY29uc3QgcGlwZWxpbmUgPSByZWRpcy5waXBlbGluZSgpCiAgICAgIGtleXMuZm9yRWFjaCgoa2V5KSA9PiBwaXBlbGluZS5kZWwoa2V5KSkKICAgICAgYXdhaXQgcGlwZWxpbmUuZXhlYygpCgogICAgICBjb25zb2xlLmxvZyhg8J+Xke+4jyBEZWxldGFkb3MgJHtrZXlzLmxlbmd0aH0gY2FjaGVzIGNvbSBwYWRyw6NvOiAke3BhdHRlcm59YCkKICAgICAgcmV0dXJuIGtleXMubGVuZ3RoCiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKGDinYwgRXJybyBhbyBkZWxldGFyIGNhY2hlcyBjb20gcGFkcsOjbyBbJHtwYXR0ZXJufV06YCwgZXJyb3IpCiAgICAgIHJldHVybiAwCiAgICB9CiAgfQoKICBhc3luYyBjbGVhcigpOiBQcm9taXNlPGJvb2xlYW4+IHsKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuZW5zdXJlQ29ubmVjdGlvbigpCiAgICAgIGF3YWl0IHJlZGlzLmZsdXNoZGIoKQogICAgICBjb25zb2xlLmxvZygi8J+Xke+4jyBDYWNoZSBSZWRpcyBsaW1wbyBjb21wbGV0YW1lbnRlIikKICAgICAgcmV0dXJuIHRydWUKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIuKdjCBFcnJvIGFvIGxpbXBhciBjYWNoZToiLCBlcnJvcikKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQoKICBhc3luYyB3YXJtdXAod2FybXVwRGF0YTogQXJyYXk8eyBrZXk6IHN0cmluZzsgZmV0Y2hlcjogKCkgPT4gUHJvbWlzZTxhbnk+OyB0dGw/OiBudW1iZXIgfT4pOiBQcm9taXNlPHZvaWQ+IHsKICAgIGNvbnNvbGUubG9nKGDwn5SlIEluaWNpYW5kbyBjYWNoZSB3YXJtaW5nIHBhcmEgJHt3YXJtdXBEYXRhLmxlbmd0aH0gY2hhdmVzLi4uYCkKCiAgICBjb25zdCBwcm9taXNlcyA9IHdhcm11cERhdGEubWFwKGFzeW5jICh7IGtleSwgZmV0Y2hlciwgdHRsID0gQ0FDSEVfVFRMLkxPTkcgfSkgPT4gewogICAgICB0cnkgewogICAgICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgdGhpcy5nZXQoa2V5KQogICAgICAgIGlmIChleGlzdGluZykgcmV0dXJuIC8vIErDoSBleGlzdGUgbm8gY2FjaGUKCiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IGZldGNoZXIoKQogICAgICAgIGF3YWl0IHRoaXMuc2V0KGtleSwgZGF0YSwgdHRsKQogICAgICAgIGNvbnNvbGUubG9nKGDinIUgQ2FjaGUgd2FybWluZzogJHtrZXl9YCkKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGDinYwgRXJybyBubyBjYWNoZSB3YXJtaW5nIFske2tleX1dOmAsIGVycm9yKQogICAgICB9CiAgICB9KQoKICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKQogICAgY29uc29sZS5sb2coIvCflKUgQ2FjaGUgd2FybWluZyBjb25jbHXDrWRvIikKICB9CgogIGdldFN0YXRzKCk6IENhY2hlU3RhdHMgewogICAgcmV0dXJuIHsgLi4udGhpcy5zdGF0cyB9CiAgfQoKICBhc3luYyBnZXRJbmZvKCk6IFByb21pc2U8YW55PiB7CiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLmVuc3VyZUNvbm5lY3Rpb24oKQogICAgICBjb25zdCBpbmZvID0gYXdhaXQgcmVkaXMuaW5mbygpCiAgICAgIGNvbnN0IGRic2l6ZSA9IGF3YWl0IHJlZGlzLmRic2l6ZSgpCgogICAgICByZXR1cm4gewogICAgICAgIGNvbm5lY3RlZDogdGhpcy5pc0Nvbm5lY3RlZCwKICAgICAgICBkYnNpemUsCiAgICAgICAgaW5mbzogaW5mby5zcGxpdCgiXHJcbiIpLnJlZHVjZSgoYWNjOiBhbnksIGxpbmU6IHN0cmluZykgPT4gewogICAgICAgICAgY29uc3QgW2tleSwgdmFsdWVdID0gbGluZS5zcGxpdCgiOiIpCiAgICAgICAgICBpZiAoa2V5ICYmIHZhbHVlKSB7CiAgICAgICAgICAgIGFjY1trZXldID0gdmFsdWUKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBhY2MKICAgICAgICB9LCB7fSksCiAgICAgICAgc3RhdHM6IHRoaXMuZ2V0U3RhdHMoKSwKICAgICAgfQogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgY29uc29sZS5lcnJvcigi4p2MIEVycm8gYW8gb2J0ZXIgaW5mbyBkbyBSZWRpczoiLCBlcnJvcikKICAgICAgcmV0dXJuIHsKICAgICAgICBjb25uZWN0ZWQ6IGZhbHNlLAogICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICJVbmtub3duIGVycm9yIiwKICAgICAgfQogICAgfQogIH0KfQoKZXhwb3J0IGNvbnN0IHJlZGlzQ2FjaGUgPSBuZXcgSW1wcm92ZWRSZWRpc0NhY2hlKCkK"}