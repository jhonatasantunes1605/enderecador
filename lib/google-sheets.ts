{"data":"aW1wb3J0IHsgR29vZ2xlU3ByZWFkc2hlZXQgfSBmcm9tICJnb29nbGUtc3ByZWFkc2hlZXQiCmltcG9ydCB7IEpXVCB9IGZyb20gImdvb2dsZS1hdXRoLWxpYnJhcnkiCmltcG9ydCB7IHJlZGlzQ2FjaGUsIENBQ0hFX0tFWVMsIENBQ0hFX1RUTCB9IGZyb20gIi4vcmVkaXMtY2FjaGUiCmltcG9ydCB7IHBlcmZvcm1hbmNlTW9uaXRvciB9IGZyb20gIi4vcGVyZm9ybWFuY2UtbW9uaXRvciIKCi8vIEZ1bsOnw6NvIG1lbGhvcmFkYSBwYXJhIHByb2Nlc3NhciBhIGNoYXZlIHByaXZhZGEKZnVuY3Rpb24gcHJvY2Vzc1ByaXZhdGVLZXkoa2V5OiBzdHJpbmcpOiBzdHJpbmcgewogIGlmICgha2V5KSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkdPT0dMRV9QUklWQVRFX0tFWSBuw6NvIGVzdMOhIGRlZmluaWRhIikKICB9CgogIC8vIFJlbW92ZSBhc3BhcyBleHRyYXMgc2UgZXhpc3RpcmVtCiAgbGV0IHByb2Nlc3NlZEtleSA9IGtleS50cmltKCkKICBpZiAocHJvY2Vzc2VkS2V5LnN0YXJ0c1dpdGgoJyInKSAmJiBwcm9jZXNzZWRLZXkuZW5kc1dpdGgoJyInKSkgewogICAgcHJvY2Vzc2VkS2V5ID0gcHJvY2Vzc2VkS2V5LnNsaWNlKDEsIC0xKQogIH0KCiAgLy8gU2UgYSBjaGF2ZSBuw6NvIHRlbSBxdWVicmFzIGRlIGxpbmhhLCB2YW1vcyBhZGljaW9uw6EtbGFzCiAgaWYgKCFwcm9jZXNzZWRLZXkuaW5jbHVkZXMoIlxuIikgJiYgIXByb2Nlc3NlZEtleS5pbmNsdWRlcygiXFxuIikpIHsKICAgIGNvbnN0IGJlZ2luTWFya2VyID0gIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLSIKICAgIGNvbnN0IGVuZE1hcmtlciA9ICItLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tIgoKICAgIGlmIChwcm9jZXNzZWRLZXkuaW5jbHVkZXMoYmVnaW5NYXJrZXIpICYmIHByb2Nlc3NlZEtleS5pbmNsdWRlcyhlbmRNYXJrZXIpKSB7CiAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBwcm9jZXNzZWRLZXkuaW5kZXhPZihiZWdpbk1hcmtlcikgKyBiZWdpbk1hcmtlci5sZW5ndGgKICAgICAgY29uc3QgZW5kSW5kZXggPSBwcm9jZXNzZWRLZXkuaW5kZXhPZihlbmRNYXJrZXIpCiAgICAgIGNvbnN0IGNvbnRlbnQgPSBwcm9jZXNzZWRLZXkuc3Vic3RyaW5nKHN0YXJ0SW5kZXgsIGVuZEluZGV4KQoKICAgICAgY29uc3QgbGluZXMgPSBbXQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbnRlbnQubGVuZ3RoOyBpICs9IDY0KSB7CiAgICAgICAgbGluZXMucHVzaChjb250ZW50LnN1YnN0cmluZyhpLCBpICsgNjQpKQogICAgICB9CgogICAgICBwcm9jZXNzZWRLZXkgPSBiZWdpbk1hcmtlciArICJcbiIgKyBsaW5lcy5qb2luKCJcbiIpICsgIlxuIiArIGVuZE1hcmtlcgogICAgfQogIH0gZWxzZSB7CiAgICAvLyBDb252ZXJ0ZXIgXG4gZW0gcXVlYnJhcyBkZSBsaW5oYSByZWFpcwogICAgcHJvY2Vzc2VkS2V5ID0gcHJvY2Vzc2VkS2V5LnJlcGxhY2UoL1xcbi9nLCAiXG4iKQogIH0KCiAgLy8gVmFsaWRhciBmb3JtYXRvIGZpbmFsCiAgaWYgKCFwcm9jZXNzZWRLZXkuaW5jbHVkZXMoIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLSIpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkZvcm1hdG8gZGEgY2hhdmUgcHJpdmFkYSBpbnbDoWxpZG86IG1hcmNhZG9yIEJFR0lOIG7Do28gZW5jb250cmFkbyIpCiAgfQoKICBpZiAoIXByb2Nlc3NlZEtleS5pbmNsdWRlcygiLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLSIpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkZvcm1hdG8gZGEgY2hhdmUgcHJpdmFkYSBpbnbDoWxpZG86IG1hcmNhZG9yIEVORCBuw6NvIGVuY29udHJhZG8iKQogIH0KCiAgcmV0dXJuIHByb2Nlc3NlZEtleQp9CgovLyBDb25maWd1cmHDp8OjbyBkbyBjbGllbnRlIEpXVCBwYXJhIGF1dGVudGljYcOnw6NvCmxldCBzZXJ2aWNlQWNjb3VudEF1dGg6IEpXVAoKdHJ5IHsKICBjb25zdCBwcml2YXRlS2V5ID0gcHJvY2Vzc1ByaXZhdGVLZXkocHJvY2Vzcy5lbnYuR09PR0xFX1BSSVZBVEVfS0VZIHx8ICIiKQoKICBzZXJ2aWNlQWNjb3VudEF1dGggPSBuZXcgSldUKHsKICAgIGVtYWlsOiBwcm9jZXNzLmVudi5HT09HTEVfU0VSVklDRV9BQ0NPVU5UX0VNQUlMLAogICAga2V5OiBwcml2YXRlS2V5LAogICAgc2NvcGVzOiBbImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2F1dGgvc3ByZWFkc2hlZXRzIiwgImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2F1dGgvZHJpdmUuZmlsZSJdLAogIH0pCn0gY2F0Y2ggKGVycm9yKSB7CiAgY29uc29sZS5lcnJvcigiRXJybyBhbyBjb25maWd1cmFyIGF1dGVudGljYcOnw6NvIEdvb2dsZToiLCBlcnJvcikKICB0aHJvdyBlcnJvcgp9CgovLyBJbnN0w6JuY2lhIGRvIGRvY3VtZW50byBHb29nbGUgU2hlZXRzCmNvbnN0IGRvYyA9IG5ldyBHb29nbGVTcHJlYWRzaGVldChwcm9jZXNzLmVudi5HT09HTEVfU0hFRVRfSUQhLCBzZXJ2aWNlQWNjb3VudEF1dGgpCgovLyBJbnRlcmZhY2VzIHBhcmEgb3MgZGFkb3MKZXhwb3J0IGludGVyZmFjZSBXYXJlaG91c2VSb3cgewogIGlkOiBzdHJpbmcKICBuYW1lOiBzdHJpbmcKICBjcmVhdGVkQXQ6IHN0cmluZwp9CgpleHBvcnQgaW50ZXJmYWNlIEFpc2xlUm93IHsKICBpZDogc3RyaW5nCiAgd2FyZWhvdXNlSWQ6IHN0cmluZwogIG5hbWU6IHN0cmluZwogIG5vdGVzOiBzdHJpbmcKICBjYXBhY2l0eTogc3RyaW5nCiAgc3RvcmFnZVR5cGU6IHN0cmluZyAvLyAncGFsbGV0JyBvdSAnc2hlbGYnCiAgc2hlbGZMZXZlbHM6IHN0cmluZyAvLyBuw7ptZXJvIGRlIGFuZGFyZXMgc2UgZm9yIHByYXRlbGVpcmEKICBjcmVhdGVkQXQ6IHN0cmluZwp9CgpleHBvcnQgaW50ZXJmYWNlIFBhbGxldFJvdyB7CiAgaWQ6IHN0cmluZwogIGFpc2xlSWQ6IHN0cmluZwogIHBvc2l0aW9uOiBzdHJpbmcKICBlYW46IHN0cmluZyAvLyBJRCBkbyBwcm9kdXRvIChjb2x1bmEgRSBkYSBwbGFuaWxoYSBkZSBwcm9kdXRvcykKICBwcm9kdWN0TmFtZTogc3RyaW5nCiAgY2F0ZWdvcnk6IHN0cmluZwogIGVhbjEzOiBzdHJpbmcgLy8gRUFOIHJlYWwgZG8gcHJvZHV0byAoY29sdW5hIEEgZGEgcGxhbmlsaGEgZGUgcHJvZHV0b3MpCiAgbGFzdFZlcmlmaWVkOiBzdHJpbmcKICBjcmVhdGVkQXQ6IHN0cmluZwp9CgpleHBvcnQgaW50ZXJmYWNlIFNoZWxmUm93IHsKICBpZDogc3RyaW5nCiAgYWlzbGVJZDogc3RyaW5nCiAgcG9zaXRpb246IHN0cmluZwogIGxldmVsOiBzdHJpbmcgLy8gYW5kYXIgZGEgcHJhdGVsZWlyYSAoMSwgMiwgMywgZXRjLikKICBlYW46IHN0cmluZyAvLyBJRCBkbyBwcm9kdXRvIChjb2x1bmEgRSBkYSBwbGFuaWxoYSBkZSBwcm9kdXRvcykKICBwcm9kdWN0TmFtZTogc3RyaW5nCiAgY2F0ZWdvcnk6IHN0cmluZwogIGVhbjEzOiBzdHJpbmcgLy8gRUFOIHJlYWwgZG8gcHJvZHV0byAoY29sdW5hIEEgZGEgcGxhbmlsaGEgZGUgcHJvZHV0b3MpCiAgb2NjdXBhbmN5UGVyY2VudGFnZTogc3RyaW5nIC8vIHBvcmNlbnRhZ2VtIGRlIG9jdXBhw6fDo28gKDAtMTAwKQogIGxhc3RWZXJpZmllZDogc3RyaW5nCiAgY3JlYXRlZEF0OiBzdHJpbmcKfQoKLy8gTm92YSBpbnRlcmZhY2UgcGFyYSByZXNzdXByaW1lbnRvCmV4cG9ydCBpbnRlcmZhY2UgUmVzdXBwbHlSb3cgewogIGlkOiBzdHJpbmcKICBwcm9kdWN0SWQ6IHN0cmluZwogIHByb2R1Y3ROYW1lOiBzdHJpbmcKICBlYW4xMzogc3RyaW5nCiAgY2F0ZWdvcnk6IHN0cmluZwogIGxvY2F0aW9uSWQ6IHN0cmluZwogIGxvY2F0aW9uVHlwZTogc3RyaW5nIC8vICdwYWxsZXQnIG91ICdzaGVsZicKICBhZGRyZXNzOiBzdHJpbmcKICB3YXJlaG91c2VJZDogc3RyaW5nCiAgd2FyZWhvdXNlTmFtZTogc3RyaW5nCiAgYWlzbGVJZDogc3RyaW5nCiAgYWlzbGVOYW1lOiBzdHJpbmcKICBwb3NpdGlvbjogc3RyaW5nCiAgbGV2ZWw6IHN0cmluZwogIHN0YXR1czogc3RyaW5nIC8vICdwZW5kaW5nJywgJ2luX3Byb2dyZXNzJywgJ2NvbXBsZXRlZCcsICdvdXRfb2Zfc3RvY2snCiAgcHJpb3JpdHk6IHN0cmluZyAvLyAnaGlnaCcsICdtZWRpdW0nLCAnbG93JwogIG5vdGVzOiBzdHJpbmcKICBub3RpZmllZEF0OiBzdHJpbmcKICBjb21wbGV0ZWRBdDogc3RyaW5nCiAgY3JlYXRlZEF0OiBzdHJpbmcKfQoKLy8gTm92YSBpbnRlcmZhY2UgcGFyYSByZWNlYmltZW50bwpleHBvcnQgaW50ZXJmYWNlIFJlY2VpdmluZ1JvdyB7CiAgaWQ6IHN0cmluZwogIG5mOiBzdHJpbmcKICBzdXBwbGllcjogc3RyaW5nCiAgcGFsbGV0Q291bnQ6IHN0cmluZwogIGFkZHJlc3M6IHN0cmluZwogIHNjaGVkdWxlZERhdGU6IHN0cmluZwogIHN0YXR1czogc3RyaW5nCiAgcmVjZWl2ZWRBdDogc3RyaW5nCiAgY3JlYXRlZEF0OiBzdHJpbmcKfQoKZnVuY3Rpb24gbm9ybWFsaXplRUFOcyhlYW5TdHJpbmc6IHN0cmluZyk6IHN0cmluZ1tdIHsKICBpZiAoIWVhblN0cmluZyB8fCBlYW5TdHJpbmcudHJpbSgpID09PSAiIikgcmV0dXJuIFtdCgogIHJldHVybiBlYW5TdHJpbmcKICAgIC5zcGxpdCgiOyIpIC8vIENoYW5nZWQgZnJvbSBjb21tYSB0byBzZW1pY29sb24KICAgIC5tYXAoKGVhbikgPT4gZWFuLnRyaW0oKS50b0xvd2VyQ2FzZSgpKSAvLyBBZGljaW9uYXIgdG9Mb3dlckNhc2UgcGFyYSBjb25zaXN0w6puY2lhCiAgICAuZmlsdGVyKChlYW4pID0+IGVhbi5sZW5ndGggPiAwKQp9CgpmdW5jdGlvbiBjb250YWluc0VBTihlYW5TdHJpbmc6IHN0cmluZywgc2VhcmNoRUFOOiBzdHJpbmcpOiBib29sZWFuIHsKICBpZiAoIWVhblN0cmluZyB8fCAhc2VhcmNoRUFOKSByZXR1cm4gZmFsc2UKCiAgY29uc3Qgbm9ybWFsaXplZEVBTnMgPSBub3JtYWxpemVFQU5zKGVhblN0cmluZykKICBjb25zdCBub3JtYWxpemVkU2VhcmNoRUFOID0gc2VhcmNoRUFOLnRyaW0oKS50b0xvd2VyQ2FzZSgpCgogIHJldHVybiBub3JtYWxpemVkRUFOcy5zb21lKChlYW4pID0+IGVhbiA9PT0gbm9ybWFsaXplZFNlYXJjaEVBTikgLy8gVXNhciBjb21wYXJhw6fDo28gZXhhdGEgYW8gaW52w6lzIGRlIGluY2x1ZGVzCn0KCmNsYXNzIEdvb2dsZVNoZWV0c1NlcnZpY2UgewogIHByaXZhdGUgaW5pdGlhbGl6ZWQgPSBmYWxzZQogIHByaXZhdGUgaW5pdFByb21pc2U6IFByb21pc2U8dm9pZD4gfCBudWxsID0gbnVsbAoKICBnZXQgZG9jKCkgewogICAgcmV0dXJuIGRvYwogIH0KCiAgYXN5bmMgaW5pdCgpIHsKICAgIGlmICh0aGlzLmluaXRpYWxpemVkKSByZXR1cm4KICAgIGlmICh0aGlzLmluaXRQcm9taXNlKSByZXR1cm4gdGhpcy5pbml0UHJvbWlzZQoKICAgIHRoaXMuaW5pdFByb21pc2UgPSB0aGlzLl9pbml0KCkKICAgIHJldHVybiB0aGlzLmluaXRQcm9taXNlCiAgfQoKICBwcml2YXRlIGFzeW5jIF9pbml0KCkgewogICAgdHJ5IHsKICAgICAgYXdhaXQgZG9jLmxvYWRJbmZvKCkKCiAgICAgIC8vIENyaWFyIGFzIGFiYXMgc2UgbsOjbyBleGlzdGlyZW0KICAgICAgYXdhaXQgdGhpcy5lbnN1cmVTaGVldEV4aXN0cygid2FyZWhvdXNlcyIsIFsiaWQiLCAibmFtZSIsICJjcmVhdGVkQXQiXSkKICAgICAgYXdhaXQgdGhpcy5lbnN1cmVTaGVldEV4aXN0cygiYWlzbGVzIiwgWwogICAgICAgICJpZCIsCiAgICAgICAgIndhcmVob3VzZUlkIiwKICAgICAgICAibmFtZSIsCiAgICAgICAgIm5vdGVzIiwKICAgICAgICAiY2FwYWNpdHkiLAogICAgICAgICJzdG9yYWdlVHlwZSIsCiAgICAgICAgInNoZWxmTGV2ZWxzIiwKICAgICAgICAiY3JlYXRlZEF0IiwKICAgICAgXSkKICAgICAgYXdhaXQgdGhpcy5lbnN1cmVTaGVldEV4aXN0cygicGFsbGV0cyIsIFsKICAgICAgICAiaWQiLAogICAgICAgICJhaXNsZUlkIiwKICAgICAgICAicG9zaXRpb24iLAogICAgICAgICJlYW4iLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgICAgInByb2R1Y3ROYW1lIiwKICAgICAgICAiY2F0ZWdvcnkiLAogICAgICAgICJlYW4xMyIsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgICAgICAibGFzdFZlcmlmaWVkIiwKICAgICAgICAiY3JlYXRlZEF0IiwKICAgICAgXSkKICAgICAgYXdhaXQgdGhpcy5lbnN1cmVTaGVldEV4aXN0cygic2hlbHZlcyIsIFsKICAgICAgICAiaWQiLAogICAgICAgICJhaXNsZUlkIiwKICAgICAgICAicG9zaXRpb24iLAogICAgICAgICJsZXZlbCIsCiAgICAgICAgImVhbiIsIC8vIElEIGRvIHByb2R1dG8KICAgICAgICAicHJvZHVjdE5hbWUiLAogICAgICAgICJjYXRlZ29yeSIsCiAgICAgICAgImVhbjEzIiwgLy8gRUFOIHJlYWwgZG8gcHJvZHV0bwogICAgICAgICJvY2N1cGFuY3lQZXJjZW50YWdlIiwKICAgICAgICAibGFzdFZlcmlmaWVkIiwKICAgICAgICAiY3JlYXRlZEF0IiwKICAgICAgXSkKICAgICAgLy8gTm92YSBhYmEgcGFyYSByZXNzdXByaW1lbnRvCiAgICAgIGF3YWl0IHRoaXMuZW5zdXJlU2hlZXRFeGlzdHMoInJlc3VwcGx5IiwgWwogICAgICAgICJpZCIsCiAgICAgICAgInByb2R1Y3RJZCIsCiAgICAgICAgInByb2R1Y3ROYW1lIiwKICAgICAgICAiZWFuMTMiLAogICAgICAgICJjYXRlZ29yeSIsCiAgICAgICAgImxvY2F0aW9uSWQiLAogICAgICAgICJsb2NhdGlvblR5cGUiLAogICAgICAgICJhZGRyZXNzIiwKICAgICAgICAid2FyZWhvdXNlSWQiLAogICAgICAgICJ3YXJlaG91c2VOYW1lIiwKICAgICAgICAiYWlzbGVJZCIsCiAgICAgICAgImFpc2xlTmFtZSIsCiAgICAgICAgInBvc2l0aW9uIiwKICAgICAgICAibGV2ZWwiLAogICAgICAgICJzdGF0dXMiLAogICAgICAgICJwcmlvcml0eSIsCiAgICAgICAgIm5vdGVzIiwKICAgICAgICAibm90aWZpZWRBdCIsCiAgICAgICAgImNvbXBsZXRlZEF0IiwKICAgICAgICAiY3JlYXRlZEF0IiwKICAgICAgXSkKICAgICAgYXdhaXQgdGhpcy5lbnN1cmVTaGVldEV4aXN0cygicmVjZWl2aW5nIiwgWwogICAgICAgICJpZCIsCiAgICAgICAgIm5mIiwKICAgICAgICAic3VwcGxpZXIiLAogICAgICAgICJwYWxsZXRDb3VudCIsCiAgICAgICAgImFkZHJlc3MiLAogICAgICAgICJzY2hlZHVsZWREYXRlIiwKICAgICAgICAic3RhdHVzIiwKICAgICAgICAicmVjZWl2ZWRBdCIsCiAgICAgICAgImNyZWF0ZWRBdCIsCiAgICAgIF0pCgogICAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZQogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBpbmljaWFsaXphciBHb29nbGUgU2hlZXRzOiIsIGVycm9yKQogICAgICB0aGlzLmluaXRQcm9taXNlID0gbnVsbAogICAgICB0aHJvdyBlcnJvcgogICAgfQogIH0KCiAgcHJpdmF0ZSBhc3luYyBlbnN1cmVTaGVldEV4aXN0cyh0aXRsZTogc3RyaW5nLCBoZWFkZXJzOiBzdHJpbmdbXSkgewogICAgdHJ5IHsKICAgICAgbGV0IHNoZWV0ID0gZG9jLnNoZWV0c0J5VGl0bGVbdGl0bGVdCgogICAgICBpZiAoIXNoZWV0KSB7CiAgICAgICAgc2hlZXQgPSBhd2FpdCBkb2MuYWRkU2hlZXQoewogICAgICAgICAgdGl0bGUsCiAgICAgICAgICBoZWFkZXJWYWx1ZXM6IGhlYWRlcnMsCiAgICAgICAgICBncmlkUHJvcGVydGllczogewogICAgICAgICAgICByb3dDb3VudDogMTAwMCwKICAgICAgICAgICAgY29sdW1uQ291bnQ6IGhlYWRlcnMubGVuZ3RoLAogICAgICAgICAgfSwKICAgICAgICB9KQogICAgICB9IGVsc2UgewogICAgICAgIGF3YWl0IHNoZWV0LmxvYWRIZWFkZXJSb3coKQogICAgICAgIGlmIChzaGVldC5oZWFkZXJWYWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICBhd2FpdCBzaGVldC5zZXRIZWFkZXJSb3coaGVhZGVycykKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgbWlzc2luZ0hlYWRlcnMgPSBoZWFkZXJzLmZpbHRlcigoaGVhZGVyKSA9PiAhc2hlZXQuaGVhZGVyVmFsdWVzLmluY2x1ZGVzKGhlYWRlcikpCiAgICAgICAgICBpZiAobWlzc2luZ0hlYWRlcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBhd2FpdCBzaGVldC5zZXRIZWFkZXJSb3coaGVhZGVycykKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBzaGVldAogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgY29uc29sZS5lcnJvcihgRXJybyBhbyBjcmlhci92ZXJpZmljYXIgYWJhICR7dGl0bGV9OmAsIGVycm9yKQogICAgICB0aHJvdyBlcnJvcgogICAgfQogIH0KCiAgLy8gV0FSRUhPVVNFUwogIGFzeW5jIGdldFdhcmVob3VzZXMoKTogUHJvbWlzZTxXYXJlaG91c2VSb3dbXT4gewogICAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbigiZ2V0V2FyZWhvdXNlcyIsIGFzeW5jICgpID0+IHsKICAgICAgY29uc3QgY2FjaGVLZXkgPSBDQUNIRV9LRVlTLldBUkVIT1VTRVMKCiAgICAgIC8vIFRlbnRhciBidXNjYXIgZG8gY2FjaGUgcHJpbWVpcm8KICAgICAgY29uc3QgY2FjaGVkID0gYXdhaXQgcmVkaXNDYWNoZS5nZXQ8V2FyZWhvdXNlUm93W10+KGNhY2hlS2V5KQogICAgICBpZiAoY2FjaGVkKSB7CiAgICAgICAgcGVyZm9ybWFuY2VNb25pdG9yLnJlY29yZENhY2hlSGl0KCkKICAgICAgICByZXR1cm4gY2FjaGVkCiAgICAgIH0KCiAgICAgIHBlcmZvcm1hbmNlTW9uaXRvci5yZWNvcmRDYWNoZU1pc3MoKQogICAgICBjb25zb2xlLmxvZygiW1NIRUVUU10gQnVzY2FuZG8gd2FyZWhvdXNlcyBkYSBwbGFuaWxoYS4uLiIpCgogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsid2FyZWhvdXNlcyJdCgogICAgICAgIGlmICghc2hlZXQpIHsKICAgICAgICAgIHJldHVybiBbXQogICAgICAgIH0KCiAgICAgICAgY29uc3Qgcm93cyA9IGF3YWl0IHNoZWV0LmdldFJvd3MoKQogICAgICAgIGNvbnN0IHdhcmVob3VzZXMgPSByb3dzLm1hcCgocm93KSA9PiAoewogICAgICAgICAgaWQ6IHJvdy5nZXQoImlkIikgfHwgIiIsCiAgICAgICAgICBuYW1lOiByb3cuZ2V0KCJuYW1lIikgfHwgIiIsCiAgICAgICAgICBjcmVhdGVkQXQ6IHJvdy5nZXQoImNyZWF0ZWRBdCIpIHx8ICIiLAogICAgICAgIH0pKQoKICAgICAgICAvLyBTYWx2YXIgbm8gY2FjaGUKICAgICAgICBhd2FpdCByZWRpc0NhY2hlLnNldChjYWNoZUtleSwgd2FyZWhvdXNlcywgQ0FDSEVfVFRMLkxPTkcpCgogICAgICAgIGNvbnNvbGUubG9nKGBbU0hFRVRTXSDinIUgJHt3YXJlaG91c2VzLmxlbmd0aH0gd2FyZWhvdXNlcyBjYXJyZWdhZG9zYCkKICAgICAgICByZXR1cm4gd2FyZWhvdXNlcwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIltTSEVFVFNdIEVycm8gYW8gYnVzY2FyIHdhcmVob3VzZXM6IiwgZXJyb3IpCiAgICAgICAgdGhyb3cgZXJyb3IKICAgICAgfQogICAgfSkKICB9CgogIGFzeW5jIGFkZFdhcmVob3VzZSh3YXJlaG91c2U6IE9taXQ8V2FyZWhvdXNlUm93LCAiY3JlYXRlZEF0Ij4pOiBQcm9taXNlPFdhcmVob3VzZVJvdz4gewogICAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbigiYWRkV2FyZWhvdXNlIiwgYXN5bmMgKCkgPT4gewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsid2FyZWhvdXNlcyJdCgogICAgICAgIGNvbnN0IG5ld1dhcmVob3VzZTogV2FyZWhvdXNlUm93ID0gewogICAgICAgICAgLi4ud2FyZWhvdXNlLAogICAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICAgICAgfQoKICAgICAgICBjb25zdCBhZGRlZFJvdyA9IGF3YWl0IHNoZWV0LmFkZFJvdyhuZXdXYXJlaG91c2UpCiAgICAgICAgYXdhaXQgYWRkZWRSb3cuc2F2ZSgpCgogICAgICAgIC8vIEludmFsaWRhciBjYWNoZQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuV0FSRUhPVVNFUykKICAgICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbChDQUNIRV9LRVlTLldBUkVIT1VTRSh3YXJlaG91c2UuaWQpKQoKICAgICAgICByZXR1cm4gbmV3V2FyZWhvdXNlCiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBhZGljaW9uYXIgZ2FscMOjbzoiLCBlcnJvcikKICAgICAgICB0aHJvdyBlcnJvcgogICAgICB9CiAgICB9KQogIH0KCiAgYXN5bmMgZGVsZXRlV2FyZWhvdXNlKGlkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHsKICAgIHJldHVybiBwZXJmb3JtYW5jZU1vbml0b3IudHJhY2tPcGVyYXRpb24oImRlbGV0ZVdhcmVob3VzZSIsIGFzeW5jICgpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLmluaXQoKQogICAgICAgIGNvbnN0IHNoZWV0ID0gZG9jLnNoZWV0c0J5VGl0bGVbIndhcmVob3VzZXMiXQogICAgICAgIGNvbnN0IHJvd3MgPSBhd2FpdCBzaGVldC5nZXRSb3dzKCkKCiAgICAgICAgY29uc3Qgcm93VG9EZWxldGUgPSByb3dzLmZpbmQoKHJvdykgPT4gcm93LmdldCgiaWQiKSA9PT0gaWQpCiAgICAgICAgaWYgKHJvd1RvRGVsZXRlKSB7CiAgICAgICAgICBhd2FpdCByb3dUb0RlbGV0ZS5kZWxldGUoKQoKICAgICAgICAgIC8vIEludmFsaWRhciBjYWNoZQogICAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5XQVJFSE9VU0VTKQogICAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWxQYXR0ZXJuKENBQ0hFX0tFWVMuUEFUVEVSTlMuV0FSRUhPVVNFKGlkKSkKCiAgICAgICAgICByZXR1cm4gdHJ1ZQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGRlbGV0YXIgd2FyZWhvdXNlOiIsIGVycm9yKQogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9CiAgICB9KQogIH0KCiAgLy8gQUlTTEVTCiAgYXN5bmMgZ2V0QWlzbGVzQnlXYXJlaG91c2Uod2FyZWhvdXNlSWQ6IHN0cmluZyk6IFByb21pc2U8QWlzbGVSb3dbXT4gewogICAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbigiZ2V0QWlzbGVzQnlXYXJlaG91c2UiLCBhc3luYyAoKSA9PiB7CiAgICAgIGNvbnN0IGNhY2hlS2V5ID0gQ0FDSEVfS0VZUy5BSVNMRVNfQllfV0FSRUhPVVNFKHdhcmVob3VzZUlkKQoKICAgICAgLy8gVGVudGFyIGJ1c2NhciBkbyBjYWNoZSBwcmltZWlybwogICAgICBjb25zdCBjYWNoZWQgPSBhd2FpdCByZWRpc0NhY2hlLmdldDxBaXNsZVJvd1tdPihjYWNoZUtleSkKICAgICAgaWYgKGNhY2hlZCkgewogICAgICAgIHBlcmZvcm1hbmNlTW9uaXRvci5yZWNvcmRDYWNoZUhpdCgpCiAgICAgICAgcmV0dXJuIGNhY2hlZAogICAgICB9CgogICAgICBwZXJmb3JtYW5jZU1vbml0b3IucmVjb3JkQ2FjaGVNaXNzKCkKICAgICAgY29uc29sZS5sb2coYFtTSEVFVFNdIEJ1c2NhbmRvIGFpc2xlcyBkbyB3YXJlaG91c2UgJHt3YXJlaG91c2VJZH0uLi5gKQoKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLmluaXQoKQogICAgICAgIGNvbnN0IHNoZWV0ID0gZG9jLnNoZWV0c0J5VGl0bGVbImFpc2xlcyJdCgogICAgICAgIGlmICghc2hlZXQpIHsKICAgICAgICAgIHJldHVybiBbXQogICAgICAgIH0KCiAgICAgICAgY29uc3Qgcm93cyA9IGF3YWl0IHNoZWV0LmdldFJvd3MoKQogICAgICAgIGNvbnN0IGZpbHRlcmVkUm93cyA9IHdhcmVob3VzZUlkID8gcm93cy5maWx0ZXIoKHJvdykgPT4gcm93LmdldCgid2FyZWhvdXNlSWQiKSA9PT0gd2FyZWhvdXNlSWQpIDogcm93cwoKICAgICAgICBjb25zdCBhaXNsZXMgPSBmaWx0ZXJlZFJvd3MubWFwKChyb3cpID0+ICh7CiAgICAgICAgICBpZDogcm93LmdldCgiaWQiKSB8fCAiIiwKICAgICAgICAgIHdhcmVob3VzZUlkOiByb3cuZ2V0KCJ3YXJlaG91c2VJZCIpIHx8ICIiLAogICAgICAgICAgbmFtZTogcm93LmdldCgibmFtZSIpIHx8ICIiLAogICAgICAgICAgbm90ZXM6IHJvdy5nZXQoIm5vdGVzIikgfHwgIiIsCiAgICAgICAgICBjYXBhY2l0eTogcm93LmdldCgiY2FwYWNpdHkiKSB8fCAiMCIsCiAgICAgICAgICBzdG9yYWdlVHlwZTogcm93LmdldCgic3RvcmFnZVR5cGUiKSB8fCAicGFsbGV0IiwKICAgICAgICAgIHNoZWxmTGV2ZWxzOiByb3cuZ2V0KCJzaGVsZkxldmVscyIpIHx8ICIxIiwKICAgICAgICAgIGNyZWF0ZWRBdDogcm93LmdldCgiY3JlYXRlZEF0IikgfHwgIiIsCiAgICAgICAgfSkpCgogICAgICAgIC8vIFNhbHZhciBubyBjYWNoZQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuc2V0KGNhY2hlS2V5LCBhaXNsZXMsIENBQ0hFX1RUTC5NRURJVU0pCgogICAgICAgIC8vIENhY2hlIGluZGl2aWR1YWwgcGFyYSBjYWRhIGFpc2xlCiAgICAgICAgY29uc3QgY2FjaGVQcm9taXNlcyA9IGFpc2xlcy5tYXAoKGFpc2xlKSA9PiByZWRpc0NhY2hlLnNldChDQUNIRV9LRVlTLkFJU0xFKGFpc2xlLmlkKSwgYWlzbGUsIENBQ0hFX1RUTC5NRURJVU0pKQogICAgICAgIGF3YWl0IFByb21pc2UuYWxsKGNhY2hlUHJvbWlzZXMpCgogICAgICAgIGNvbnNvbGUubG9nKGBbU0hFRVRTXSDinIUgJHthaXNsZXMubGVuZ3RofSBhaXNsZXMgY2FycmVnYWRvc2ApCiAgICAgICAgcmV0dXJuIGFpc2xlcwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYnVzY2FyIGFpc2xlczoiLCBlcnJvcikKICAgICAgICByZXR1cm4gW10KICAgICAgfQogICAgfSkKICB9CgogIGFzeW5jIGdldEFpc2xlQnlJZChpZDogc3RyaW5nKTogUHJvbWlzZTxBaXNsZVJvdyB8IG51bGw+IHsKICAgIHJldHVybiBwZXJmb3JtYW5jZU1vbml0b3IudHJhY2tPcGVyYXRpb24oImdldEFpc2xlQnlJZCIsIGFzeW5jICgpID0+IHsKICAgICAgY29uc3QgY2FjaGVLZXkgPSBDQUNIRV9LRVlTLkFJU0xFKGlkKQoKICAgICAgLy8gVGVudGFyIGJ1c2NhciBkbyBjYWNoZSBwcmltZWlybwogICAgICBjb25zdCBjYWNoZWQgPSBhd2FpdCByZWRpc0NhY2hlLmdldDxBaXNsZVJvdz4oY2FjaGVLZXkpCiAgICAgIGlmIChjYWNoZWQpIHsKICAgICAgICBwZXJmb3JtYW5jZU1vbml0b3IucmVjb3JkQ2FjaGVIaXQoKQogICAgICAgIHJldHVybiBjYWNoZWQKICAgICAgfQoKICAgICAgcGVyZm9ybWFuY2VNb25pdG9yLnJlY29yZENhY2hlTWlzcygpCiAgICAgIGNvbnNvbGUubG9nKGBbU0hFRVRTXSBCdXNjYW5kbyBhaXNsZSAke2lkfS4uLmApCgogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsiYWlzbGVzIl0KICAgICAgICBjb25zdCByb3dzID0gYXdhaXQgc2hlZXQuZ2V0Um93cygpCgogICAgICAgIGNvbnN0IHJvdyA9IHJvd3MuZmluZCgocm93KSA9PiByb3cuZ2V0KCJpZCIpID09PSBpZCkKICAgICAgICBpZiAoIXJvdykgewogICAgICAgICAgcmV0dXJuIG51bGwKICAgICAgICB9CgogICAgICAgIGNvbnN0IGFpc2xlID0gewogICAgICAgICAgaWQ6IHJvdy5nZXQoImlkIikgfHwgIiIsCiAgICAgICAgICB3YXJlaG91c2VJZDogcm93LmdldCgid2FyZWhvdXNlSWQiKSB8fCAiIiwKICAgICAgICAgIG5hbWU6IHJvdy5nZXQoIm5hbWUiKSB8fCAiIiwKICAgICAgICAgIG5vdGVzOiByb3cuZ2V0KCJub3RlcyIpIHx8ICIiLAogICAgICAgICAgY2FwYWNpdHk6IHJvdy5nZXQoImNhcGFjaXR5IikgfHwgIjAiLAogICAgICAgICAgc3RvcmFnZVR5cGU6IHJvdy5nZXQoInN0b3JhZ2VUeXBlIikgfHwgInBhbGxldCIsCiAgICAgICAgICBzaGVsZkxldmVsczogcm93LmdldCgic2hlbGZMZXZlbHMiKSB8fCAiMSIsCiAgICAgICAgICBjcmVhdGVkQXQ6IHJvdy5nZXQoImNyZWF0ZWRBdCIpIHx8ICIiLAogICAgICAgIH0KCiAgICAgICAgLy8gU2FsdmFyIG5vIGNhY2hlCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5zZXQoY2FjaGVLZXksIGFpc2xlLCBDQUNIRV9UVEwuTUVESVVNKQoKICAgICAgICByZXR1cm4gYWlzbGUKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGJ1c2NhciBhaXNsZSBwb3IgSUQ6IiwgZXJyb3IpCiAgICAgICAgcmV0dXJuIG51bGwKICAgICAgfQogICAgfSkKICB9CgogIGFzeW5jIGFkZEFpc2xlKGFpc2xlOiBPbWl0PEFpc2xlUm93LCAiY3JlYXRlZEF0Ij4pOiBQcm9taXNlPEFpc2xlUm93PiB7CiAgICByZXR1cm4gcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKCJhZGRBaXNsZSIsIGFzeW5jICgpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLmluaXQoKQogICAgICAgIGNvbnN0IHNoZWV0ID0gZG9jLnNoZWV0c0J5VGl0bGVbImFpc2xlcyJdCgogICAgICAgIGlmICghYWlzbGUuaWQgfHwgIWFpc2xlLndhcmVob3VzZUlkIHx8ICFhaXNsZS5uYW1lKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkRhZG9zIGluY29tcGxldG9zIHBhcmEgY3JpYXIgcnVhIikKICAgICAgICB9CgogICAgICAgIGNvbnN0IG5ld0Fpc2xlOiBBaXNsZVJvdyA9IHsKICAgICAgICAgIGlkOiBhaXNsZS5pZCwKICAgICAgICAgIHdhcmVob3VzZUlkOiBhaXNsZS53YXJlaG91c2VJZCwKICAgICAgICAgIG5hbWU6IGFpc2xlLm5hbWUsCiAgICAgICAgICBub3RlczogYWlzbGUubm90ZXMgfHwgIiIsCiAgICAgICAgICBjYXBhY2l0eTogYWlzbGUuY2FwYWNpdHkgfHwgIjAiLAogICAgICAgICAgc3RvcmFnZVR5cGU6IGFpc2xlLnN0b3JhZ2VUeXBlIHx8ICJwYWxsZXQiLAogICAgICAgICAgc2hlbGZMZXZlbHM6IGFpc2xlLnNoZWxmTGV2ZWxzIHx8ICIxIiwKICAgICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLAogICAgICAgIH0KCiAgICAgICAgY29uc3QgYWRkZWRSb3cgPSBhd2FpdCBzaGVldC5hZGRSb3cobmV3QWlzbGUpCiAgICAgICAgYXdhaXQgYWRkZWRSb3cuc2F2ZSgpCgogICAgICAgIC8vIEludmFsaWRhciBjYWNoZQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuQUlTTEVTX0JZX1dBUkVIT1VTRShhaXNsZS53YXJlaG91c2VJZCkpCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5BSVNMRShhaXNsZS5pZCkpCgogICAgICAgIHJldHVybiBuZXdBaXNsZQogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYWRpY2lvbmFyIHJ1YToiLCBlcnJvcikKICAgICAgICB0aHJvdyBlcnJvcgogICAgICB9CiAgICB9KQogIH0KCiAgYXN5bmMgdXBkYXRlQWlzbGVOb3RlcyhpZDogc3RyaW5nLCBub3Rlczogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7CiAgICByZXR1cm4gcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKCJ1cGRhdGVBaXNsZU5vdGVzIiwgYXN5bmMgKCkgPT4gewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsiYWlzbGVzIl0KCiAgICAgICAgaWYgKCFzaGVldCkgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQWJhICdhaXNsZXMnIG7Do28gZW5jb250cmFkYS4iKQogICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQoKICAgICAgICBjb25zdCByb3dzID0gYXdhaXQgc2hlZXQuZ2V0Um93cygpCiAgICAgICAgY29uc3Qgcm93VG9VcGRhdGUgPSByb3dzLmZpbmQoKHJvdykgPT4gcm93LmdldCgiaWQiKSA9PT0gaWQpCgogICAgICAgIGlmIChyb3dUb1VwZGF0ZSkgewogICAgICAgICAgY29uc3Qgc2FmZU5vdGVzID0gbm90ZXMgPT09IG51bGwgfHwgbm90ZXMgPT09IHVuZGVmaW5lZCA/ICIiIDogU3RyaW5nKG5vdGVzKQogICAgICAgICAgcm93VG9VcGRhdGUuc2V0KCJub3RlcyIsIHNhZmVOb3RlcykKICAgICAgICAgIGF3YWl0IHJvd1RvVXBkYXRlLnNhdmUoKQoKICAgICAgICAgIC8vIEludmFsaWRhciBjYWNoZQogICAgICAgICAgY29uc3Qgd2FyZWhvdXNlSWQgPSByb3dUb1VwZGF0ZS5nZXQoIndhcmVob3VzZUlkIikKICAgICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuQUlTTEUoaWQpKQogICAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5BSVNMRVNfQllfV0FSRUhPVVNFKHdhcmVob3VzZUlkKSkKCiAgICAgICAgICByZXR1cm4gdHJ1ZQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKGBSdWEgY29tIElEICR7aWR9IG7Do28gZW5jb250cmFkYSBwYXJhIGF0dWFsaXphw6fDo28uYCkKICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGF0dWFsaXphciBvYnNlcnZhw6fDtWVzIGRhIHJ1YSBubyBHb29nbGUgU2hlZXRzOiIsIGVycm9yKQogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9CiAgICB9KQogIH0KCiAgYXN5bmMgdXBkYXRlQWlzbGVDYXBhY2l0eShpZDogc3RyaW5nLCBjYXBhY2l0eTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7CiAgICByZXR1cm4gcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKCJ1cGRhdGVBaXNsZUNhcGFjaXR5IiwgYXN5bmMgKCkgPT4gewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsiYWlzbGVzIl0KCiAgICAgICAgaWYgKCFzaGVldCkgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQWJhICdhaXNsZXMnIG7Do28gZW5jb250cmFkYS4iKQogICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQoKICAgICAgICBjb25zdCByb3dzID0gYXdhaXQgc2hlZXQuZ2V0Um93cygpCiAgICAgICAgY29uc3Qgcm93VG9VcGRhdGUgPSByb3dzLmZpbmQoKHJvdykgPT4gcm93LmdldCgiaWQiKSA9PT0gaWQpCgogICAgICAgIGlmIChyb3dUb1VwZGF0ZSkgewogICAgICAgICAgY29uc3Qgc2FmZUNhcGFjaXR5ID0gY2FwYWNpdHkgPT09IG51bGwgfHwgY2FwYWNpdHkgPT09IHVuZGVmaW5lZCA/ICIwIiA6IFN0cmluZyhjYXBhY2l0eSkKICAgICAgICAgIHJvd1RvVXBkYXRlLnNldCgiY2FwYWNpdHkiLCBzYWZlQ2FwYWNpdHkpCiAgICAgICAgICBhd2FpdCByb3dUb1VwZGF0ZS5zYXZlKCkKCiAgICAgICAgICAvLyBJbnZhbGlkYXIgY2FjaGUKICAgICAgICAgIGNvbnN0IHdhcmVob3VzZUlkID0gcm93VG9VcGRhdGUuZ2V0KCJ3YXJlaG91c2VJZCIpCiAgICAgICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbChDQUNIRV9LRVlTLkFJU0xFKGlkKSkKICAgICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuQUlTTEVTX0JZX1dBUkVIT1VTRSh3YXJlaG91c2VJZCkpCgogICAgICAgICAgcmV0dXJuIHRydWUKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS5lcnJvcihgUnVhIGNvbSBJRCAke2lkfSBuw6NvIGVuY29udHJhZGEgcGFyYSBhdHVhbGl6YcOnw6NvIGRlIGNhcGFjaWRhZGUuYCkKICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGF0dWFsaXphciBjYXBhY2lkYWRlIGRhIHJ1YSBubyBHb29nbGUgU2hlZXRzOiIsIGVycm9yKQogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9CiAgICB9KQogIH0KCiAgYXN5bmMgdXBkYXRlQWlzbGVTdG9yYWdlQ29uZmlnKGlkOiBzdHJpbmcsIHN0b3JhZ2VUeXBlOiBzdHJpbmcsIHNoZWxmTGV2ZWxzOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHsKICAgIHJldHVybiBwZXJmb3JtYW5jZU1vbml0b3IudHJhY2tPcGVyYXRpb24oInVwZGF0ZUFpc2xlU3RvcmFnZUNvbmZpZyIsIGFzeW5jICgpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLmluaXQoKQogICAgICAgIGNvbnN0IHNoZWV0ID0gZG9jLnNoZWV0c0J5VGl0bGVbImFpc2xlcyJdCgogICAgICAgIGlmICghc2hlZXQpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkFiYSAnYWlzbGVzJyBuw6NvIGVuY29udHJhZGEuIikKICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KCiAgICAgICAgY29uc3Qgcm93cyA9IGF3YWl0IHNoZWV0LmdldFJvd3MoKQogICAgICAgIGNvbnN0IHJvd1RvVXBkYXRlID0gcm93cy5maW5kKChyb3cpID0+IHJvdy5nZXQoImlkIikgPT09IGlkKQoKICAgICAgICBpZiAocm93VG9VcGRhdGUpIHsKICAgICAgICAgIHJvd1RvVXBkYXRlLnNldCgic3RvcmFnZVR5cGUiLCBzdG9yYWdlVHlwZSkKICAgICAgICAgIHJvd1RvVXBkYXRlLnNldCgic2hlbGZMZXZlbHMiLCBzaGVsZkxldmVscykKICAgICAgICAgIGF3YWl0IHJvd1RvVXBkYXRlLnNhdmUoKQoKICAgICAgICAgIC8vIEludmFsaWRhciBjYWNoZQogICAgICAgICAgY29uc3Qgd2FyZWhvdXNlSWQgPSByb3dUb1VwZGF0ZS5nZXQoIndhcmVob3VzZUlkIikKICAgICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuQUlTTEUoaWQpKQogICAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5BSVNMRVNfQllfV0FSRUhPVVNFKHdhcmVob3VzZUlkKSkKCiAgICAgICAgICByZXR1cm4gdHJ1ZQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKGBSdWEgY29tIElEICR7aWR9IG7Do28gZW5jb250cmFkYSBwYXJhIGF0dWFsaXphw6fDo28gZGUgY29uZmlndXJhw6fDo28uYCkKICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGF0dWFsaXphciBjb25maWd1cmHDp8OjbyBkYSBydWEgbm8gR29vZ2xlIFNoZWV0czoiLCBlcnJvcikKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQogICAgfSkKICB9CgogIGFzeW5jIGRlbGV0ZUFpc2xlKGlkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHsKICAgIHJldHVybiBwZXJmb3JtYW5jZU1vbml0b3IudHJhY2tPcGVyYXRpb24oImRlbGV0ZUFpc2xlIiwgYXN5bmMgKCkgPT4gewogICAgICB0cnkgewogICAgICAgIGNvbnNvbGUubG9nKGBbU0hFRVRTXSBUZW50YW5kbyBleGNsdWlyIHJ1YSBjb20gSUQ6ICR7aWR9YCkKICAgICAgICBhd2FpdCB0aGlzLmluaXQoKQogICAgICAgIGNvbnN0IHNoZWV0ID0gZG9jLnNoZWV0c0J5VGl0bGVbImFpc2xlcyJdCgogICAgICAgIGlmICghc2hlZXQpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkFiYSAnYWlzbGVzJyBuw6NvIGVuY29udHJhZGEuIikKICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KCiAgICAgICAgY29uc3Qgcm93cyA9IGF3YWl0IHNoZWV0LmdldFJvd3MoKQogICAgICAgIGNvbnNvbGUubG9nKGBbU0hFRVRTXSBUb3RhbCBkZSBydWFzIGVuY29udHJhZGFzOiAke3Jvd3MubGVuZ3RofWApCgogICAgICAgIGNvbnN0IHJvd1RvRGVsZXRlID0gcm93cy5maW5kKChyb3cpID0+IHJvdy5nZXQoImlkIikgPT09IGlkKQoKICAgICAgICBpZiAocm93VG9EZWxldGUpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKGBbU0hFRVRTXSBSdWEgZW5jb250cmFkYTogJHtyb3dUb0RlbGV0ZS5nZXQoIm5hbWUiKX0sIGV4Y2x1aW5kby4uLmApCiAgICAgICAgICBjb25zdCB3YXJlaG91c2VJZCA9IHJvd1RvRGVsZXRlLmdldCgid2FyZWhvdXNlSWQiKQogICAgICAgICAgYXdhaXQgcm93VG9EZWxldGUuZGVsZXRlKCkKCiAgICAgICAgICAvLyBJbnZhbGlkYXIgY2FjaGUKICAgICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsUGF0dGVybihDQUNIRV9LRVlTLlBBVFRFUk5TLkFJU0xFKGlkKSkKICAgICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuQUlTTEVTX0JZX1dBUkVIT1VTRSh3YXJlaG91c2VJZCkpCgogICAgICAgICAgY29uc29sZS5sb2coYFtTSEVFVFNdIFJ1YSBleGNsdcOtZGEgY29tIHN1Y2Vzc29gKQogICAgICAgICAgcmV0dXJuIHRydWUKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS5lcnJvcihgW1NIRUVUU10gUnVhIGNvbSBJRCAke2lkfSBuw6NvIGVuY29udHJhZGEgcGFyYSBleGNsdXPDo28uYCkKICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGRlbGV0YXIgYWlzbGU6IiwgZXJyb3IpCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgIH0KICAgIH0pCiAgfQoKICBhc3luYyBkZWxldGVBaXNsZXNCeVdhcmVob3VzZSh3YXJlaG91c2VJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7CiAgICBhd2FpdCBwZXJmb3JtYW5jZU1vbml0b3IudHJhY2tPcGVyYXRpb24oImRlbGV0ZUFpc2xlc0J5V2FyZWhvdXNlIiwgYXN5bmMgKCkgPT4gewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsiYWlzbGVzIl0KICAgICAgICBjb25zdCByb3dzID0gYXdhaXQgc2hlZXQuZ2V0Um93cygpCgogICAgICAgIGNvbnN0IHJvd3NUb0RlbGV0ZSA9IHJvd3MuZmlsdGVyKChyb3cpID0+IHJvdy5nZXQoIndhcmVob3VzZUlkIikgPT09IHdhcmVob3VzZUlkKQogICAgICAgIGZvciAoY29uc3Qgcm93IG9mIHJvd3NUb0RlbGV0ZSkgewogICAgICAgICAgYXdhaXQgcm93LmRlbGV0ZSgpCiAgICAgICAgfQoKICAgICAgICAvLyBJbnZhbGlkYXIgY2FjaGUKICAgICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbChDQUNIRV9LRVlTLkFJU0xFU19CWV9XQVJFSE9VU0Uod2FyZWhvdXNlSWQpKQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsUGF0dGVybihDQUNIRV9LRVlTLlBBVFRFUk5TLldBUkVIT1VTRSh3YXJlaG91c2VJZCkpCiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBkZWxldGFyIGFpc2xlcyBkbyB3YXJlaG91c2U6IiwgZXJyb3IpCiAgICAgIH0KICAgIH0pCiAgfQoKICAvLyBQQUxMRVRTCiAgYXN5bmMgZ2V0UGFsbGV0c0J5QWlzbGUoYWlzbGVJZDogc3RyaW5nKTogUHJvbWlzZTxQYWxsZXRSb3dbXT4gewogICAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbigiZ2V0UGFsbGV0c0J5QWlzbGUiLCBhc3luYyAoKSA9PiB7CiAgICAgIGNvbnN0IGNhY2hlS2V5ID0gQ0FDSEVfS0VZUy5QQUxMRVRTX0JZX0FJU0xFKGFpc2xlSWQpCgogICAgICAvLyBUZW50YXIgYnVzY2FyIGRvIGNhY2hlIHByaW1laXJvCiAgICAgIGNvbnN0IGNhY2hlZCA9IGF3YWl0IHJlZGlzQ2FjaGUuZ2V0PFBhbGxldFJvd1tdPihjYWNoZUtleSkKICAgICAgaWYgKGNhY2hlZCkgewogICAgICAgIHBlcmZvcm1hbmNlTW9uaXRvci5yZWNvcmRDYWNoZUhpdCgpCiAgICAgICAgcmV0dXJuIGNhY2hlZAogICAgICB9CgogICAgICBwZXJmb3JtYW5jZU1vbml0b3IucmVjb3JkQ2FjaGVNaXNzKCkKICAgICAgY29uc29sZS5sb2coYFtTSEVFVFNdIEJ1c2NhbmRvIHBhbGxldHMgZG8gYWlzbGUgJHthaXNsZUlkfS4uLmApCgogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsicGFsbGV0cyJdCiAgICAgICAgY29uc3Qgcm93cyA9IGF3YWl0IHNoZWV0LmdldFJvd3MoKQoKICAgICAgICBjb25zdCBmaWx0ZXJlZFJvd3MgPSBhaXNsZUlkID8gcm93cy5maWx0ZXIoKHJvdykgPT4gcm93LmdldCgiYWlzbGVJZCIpID09PSBhaXNsZUlkKSA6IHJvd3MKCiAgICAgICAgY29uc3QgcGFsbGV0cyA9IGZpbHRlcmVkUm93cwogICAgICAgICAgLm1hcCgocm93KSA9PiAoewogICAgICAgICAgICBpZDogcm93LmdldCgiaWQiKSB8fCAiIiwKICAgICAgICAgICAgYWlzbGVJZDogcm93LmdldCgiYWlzbGVJZCIpIHx8ICIiLAogICAgICAgICAgICBwb3NpdGlvbjogcm93LmdldCgicG9zaXRpb24iKSB8fCAiMCIsCiAgICAgICAgICAgIGVhbjogcm93LmdldCgiZWFuIikgfHwgIiIsIC8vIElEIGRvIHByb2R1dG8KICAgICAgICAgICAgcHJvZHVjdE5hbWU6IHJvdy5nZXQoInByb2R1Y3ROYW1lIikgfHwgIiIsCiAgICAgICAgICAgIGNhdGVnb3J5OiByb3cuZ2V0KCJjYXRlZ29yeSIpIHx8ICIiLAogICAgICAgICAgICBlYW4xMzogcm93LmdldCgiZWFuMTMiKSB8fCAiIiwgLy8gRUFOIHJlYWwgZG8gcHJvZHV0bwogICAgICAgICAgICBsYXN0VmVyaWZpZWQ6IHJvdy5nZXQoImxhc3RWZXJpZmllZCIpIHx8ICIiLAogICAgICAgICAgICBjcmVhdGVkQXQ6IHJvdy5nZXQoImNyZWF0ZWRBdCIpIHx8ICIiLAogICAgICAgICAgfSkpCiAgICAgICAgICAuc29ydCgoYSwgYikgPT4gTnVtYmVyLnBhcnNlSW50KGEucG9zaXRpb24pIC0gTnVtYmVyLnBhcnNlSW50KGIucG9zaXRpb24pKQoKICAgICAgICAvLyBTYWx2YXIgbm8gY2FjaGUKICAgICAgICBhd2FpdCByZWRpc0NhY2hlLnNldChjYWNoZUtleSwgcGFsbGV0cywgQ0FDSEVfVFRMLlNIT1JUKQoKICAgICAgICAvLyBDYWNoZSBpbmRpdmlkdWFsIHBhcmEgY2FkYSBwYWxsZXQKICAgICAgICBjb25zdCBjYWNoZVByb21pc2VzID0gcGFsbGV0cy5tYXAoKHBhbGxldCkgPT4KICAgICAgICAgIHJlZGlzQ2FjaGUuc2V0KENBQ0hFX0tFWVMuUEFMTEVUKHBhbGxldC5pZCksIHBhbGxldCwgQ0FDSEVfVFRMLlNIT1JUKSwKICAgICAgICApCiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoY2FjaGVQcm9taXNlcykKCiAgICAgICAgY29uc29sZS5sb2coYFtTSEVFVFNdIOKchSAke3BhbGxldHMubGVuZ3RofSBwYWxsZXRzIGNhcnJlZ2Fkb3NgKQogICAgICAgIHJldHVybiBwYWxsZXRzCiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBidXNjYXIgcGFsbGV0czoiLCBlcnJvcikKICAgICAgICByZXR1cm4gW10KICAgICAgfQogICAgfSkKICB9CgogIGFzeW5jIGdldFBhbGxldEJ5SWQoaWQ6IHN0cmluZyk6IFByb21pc2U8UGFsbGV0Um93IHwgbnVsbD4gewogICAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbigiZ2V0UGFsbGV0QnlJZCIsIGFzeW5jICgpID0+IHsKICAgICAgY29uc3QgY2FjaGVLZXkgPSBDQUNIRV9LRVlTLlBBTExFVChpZCkKCiAgICAgIC8vIFRlbnRhciBidXNjYXIgZG8gY2FjaGUgcHJpbWVpcm8KICAgICAgY29uc3QgY2FjaGVkID0gYXdhaXQgcmVkaXNDYWNoZS5nZXQ8UGFsbGV0Um93PihjYWNoZUtleSkKICAgICAgaWYgKGNhY2hlZCkgewogICAgICAgIHBlcmZvcm1hbmNlTW9uaXRvci5yZWNvcmRDYWNoZUhpdCgpCiAgICAgICAgcmV0dXJuIGNhY2hlZAogICAgICB9CgogICAgICBwZXJmb3JtYW5jZU1vbml0b3IucmVjb3JkQ2FjaGVNaXNzKCkKICAgICAgY29uc29sZS5sb2coYFtTSEVFVFNdIEJ1c2NhbmRvIHBhbGxldCAke2lkfS4uLmApCgogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsicGFsbGV0cyJdCiAgICAgICAgY29uc3Qgcm93cyA9IGF3YWl0IHNoZWV0LmdldFJvd3MoKQoKICAgICAgICBjb25zdCByb3cgPSByb3dzLmZpbmQoKHJvdykgPT4gcm93LmdldCgiaWQiKSA9PT0gaWQpCiAgICAgICAgaWYgKCFyb3cpIHsKICAgICAgICAgIHJldHVybiBudWxsCiAgICAgICAgfQoKICAgICAgICBjb25zdCBwYWxsZXQgPSB7CiAgICAgICAgICBpZDogcm93LmdldCgiaWQiKSB8fCAiIiwKICAgICAgICAgIGFpc2xlSWQ6IHJvdy5nZXQoImFpc2xlSWQiKSB8fCAiIiwKICAgICAgICAgIHBvc2l0aW9uOiByb3cuZ2V0KCJwb3NpdGlvbiIpIHx8ICIwIiwKICAgICAgICAgIGVhbjogcm93LmdldCgiZWFuIikgfHwgIiIsIC8vIElEIGRvIHByb2R1dG8KICAgICAgICAgIHByb2R1Y3ROYW1lOiByb3cuZ2V0KCJwcm9kdWN0TmFtZSIpIHx8ICIiLAogICAgICAgICAgY2F0ZWdvcnk6IHJvdy5nZXQoImNhdGVnb3J5IikgfHwgIiIsCiAgICAgICAgICBlYW4xMzogcm93LmdldCgiZWFuMTMiKSB8fCAiIiwgLy8gRUFOIHJlYWwgZG8gcHJvZHV0bwogICAgICAgICAgbGFzdFZlcmlmaWVkOiByb3cuZ2V0KCJsYXN0VmVyaWZpZWQiKSB8fCAiIiwKICAgICAgICAgIGNyZWF0ZWRBdDogcm93LmdldCgiY3JlYXRlZEF0IikgfHwgIiIsCiAgICAgICAgfQoKICAgICAgICAvLyBTYWx2YXIgbm8gY2FjaGUKICAgICAgICBhd2FpdCByZWRpc0NhY2hlLnNldChjYWNoZUtleSwgcGFsbGV0LCBDQUNIRV9UVEwuU0hPUlQpCgogICAgICAgIHJldHVybiBwYWxsZXQKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGJ1c2NhciBwYWxsZXQgcG9yIElEOiIsIGVycm9yKQogICAgICAgIHJldHVybiBudWxsCiAgICAgIH0KICAgIH0pCiAgfQoKICBhc3luYyBhZGRQYWxsZXQocGFsbGV0OiBPbWl0PFBhbGxldFJvdywgImNyZWF0ZWRBdCI+KTogUHJvbWlzZTxQYWxsZXRSb3c+IHsKICAgIHJldHVybiBwZXJmb3JtYW5jZU1vbml0b3IudHJhY2tPcGVyYXRpb24oImFkZFBhbGxldCIsIGFzeW5jICgpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLmluaXQoKQogICAgICAgIGNvbnN0IHNoZWV0ID0gZG9jLnNoZWV0c0J5VGl0bGVbInBhbGxldHMiXQoKICAgICAgICAvLyBHYXJhbnRpciBxdWUgYSBhYmEgdGVuaGEgb3MgY2FiZcOnYWxob3MgY29ycmV0b3MKICAgICAgICBhd2FpdCBzaGVldC5sb2FkSGVhZGVyUm93KCkKICAgICAgICBjb25zdCBleHBlY3RlZEhlYWRlcnMgPSBbCiAgICAgICAgICAiaWQiLAogICAgICAgICAgImFpc2xlSWQiLAogICAgICAgICAgInBvc2l0aW9uIiwKICAgICAgICAgICJlYW4iLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgICAgICAicHJvZHVjdE5hbWUiLAogICAgICAgICAgImNhdGVnb3J5IiwKICAgICAgICAgICJlYW4xMyIsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgICAgICAgICJsYXN0VmVyaWZpZWQiLAogICAgICAgICAgImNyZWF0ZWRBdCIsCiAgICAgICAgXQoKICAgICAgICBpZiAoIXNoZWV0LmhlYWRlclZhbHVlcy5pbmNsdWRlcygiZWFuMTMiKSkgewogICAgICAgICAgYXdhaXQgc2hlZXQuc2V0SGVhZGVyUm93KGV4cGVjdGVkSGVhZGVycykKICAgICAgICB9CgogICAgICAgIC8vIFZhbGlkYcOnw6NvCiAgICAgICAgaWYgKCFwYWxsZXQuaWQgfHwgIXBhbGxldC5haXNsZUlkIHx8ICFwYWxsZXQucG9zaXRpb24pIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRGFkb3MgaW5jb21wbGV0b3MgcGFyYSBjcmlhciBwYWxldGUiKQogICAgICAgIH0KCiAgICAgICAgY29uc3QgbmV3UGFsbGV0OiBQYWxsZXRSb3cgPSB7CiAgICAgICAgICBpZDogcGFsbGV0LmlkLAogICAgICAgICAgYWlzbGVJZDogcGFsbGV0LmFpc2xlSWQsCiAgICAgICAgICBwb3NpdGlvbjogcGFsbGV0LnBvc2l0aW9uLAogICAgICAgICAgZWFuOiBwYWxsZXQuZWFuIHx8ICIiLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgICAgICBwcm9kdWN0TmFtZTogcGFsbGV0LnByb2R1Y3ROYW1lIHx8ICIiLAogICAgICAgICAgY2F0ZWdvcnk6IHBhbGxldC5jYXRlZ29yeSB8fCAiIiwKICAgICAgICAgIGVhbjEzOiBwYWxsZXQuZWFuMTMgfHwgIiIsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgICAgICAgIGxhc3RWZXJpZmllZDogcGFsbGV0Lmxhc3RWZXJpZmllZCB8fCBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgICAgICB9CgogICAgICAgIGNvbnN0IGFkZGVkUm93ID0gYXdhaXQgc2hlZXQuYWRkUm93KG5ld1BhbGxldCkKICAgICAgICBhd2FpdCBhZGRlZFJvdy5zYXZlKCkKCiAgICAgICAgLy8gSW52YWxpZGFyIGNhY2hlCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5QQUxMRVRTX0JZX0FJU0xFKHBhbGxldC5haXNsZUlkKSkKICAgICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbChDQUNIRV9LRVlTLlBBTExFVChwYWxsZXQuaWQpKQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsUGF0dGVybihDQUNIRV9LRVlTLlBBVFRFUk5TLlNFQVJDSCkKCiAgICAgICAgcmV0dXJuIG5ld1BhbGxldAogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYWRpY2lvbmFyIHBhbGV0ZToiLCBlcnJvcikKICAgICAgICB0aHJvdyBlcnJvcgogICAgICB9CiAgICB9KQogIH0KCiAgYXN5bmMgdXBkYXRlUGFsbGV0KGlkOiBzdHJpbmcsIHVwZGF0ZXM6IFBhcnRpYWw8UGFsbGV0Um93Pik6IFByb21pc2U8Ym9vbGVhbj4gewogICAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbigidXBkYXRlUGFsbGV0IiwgYXN5bmMgKCkgPT4gewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsicGFsbGV0cyJdCiAgICAgICAgY29uc3Qgcm93cyA9IGF3YWl0IHNoZWV0LmdldFJvd3MoKQoKICAgICAgICBjb25zdCByb3dUb1VwZGF0ZSA9IHJvd3MuZmluZCgocm93KSA9PiByb3cuZ2V0KCJpZCIpID09PSBpZCkKICAgICAgICBpZiAocm93VG9VcGRhdGUpIHsKICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHVwZGF0ZXMpLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4gewogICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIHJvd1RvVXBkYXRlLnNldChrZXksIHZhbHVlKQogICAgICAgICAgICB9CiAgICAgICAgICB9KQogICAgICAgICAgYXdhaXQgcm93VG9VcGRhdGUuc2F2ZSgpCgogICAgICAgICAgLy8gSW52YWxpZGFyIGNhY2hlCiAgICAgICAgICBjb25zdCBhaXNsZUlkID0gcm93VG9VcGRhdGUuZ2V0KCJhaXNsZUlkIikKICAgICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuUEFMTEVUKGlkKSkKICAgICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuUEFMTEVUU19CWV9BSVNMRShhaXNsZUlkKSkKICAgICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsUGF0dGVybihDQUNIRV9LRVlTLlBBVFRFUk5TLlNFQVJDSCkKICAgICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuRFVQTElDQVRFRF9FQU5TKQoKICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYXR1YWxpemFyIHBhbGxldDoiLCBlcnJvcikKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQogICAgfSkKICB9CgogIGFzeW5jIGRlbGV0ZVBhbGxldChpZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7CiAgICByZXR1cm4gcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKCJkZWxldGVQYWxsZXQiLCBhc3luYyAoKSA9PiB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc29sZS5sb2coYFtTSEVFVFNdIFRlbnRhbmRvIGV4Y2x1aXIgcGFsZXRlIGNvbSBJRDogJHtpZH1gKQogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsicGFsbGV0cyJdCgogICAgICAgIGlmICghc2hlZXQpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkFiYSAncGFsbGV0cycgbsOjbyBlbmNvbnRyYWRhLiIpCiAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CgogICAgICAgIGNvbnN0IHJvd3MgPSBhd2FpdCBzaGVldC5nZXRSb3dzKCkKICAgICAgICBjb25zb2xlLmxvZyhgW1NIRUVUU10gVG90YWwgZGUgcGFsZXRlcyBlbmNvbnRyYWRvczogJHtyb3dzLmxlbmd0aH1gKQoKICAgICAgICBjb25zdCByb3dUb0RlbGV0ZSA9IHJvd3MuZmluZCgocm93KSA9PiByb3cuZ2V0KCJpZCIpID09PSBpZCkKCiAgICAgICAgaWYgKHJvd1RvRGVsZXRlKSB7CiAgICAgICAgICBjb25zb2xlLmxvZyhgW1NIRUVUU10gUGFsZXRlIGVuY29udHJhZG8gbmEgcG9zacOnw6NvOiAke3Jvd1RvRGVsZXRlLmdldCgicG9zaXRpb24iKX0sIGV4Y2x1aW5kby4uLmApCiAgICAgICAgICBjb25zdCBhaXNsZUlkID0gcm93VG9EZWxldGUuZ2V0KCJhaXNsZUlkIikKICAgICAgICAgIGF3YWl0IHJvd1RvRGVsZXRlLmRlbGV0ZSgpCgogICAgICAgICAgLy8gSW52YWxpZGFyIGNhY2hlCiAgICAgICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbFBhdHRlcm4oQ0FDSEVfS0VZUy5QQVRURVJOUy5QQUxMRVQoaWQpKQogICAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5QQUxMRVRTX0JZX0FJU0xFKGFpc2xlSWQpKQogICAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWxQYXR0ZXJuKENBQ0hFX0tFWVMuUEFUVEVSTlMuU0VBUkNIKQoKICAgICAgICAgIGNvbnNvbGUubG9nKGBbU0hFRVRTXSBQYWxldGUgZXhjbHXDrWRvIGNvbSBzdWNlc3NvYCkKICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtTSEVFVFNdIFBhbGV0ZSBjb20gSUQgJHtpZH0gbsOjbyBlbmNvbnRyYWRvIHBhcmEgZXhjbHVzw6NvLmApCiAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBkZWxldGFyIHBhbGxldDoiLCBlcnJvcikKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQogICAgfSkKICB9CgogIGFzeW5jIGRlbGV0ZVBhbGxldHNCeUFpc2xlKGFpc2xlSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4gewogICAgYXdhaXQgcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKCJkZWxldGVQYWxsZXRzQnlBaXNsZSIsIGFzeW5jICgpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICBjb25zb2xlLmxvZyhgW1NIRUVUU10gRXhjbHVpbmRvIHRvZG9zIG9zIHBhbGV0ZXMgZGEgcnVhOiAke2Fpc2xlSWR9YCkKICAgICAgICBhd2FpdCB0aGlzLmluaXQoKQogICAgICAgIGNvbnN0IHNoZWV0ID0gZG9jLnNoZWV0c0J5VGl0bGVbInBhbGxldHMiXQogICAgICAgIGNvbnN0IHJvd3MgPSBhd2FpdCBzaGVldC5nZXRSb3dzKCkKCiAgICAgICAgY29uc3Qgcm93c1RvRGVsZXRlID0gcm93cy5maWx0ZXIoKHJvdykgPT4gcm93LmdldCgiYWlzbGVJZCIpID09PSBhaXNsZUlkKQogICAgICAgIGNvbnNvbGUubG9nKGBbU0hFRVRTXSBFbmNvbnRyYWRvcyAke3Jvd3NUb0RlbGV0ZS5sZW5ndGh9IHBhbGV0ZXMgcGFyYSBleGNsdWlyYCkKCiAgICAgICAgZm9yIChjb25zdCByb3cgb2Ygcm93c1RvRGVsZXRlKSB7CiAgICAgICAgICBhd2FpdCByb3cuZGVsZXRlKCkKICAgICAgICB9CgogICAgICAgIC8vIEludmFsaWRhciBjYWNoZQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuUEFMTEVUU19CWV9BSVNMRShhaXNsZUlkKSkKICAgICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbFBhdHRlcm4oQ0FDSEVfS0VZUy5QQVRURVJOUy5BSVNMRShhaXNsZUlkKSkKICAgICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbFBhdHRlcm4oQ0FDSEVfS0VZUy5QQVRURVJOUy5TRUFSQ0gpCgogICAgICAgIGNvbnNvbGUubG9nKGBbU0hFRVRTXSBUb2RvcyBvcyBwYWxldGVzIGRhIHJ1YSBleGNsdcOtZG9zYCkKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGRlbGV0YXIgcGFsbGV0cyBkYSBhaXNsZToiLCBlcnJvcikKICAgICAgfQogICAgfSkKICB9CgogIGFzeW5jIHJlb3JkZXJQYWxsZXRzKGFpc2xlSWQ6IHN0cmluZywgbmV3T3JkZXI6IHsgaWQ6IHN0cmluZzsgcG9zaXRpb246IG51bWJlciB9W10pOiBQcm9taXNlPGJvb2xlYW4+IHsKICAgIHJldHVybiBwZXJmb3JtYW5jZU1vbml0b3IudHJhY2tPcGVyYXRpb24oInJlb3JkZXJQYWxsZXRzIiwgYXN5bmMgKCkgPT4gewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsicGFsbGV0cyJdCiAgICAgICAgY29uc3Qgcm93cyA9IGF3YWl0IHNoZWV0LmdldFJvd3MoKQoKICAgICAgICBmb3IgKGNvbnN0IHsgaWQsIHBvc2l0aW9uIH0gb2YgbmV3T3JkZXIpIHsKICAgICAgICAgIGNvbnN0IHJvd1RvVXBkYXRlID0gcm93cy5maW5kKChyb3cpID0+IHJvdy5nZXQoImlkIikgPT09IGlkICYmIHJvdy5nZXQoImFpc2xlSWQiKSA9PT0gYWlzbGVJZCkKICAgICAgICAgIGlmIChyb3dUb1VwZGF0ZSkgewogICAgICAgICAgICByb3dUb1VwZGF0ZS5zZXQoInBvc2l0aW9uIiwgcG9zaXRpb24udG9TdHJpbmcoKSkKICAgICAgICAgICAgYXdhaXQgcm93VG9VcGRhdGUuc2F2ZSgpCiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBJbnZhbGlkYXIgY2FjaGUKICAgICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbChDQUNIRV9LRVlTLlBBTExFVFNfQllfQUlTTEUoYWlzbGVJZCkpCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWxQYXR0ZXJuKENBQ0hFX0tFWVMuUEFUVEVSTlMuQUlTTEUoYWlzbGVJZCkpCgogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiRXJybyBhbyByZW9yZGVuYXIgcGFsbGV0czoiLCBlcnJvcikKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQogICAgfSkKICB9CgogIC8vIFNIRUxWRVMKICBhc3luYyBnZXRTaGVsdmVzQnlBaXNsZShhaXNsZUlkOiBzdHJpbmcpOiBQcm9taXNlPFNoZWxmUm93W10+IHsKICAgIHJldHVybiBwZXJmb3JtYW5jZU1vbml0b3IudHJhY2tPcGVyYXRpb24oImdldFNoZWx2ZXNCeUFpc2xlIiwgYXN5bmMgKCkgPT4gewogICAgICBjb25zdCBjYWNoZUtleSA9IENBQ0hFX0tFWVMuU0hFTFZFU19CWV9BSVNMRShhaXNsZUlkKQoKICAgICAgLy8gVGVudGFyIGJ1c2NhciBkbyBjYWNoZSBwcmltZWlybwogICAgICBjb25zdCBjYWNoZWQgPSBhd2FpdCByZWRpc0NhY2hlLmdldDxTaGVsZlJvd1tdPihjYWNoZUtleSkKICAgICAgaWYgKGNhY2hlZCkgewogICAgICAgIHBlcmZvcm1hbmNlTW9uaXRvci5yZWNvcmRDYWNoZUhpdCgpCiAgICAgICAgcmV0dXJuIGNhY2hlZAogICAgICB9CgogICAgICBwZXJmb3JtYW5jZU1vbml0b3IucmVjb3JkQ2FjaGVNaXNzKCkKICAgICAgY29uc29sZS5sb2coYFtTSEVFVFNdIEJ1c2NhbmRvIHNoZWx2ZXMgZG8gYWlzbGUgJHthaXNsZUlkfS4uLmApCgogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsic2hlbHZlcyJdCiAgICAgICAgY29uc3Qgcm93cyA9IGF3YWl0IHNoZWV0LmdldFJvd3MoKQoKICAgICAgICBjb25zdCBmaWx0ZXJlZFJvd3MgPSBhaXNsZUlkID8gcm93cy5maWx0ZXIoKHJvdykgPT4gcm93LmdldCgiYWlzbGVJZCIpID09PSBhaXNsZUlkKSA6IHJvd3MKCiAgICAgICAgY29uc3Qgc2hlbHZlcyA9IGZpbHRlcmVkUm93cwogICAgICAgICAgLm1hcCgocm93KSA9PiAoewogICAgICAgICAgICBpZDogcm93LmdldCgiaWQiKSB8fCAiIiwKICAgICAgICAgICAgYWlzbGVJZDogcm93LmdldCgiYWlzbGVJZCIpIHx8ICIiLAogICAgICAgICAgICBwb3NpdGlvbjogcm93LmdldCgicG9zaXRpb24iKSB8fCAiMCIsCiAgICAgICAgICAgIGxldmVsOiByb3cuZ2V0KCJsZXZlbCIpIHx8ICIxIiwKICAgICAgICAgICAgZWFuOiByb3cuZ2V0KCJlYW4iKSB8fCAiIiwgLy8gSUQgZG8gcHJvZHV0bwogICAgICAgICAgICBwcm9kdWN0TmFtZTogcm93LmdldCgicHJvZHVjdE5hbWUiKSB8fCAiIiwKICAgICAgICAgICAgY2F0ZWdvcnk6IHJvdy5nZXQoImNhdGVnb3J5IikgfHwgIiIsCiAgICAgICAgICAgIGVhbjEzOiByb3cuZ2V0KCJlYW4xMyIpIHx8ICIiLCAvLyBFQU4gcmVhbCBkbyBwcm9kdXRvCiAgICAgICAgICAgIG9jY3VwYW5jeVBlcmNlbnRhZ2U6IHJvdy5nZXQoIm9jY3VwYW5jeVBlcmNlbnRhZ2UiKSB8fCAiMCIsCiAgICAgICAgICAgIGxhc3RWZXJpZmllZDogcm93LmdldCgibGFzdFZlcmlmaWVkIikgfHwgIiIsCiAgICAgICAgICAgIGNyZWF0ZWRBdDogcm93LmdldCgiY3JlYXRlZEF0IikgfHwgIiIsCiAgICAgICAgICB9KSkKICAgICAgICAgIC5zb3J0KChhLCBiKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHBvc0EgPSBOdW1iZXIucGFyc2VJbnQoYS5wb3NpdGlvbikKICAgICAgICAgICAgY29uc3QgcG9zQiA9IE51bWJlci5wYXJzZUludChiLnBvc2l0aW9uKQogICAgICAgICAgICBpZiAocG9zQSAhPT0gcG9zQikgcmV0dXJuIHBvc0EgLSBwb3NCCiAgICAgICAgICAgIHJldHVybiBOdW1iZXIucGFyc2VJbnQoYS5sZXZlbCkgLSBOdW1iZXIucGFyc2VJbnQoYi5sZXZlbCkKICAgICAgICAgIH0pCgogICAgICAgIC8vIFNhbHZhciBubyBjYWNoZQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuc2V0KGNhY2hlS2V5LCBzaGVsdmVzLCBDQUNIRV9UVEwuU0hPUlQpCgogICAgICAgIC8vIENhY2hlIGluZGl2aWR1YWwgcGFyYSBjYWRhIHNoZWxmCiAgICAgICAgY29uc3QgY2FjaGVQcm9taXNlcyA9IHNoZWx2ZXMubWFwKChzaGVsZikgPT4gcmVkaXNDYWNoZS5zZXQoQ0FDSEVfS0VZUy5TSEVMRihzaGVsZi5pZCksIHNoZWxmLCBDQUNIRV9UVEwuU0hPUlQpKQogICAgICAgIGF3YWl0IFByb21pc2UuYWxsKGNhY2hlUHJvbWlzZXMpCgogICAgICAgIGNvbnNvbGUubG9nKGBbU0hFRVRTXSDinIUgJHtzaGVsdmVzLmxlbmd0aH0gc2hlbHZlcyBjYXJyZWdhZG9zYCkKICAgICAgICByZXR1cm4gc2hlbHZlcwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYnVzY2FyIHNoZWx2ZXM6IiwgZXJyb3IpCiAgICAgICAgcmV0dXJuIFtdCiAgICAgIH0KICAgIH0pCiAgfQoKICBhc3luYyBhZGRTaGVsZihzaGVsZjogT21pdDxTaGVsZlJvdywgImNyZWF0ZWRBdCI+KTogUHJvbWlzZTxTaGVsZlJvdz4gewogICAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbigiYWRkU2hlbGYiLCBhc3luYyAoKSA9PiB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgdGhpcy5pbml0KCkKICAgICAgICBjb25zdCBzaGVldCA9IGRvYy5zaGVldHNCeVRpdGxlWyJzaGVsdmVzIl0KCiAgICAgICAgLy8gR2FyYW50aXIgcXVlIGEgYWJhIHRlbmhhIG9zIGNhYmXDp2FsaG9zIGNvcnJldG9zCiAgICAgICAgYXdhaXQgc2hlZXQubG9hZEhlYWRlclJvdygpCiAgICAgICAgY29uc3QgZXhwZWN0ZWRIZWFkZXJzID0gWwogICAgICAgICAgImlkIiwKICAgICAgICAgICJhaXNsZUlkIiwKICAgICAgICAgICJwb3NpdGlvbiIsCiAgICAgICAgICAibGV2ZWwiLAogICAgICAgICAgImVhbiIsIC8vIElEIGRvIHByb2R1dG8KICAgICAgICAgICJwcm9kdWN0TmFtZSIsCiAgICAgICAgICAiY2F0ZWdvcnkiLAogICAgICAgICAgImVhbjEzIiwgLy8gRUFOIHJlYWwgZG8gcHJvZHV0bwogICAgICAgICAgIm9jY3VwYW5jeVBlcmNlbnRhZ2UiLAogICAgICAgICAgImxhc3RWZXJpZmllZCIsCiAgICAgICAgICAiY3JlYXRlZEF0IiwKICAgICAgICBdCgogICAgICAgIGlmICghc2hlZXQuaGVhZGVyVmFsdWVzLmluY2x1ZGVzKCJlYW4xMyIpKSB7CiAgICAgICAgICBhd2FpdCBzaGVldC5zZXRIZWFkZXJSb3coZXhwZWN0ZWRIZWFkZXJzKQogICAgICAgIH0KCiAgICAgICAgY29uc3QgbmV3U2hlbGY6IFNoZWxmUm93ID0gewogICAgICAgICAgaWQ6IHNoZWxmLmlkLAogICAgICAgICAgYWlzbGVJZDogc2hlbGYuYWlzbGVJZCwKICAgICAgICAgIHBvc2l0aW9uOiBzaGVsZi5wb3NpdGlvbiwKICAgICAgICAgIGxldmVsOiBzaGVsZi5sZXZlbCwKICAgICAgICAgIGVhbjogc2hlbGYuZWFuIHx8ICIiLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgICAgICBwcm9kdWN0TmFtZTogc2hlbGYucHJvZHVjdE5hbWUgfHwgIiIsCiAgICAgICAgICBjYXRlZ29yeTogc2hlbGYuY2F0ZWdvcnkgfHwgIiIsCiAgICAgICAgICBlYW4xMzogc2hlbGYuZWFuMTMgfHwgIiIsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgICAgICAgIG9jY3VwYW5jeVBlcmNlbnRhZ2U6IHNoZWxmLm9jY3VwYW5jeVBlcmNlbnRhZ2UgfHwgIjAiLAogICAgICAgICAgbGFzdFZlcmlmaWVkOiBzaGVsZi5sYXN0VmVyaWZpZWQgfHwgbmV3IERhdGUoKS50b0lTT1N0cmluZygpLAogICAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICAgICAgfQoKICAgICAgICBjb25zdCBhZGRlZFJvdyA9IGF3YWl0IHNoZWV0LmFkZFJvdyhuZXdTaGVsZikKICAgICAgICBhd2FpdCBhZGRlZFJvdy5zYXZlKCkKCiAgICAgICAgLy8gSW52YWxpZGFyIGNhY2hlCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5TSEVMVkVTX0JZX0FJU0xFKHNoZWxmLmFpc2xlSWQpKQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuU0hFTEYoc2hlbGYuaWQpKQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsUGF0dGVybihDQUNIRV9LRVlTLlBBVFRFUk5TLlNFQVJDSCkKCiAgICAgICAgcmV0dXJuIG5ld1NoZWxmCiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBhZGljaW9uYXIgcHJhdGVsZWlyYToiLCBlcnJvcikKICAgICAgICB0aHJvdyBlcnJvcgogICAgICB9CiAgICB9KQogIH0KCiAgYXN5bmMgdXBkYXRlU2hlbGYoaWQ6IHN0cmluZywgdXBkYXRlczogUGFydGlhbDxTaGVsZlJvdz4pOiBQcm9taXNlPGJvb2xlYW4+IHsKICAgIHJldHVybiBwZXJmb3JtYW5jZU1vbml0b3IudHJhY2tPcGVyYXRpb24oInVwZGF0ZVNoZWxmIiwgYXN5bmMgKCkgPT4gewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsic2hlbHZlcyJdCiAgICAgICAgY29uc3Qgcm93cyA9IGF3YWl0IHNoZWV0LmdldFJvd3MoKQoKICAgICAgICBjb25zdCByb3dUb1VwZGF0ZSA9IHJvd3MuZmluZCgocm93KSA9PiByb3cuZ2V0KCJpZCIpID09PSBpZCkKICAgICAgICBpZiAocm93VG9VcGRhdGUpIHsKICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHVwZGF0ZXMpLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4gewogICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIHJvd1RvVXBkYXRlLnNldChrZXksIHZhbHVlKQogICAgICAgICAgICB9CiAgICAgICAgICB9KQogICAgICAgICAgYXdhaXQgcm93VG9VcGRhdGUuc2F2ZSgpCgogICAgICAgICAgLy8gSW52YWxpZGFyIGNhY2hlCiAgICAgICAgICBjb25zdCBhaXNsZUlkID0gcm93VG9VcGRhdGUuZ2V0KCJhaXNsZUlkIikKICAgICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKENBQ0hFX0tFWVMuU0hFTEYoaWQpKQogICAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5TSEVMVkVTX0JZX0FJU0xFKGFpc2xlSWQpKQogICAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWxQYXR0ZXJuKENBQ0hFX0tFWVMuUEFUVEVSTlMuU0VBUkNIKQogICAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5EVVBMSUNBVEVEX0VBTlMpCgogICAgICAgICAgcmV0dXJuIHRydWUKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBhdHVhbGl6YXIgc2hlbGY6IiwgZXJyb3IpCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgIH0KICAgIH0pCiAgfQoKICBhc3luYyBkZWxldGVTaGVsZihpZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7CiAgICByZXR1cm4gcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKCJkZWxldGVTaGVsZiIsIGFzeW5jICgpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICBjb25zb2xlLmxvZyhgW1NIRUVUU10gVGVudGFuZG8gZXhjbHVpciBwcmF0ZWxlaXJhIGNvbSBJRDogJHtpZH1gKQogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsic2hlbHZlcyJdCgogICAgICAgIGlmICghc2hlZXQpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkFiYSAnc2hlbHZlcycgbsOjbyBlbmNvbnRyYWRhLiIpCiAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CgogICAgICAgIGNvbnN0IHJvd3MgPSBhd2FpdCBzaGVldC5nZXRSb3dzKCkKICAgICAgICBjb25zb2xlLmxvZyhgW1NIRUVUU10gVG90YWwgZGUgcHJhdGVsZWlyYXMgZW5jb250cmFkYXM6ICR7cm93cy5sZW5ndGh9YCkKCiAgICAgICAgY29uc3Qgcm93VG9EZWxldGUgPSByb3dzLmZpbmQoKHJvdykgPT4gcm93LmdldCgiaWQiKSA9PT0gaWQpCgogICAgICAgIGlmIChyb3dUb0RlbGV0ZSkgewogICAgICAgICAgY29uc29sZS5sb2coCiAgICAgICAgICAgIGBbU0hFRVRTXSBQcmF0ZWxlaXJhIGVuY29udHJhZGEgbmEgcG9zacOnw6NvOiAke3Jvd1RvRGVsZXRlLmdldCgicG9zaXRpb24iKX0sIGFuZGFyOiAke3Jvd1RvRGVsZXRlLmdldCgibGV2ZWwiKX0sIGV4Y2x1aW5kby4uLmAsCiAgICAgICAgICApCiAgICAgICAgICBjb25zdCBhaXNsZUlkID0gcm93VG9EZWxldGUuZ2V0KCJhaXNsZUlkIikKICAgICAgICAgIGF3YWl0IHJvd1RvRGVsZXRlLmRlbGV0ZSgpCgogICAgICAgICAgLy8gSW52YWxpZGFyIGNhY2hlCiAgICAgICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbFBhdHRlcm4oQ0FDSEVfS0VZUy5QQVRURVJOUy5TSEVMRihpZCkpCiAgICAgICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbChDQUNIRV9LRVlTLlNIRUxWRVNfQllfQUlTTEUoYWlzbGVJZCkpCiAgICAgICAgICBhd2FpdCByZWRpc0NhY2hlLmRlbFBhdHRlcm4oQ0FDSEVfS0VZUy5QQVRURVJOUy5TRUFSQ0gpCgogICAgICAgICAgY29uc29sZS5sb2coYFtTSEVFVFNdIFByYXRlbGVpcmEgZXhjbHXDrWRhIGNvbSBzdWNlc3NvYCkKICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtTSEVFVFNdIFByYXRlbGVpcmEgY29tIElEICR7aWR9IG7Do28gZW5jb250cmFkYSBwYXJhIGV4Y2x1c8Ojby5gKQogICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gZGVsZXRhciBzaGVsZjoiLCBlcnJvcikKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQogICAgfSkKICB9CgogIGFzeW5jIGRlbGV0ZVNoZWx2ZXNCeUFpc2xlKGFpc2xlSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4gewogICAgYXdhaXQgcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKCJkZWxldGVTaGVsdmVzQnlBaXNsZSIsIGFzeW5jICgpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICBjb25zb2xlLmxvZyhgW1NIRUVUU10gRXhjbHVpbmRvIHRvZGFzIGFzIHByYXRlbGVpcmFzIGRhIHJ1YTogJHthaXNsZUlkfWApCiAgICAgICAgYXdhaXQgdGhpcy5pbml0KCkKICAgICAgICBjb25zdCBzaGVldCA9IGRvYy5zaGVldHNCeVRpdGxlWyJzaGVsdmVzIl0KICAgICAgICBjb25zdCByb3dzID0gYXdhaXQgc2hlZXQuZ2V0Um93cygpCgogICAgICAgIGNvbnN0IHJvd3NUb0RlbGV0ZSA9IHJvd3MuZmlsdGVyKChyb3cpID0+IHJvdy5nZXQoImFpc2xlSWQiKSA9PT0gYWlzbGVJZCkKICAgICAgICBjb25zb2xlLmxvZyhgW1NIRUVUU10gRW5jb250cmFkYXMgJHtyb3dzVG9EZWxldGUubGVuZ3RofSBwcmF0ZWxlaXJhcyBwYXJhIGV4Y2x1aXJgKQoKICAgICAgICBmb3IgKGNvbnN0IHJvdyBvZiByb3dzVG9EZWxldGUpIHsKICAgICAgICAgIGF3YWl0IHJvdy5kZWxldGUoKQogICAgICAgIH0KCiAgICAgICAgLy8gSW52YWxpZGFyIGNhY2hlCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoQ0FDSEVfS0VZUy5TSEVMVkVTX0JZX0FJU0xFKGFpc2xlSWQpKQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsUGF0dGVybihDQUNIRV9LRVlTLlBBVFRFUk5TLkFJU0xFKGFpc2xlSWQpKQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsUGF0dGVybihDQUNIRV9LRVlTLlBBVFRFUk5TLlNFQVJDSCkKCiAgICAgICAgY29uc29sZS5sb2coYFtTSEVFVFNdIFRvZGFzIGFzIHByYXRlbGVpcmFzIGRhIHJ1YSBleGNsdcOtZGFzYCkKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGRlbGV0YXIgc2hlbHZlcyBkYSBhaXNsZToiLCBlcnJvcikKICAgICAgfQogICAgfSkKICB9CgogIC8vIFJFU1VQUExZIC0gTm92YXMgZnVuw6fDtWVzIHBhcmEgZ2VyZW5jaWFyIHJlc3N1cHJpbWVudG8KICBhc3luYyBnZXRSZXN1cHBseU5vdGlmaWNhdGlvbnMoKTogUHJvbWlzZTxSZXN1cHBseVJvd1tdPiB7CiAgICByZXR1cm4gcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKCJnZXRSZXN1cHBseU5vdGlmaWNhdGlvbnMiLCBhc3luYyAoKSA9PiB7CiAgICAgIGNvbnN0IGNhY2hlS2V5ID0gInJlc3VwcGx5Om5vdGlmaWNhdGlvbnMiCgogICAgICAvLyBUZW50YXIgYnVzY2FyIGRvIGNhY2hlIHByaW1laXJvCiAgICAgIGNvbnN0IGNhY2hlZCA9IGF3YWl0IHJlZGlzQ2FjaGUuZ2V0PFJlc3VwcGx5Um93W10+KGNhY2hlS2V5KQogICAgICBpZiAoY2FjaGVkKSB7CiAgICAgICAgcGVyZm9ybWFuY2VNb25pdG9yLnJlY29yZENhY2hlSGl0KCkKICAgICAgICByZXR1cm4gY2FjaGVkCiAgICAgIH0KCiAgICAgIHBlcmZvcm1hbmNlTW9uaXRvci5yZWNvcmRDYWNoZU1pc3MoKQogICAgICBjb25zb2xlLmxvZygiW1NIRUVUU10gQnVzY2FuZG8gbm90aWZpY2HDp8O1ZXMgZGUgcmVzc3VwcmltZW50by4uLiIpCgogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsicmVzdXBwbHkiXQoKICAgICAgICBpZiAoIXNoZWV0KSB7CiAgICAgICAgICByZXR1cm4gW10KICAgICAgICB9CgogICAgICAgIGNvbnN0IHJvd3MgPSBhd2FpdCBzaGVldC5nZXRSb3dzKCkKICAgICAgICBjb25zdCBub3RpZmljYXRpb25zID0gcm93cy5tYXAoKHJvdykgPT4gKHsKICAgICAgICAgIGlkOiByb3cuZ2V0KCJpZCIpIHx8ICIiLAogICAgICAgICAgcHJvZHVjdElkOiByb3cuZ2V0KCJwcm9kdWN0SWQiKSB8fCAiIiwKICAgICAgICAgIHByb2R1Y3ROYW1lOiByb3cuZ2V0KCJwcm9kdWN0TmFtZSIpIHx8ICIiLAogICAgICAgICAgZWFuMTM6IHJvdy5nZXQoImVhbjEzIikgfHwgIiIsCiAgICAgICAgICBjYXRlZ29yeTogcm93LmdldCgiY2F0ZWdvcnkiKSB8fCAiIiwKICAgICAgICAgIGxvY2F0aW9uSWQ6IHJvdy5nZXQoImxvY2F0aW9uSWQiKSB8fCAiIiwKICAgICAgICAgIGxvY2F0aW9uVHlwZTogcm93LmdldCgibG9jYXRpb25UeXBlIikgfHwgInBhbGxldCIsCiAgICAgICAgICBhZGRyZXNzOiByb3cuZ2V0KCJhZGRyZXNzIikgfHwgIiIsCiAgICAgICAgICB3YXJlaG91c2VJZDogcm93LmdldCgid2FyZWhvdXNlSWQiKSB8fCAiIiwKICAgICAgICAgIHdhcmVob3VzZU5hbWU6IHJvdy5nZXQoIndhcmVob3VzZU5hbWUiKSB8fCAiIiwKICAgICAgICAgIGFpc2xlSWQ6IHJvdy5nZXQoImFpc2xlSWQiKSB8fCAiIiwKICAgICAgICAgIGFpc2xlTmFtZTogcm93LmdldCgiYWlzbGVOYW1lIikgfHwgIiIsCiAgICAgICAgICBwb3NpdGlvbjogcm93LmdldCgicG9zaXRpb24iKSB8fCAiMCIsCiAgICAgICAgICBsZXZlbDogcm93LmdldCgibGV2ZWwiKSB8fCAiIiwKICAgICAgICAgIHN0YXR1czogcm93LmdldCgic3RhdHVzIikgfHwgInBlbmRpbmciLAogICAgICAgICAgcHJpb3JpdHk6IHJvdy5nZXQoInByaW9yaXR5IikgfHwgIm1lZGl1bSIsCiAgICAgICAgICBub3Rlczogcm93LmdldCgibm90ZXMiKSB8fCAiIiwKICAgICAgICAgIG5vdGlmaWVkQXQ6IHJvdy5nZXQoIm5vdGlmaWVkQXQiKSB8fCAiIiwKICAgICAgICAgIGNvbXBsZXRlZEF0OiByb3cuZ2V0KCJjb21wbGV0ZWRBdCIpIHx8ICIiLAogICAgICAgICAgY3JlYXRlZEF0OiByb3cuZ2V0KCJjcmVhdGVkQXQiKSB8fCAiIiwKICAgICAgICB9KSkKCiAgICAgICAgLy8gU2FsdmFyIG5vIGNhY2hlCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5zZXQoY2FjaGVLZXksIG5vdGlmaWNhdGlvbnMsIENBQ0hFX1RUTC5TSE9SVCkKCiAgICAgICAgY29uc29sZS5sb2coYFtTSEVFVFNdIOKchSAke25vdGlmaWNhdGlvbnMubGVuZ3RofSBub3RpZmljYcOnw7VlcyBkZSByZXNzdXByaW1lbnRvIGNhcnJlZ2FkYXNgKQogICAgICAgIHJldHVybiBub3RpZmljYXRpb25zCiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBidXNjYXIgbm90aWZpY2HDp8O1ZXMgZGUgcmVzc3VwcmltZW50bzoiLCBlcnJvcikKICAgICAgICByZXR1cm4gW10KICAgICAgfQogICAgfSkKICB9CgogIGFzeW5jIGFkZFJlc3VwcGx5Tm90aWZpY2F0aW9uKG5vdGlmaWNhdGlvbjogT21pdDxSZXN1cHBseVJvdywgImlkIiB8ICJjcmVhdGVkQXQiPik6IFByb21pc2U8UmVzdXBwbHlSb3c+IHsKICAgIHJldHVybiBwZXJmb3JtYW5jZU1vbml0b3IudHJhY2tPcGVyYXRpb24oImFkZFJlc3VwcGx5Tm90aWZpY2F0aW9uIiwgYXN5bmMgKCkgPT4gewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsicmVzdXBwbHkiXQoKICAgICAgICBjb25zdCBuZXdOb3RpZmljYXRpb246IFJlc3VwcGx5Um93ID0gewogICAgICAgICAgLi4ubm90aWZpY2F0aW9uLAogICAgICAgICAgaWQ6IGByZXN1cHBseS0ke0RhdGUubm93KCl9LSR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWAsCiAgICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICAgICAgICB9CgogICAgICAgIGNvbnN0IGFkZGVkUm93ID0gYXdhaXQgc2hlZXQuYWRkUm93KG5ld05vdGlmaWNhdGlvbikKICAgICAgICBhd2FpdCBhZGRlZFJvdy5zYXZlKCkKCiAgICAgICAgLy8gSW52YWxpZGFyIGNhY2hlCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5kZWwoInJlc3VwcGx5Om5vdGlmaWNhdGlvbnMiKQoKICAgICAgICBjb25zb2xlLmxvZyhgW1NIRUVUU10g4pyFIE5vdGlmaWNhw6fDo28gZGUgcmVzc3VwcmltZW50byBhZGljaW9uYWRhOiAke25ld05vdGlmaWNhdGlvbi5pZH1gKQogICAgICAgIHJldHVybiBuZXdOb3RpZmljYXRpb24KICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGFkaWNpb25hciBub3RpZmljYcOnw6NvIGRlIHJlc3N1cHJpbWVudG86IiwgZXJyb3IpCiAgICAgICAgdGhyb3cgZXJyb3IKICAgICAgfQogICAgfSkKICB9CgogIGFzeW5jIHVwZGF0ZVJlc3VwcGx5Tm90aWZpY2F0aW9uKGlkOiBzdHJpbmcsIHVwZGF0ZXM6IFBhcnRpYWw8UmVzdXBwbHlSb3c+KTogUHJvbWlzZTxib29sZWFuPiB7CiAgICByZXR1cm4gcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKCJ1cGRhdGVSZXN1cHBseU5vdGlmaWNhdGlvbiIsIGFzeW5jICgpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLmluaXQoKQogICAgICAgIGNvbnN0IHNoZWV0ID0gZG9jLnNoZWV0c0J5VGl0bGVbInJlc3VwcGx5Il0KICAgICAgICBjb25zdCByb3dzID0gYXdhaXQgc2hlZXQuZ2V0Um93cygpCgogICAgICAgIGNvbnN0IHJvd1RvVXBkYXRlID0gcm93cy5maW5kKChyb3cpID0+IHJvdy5nZXQoImlkIikgPT09IGlkKQogICAgICAgIGlmIChyb3dUb1VwZGF0ZSkgewogICAgICAgICAgT2JqZWN0LmVudHJpZXModXBkYXRlcykuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgcm93VG9VcGRhdGUuc2V0KGtleSwgdmFsdWUpCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pCiAgICAgICAgICBhd2FpdCByb3dUb1VwZGF0ZS5zYXZlKCkKCiAgICAgICAgICAvLyBJbnZhbGlkYXIgY2FjaGUKICAgICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZGVsKCJyZXN1cHBseTpub3RpZmljYXRpb25zIikKCiAgICAgICAgICBjb25zb2xlLmxvZyhgW1NIRUVUU10g4pyFIE5vdGlmaWNhw6fDo28gZGUgcmVzc3VwcmltZW50byBhdHVhbGl6YWRhOiAke2lkfWApCiAgICAgICAgICByZXR1cm4gdHJ1ZQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGF0dWFsaXphciBub3RpZmljYcOnw6NvIGRlIHJlc3N1cHJpbWVudG86IiwgZXJyb3IpCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgIH0KICAgIH0pCiAgfQoKICAvLyBTRUFSQ0ggLSBNb2RpZmljYWRvIHBhcmEgc3Vwb3J0YXIgbcO6bHRpcGxvcyBFQU5zIGUgYnVzY2FyIHBvciBJRCBkbyBwcm9kdXRvCiAgYXN5bmMgZmluZFByb2R1Y3RCeUVBTigKICAgIGVhbjogc3RyaW5nLAogICk6IFByb21pc2U8QXJyYXk8KFBhbGxldFJvdyB8IFNoZWxmUm93KSAmIHsgYWlzbGVOYW1lOiBzdHJpbmc7IHdhcmVob3VzZU5hbWU6IHN0cmluZzsgc3RvcmFnZVR5cGU6IHN0cmluZyB9Pj4gewogICAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbigiZmluZFByb2R1Y3RCeUVBTiIsIGFzeW5jICgpID0+IHsKICAgICAgY29uc3QgY2FjaGVLZXkgPSBDQUNIRV9LRVlTLlNFQVJDSF9CWV9FQU4oZWFuKQoKICAgICAgLy8gVGVudGFyIGJ1c2NhciBkbyBjYWNoZSBwcmltZWlybwogICAgICBjb25zdCBjYWNoZWQgPQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuZ2V0PAogICAgICAgICAgQXJyYXk8KFBhbGxldFJvdyB8IFNoZWxmUm93KSAmIHsgYWlzbGVOYW1lOiBzdHJpbmc7IHdhcmVob3VzZU5hbWU6IHN0cmluZzsgc3RvcmFnZVR5cGU6IHN0cmluZyB9PgogICAgICAgID4oY2FjaGVLZXkpCiAgICAgIGlmIChjYWNoZWQpIHsKICAgICAgICBwZXJmb3JtYW5jZU1vbml0b3IucmVjb3JkQ2FjaGVIaXQoKQogICAgICAgIHJldHVybiBjYWNoZWQKICAgICAgfQoKICAgICAgcGVyZm9ybWFuY2VNb25pdG9yLnJlY29yZENhY2hlTWlzcygpCiAgICAgIGNvbnNvbGUubG9nKGBbU0hFRVRTXSBCdXNjYW5kbyBwcm9kdXRvIHBvciBFQU4vSUQ6ICR7ZWFufWApCgogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3QgcGFsbGV0c1NoZWV0ID0gZG9jLnNoZWV0c0J5VGl0bGVbInBhbGxldHMiXQogICAgICAgIGNvbnN0IHNoZWx2ZXNTaGVldCA9IGRvYy5zaGVldHNCeVRpdGxlWyJzaGVsdmVzIl0KICAgICAgICBjb25zdCBhaXNsZXNTaGVldCA9IGRvYy5zaGVldHNCeVRpdGxlWyJhaXNsZXMiXQogICAgICAgIGNvbnN0IHdhcmVob3VzZXNTaGVldCA9IGRvYy5zaGVldHNCeVRpdGxlWyJ3YXJlaG91c2VzIl0KCiAgICAgICAgY29uc3QgW3BhbGxldFJvd3MsIHNoZWxmUm93cywgYWlzbGVSb3dzLCB3YXJlaG91c2VSb3dzXSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgICAgICAgIHBhbGxldHNTaGVldC5nZXRSb3dzKCksCiAgICAgICAgICBzaGVsdmVzU2hlZXQuZ2V0Um93cygpLAogICAgICAgICAgYWlzbGVzU2hlZXQuZ2V0Um93cygpLAogICAgICAgICAgd2FyZWhvdXNlc1NoZWV0LmdldFJvd3MoKSwKICAgICAgICBdKQoKICAgICAgICBjb25zdCBub3JtYWxpemVkRUFOID0gZWFuLnRyaW0oKS50b0xvd2VyQ2FzZSgpCiAgICAgICAgY29uc29sZS5sb2coYFtTSEVFVFNdIEVBTiBub3JtYWxpemFkbyBwYXJhIGJ1c2NhOiAiJHtub3JtYWxpemVkRUFOfSJgKQoKICAgICAgICAvLyBCdXNjYXIgZW0gcGFsZXRlcyAtIGJ1c2NhIHBvciBJRCBkbyBwcm9kdXRvIChjYW1wbyBlYW4pIG91IEVBTjEzCiAgICAgICAgY29uc3QgbWF0Y2hpbmdQYWxsZXRzID0gcGFsbGV0Um93cy5maWx0ZXIoKHJvdykgPT4gewogICAgICAgICAgY29uc3QgcHJvZHVjdElkID0gcm93LmdldCgiZWFuIikgfHwgIiIKICAgICAgICAgIGNvbnN0IGVhbjEzID0gcm93LmdldCgiZWFuMTMiKSB8fCAiIgoKICAgICAgICAgIGNvbnN0IG1hdGNoQnlJZCA9IGNvbnRhaW5zRUFOKHByb2R1Y3RJZCwgbm9ybWFsaXplZEVBTikKICAgICAgICAgIGNvbnN0IG1hdGNoQnlFYW4xMyA9IGNvbnRhaW5zRUFOKGVhbjEzLCBub3JtYWxpemVkRUFOKQoKICAgICAgICAgIGlmIChtYXRjaEJ5SWQgfHwgbWF0Y2hCeUVhbjEzKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbU0hFRVRTXSDinIUgTWF0Y2ggZW5jb250cmFkbyBlbSBwYWxsZXQ6YCwgewogICAgICAgICAgICAgIHNlYXJjaEVBTjogbm9ybWFsaXplZEVBTiwKICAgICAgICAgICAgICBwcm9kdWN0SWQ6IHByb2R1Y3RJZCwKICAgICAgICAgICAgICBlYW4xMzogZWFuMTMsCiAgICAgICAgICAgICAgbWF0Y2hCeUlkLAogICAgICAgICAgICAgIG1hdGNoQnlFYW4xMywKICAgICAgICAgICAgfSkKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gbWF0Y2hCeUlkIHx8IG1hdGNoQnlFYW4xMwogICAgICAgIH0pCgogICAgICAgIC8vIEJ1c2NhciBlbSBwcmF0ZWxlaXJhcyAtIGJ1c2NhIHBvciBJRCBkbyBwcm9kdXRvIChjYW1wbyBlYW4pIG91IEVBTjEzCiAgICAgICAgY29uc3QgbWF0Y2hpbmdTaGVsdmVzID0gc2hlbGZSb3dzLmZpbHRlcigocm93KSA9PiB7CiAgICAgICAgICBjb25zdCBwcm9kdWN0SWQgPSByb3cuZ2V0KCJlYW4iKSB8fCAiIgogICAgICAgICAgY29uc3QgZWFuMTMgPSByb3cuZ2V0KCJlYW4xMyIpIHx8ICIiCgogICAgICAgICAgY29uc3QgbWF0Y2hCeUlkID0gY29udGFpbnNFQU4ocHJvZHVjdElkLCBub3JtYWxpemVkRUFOKQogICAgICAgICAgY29uc3QgbWF0Y2hCeUVhbjEzID0gY29udGFpbnNFQU4oZWFuMTMsIG5vcm1hbGl6ZWRFQU4pCgogICAgICAgICAgaWYgKG1hdGNoQnlJZCB8fCBtYXRjaEJ5RWFuMTMpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFtTSEVFVFNdIOKchSBNYXRjaCBlbmNvbnRyYWRvIGVtIHNoZWxmOmAsIHsKICAgICAgICAgICAgICBzZWFyY2hFQU46IG5vcm1hbGl6ZWRFQU4sCiAgICAgICAgICAgICAgcHJvZHVjdElkOiBwcm9kdWN0SWQsCiAgICAgICAgICAgICAgZWFuMTM6IGVhbjEzLAogICAgICAgICAgICAgIG1hdGNoQnlJZCwKICAgICAgICAgICAgICBtYXRjaEJ5RWFuMTMsCiAgICAgICAgICAgIH0pCiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIG1hdGNoQnlJZCB8fCBtYXRjaEJ5RWFuMTMKICAgICAgICB9KQoKICAgICAgICBjb25zb2xlLmxvZyhgW1NIRUVUU10gRW5jb250cmFkb3MgJHttYXRjaGluZ1BhbGxldHMubGVuZ3RofSBwYWxsZXRzIGUgJHttYXRjaGluZ1NoZWx2ZXMubGVuZ3RofSBzaGVsdmVzYCkKCiAgICAgICAgY29uc3QgcmVzdWx0cyA9IFtdCgogICAgICAgIC8vIFByb2Nlc3NhciBwYWxsZXRzCiAgICAgICAgZm9yIChjb25zdCBwYWxsZXRSb3cgb2YgbWF0Y2hpbmdQYWxsZXRzKSB7CiAgICAgICAgICBjb25zdCBhaXNsZUlkID0gcGFsbGV0Um93LmdldCgiYWlzbGVJZCIpCiAgICAgICAgICBjb25zdCBhaXNsZVJvdyA9IGFpc2xlUm93cy5maW5kKChyb3cpID0+IHJvdy5nZXQoImlkIikgPT09IGFpc2xlSWQpCgogICAgICAgICAgaWYgKGFpc2xlUm93KSB7CiAgICAgICAgICAgIGNvbnN0IHdhcmVob3VzZUlkID0gYWlzbGVSb3cuZ2V0KCJ3YXJlaG91c2VJZCIpCiAgICAgICAgICAgIGNvbnN0IHdhcmVob3VzZVJvdyA9IHdhcmVob3VzZVJvd3MuZmluZCgocm93KSA9PiByb3cuZ2V0KCJpZCIpID09PSB3YXJlaG91c2VJZCkKCiAgICAgICAgICAgIGlmICh3YXJlaG91c2VSb3cpIHsKICAgICAgICAgICAgICBjb25zdCBwcm9kdWN0SWRzID0gcGFsbGV0Um93LmdldCgiZWFuIikgfHwgIiIKICAgICAgICAgICAgICBjb25zdCBwcm9kdWN0TmFtZXMgPSBwYWxsZXRSb3cuZ2V0KCJwcm9kdWN0TmFtZSIpIHx8ICIiCiAgICAgICAgICAgICAgY29uc3QgZWFuMTNzID0gcGFsbGV0Um93LmdldCgiZWFuMTMiKSB8fCAiIgoKICAgICAgICAgICAgICAvLyBTcGxpdCBzZW1pY29sb24tc2VwYXJhdGVkIHZhbHVlcwogICAgICAgICAgICAgIGNvbnN0IGlkc0FycmF5ID0gbm9ybWFsaXplRUFOcyhwcm9kdWN0SWRzKQogICAgICAgICAgICAgIGNvbnN0IG5hbWVzQXJyYXkgPSBwcm9kdWN0TmFtZXMKICAgICAgICAgICAgICAgIC5zcGxpdCgiOyIpCiAgICAgICAgICAgICAgICAubWFwKChuYW1lKSA9PiBuYW1lLnRyaW0oKSkKICAgICAgICAgICAgICAgIC5maWx0ZXIoKG5hbWUpID0+IG5hbWUubGVuZ3RoID4gMCkKICAgICAgICAgICAgICBjb25zdCBlYW4xM0FycmF5ID0gbm9ybWFsaXplRUFOcyhlYW4xM3MpCgogICAgICAgICAgICAgIC8vIEZpbmQgd2hpY2ggc3BlY2lmaWMgcHJvZHVjdCBtYXRjaGVzIHRoZSBzZWFyY2gKICAgICAgICAgICAgICBsZXQgbWF0Y2hpbmdJbmRleCA9IC0xCgogICAgICAgICAgICAgIC8vIEZpcnN0IHRyeSB0byBmaW5kIGV4YWN0IG1hdGNoIGluIHByb2R1Y3QgSURzCiAgICAgICAgICAgICAgbWF0Y2hpbmdJbmRleCA9IGlkc0FycmF5LmZpbmRJbmRleCgoaWQpID0+IGlkLnRvTG93ZXJDYXNlKCkgPT09IG5vcm1hbGl6ZWRFQU4pCgogICAgICAgICAgICAgIC8vIElmIG5vdCBmb3VuZCBpbiBJRHMsIHRyeSBFQU4xMwogICAgICAgICAgICAgIGlmIChtYXRjaGluZ0luZGV4ID09PSAtMSkgewogICAgICAgICAgICAgICAgbWF0Y2hpbmdJbmRleCA9IGVhbjEzQXJyYXkuZmluZEluZGV4KChlYW4xMykgPT4gZWFuMTMudG9Mb3dlckNhc2UoKSA9PT0gbm9ybWFsaXplZEVBTikKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIElmIHN0aWxsIG5vdCBmb3VuZCwgZmluZCBmaXJzdCBvY2N1cnJlbmNlIChmYWxsYmFjaykKICAgICAgICAgICAgICBpZiAobWF0Y2hpbmdJbmRleCA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIG1hdGNoaW5nSW5kZXggPSAwCiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBDcmVhdGUgcmVzdWx0IHdpdGggc3BlY2lmaWMgcHJvZHVjdCBpbmZvcm1hdGlvbgogICAgICAgICAgICAgIGNvbnN0IHNwZWNpZmljUHJvZHVjdElkID0gaWRzQXJyYXlbbWF0Y2hpbmdJbmRleF0gfHwgaWRzQXJyYXlbMF0gfHwgIiIKICAgICAgICAgICAgICBjb25zdCBzcGVjaWZpY1Byb2R1Y3ROYW1lID0gbmFtZXNBcnJheVttYXRjaGluZ0luZGV4XSB8fCBuYW1lc0FycmF5WzBdIHx8ICIiCiAgICAgICAgICAgICAgY29uc3Qgc3BlY2lmaWNFYW4xMyA9IGVhbjEzQXJyYXlbbWF0Y2hpbmdJbmRleF0gfHwgZWFuMTNBcnJheVswXSB8fCAiIgoKICAgICAgICAgICAgICByZXN1bHRzLnB1c2goewogICAgICAgICAgICAgICAgaWQ6IHBhbGxldFJvdy5nZXQoImlkIikgfHwgIiIsCiAgICAgICAgICAgICAgICBhaXNsZUlkOiBwYWxsZXRSb3cuZ2V0KCJhaXNsZUlkIikgfHwgIiIsCiAgICAgICAgICAgICAgICBwb3NpdGlvbjogcGFsbGV0Um93LmdldCgicG9zaXRpb24iKSB8fCAiMCIsCiAgICAgICAgICAgICAgICBlYW46IHNwZWNpZmljUHJvZHVjdElkLCAvLyBTcGVjaWZpYyBwcm9kdWN0IElEIHRoYXQgbWF0Y2hlcyB0aGUgc2VhcmNoCiAgICAgICAgICAgICAgICBwcm9kdWN0TmFtZTogc3BlY2lmaWNQcm9kdWN0TmFtZSwgLy8gU3BlY2lmaWMgcHJvZHVjdCBuYW1lIHRoYXQgbWF0Y2hlcwogICAgICAgICAgICAgICAgY2F0ZWdvcnk6IHBhbGxldFJvdy5nZXQoImNhdGVnb3J5IikgfHwgIiIsCiAgICAgICAgICAgICAgICBlYW4xMzogc3BlY2lmaWNFYW4xMywgLy8gU3BlY2lmaWMgRUFOMTMgdGhhdCBtYXRjaGVzCiAgICAgICAgICAgICAgICBsYXN0VmVyaWZpZWQ6IHBhbGxldFJvdy5nZXQoImxhc3RWZXJpZmllZCIpIHx8ICIiLAogICAgICAgICAgICAgICAgY3JlYXRlZEF0OiBwYWxsZXRSb3cuZ2V0KCJjcmVhdGVkQXQiKSB8fCAiIiwKICAgICAgICAgICAgICAgIGFpc2xlTmFtZTogYWlzbGVSb3cuZ2V0KCJuYW1lIikgfHwgIiIsCiAgICAgICAgICAgICAgICB3YXJlaG91c2VOYW1lOiB3YXJlaG91c2VSb3cuZ2V0KCJuYW1lIikgfHwgIiIsCiAgICAgICAgICAgICAgICBzdG9yYWdlVHlwZTogInBhbGxldCIsCiAgICAgICAgICAgICAgICAvLyBBZGQgbWV0YWRhdGEgdG8gaWRlbnRpZnkgd2hpY2ggc3BlY2lmaWMgcHJvZHVjdCB0aGlzIGlzCiAgICAgICAgICAgICAgICBwcm9kdWN0SW5kZXg6IG1hdGNoaW5nSW5kZXgsCiAgICAgICAgICAgICAgICB0b3RhbFByb2R1Y3RzOiBNYXRoLm1heChpZHNBcnJheS5sZW5ndGgsIG5hbWVzQXJyYXkubGVuZ3RoKSwKICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBQcm9jZXNzYXIgcHJhdGVsZWlyYXMKICAgICAgICBmb3IgKGNvbnN0IHNoZWxmUm93IG9mIG1hdGNoaW5nU2hlbHZlcykgewogICAgICAgICAgY29uc3QgYWlzbGVJZCA9IHNoZWxmUm93LmdldCgiYWlzbGVJZCIpCiAgICAgICAgICBjb25zdCBhaXNsZVJvdyA9IGFpc2xlUm93cy5maW5kKChyb3cpID0+IHJvdy5nZXQoImlkIikgPT09IGFpc2xlSWQpCgogICAgICAgICAgaWYgKGFpc2xlUm93KSB7CiAgICAgICAgICAgIGNvbnN0IHdhcmVob3VzZUlkID0gYWlzbGVSb3cuZ2V0KCJ3YXJlaG91c2VJZCIpCiAgICAgICAgICAgIGNvbnN0IHdhcmVob3VzZVJvdyA9IHdhcmVob3VzZVJvd3MuZmluZCgocm93KSA9PiByb3cuZ2V0KCJpZCIpID09PSB3YXJlaG91c2VJZCkKCiAgICAgICAgICAgIGlmICh3YXJlaG91c2VSb3cpIHsKICAgICAgICAgICAgICBjb25zdCBwcm9kdWN0SWRzID0gc2hlbGZSb3cuZ2V0KCJlYW4iKSB8fCAiIgogICAgICAgICAgICAgIGNvbnN0IHByb2R1Y3ROYW1lcyA9IHNoZWxmUm93LmdldCgicHJvZHVjdE5hbWUiKSB8fCAiIgogICAgICAgICAgICAgIGNvbnN0IGVhbjEzcyA9IHNoZWxmUm93LmdldCgiZWFuMTMiKSB8fCAiIgoKICAgICAgICAgICAgICAvLyBTcGxpdCBzZW1pY29sb24tc2VwYXJhdGVkIHZhbHVlcwogICAgICAgICAgICAgIGNvbnN0IGlkc0FycmF5ID0gbm9ybWFsaXplRUFOcyhwcm9kdWN0SWRzKQogICAgICAgICAgICAgIGNvbnN0IG5hbWVzQXJyYXkgPSBwcm9kdWN0TmFtZXMKICAgICAgICAgICAgICAgIC5zcGxpdCgiOyIpCiAgICAgICAgICAgICAgICAubWFwKChuYW1lKSA9PiBuYW1lLnRyaW0oKSkKICAgICAgICAgICAgICAgIC5maWx0ZXIoKG5hbWUpID0+IG5hbWUubGVuZ3RoID4gMCkKICAgICAgICAgICAgICBjb25zdCBlYW4xM0FycmF5ID0gbm9ybWFsaXplRUFOcyhlYW4xM3MpCgogICAgICAgICAgICAgIC8vIEZpbmQgd2hpY2ggc3BlY2lmaWMgcHJvZHVjdCBtYXRjaGVzIHRoZSBzZWFyY2gKICAgICAgICAgICAgICBsZXQgbWF0Y2hpbmdJbmRleCA9IC0xCgogICAgICAgICAgICAgIC8vIEZpcnN0IHRyeSB0byBmaW5kIGV4YWN0IG1hdGNoIGluIHByb2R1Y3QgSURzCiAgICAgICAgICAgICAgbWF0Y2hpbmdJbmRleCA9IGlkc0FycmF5LmZpbmRJbmRleCgoaWQpID0+IGlkLnRvTG93ZXJDYXNlKCkgPT09IG5vcm1hbGl6ZWRFQU4pCgogICAgICAgICAgICAgIC8vIElmIG5vdCBmb3VuZCBpbiBJRHMsIHRyeSBFQU4xMwogICAgICAgICAgICAgIGlmIChtYXRjaGluZ0luZGV4ID09PSAtMSkgewogICAgICAgICAgICAgICAgbWF0Y2hpbmdJbmRleCA9IGVhbjEzQXJyYXkuZmluZEluZGV4KChlYW4xMykgPT4gZWFuMTMudG9Mb3dlckNhc2UoKSA9PT0gbm9ybWFsaXplZEVBTikKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIElmIHN0aWxsIG5vdCBmb3VuZCwgZmluZCBmaXJzdCBvY2N1cnJlbmNlIChmYWxsYmFjaykKICAgICAgICAgICAgICBpZiAobWF0Y2hpbmdJbmRleCA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIG1hdGNoaW5nSW5kZXggPSAwCiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBDcmVhdGUgcmVzdWx0IHdpdGggc3BlY2lmaWMgcHJvZHVjdCBpbmZvcm1hdGlvbgogICAgICAgICAgICAgIGNvbnN0IHNwZWNpZmljUHJvZHVjdElkID0gaWRzQXJyYXlbbWF0Y2hpbmdJbmRleF0gfHwgaWRzQXJyYXlbMF0gfHwgIiIKICAgICAgICAgICAgICBjb25zdCBzcGVjaWZpY1Byb2R1Y3ROYW1lID0gbmFtZXNBcnJheVttYXRjaGluZ0luZGV4XSB8fCBuYW1lc0FycmF5WzBdIHx8ICIiCiAgICAgICAgICAgICAgY29uc3Qgc3BlY2lmaWNFYW4xMyA9IGVhbjEzQXJyYXlbbWF0Y2hpbmdJbmRleF0gfHwgZWFuMTNBcnJheVswXSB8fCAiIgoKICAgICAgICAgICAgICByZXN1bHRzLnB1c2goewogICAgICAgICAgICAgICAgaWQ6IHNoZWxmUm93LmdldCgiaWQiKSB8fCAiIiwKICAgICAgICAgICAgICAgIGFpc2xlSWQ6IHNoZWxmUm93LmdldCgiYWlzbGVJZCIpIHx8ICIiLAogICAgICAgICAgICAgICAgcG9zaXRpb246IHNoZWxmUm93LmdldCgicG9zaXRpb24iKSB8fCAiMCIsCiAgICAgICAgICAgICAgICBsZXZlbDogc2hlbGZSb3cuZ2V0KCJsZXZlbCIpIHx8ICIxIiwKICAgICAgICAgICAgICAgIGVhbjogc3BlY2lmaWNQcm9kdWN0SWQsIC8vIFNwZWNpZmljIHByb2R1Y3QgSUQgdGhhdCBtYXRjaGVzIHRoZSBzZWFyY2gKICAgICAgICAgICAgICAgIHByb2R1Y3ROYW1lOiBzcGVjaWZpY1Byb2R1Y3ROYW1lLCAvLyBTcGVjaWZpYyBwcm9kdWN0IG5hbWUgdGhhdCBtYXRjaGVzCiAgICAgICAgICAgICAgICBjYXRlZ29yeTogc2hlbGZSb3cuZ2V0KCJjYXRlZ29yeSIpIHx8ICIiLAogICAgICAgICAgICAgICAgZWFuMTM6IHNwZWNpZmljRWFuMTMsIC8vIFNwZWNpZmljIEVBTjEzIHRoYXQgbWF0Y2hlcwogICAgICAgICAgICAgICAgb2NjdXBhbmN5UGVyY2VudGFnZTogc2hlbGZSb3cuZ2V0KCJvY2N1cGFuY3lQZXJjZW50YWdlIikgfHwgIjAiLAogICAgICAgICAgICAgICAgbGFzdFZlcmlmaWVkOiBzaGVsZlJvdy5nZXQoImxhc3RWZXJpZmllZCIpIHx8ICIiLAogICAgICAgICAgICAgICAgY3JlYXRlZEF0OiBzaGVsZlJvdy5nZXQoImNyZWF0ZWRBdCIpIHx8ICIiLAogICAgICAgICAgICAgICAgYWlzbGVOYW1lOiBhaXNsZVJvdy5nZXQoIm5hbWUiKSB8fCAiIiwKICAgICAgICAgICAgICAgIHdhcmVob3VzZU5hbWU6IHdhcmVob3VzZVJvdy5nZXQoIm5hbWUiKSB8fCAiIiwKICAgICAgICAgICAgICAgIHN0b3JhZ2VUeXBlOiAic2hlbGYiLAogICAgICAgICAgICAgICAgLy8gQWRkIG1ldGFkYXRhIHRvIGlkZW50aWZ5IHdoaWNoIHNwZWNpZmljIHByb2R1Y3QgdGhpcyBpcwogICAgICAgICAgICAgICAgcHJvZHVjdEluZGV4OiBtYXRjaGluZ0luZGV4LAogICAgICAgICAgICAgICAgdG90YWxQcm9kdWN0czogTWF0aC5tYXgoaWRzQXJyYXkubGVuZ3RoLCBuYW1lc0FycmF5Lmxlbmd0aCksCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gU2FsdmFyIG5vIGNhY2hlCiAgICAgICAgYXdhaXQgcmVkaXNDYWNoZS5zZXQoY2FjaGVLZXksIHJlc3VsdHMsIENBQ0hFX1RUTC5TSE9SVCkKCiAgICAgICAgY29uc29sZS5sb2coYFtTSEVFVFNdIOKchSAke3Jlc3VsdHMubGVuZ3RofSByZXN1bHRhZG9zIGVuY29udHJhZG9zYCkKICAgICAgICByZXR1cm4gcmVzdWx0cwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYnVzY2FyIHByb2R1dG8gcG9yIEVBTjoiLCBlcnJvcikKICAgICAgICByZXR1cm4gW10KICAgICAgfQogICAgfSkKICB9CgogIGFzeW5jIGdldER1cGxpY2F0ZWRFQU5zKCk6IFByb21pc2U8U2V0PHN0cmluZz4+IHsKICAgIHJldHVybiBwZXJmb3JtYW5jZU1vbml0b3IudHJhY2tPcGVyYXRpb24oImdldER1cGxpY2F0ZWRFQU5zIiwgYXN5bmMgKCkgPT4gewogICAgICBjb25zdCBjYWNoZUtleSA9IENBQ0hFX0tFWVMuRFVQTElDQVRFRF9FQU5TCgogICAgICAvLyBUZW50YXIgYnVzY2FyIGRvIGNhY2hlIHByaW1laXJvCiAgICAgIGNvbnN0IGNhY2hlZCA9IGF3YWl0IHJlZGlzQ2FjaGUuZ2V0PHN0cmluZ1tdPihjYWNoZUtleSkKICAgICAgaWYgKGNhY2hlZCkgewogICAgICAgIHBlcmZvcm1hbmNlTW9uaXRvci5yZWNvcmRDYWNoZUhpdCgpCiAgICAgICAgcmV0dXJuIG5ldyBTZXQoY2FjaGVkKQogICAgICB9CgogICAgICBwZXJmb3JtYW5jZU1vbml0b3IucmVjb3JkQ2FjaGVNaXNzKCkKICAgICAgY29uc29sZS5sb2coIltTSEVFVFNdIEJ1c2NhbmRvIEVBTnMgZHVwbGljYWRvcy4uLiIpCgogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3QgcGFsbGV0c1NoZWV0ID0gZG9jLnNoZWV0c0J5VGl0bGVbInBhbGxldHMiXQogICAgICAgIGNvbnN0IHNoZWx2ZXNTaGVldCA9IGRvYy5zaGVldHNCeVRpdGxlWyJzaGVsdmVzIl0KICAgICAgICBjb25zdCBbcGFsbGV0Um93cywgc2hlbGZSb3dzXSA9IGF3YWl0IFByb21pc2UuYWxsKFtwYWxsZXRzU2hlZXQuZ2V0Um93cygpLCBzaGVsdmVzU2hlZXQuZ2V0Um93cygpXSkKCiAgICAgICAgY29uc3QgZWFuQ291bnRzID0gbmV3IE1hcDxzdHJpbmcsIG51bWJlcj4oKQogICAgICAgIGNvbnN0IGR1cGxpY2F0ZWRFQU5zID0gbmV3IFNldDxzdHJpbmc+KCkKCiAgICAgICAgLy8gQ29udGFyIElEcyBkb3MgcHJvZHV0b3MgZG9zIHBhbGxldHMKICAgICAgICBmb3IgKGNvbnN0IHJvdyBvZiBwYWxsZXRSb3dzKSB7CiAgICAgICAgICBjb25zdCBwcm9kdWN0SWQgPSByb3cuZ2V0KCJlYW4iKQogICAgICAgICAgaWYgKHByb2R1Y3RJZCAmJiBwcm9kdWN0SWQudHJpbSgpICE9PSAiIikgewogICAgICAgICAgICBjb25zdCBpZHMgPSBub3JtYWxpemVFQU5zKHByb2R1Y3RJZCkKICAgICAgICAgICAgZm9yIChjb25zdCBpZCBvZiBpZHMpIHsKICAgICAgICAgICAgICBjb25zdCBub3JtYWxpemVkSWQgPSBpZC50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAgICAgZWFuQ291bnRzLnNldChub3JtYWxpemVkSWQsIChlYW5Db3VudHMuZ2V0KG5vcm1hbGl6ZWRJZCkgfHwgMCkgKyAxKQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBDb250YXIgSURzIGRvcyBwcm9kdXRvcyBkYXMgcHJhdGVsZWlyYXMKICAgICAgICBmb3IgKGNvbnN0IHJvdyBvZiBzaGVsZlJvd3MpIHsKICAgICAgICAgIGNvbnN0IHByb2R1Y3RJZCA9IHJvdy5nZXQoImVhbiIpCiAgICAgICAgICBpZiAocHJvZHVjdElkICYmIHByb2R1Y3RJZC50cmltKCkgIT09ICIiKSB7CiAgICAgICAgICAgIGNvbnN0IGlkcyA9IG5vcm1hbGl6ZUVBTnMocHJvZHVjdElkKQogICAgICAgICAgICBmb3IgKGNvbnN0IGlkIG9mIGlkcykgewogICAgICAgICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRJZCA9IGlkLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICBlYW5Db3VudHMuc2V0KG5vcm1hbGl6ZWRJZCwgKGVhbkNvdW50cy5nZXQobm9ybWFsaXplZElkKSB8fCAwKSArIDEpCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZvciAoY29uc3QgW2lkLCBjb3VudF0gb2YgZWFuQ291bnRzLmVudHJpZXMoKSkgewogICAgICAgICAgaWYgKGNvdW50ID4gMSkgewogICAgICAgICAgICBkdXBsaWNhdGVkRUFOcy5hZGQoaWQpCiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBTYWx2YXIgbm8gY2FjaGUKICAgICAgICBjb25zdCBkdXBsaWNhdGVkQXJyYXkgPSBBcnJheS5mcm9tKGR1cGxpY2F0ZWRFQU5zKQogICAgICAgIGF3YWl0IHJlZGlzQ2FjaGUuc2V0KGNhY2hlS2V5LCBkdXBsaWNhdGVkQXJyYXksIENBQ0hFX1RUTC5NRURJVU0pCgogICAgICAgIGNvbnNvbGUubG9nKGBbU0hFRVRTXSDinIUgJHtkdXBsaWNhdGVkQXJyYXkubGVuZ3RofSBJRHMgZHVwbGljYWRvcyBlbmNvbnRyYWRvc2ApCiAgICAgICAgcmV0dXJuIGR1cGxpY2F0ZWRFQU5zCiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiRXJybyBhbyBidXNjYXIgSURzIGR1cGxpY2Fkb3M6IiwgZXJyb3IpCiAgICAgICAgcmV0dXJuIG5ldyBTZXQoKQogICAgICB9CiAgICB9KQogIH0KCiAgYXN5bmMgZ2V0UmVjZWl2aW5nUmVjb3JkcygpOiBQcm9taXNlPFJlY2VpdmluZ1Jvd1tdPiB7CiAgICByZXR1cm4gcGVyZm9ybWFuY2VNb25pdG9yLnRyYWNrT3BlcmF0aW9uKCJnZXRSZWNlaXZpbmdSZWNvcmRzIiwgYXN5bmMgKCkgPT4gewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsicmVjZWl2aW5nIl0KCiAgICAgICAgaWYgKCFzaGVldCkgewogICAgICAgICAgcmV0dXJuIFtdCiAgICAgICAgfQoKICAgICAgICBjb25zdCByb3dzID0gYXdhaXQgc2hlZXQuZ2V0Um93cygpCiAgICAgICAgY29uc3QgcmVjb3JkcyA9IHJvd3MubWFwKChyb3cpID0+ICh7CiAgICAgICAgICBpZDogcm93LmdldCgiaWQiKSB8fCAiIiwKICAgICAgICAgIG5mOiByb3cuZ2V0KCJuZiIpIHx8ICIiLAogICAgICAgICAgc3VwcGxpZXI6IHJvdy5nZXQoInN1cHBsaWVyIikgfHwgIiIsCiAgICAgICAgICBwYWxsZXRDb3VudDogcm93LmdldCgicGFsbGV0Q291bnQiKSB8fCAiMCIsCiAgICAgICAgICBhZGRyZXNzOiByb3cuZ2V0KCJhZGRyZXNzIikgfHwgIiIsCiAgICAgICAgICBzY2hlZHVsZWREYXRlOiByb3cuZ2V0KCJzY2hlZHVsZWREYXRlIikgfHwgIiIsCiAgICAgICAgICBzdGF0dXM6IHJvdy5nZXQoInN0YXR1cyIpIHx8ICJzY2hlZHVsZWQiLAogICAgICAgICAgcmVjZWl2ZWRBdDogcm93LmdldCgicmVjZWl2ZWRBdCIpIHx8ICIiLAogICAgICAgICAgY3JlYXRlZEF0OiByb3cuZ2V0KCJjcmVhdGVkQXQiKSB8fCAiIiwKICAgICAgICB9KSkKCiAgICAgICAgY29uc29sZS5sb2coYFtTSEVFVFNdIOKchSAke3JlY29yZHMubGVuZ3RofSByZWdpc3Ryb3MgZGUgcmVjZWJpbWVudG8gY2FycmVnYWRvc2ApCiAgICAgICAgcmV0dXJuIHJlY29yZHMKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJbU0hFRVRTXSBFcnJvIGFvIGJ1c2NhciByZWdpc3Ryb3MgZGUgcmVjZWJpbWVudG86IiwgZXJyb3IpCiAgICAgICAgdGhyb3cgZXJyb3IKICAgICAgfQogICAgfSkKICB9CgogIGFzeW5jIGFkZFJlY2VpdmluZ1JlY29yZChyZWNvcmQ6IE9taXQ8UmVjZWl2aW5nUm93LCAiaWQiIHwgImNyZWF0ZWRBdCI+KTogUHJvbWlzZTxSZWNlaXZpbmdSb3c+IHsKICAgIHJldHVybiBwZXJmb3JtYW5jZU1vbml0b3IudHJhY2tPcGVyYXRpb24oImFkZFJlY2VpdmluZ1JlY29yZCIsIGFzeW5jICgpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCB0aGlzLmluaXQoKQogICAgICAgIGNvbnN0IHNoZWV0ID0gZG9jLnNoZWV0c0J5VGl0bGVbInJlY2VpdmluZyJdCgogICAgICAgIGNvbnN0IG5ld1JlY29yZDogUmVjZWl2aW5nUm93ID0gewogICAgICAgICAgLi4ucmVjb3JkLAogICAgICAgICAgaWQ6IGBSRUMtJHtEYXRlLm5vdygpfS0ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KX1gLAogICAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICAgICAgfQoKICAgICAgICBjb25zdCBhZGRlZFJvdyA9IGF3YWl0IHNoZWV0LmFkZFJvdyhuZXdSZWNvcmQpCiAgICAgICAgYXdhaXQgYWRkZWRSb3cuc2F2ZSgpCgogICAgICAgIHJldHVybiBuZXdSZWNvcmQKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvIGFvIGFkaWNpb25hciByZWdpc3RybyBkZSByZWNlYmltZW50bzoiLCBlcnJvcikKICAgICAgICB0aHJvdyBlcnJvcgogICAgICB9CiAgICB9KQogIH0KCiAgYXN5bmMgdXBkYXRlUmVjZWl2aW5nUmVjb3JkKGlkOiBzdHJpbmcsIHVwZGF0ZXM6IFBhcnRpYWw8UmVjZWl2aW5nUm93Pik6IFByb21pc2U8Ym9vbGVhbj4gewogICAgcmV0dXJuIHBlcmZvcm1hbmNlTW9uaXRvci50cmFja09wZXJhdGlvbigidXBkYXRlUmVjZWl2aW5nUmVjb3JkIiwgYXN5bmMgKCkgPT4gewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdCgpCiAgICAgICAgY29uc3Qgc2hlZXQgPSBkb2Muc2hlZXRzQnlUaXRsZVsicmVjZWl2aW5nIl0KICAgICAgICBjb25zdCByb3dzID0gYXdhaXQgc2hlZXQuZ2V0Um93cygpCgogICAgICAgIGNvbnN0IHJvd1RvVXBkYXRlID0gcm93cy5maW5kKChyb3cpID0+IHJvdy5nZXQoImlkIikgPT09IGlkKQogICAgICAgIGlmIChyb3dUb1VwZGF0ZSkgewogICAgICAgICAgT2JqZWN0LmVudHJpZXModXBkYXRlcykuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgcm93VG9VcGRhdGUuc2V0KGtleSwgdmFsdWUpCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pCiAgICAgICAgICBhd2FpdCByb3dUb1VwZGF0ZS5zYXZlKCkKICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm8gYW8gYXR1YWxpemFyIHJlZ2lzdHJvIGRlIHJlY2ViaW1lbnRvOiIsIGVycm9yKQogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9CiAgICB9KQogIH0KfQoKZXhwb3J0IGNvbnN0IGdvb2dsZVNoZWV0c1NlcnZpY2UgPSBuZXcgR29vZ2xlU2hlZXRzU2VydmljZSgpCg=="}