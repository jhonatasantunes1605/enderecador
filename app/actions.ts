{"data":"InVzZSBzZXJ2ZXIiCgppbXBvcnQgeyByZXZhbGlkYXRlUGF0aCB9IGZyb20gIm5leHQvY2FjaGUiCmltcG9ydCB7CiAgYWRkQWlzbGUsCiAgYWRkUGFsbGV0LAogIGFkZFNoZWxmLAogIGFkZFdhcmVob3VzZSwKICB1cGRhdGVQYWxsZXQsCiAgdXBkYXRlU2hlbGYsCiAgZGVsZXRlUGFsbGV0LAogIGRlbGV0ZVNoZWxmLAogIGRlbGV0ZUFpc2xlLAogIGdldFBhbGxldHNCeUFpc2xlLAogIGdldFNoZWx2ZXNCeUFpc2xlLAogIGdldEFpc2xlQnlJZCwKICBnZXRQYWxsZXRCeUlkLAogIGdldFNoZWxmQnlJZCwKICBkZWxldGVXYXJlaG91c2UsCiAgZmluZFByb2R1Y3RCeUVBTiwKICBmaW5kV2FyZWhvdXNlSWRCeUFpc2xlSWQsCiAgdmVyaWZ5UGFsbGV0LAogIHZlcmlmeVNoZWxmLAogIHJlb3JkZXJQYWxsZXRzLAogIHVwZGF0ZUFpc2xlTm90ZXMsCiAgdXBkYXRlQWlzbGVDYXBhY2l0eSwKICB1cGRhdGVBaXNsZVN0b3JhZ2VDb25maWcsCiAgdW5hc3NpZ25Qcm9kdWN0RnJvbVBhbGxldCBhcyByZW1vdmVQcm9kdWN0RnJvbVBhbGxldE9yaWdpbmFsLAogIHVuYXNzaWduUHJvZHVjdEZyb21TaGVsZiBhcyByZW1vdmVQcm9kdWN0RnJvbVNoZWxmT3JpZ2luYWwsCiAgZmluZEJ5QWRkcmVzcywKICB0eXBlIFNlYXJjaFJlc3VsdCwKICB0eXBlIEFkZHJlc3NTZWFyY2hSZXN1bHQsCn0gZnJvbSAiQC9saWIvZGF0YSIKaW1wb3J0IHsgZGV0ZWN0UHJvZHVjdENhdGVnb3J5IH0gZnJvbSAiQC9saWIvY2F0ZWdvcnktdXRpbHMiCmltcG9ydCB7IHByb2R1Y3RzU2hlZXRzU2VydmljZSB9IGZyb20gIkAvbGliL3Byb2R1Y3RzLXNoZWV0cyIKaW1wb3J0IHsgYWRkUmVzdXBwbHlOb3RpZmljYXRpb24sIHVwZGF0ZVJlc3VwcGx5U3RhdHVzLCB0eXBlIFJlc3VwcGx5Tm90aWZpY2F0aW9uIH0gZnJvbSAiQC9saWIvcmVzdXBwbHktZGF0YSIKaW1wb3J0IHsgRGF0YVZhbGlkYXRvciwgVmFsaWRhdGlvbkVycm9yIH0gZnJvbSAiQC9saWIvZGF0YS12YWxpZGF0aW9uIgoKLy8gRnVuw6fDo28gaGVscGVyIHBhcmEgcmV2YWxpZGHDp8OjbyBkZSBwYXRocwpmdW5jdGlvbiByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMod2FyZWhvdXNlSWQ/OiBzdHJpbmcpIHsKICByZXZhbGlkYXRlUGF0aCgiLyIpCiAgcmV2YWxpZGF0ZVBhdGgoIi9yZXN1cHBseSIpCiAgaWYgKHdhcmVob3VzZUlkKSB7CiAgICByZXZhbGlkYXRlUGF0aChgL3dhcmVob3VzZXMvJHt3YXJlaG91c2VJZH1gKQogIH0KfQoKLy8gRnVuw6fDo28gaGVscGVyIHBhcmEgdHJhdGFtZW50byBkZSBlcnJvcwpmdW5jdGlvbiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvcjogdW5rbm93biwgb3BlcmF0aW9uOiBzdHJpbmcpIHsKICBjb25zb2xlLmVycm9yKGBbQUNUSU9OXSBFcnJvIGVtICR7b3BlcmF0aW9ufTpgLCBlcnJvcikKCiAgaWYgKGVycm9yIGluc3RhbmNlb2YgVmFsaWRhdGlvbkVycm9yKSB7CiAgICByZXR1cm4geyBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLCBzdWNjZXNzOiBmYWxzZSB9CiAgfQoKICBjb25zdCBlcnJvck1lc3NhZ2UgPSBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICJFcnJvIGRlc2NvbmhlY2lkbyIKICByZXR1cm4geyBtZXNzYWdlOiBgRXJybyBlbSAke29wZXJhdGlvbn06ICR7ZXJyb3JNZXNzYWdlfWAsIHN1Y2Nlc3M6IGZhbHNlIH0KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVdhcmVob3VzZShwcmV2U3RhdGU6IGFueSwgZm9ybURhdGE6IEZvcm1EYXRhKSB7CiAgdHJ5IHsKICAgIGNvbnN0IG5hbWUgPSBmb3JtRGF0YS5nZXQoIm5hbWUiKSBhcyBzdHJpbmcKCiAgICAvLyBWYWxpZGHDp8OjbyB1c2FuZG8gRGF0YVZhbGlkYXRvcgogICAgY29uc3QgdmFsaWRhdGlvbiA9IERhdGFWYWxpZGF0b3IudmFsaWRhdGVXYXJlaG91c2UoeyBuYW1lIH0pCiAgICBpZiAoIXZhbGlkYXRpb24uaXNWYWxpZCkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiB2YWxpZGF0aW9uLmVycm9yc1swXS5tZXNzYWdlLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgYXdhaXQgYWRkV2FyZWhvdXNlKG5hbWUudHJpbSgpKQogICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKCkKICAgIHJldHVybiB7IG1lc3NhZ2U6ICJHYWxww6NvIGNyaWFkbyBjb20gc3VjZXNzbyEiLCBzdWNjZXNzOiB0cnVlIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAiY3JpYXIgZ2FscMOjbyIpCiAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlQWlzbGUod2FyZWhvdXNlSWQ6IHN0cmluZywgcHJldlN0YXRlOiBhbnksIGZvcm1EYXRhOiBGb3JtRGF0YSkgewogIHRyeSB7CiAgICBjb25zdCBuYW1lID0gZm9ybURhdGEuZ2V0KCJuYW1lIikgYXMgc3RyaW5nCiAgICBjb25zdCBub3RlcyA9IGZvcm1EYXRhLmdldCgibm90ZXMiKSBhcyBzdHJpbmcgfCBudWxsCiAgICBjb25zdCBjYXBhY2l0eSA9IE51bWJlcihmb3JtRGF0YS5nZXQoImNhcGFjaXR5IikpIHx8IDAKICAgIGNvbnN0IHN0b3JhZ2VUeXBlID0gKGZvcm1EYXRhLmdldCgic3RvcmFnZVR5cGUiKSBhcyAicGFsbGV0IiB8ICJzaGVsZiIpIHx8ICJwYWxsZXQiCiAgICBjb25zdCBzaGVsZkxldmVscyA9IE51bWJlcihmb3JtRGF0YS5nZXQoInNoZWxmTGV2ZWxzIikpIHx8IDEKCiAgICAvLyBWYWxpZGHDp8OjbyB1c2FuZG8gRGF0YVZhbGlkYXRvcgogICAgY29uc3QgdmFsaWRhdGlvbiA9IERhdGFWYWxpZGF0b3IudmFsaWRhdGVBaXNsZSh7CiAgICAgIG5hbWUsCiAgICAgIHdhcmVob3VzZUlkLAogICAgICBzdG9yYWdlVHlwZSwKICAgICAgY2FwYWNpdHksCiAgICAgIHNoZWxmTGV2ZWxzLAogICAgfSkKICAgIGlmICghdmFsaWRhdGlvbi5pc1ZhbGlkKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6IHZhbGlkYXRpb24uZXJyb3JzWzBdLm1lc3NhZ2UsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBhd2FpdCBhZGRBaXNsZSh3YXJlaG91c2VJZCwgbmFtZS50cmltKCksIG5vdGVzPy50cmltKCkgfHwgbnVsbCwgY2FwYWNpdHksIHN0b3JhZ2VUeXBlLCBzaGVsZkxldmVscykKICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyh3YXJlaG91c2VJZCkKICAgIHJldHVybiB7IG1lc3NhZ2U6ICJSdWEgY3JpYWRhIGNvbSBzdWNlc3NvISIsIHN1Y2Nlc3M6IHRydWUgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gaGFuZGxlQWN0aW9uRXJyb3IoZXJyb3IsICJjcmlhciBydWEiKQogIH0KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGFkZFNpbmdsZVBhbGxldChhaXNsZUlkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3QgdmFsaWRhdGlvbiA9IERhdGFWYWxpZGF0b3IudmFsaWRhdGVBaXNsZSh7IG5hbWU6ICJkdW1teSIsIHdhcmVob3VzZUlkOiAiZHVtbXkiLCBzdG9yYWdlVHlwZTogInBhbGxldCIgfSkgLy8gU2ltcGxpZmllZCB2YWxpZGF0aW9uIGZvciBhaXNsZUlkIHByZXNlbmNlCiAgICBpZiAoIWFpc2xlSWQgfHwgYWlzbGVJZC50cmltKCkgPT09ICIiKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJJRCBkYSBydWEgw6kgb2JyaWdhdMOzcmlvLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZChhaXNsZUlkKQogICAgaWYgKCFhaXNsZSkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiUnVhIG7Do28gZW5jb250cmFkYS4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgaWYgKGFpc2xlLnN0b3JhZ2VUeXBlICE9PSAicGFsbGV0IikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiRXN0YSBydWEgbsOjbyDDqSBjb25maWd1cmFkYSBwYXJhIHBhbGV0ZXMuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IGV4aXN0aW5nUGFsbGV0cyA9IGF3YWl0IGdldFBhbGxldHNCeUFpc2xlKGFpc2xlSWQpCiAgICBjb25zdCBuZXh0UG9zaXRpb24gPSBleGlzdGluZ1BhbGxldHMubGVuZ3RoID4gMCA/IE1hdGgubWF4KC4uLmV4aXN0aW5nUGFsbGV0cy5tYXAoKHApID0+IHAucG9zaXRpb24pKSArIDEgOiAxCgogICAgYXdhaXQgYWRkUGFsbGV0KGFpc2xlSWQsIG5leHRQb3NpdGlvbikKICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyhhaXNsZS53YXJlaG91c2VJZCkKICAgIHJldHVybiB7IG1lc3NhZ2U6IGBQYWxldGUgJHtuZXh0UG9zaXRpb259IGFkaWNpb25hZG8gY29tIHN1Y2Vzc28hYCwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImFkaWNpb25hciBwYWxldGUiKQogIH0KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGFkZFNpbmdsZVNoZWxmKGFpc2xlSWQ6IHN0cmluZywgcHJldlN0YXRlOiBhbnksIGZvcm1EYXRhOiBGb3JtRGF0YSkgewogIHRyeSB7CiAgICBjb25zdCB2YWxpZGF0aW9uID0gRGF0YVZhbGlkYXRvci52YWxpZGF0ZUFpc2xlKHsgbmFtZTogImR1bW15Iiwgd2FyZWhvdXNlSWQ6ICJkdW1teSIsIHN0b3JhZ2VUeXBlOiAic2hlbGYiIH0pIC8vIFNpbXBsaWZpZWQgdmFsaWRhdGlvbiBmb3IgYWlzbGVJZCBwcmVzZW5jZQogICAgaWYgKCFhaXNsZUlkIHx8IGFpc2xlSWQudHJpbSgpID09PSAiIikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiSUQgZGEgcnVhIMOpIG9icmlnYXTDs3Jpby4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgYWRkRXh0cmFMZXZlbCA9IGZvcm1EYXRhLmdldCgiYWRkRXh0cmFMZXZlbCIpID09PSAidHJ1ZSIKICAgIGNvbnN0IHByb3ZpZGVkUG9zaXRpb24gPSBmb3JtRGF0YS5nZXQoInBvc2l0aW9uIikKCiAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZChhaXNsZUlkKQogICAgaWYgKCFhaXNsZSkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiUnVhIG7Do28gZW5jb250cmFkYS4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgaWYgKGFpc2xlLnN0b3JhZ2VUeXBlICE9PSAic2hlbGYiKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJFc3RhIHJ1YSBuw6NvIMOpIGNvbmZpZ3VyYWRhIHBhcmEgcHJhdGVsZWlyYXMuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IGV4aXN0aW5nU2hlbHZlcyA9IGF3YWl0IGdldFNoZWx2ZXNCeUFpc2xlKGFpc2xlSWQpCgogICAgbGV0IHRhcmdldFBvc2l0aW9uOiBudW1iZXIKICAgIGxldCBsZXZlbHNUb0NyZWF0ZTogbnVtYmVyCgogICAgaWYgKGFkZEV4dHJhTGV2ZWwgJiYgcHJvdmlkZWRQb3NpdGlvbikgewogICAgICB0YXJnZXRQb3NpdGlvbiA9IE51bWJlcihwcm92aWRlZFBvc2l0aW9uKQoKICAgICAgY29uc3QgZXhpc3RpbmdMZXZlbHNBdFBvc2l0aW9uID0gZXhpc3RpbmdTaGVsdmVzLmZpbHRlcigocykgPT4gcy5wb3NpdGlvbiA9PT0gdGFyZ2V0UG9zaXRpb24pCiAgICAgIGNvbnN0IG1heExldmVsID0KICAgICAgICBleGlzdGluZ0xldmVsc0F0UG9zaXRpb24ubGVuZ3RoID4gMCA/IE1hdGgubWF4KC4uLmV4aXN0aW5nTGV2ZWxzQXRQb3NpdGlvbi5tYXAoKHMpID0+IHMubGV2ZWwpKSA6IDAKCiAgICAgIGF3YWl0IGFkZFNoZWxmKGFpc2xlSWQsIHRhcmdldFBvc2l0aW9uLCBtYXhMZXZlbCArIDEpCgogICAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoYWlzbGUud2FyZWhvdXNlSWQpCgogICAgICBjb25zdCB0b3RhbExldmVscyA9IG1heExldmVsICsgMQogICAgICByZXR1cm4gewogICAgICAgIG1lc3NhZ2U6IGBBbmRhciBleHRyYSBhZGljaW9uYWRvIMOgIHByYXRlbGVpcmEgJHt0YXJnZXRQb3NpdGlvbn0gY29tIHN1Y2Vzc28hICgke3RvdGFsTGV2ZWxzfSBhbmRhcmVzIHRvdGFsKWAsCiAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgcG9zaXRpb25zID0gZXhpc3RpbmdTaGVsdmVzLm1hcCgocykgPT4gcy5wb3NpdGlvbikKICAgICAgdGFyZ2V0UG9zaXRpb24gPSBwb3NpdGlvbnMubGVuZ3RoID4gMCA/IE1hdGgubWF4KC4uLnBvc2l0aW9ucykgKyAxIDogMQogICAgICBsZXZlbHNUb0NyZWF0ZSA9IGFpc2xlLnNoZWxmTGV2ZWxzCgogICAgICBmb3IgKGxldCBsZXZlbCA9IDE7IGxldmVsIDw9IGxldmVsc1RvQ3JlYXRlOyBsZXZlbCsrKSB7CiAgICAgICAgYXdhaXQgYWRkU2hlbGYoYWlzbGVJZCwgdGFyZ2V0UG9zaXRpb24sIGxldmVsKQogICAgICB9CgogICAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoYWlzbGUud2FyZWhvdXNlSWQpCgogICAgICByZXR1cm4gewogICAgICAgIG1lc3NhZ2U6IGBQcmF0ZWxlaXJhICR7dGFyZ2V0UG9zaXRpb259IGNvbSAke2xldmVsc1RvQ3JlYXRlfSBhbmRhcmVzIGFkaWNpb25hZGEgY29tIHN1Y2Vzc28hYCwKICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICB9CiAgICB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImFkaWNpb25hciBwcmF0ZWxlaXJhIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhZGRQYWxsZXRzVG9BaXNsZShhaXNsZUlkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3QgY291bnQgPSBOdW1iZXIoZm9ybURhdGEuZ2V0KCJjb3VudCIpKQoKICAgIGlmICghY291bnQgfHwgY291bnQgPD0gMCB8fCBjb3VudCA+IDUwKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJOw7ptZXJvIGRlIHBhbGV0ZXMgZGV2ZSBlc3RhciBlbnRyZSAxIGUgNTAuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IHZhbGlkYXRpb24gPSBEYXRhVmFsaWRhdG9yLnZhbGlkYXRlQWlzbGUoeyBuYW1lOiAiZHVtbXkiLCB3YXJlaG91c2VJZDogImR1bW15Iiwgc3RvcmFnZVR5cGU6ICJwYWxsZXQiIH0pIC8vIFNpbXBsaWZpZWQgdmFsaWRhdGlvbiBmb3IgYWlzbGVJZCBwcmVzZW5jZQogICAgaWYgKCFhaXNsZUlkIHx8IGFpc2xlSWQudHJpbSgpID09PSAiIikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiSUQgZGEgcnVhIMOpIG9icmlnYXTDs3Jpby4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgYWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQoYWlzbGVJZCkKICAgIGlmICghYWlzbGUpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlJ1YSBuw6NvIGVuY29udHJhZGEuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGlmIChhaXNsZS5zdG9yYWdlVHlwZSAhPT0gInBhbGxldCIpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIkVzdGEgcnVhIG7Do28gw6kgY29uZmlndXJhZGEgcGFyYSBwYWxldGVzLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBleGlzdGluZ1BhbGxldHMgPSBhd2FpdCBnZXRQYWxsZXRzQnlBaXNsZShhaXNsZUlkKQogICAgbGV0IG5leHRQb3NpdGlvbiA9IGV4aXN0aW5nUGFsbGV0cy5sZW5ndGggPiAwID8gTWF0aC5tYXgoLi4uZXhpc3RpbmdQYWxsZXRzLm1hcCgocCkgPT4gcC5wb3NpdGlvbikpICsgMSA6IDEKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgYXdhaXQgYWRkUGFsbGV0KGFpc2xlSWQsIG5leHRQb3NpdGlvbisrKQogICAgfQoKICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyhhaXNsZS53YXJlaG91c2VJZCkKICAgIHJldHVybiB7IG1lc3NhZ2U6IGAke2NvdW50fSBwYWxldGVzIGFkaWNpb25hZG9zIGNvbSBzdWNlc3NvIWAsIHN1Y2Nlc3M6IHRydWUgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gaGFuZGxlQWN0aW9uRXJyb3IoZXJyb3IsICJhZGljaW9uYXIgcGFsZXRlcyIpCiAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gYWRkU2hlbHZlc1RvQWlzbGUoYWlzbGVJZDogc3RyaW5nLCBwcmV2U3RhdGU6IGFueSwgZm9ybURhdGE6IEZvcm1EYXRhKSB7CiAgdHJ5IHsKICAgIGNvbnN0IGNvdW50ID0gTnVtYmVyKGZvcm1EYXRhLmdldCgiY291bnQiKSkKCiAgICBpZiAoIWNvdW50IHx8IGNvdW50IDw9IDAgfHwgY291bnQgPiA1MCkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiTsO6bWVybyBkZSBwcmF0ZWxlaXJhcyBkZXZlIGVzdGFyIGVudHJlIDEgZSA1MC4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgdmFsaWRhdGlvbiA9IERhdGFWYWxpZGF0b3IudmFsaWRhdGVBaXNsZSh7IG5hbWU6ICJkdW1teSIsIHdhcmVob3VzZUlkOiAiZHVtbXkiLCBzdG9yYWdlVHlwZTogInNoZWxmIiB9KSAvLyBTaW1wbGlmaWVkIHZhbGlkYXRpb24gZm9yIGFpc2xlSWQgcHJlc2VuY2UKICAgIGlmICghYWlzbGVJZCB8fCBhaXNsZUlkLnRyaW0oKSA9PT0gIiIpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIklEIGRhIHJ1YSDDqSBvYnJpZ2F0w7NyaW8uIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IGFpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKGFpc2xlSWQpCiAgICBpZiAoIWFpc2xlKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJSdWEgbsOjbyBlbmNvbnRyYWRhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBpZiAoYWlzbGUuc3RvcmFnZVR5cGUgIT09ICJzaGVsZiIpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIkVzdGEgcnVhIG7Do28gw6kgY29uZmlndXJhZGEgcGFyYSBwcmF0ZWxlaXJhcy4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgZXhpc3RpbmdTaGVsdmVzID0gYXdhaXQgZ2V0U2hlbHZlc0J5QWlzbGUoYWlzbGVJZCkKICAgIGNvbnN0IHBvc2l0aW9ucyA9IGV4aXN0aW5nU2hlbHZlcy5tYXAoKHMpID0+IHMucG9zaXRpb24pCiAgICBsZXQgbmV4dFBvc2l0aW9uID0gcG9zaXRpb25zLmxlbmd0aCA+IDAgPyBNYXRoLm1heCguLi5wb3NpdGlvbnMpICsgMSA6IDEKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgLy8gQ3JpYXIgdG9kb3Mgb3MgYW5kYXJlcyBwYXJhIGNhZGEgcHJhdGVsZWlyYQogICAgICBmb3IgKGxldCBsZXZlbCA9IDE7IGxldmVsIDw9IGFpc2xlLnNoZWxmTGV2ZWxzOyBsZXZlbCsrKSB7CiAgICAgICAgYXdhaXQgYWRkU2hlbGYoYWlzbGVJZCwgbmV4dFBvc2l0aW9uLCBsZXZlbCkKICAgICAgfQogICAgICBuZXh0UG9zaXRpb24rKwogICAgfQoKICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyhhaXNsZS53YXJlaG91c2VJZCkKICAgIHJldHVybiB7CiAgICAgIG1lc3NhZ2U6IGAke2NvdW50fSBwcmF0ZWxlaXJhcyBjb20gJHthaXNsZS5zaGVsZkxldmVsc30gYW5kYXJlcyBjYWRhIGFkaWNpb25hZGFzIGNvbSBzdWNlc3NvIWAsCiAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImFkaWNpb25hciBwcmF0ZWxlaXJhcyIpCiAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlQWlzbGVOb3Rlc0FjdGlvbihhaXNsZUlkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3Qgbm90ZXMgPSBmb3JtRGF0YS5nZXQoIm5vdGVzIikgYXMgc3RyaW5nCgogICAgY29uc3QgdmFsaWRhdGlvbiA9IERhdGFWYWxpZGF0b3IudmFsaWRhdGVBaXNsZSh7IG5hbWU6ICJkdW1teSIsIHdhcmVob3VzZUlkOiAiZHVtbXkiLCBzdG9yYWdlVHlwZTogInBhbGxldCIgfSkgLy8gU2ltcGxpZmllZCB2YWxpZGF0aW9uIGZvciBhaXNsZUlkIHByZXNlbmNlCiAgICBpZiAoIWFpc2xlSWQgfHwgYWlzbGVJZC50cmltKCkgPT09ICIiKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJJRCBkYSBydWEgw6kgb2JyaWdhdMOzcmlvLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBleGlzdGluZ0Fpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKGFpc2xlSWQpCiAgICBpZiAoIWV4aXN0aW5nQWlzbGUpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlJ1YSBuw6NvIGVuY29udHJhZGEuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCB1cGRhdGVBaXNsZU5vdGVzKGFpc2xlSWQsIG5vdGVzIHx8ICIiKQogICAgaWYgKCF1cGRhdGVkKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJGYWxoYSBhbyBhdHVhbGl6YXIgb2JzZXJ2YcOnw7Vlcy4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKGV4aXN0aW5nQWlzbGUud2FyZWhvdXNlSWQpCiAgICByZXR1cm4geyBtZXNzYWdlOiAiT2JzZXJ2YcOnw7VlcyBhdHVhbGl6YWRhcyBjb20gc3VjZXNzbyEiLCBzdWNjZXNzOiB0cnVlIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAiYXR1YWxpemFyIG9ic2VydmHDp8O1ZXMiKQogIH0KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUFpc2xlU3RvcmFnZUNvbmZpZ0FjdGlvbihhaXNsZUlkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3Qgc3RvcmFnZVR5cGUgPSBmb3JtRGF0YS5nZXQoInN0b3JhZ2VUeXBlIikgYXMgInBhbGxldCIgfCAic2hlbGYiCiAgICBjb25zdCBzaGVsZkxldmVscyA9IE51bWJlcihmb3JtRGF0YS5nZXQoInNoZWxmTGV2ZWxzIikpIHx8IDEKCiAgICBjb25zdCB2YWxpZGF0aW9uID0gRGF0YVZhbGlkYXRvci52YWxpZGF0ZUFpc2xlKHsgbmFtZTogImR1bW15Iiwgd2FyZWhvdXNlSWQ6ICJkdW1teSIsIHN0b3JhZ2VUeXBlIH0pIC8vIFNpbXBsaWZpZWQgdmFsaWRhdGlvbiBmb3IgYWlzbGVJZCBwcmVzZW5jZQogICAgaWYgKCFhaXNsZUlkIHx8IGFpc2xlSWQudHJpbSgpID09PSAiIikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiSUQgZGEgcnVhIMOpIG9icmlnYXTDs3Jpby4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgaWYgKCFbInBhbGxldCIsICJzaGVsZiJdLmluY2x1ZGVzKHN0b3JhZ2VUeXBlKSkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiVGlwbyBkZSBhcm1hemVuYW1lbnRvIGludsOhbGlkby4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgaWYgKHN0b3JhZ2VUeXBlID09PSAic2hlbGYiICYmIChzaGVsZkxldmVscyA8IDEgfHwgc2hlbGZMZXZlbHMgPiAxMCkpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIk7Dum1lcm8gZGUgYW5kYXJlcyBkZXZlIGVzdGFyIGVudHJlIDEgZSAxMC4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgZXhpc3RpbmdBaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZChhaXNsZUlkKQogICAgaWYgKCFleGlzdGluZ0Fpc2xlKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJSdWEgbsOjbyBlbmNvbnRyYWRhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgdXBkYXRlQWlzbGVTdG9yYWdlQ29uZmlnKGFpc2xlSWQsIHN0b3JhZ2VUeXBlLCBzaGVsZkxldmVscykKICAgIGlmICghdXBkYXRlZCkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiRmFsaGEgYW8gYXR1YWxpemFyIGNvbmZpZ3VyYcOnw6NvLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoZXhpc3RpbmdBaXNsZS53YXJlaG91c2VJZCkKICAgIHJldHVybiB7IG1lc3NhZ2U6ICJDb25maWd1cmHDp8OjbyBhdHVhbGl6YWRhIGNvbSBzdWNlc3NvISIsIHN1Y2Nlc3M6IHRydWUgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gaGFuZGxlQWN0aW9uRXJyb3IoZXJyb3IsICJhdHVhbGl6YXIgY29uZmlndXJhw6fDo28iKQogIH0KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZVBhbGxldEFjdGlvbihwYWxsZXRJZDogc3RyaW5nLCBwcmV2U3RhdGU6IGFueSwgZm9ybURhdGE6IEZvcm1EYXRhKSB7CiAgdHJ5IHsKICAgIGNvbnN0IHZhbGlkYXRpb24gPSBEYXRhVmFsaWRhdG9yLnZhbGlkYXRlUHJvZHVjdCh7IGVhbjogImR1bW15IiwgcHJvZHVjdE5hbWU6ICJkdW1teSIgfSkgLy8gU2ltcGxpZmllZCB2YWxpZGF0aW9uIGZvciBwYWxsZXRJZCBwcmVzZW5jZQogICAgaWYgKCFwYWxsZXRJZCB8fCBwYWxsZXRJZC50cmltKCkgPT09ICIiKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJJRCBkbyBwYWxldGUgw6kgb2JyaWdhdMOzcmlvLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBwYWxsZXQgPSBhd2FpdCBnZXRQYWxsZXRCeUlkKHBhbGxldElkKQogICAgaWYgKCFwYWxsZXQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlBhbGV0ZSBuw6NvIGVuY29udHJhZG8uIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IGFpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKHBhbGxldC5haXNsZUlkKQogICAgaWYgKCFhaXNsZSkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiUnVhIG7Do28gZW5jb250cmFkYS4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgZGVsZXRlZCA9IGF3YWl0IGRlbGV0ZVBhbGxldChwYWxsZXRJZCkKICAgIGlmICghZGVsZXRlZCkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiRmFsaGEgYW8gZXhjbHVpciBwYWxldGUuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyhhaXNsZS53YXJlaG91c2VJZCkKICAgIHJldHVybiB7IG1lc3NhZ2U6IGBQYWxldGUgJHtwYWxsZXQucG9zaXRpb259IGV4Y2x1w61kbyBjb20gc3VjZXNzbyFgLCBzdWNjZXNzOiB0cnVlIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAiZXhjbHVpciBwYWxldGUiKQogIH0KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZVNoZWxmQWN0aW9uKHNoZWxmSWQ6IHN0cmluZywgcHJldlN0YXRlOiBhbnksIGZvcm1EYXRhOiBGb3JtRGF0YSkgewogIHRyeSB7CiAgICBjb25zdCB2YWxpZGF0aW9uID0gRGF0YVZhbGlkYXRvci52YWxpZGF0ZVByb2R1Y3QoeyBlYW46ICJkdW1teSIsIHByb2R1Y3ROYW1lOiAiZHVtbXkiIH0pIC8vIFNpbXBsaWZpZWQgdmFsaWRhdGlvbiBmb3Igc2hlbGZJZCBwcmVzZW5jZQogICAgaWYgKCFzaGVsZklkIHx8IHNoZWxmSWQudHJpbSgpID09PSAiIikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiSUQgZGEgcHJhdGVsZWlyYSDDqSBvYnJpZ2F0w7NyaW8uIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IHNoZWxmID0gYXdhaXQgZ2V0U2hlbGZCeUlkKHNoZWxmSWQpCiAgICBpZiAoIXNoZWxmKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJQcmF0ZWxlaXJhIG7Do28gZW5jb250cmFkYS4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgYWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQoc2hlbGYuYWlzbGVJZCkKICAgIGlmICghYWlzbGUpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlJ1YSBuw6NvIGVuY29udHJhZGEuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIC8vIFNlIGZvciBvIHByaW1laXJvIGFuZGFyIChBMSksIGV4Y2x1aXIgdG9kYSBhIHByYXRlbGVpcmEgKHRvZG9zIG9zIGFuZGFyZXMpCiAgICBpZiAoc2hlbGYubGV2ZWwgPT09IDEpIHsKICAgICAgLy8gQnVzY2FyIHRvZG9zIG9zIGFuZGFyZXMgZGVzdGEgcHJhdGVsZWlyYQogICAgICBjb25zdCBhbGxTaGVsdmVzID0gYXdhaXQgZ2V0U2hlbHZlc0J5QWlzbGUoc2hlbGYuYWlzbGVJZCkKICAgICAgY29uc3Qgc2hlbHZlc1RvRGVsZXRlID0gYWxsU2hlbHZlcy5maWx0ZXIoKHMpID0+IHMucG9zaXRpb24gPT09IHNoZWxmLnBvc2l0aW9uKQoKICAgICAgLy8gRXhjbHVpciB0b2RvcyBvcyBhbmRhcmVzCiAgICAgIGxldCBkZWxldGVkQ291bnQgPSAwCiAgICAgIGZvciAoY29uc3Qgc2hlbGZUb0RlbGV0ZSBvZiBzaGVsdmVzVG9EZWxldGUpIHsKICAgICAgICBjb25zdCBkZWxldGVkID0gYXdhaXQgZGVsZXRlU2hlbGYoc2hlbGZUb0RlbGV0ZS5pZCkKICAgICAgICBpZiAoZGVsZXRlZCkgewogICAgICAgICAgZGVsZXRlZENvdW50KysKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChkZWxldGVkQ291bnQgPiAwKSB7CiAgICAgICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKGFpc2xlLndhcmVob3VzZUlkKQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBtZXNzYWdlOiBgUHJhdGVsZWlyYSAke3NoZWxmLnBvc2l0aW9ufSBjb21wbGV0YSAoJHtkZWxldGVkQ291bnR9IGFuZGFyZXMpIGV4Y2x1w61kYSBjb20gc3VjZXNzbyFgLAogICAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJPcGVyYcOnw6NvIG7Do28gcGVybWl0aWRhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICByZXR1cm4geyBtZXNzYWdlOiAiRmFsaGEgYW8gZXhjbHVpciBwcmF0ZWxlaXJhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAiZXhjbHVpciBwcmF0ZWxlaXJhIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWxldGVXYXJlaG91c2VBY3Rpb24od2FyZWhvdXNlSWQ6IHN0cmluZywgcHJldlN0YXRlOiBhbnksIGZvcm1EYXRhOiBGb3JtRGF0YSkgewogIHRyeSB7CiAgICBjb25zdCB2YWxpZGF0aW9uID0gRGF0YVZhbGlkYXRvci52YWxpZGF0ZVdhcmVob3VzZSh7IG5hbWU6ICJkdW1teSIgfSkgLy8gU2ltcGxpZmllZCB2YWxpZGF0aW9uIGZvciB3YXJlaG91c2VJZCBwcmVzZW5jZQogICAgaWYgKCF3YXJlaG91c2VJZCB8fCB3YXJlaG91c2VJZC50cmltKCkgPT09ICIiKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJJRCBkbyBnYWxww6NvIMOpIG9icmlnYXTDs3Jpby4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgZGVsZXRlZCA9IGF3YWl0IGRlbGV0ZVdhcmVob3VzZSh3YXJlaG91c2VJZCkKICAgIGlmICghZGVsZXRlZCkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiRmFsaGEgYW8gZXhjbHVpciBnYWxww6NvLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoKQogICAgcmV0dXJuIHsgbWVzc2FnZTogIkdhbHDDo28gZXhjbHXDrWRvIGNvbSBzdWNlc3NvISIsIHN1Y2Nlc3M6IHRydWUgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gaGFuZGxlQWN0aW9uRXJyb3IoZXJyb3IsICJleGNsdWlyIGdhbHDDo28iKQogIH0KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUFpc2xlQWN0aW9uKGFpc2xlSWQ6IHN0cmluZywgcHJldlN0YXRlOiBhbnksIGZvcm1EYXRhOiBGb3JtRGF0YSkgewogIHRyeSB7CiAgICBjb25zdCB2YWxpZGF0aW9uID0gRGF0YVZhbGlkYXRvci52YWxpZGF0ZUFpc2xlKHsgbmFtZTogImR1bW15Iiwgd2FyZWhvdXNlSWQ6ICJkdW1teSIsIHN0b3JhZ2VUeXBlOiAicGFsbGV0IiB9KSAvLyBTaW1wbGlmaWVkIHZhbGlkYXRpb24gZm9yIGFpc2xlSWQgcHJlc2VuY2UKICAgIGlmICghYWlzbGVJZCB8fCBhaXNsZUlkLnRyaW0oKSA9PT0gIiIpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIklEIGRhIHJ1YSDDqSBvYnJpZ2F0w7NyaW8uIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IGFpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKGFpc2xlSWQpCiAgICBpZiAoIWFpc2xlKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJSdWEgbsOjbyBlbmNvbnRyYWRhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBkZWxldGVkID0gYXdhaXQgZGVsZXRlQWlzbGUoYWlzbGVJZCkKICAgIGlmICghZGVsZXRlZCkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiRmFsaGEgYW8gZXhjbHVpciBydWEuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyhhaXNsZS53YXJlaG91c2VJZCkKICAgIHJldHVybiB7IG1lc3NhZ2U6IGBSdWEgIiR7YWlzbGUubmFtZX0iIGV4Y2x1w61kYSBjb20gc3VjZXNzbyFgLCBzdWNjZXNzOiB0cnVlIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAiZXhjbHVpciBydWEiKQogIH0KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGFzc2lnblByb2R1Y3RUb1BhbGxldChwYWxsZXRJZDogc3RyaW5nLCBwcmV2U3RhdGU6IGFueSwgZm9ybURhdGE6IEZvcm1EYXRhKSB7CiAgY29uc29sZS5sb2coIvCfmoAgW0FDVElPTl0gYXNzaWduUHJvZHVjdFRvUGFsbGV0IGluaWNpYWRhIikKICBjb25zb2xlLmxvZygi8J+TnSBQYXLDom1ldHJvcyByZWNlYmlkb3M6IiwgewogICAgcGFsbGV0SWQsCiAgICBwcmV2U3RhdGUsCiAgICBmb3JtRGF0YUVudHJpZXM6IE9iamVjdC5mcm9tRW50cmllcyhmb3JtRGF0YS5lbnRyaWVzKCkpLAogIH0pCgogIHRyeSB7CiAgICBjb25zdCBlYW4gPSBmb3JtRGF0YS5nZXQoImVhbiIpIGFzIHN0cmluZyAvLyBFc3RlIMOpIG8gSUQgZG8gcHJvZHV0byAoY29sdW5hIEUpCiAgICBjb25zdCBwcm9kdWN0TmFtZSA9IGZvcm1EYXRhLmdldCgicHJvZHVjdE5hbWUiKSBhcyBzdHJpbmcKICAgIGNvbnN0IHByb2R1Y3RDYXRlZ29yeSA9IGZvcm1EYXRhLmdldCgicHJvZHVjdENhdGVnb3J5IikgYXMgc3RyaW5nCiAgICBjb25zdCBwcm9kdWN0QnJhbmQgPSBmb3JtRGF0YS5nZXQoInByb2R1Y3RCcmFuZCIpIGFzIHN0cmluZwogICAgY29uc3QgcHJvZHVjdEVhbiA9IGZvcm1EYXRhLmdldCgicHJvZHVjdEVhbiIpIGFzIHN0cmluZyAvLyBFc3RlIMOpIG8gRUFOIHJlYWwgKGNvbHVuYSBBKSAtIGFnb3JhIHNlcsOhIHNhbHZvIGNvbW8gRUFOMTMKCiAgICBjb25zb2xlLmxvZygi8J+TiyBEYWRvcyBleHRyYcOtZG9zIGRvIEZvcm1EYXRhOiIsIHsKICAgICAgZWFuLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgIHByb2R1Y3ROYW1lLAogICAgICBwcm9kdWN0Q2F0ZWdvcnksCiAgICAgIHByb2R1Y3RCcmFuZCwKICAgICAgcHJvZHVjdEVhbiwgLy8gRUFOIHJlYWwgcXVlIHNlcsOhIHNhbHZvIGNvbW8gRUFOMTMKICAgIH0pCgogICAgLy8gVmFsaWRhw6fDo28gdXNhbmRvIERhdGFWYWxpZGF0b3IKICAgIGNvbnN0IHZhbGlkYXRpb24gPSBEYXRhVmFsaWRhdG9yLnZhbGlkYXRlUHJvZHVjdCh7IGVhbiwgcHJvZHVjdE5hbWUgfSkKICAgIGlmICghdmFsaWRhdGlvbi5pc1ZhbGlkKSB7CiAgICAgIGNvbnNvbGUubG9nKCLinYwgRXJybyBkZSB2YWxpZGHDp8OjbzoiLCB2YWxpZGF0aW9uLmVycm9yc1swXS5tZXNzYWdlKQogICAgICByZXR1cm4geyBtZXNzYWdlOiB2YWxpZGF0aW9uLmVycm9yc1swXS5tZXNzYWdlLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgLy8gVXNhciBjYXRlZ29yaWEgZGEgcGxhbmlsaGEgc2UgZGlzcG9uw612ZWwsIHNlbsOjbyB1c2FyIGRldGVjw6fDo28gYXV0b23DoXRpY2EKICAgIGNvbnN0IGZpbmFsQ2F0ZWdvcnkgPQogICAgICBwcm9kdWN0Q2F0ZWdvcnkgJiYgcHJvZHVjdENhdGVnb3J5LnRyaW0oKSAhPT0gIiIKICAgICAgICA/IHByb2R1Y3RDYXRlZ29yeS50b1VwcGVyQ2FzZSgpCiAgICAgICAgOiBkZXRlY3RQcm9kdWN0Q2F0ZWdvcnkocHJvZHVjdE5hbWUpCgogICAgY29uc29sZS5sb2coIvCfj7fvuI8gQ2F0ZWdvcmlhIGZpbmFsIGRldGVybWluYWRhOiIsIGZpbmFsQ2F0ZWdvcnkpCgogICAgY29uc29sZS5sb2coIvCfkr4gQ2hhbWFuZG8gdXBkYXRlUGFsbGV0IGNvbSBkYWRvczoiLCB7CiAgICAgIHBhbGxldElkLAogICAgICBlYW46IGVhbi50cmltKCksIC8vIElEIGRvIHByb2R1dG8KICAgICAgcHJvZHVjdE5hbWU6IHByb2R1Y3ROYW1lLnRyaW0oKSwKICAgICAgZmluYWxDYXRlZ29yeSwKICAgICAgZWFuMTM6IHByb2R1Y3RFYW4/LnRyaW0oKSB8fCAiIiwgLy8gRUFOIHJlYWwgZG8gcHJvZHV0byAoRUFOMTMpCiAgICB9KQoKICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCB1cGRhdGVQYWxsZXQoCiAgICAgIHBhbGxldElkLAogICAgICBlYW4udHJpbSgpLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgIHByb2R1Y3ROYW1lLnRyaW0oKSwKICAgICAgZmluYWxDYXRlZ29yeSwKICAgICAgcHJvZHVjdEVhbj8udHJpbSgpIHx8ICIiLCAvLyBFQU4gcmVhbCBkbyBwcm9kdXRvIChFQU4xMykKICAgICkKCiAgICBjb25zb2xlLmxvZygi8J+TiiBSZXN1bHRhZG8gZG8gdXBkYXRlUGFsbGV0OiIsIHVwZGF0ZWQpCgogICAgaWYgKCF1cGRhdGVkKSB7CiAgICAgIGNvbnNvbGUubG9nKCLinYwgUGFsZXRlIG7Do28gZW5jb250cmFkbyIpCiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJQYWxldGUgbsOjbyBlbmNvbnRyYWRvLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zb2xlLmxvZygi4pyFIFBhbGV0ZSBhdHVhbGl6YWRvIGNvbSBzdWNlc3NvISIpCgogICAgY29uc3QgYWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQodXBkYXRlZC5haXNsZUlkKQogICAgY29uc29sZS5sb2coIvCfj6IgQWlzbGUgZW5jb250cmFkYToiLCBhaXNsZSkKCiAgICBpZiAoYWlzbGU/LndhcmVob3VzZUlkKSB7CiAgICAgIGNvbnNvbGUubG9nKCLwn5SEIFJldmFsaWRhbmRvIHBhdGhzIHBhcmEgd2FyZWhvdXNlOiIsIGFpc2xlLndhcmVob3VzZUlkKQogICAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoYWlzbGUud2FyZWhvdXNlSWQpCiAgICB9CgogICAgY29uc3Qgc3VjY2Vzc01lc3NhZ2UgPSAiUHJvZHV0byBhdHJpYnXDrWRvIGNvbSBzdWNlc3NvISIKICAgIGNvbnNvbGUubG9nKCLwn46JIFJldG9ybmFuZG8gc3VjZXNzbzoiLCBzdWNjZXNzTWVzc2FnZSkKCiAgICByZXR1cm4geyBtZXNzYWdlOiBzdWNjZXNzTWVzc2FnZSwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImF0cmlidWlyIHByb2R1dG8iKQogIH0KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGFzc2lnblByb2R1Y3RUb1NoZWxmKHNoZWxmSWQ6IHN0cmluZywgcHJldlN0YXRlOiBhbnksIGZvcm1EYXRhOiBGb3JtRGF0YSkgewogIGNvbnNvbGUubG9nKCLwn5qAIFtBQ1RJT05dIGFzc2lnblByb2R1Y3RUb1NoZWxmIGluaWNpYWRhIikKICBjb25zb2xlLmxvZygi8J+TnSBQYXLDom1ldHJvcyByZWNlYmlkb3M6IiwgewogICAgc2hlbGZJZCwKICAgIHByZXZTdGF0ZSwKICAgIGZvcm1EYXRhRW50cmllczogT2JqZWN0LmZyb21FbnRyaWVzKGZvcm1EYXRhLmVudHJpZXMoKSksCiAgfSkKCiAgdHJ5IHsKICAgIGNvbnN0IGVhbiA9IGZvcm1EYXRhLmdldCgiZWFuIikgYXMgc3RyaW5nIC8vIEVzdGUgw6kgbyBJRCBkbyBwcm9kdXRvIChjb2x1bmEgRSkKICAgIGNvbnN0IHByb2R1Y3ROYW1lID0gZm9ybURhdGEuZ2V0KCJwcm9kdWN0TmFtZSIpIGFzIHN0cmluZwogICAgY29uc3Qgb2NjdXBhbmN5UGVyY2VudGFnZSA9IE51bWJlcihmb3JtRGF0YS5nZXQoIm9jY3VwYW5jeVBlcmNlbnRhZ2UiKSkgfHwgMjUKICAgIGNvbnN0IHByb2R1Y3RDYXRlZ29yeSA9IGZvcm1EYXRhLmdldCgicHJvZHVjdENhdGVnb3J5IikgYXMgc3RyaW5nCiAgICBjb25zdCBwcm9kdWN0QnJhbmQgPSBmb3JtRGF0YS5nZXQoInByb2R1Y3RCcmFuZCIpIGFzIHN0cmluZwogICAgY29uc3QgcHJvZHVjdEVhbiA9IGZvcm1EYXRhLmdldCgicHJvZHVjdEVhbiIpIGFzIHN0cmluZyAvLyBFc3RlIMOpIG8gRUFOIHJlYWwgKGNvbHVuYSBBKSAtIGFnb3JhIHNlcsOhIHNhbHZvIGNvbW8gRUFOMTMKCiAgICBjb25zb2xlLmxvZygi8J+TiyBEYWRvcyBleHRyYcOtZG9zIGRvIEZvcm1EYXRhOiIsIHsKICAgICAgZWFuLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgIHByb2R1Y3ROYW1lLAogICAgICBvY2N1cGFuY3lQZXJjZW50YWdlLAogICAgICBwcm9kdWN0Q2F0ZWdvcnksCiAgICAgIHByb2R1Y3RCcmFuZCwKICAgICAgcHJvZHVjdEVhbiwgLy8gRUFOIHJlYWwgcXVlIHNlcsOhIHNhbHZvIGNvbW8gRUFOMTMKICAgIH0pCgogICAgLy8gVmFsaWRhw6fDo28gdXNhbmRvIERhdGFWYWxpZGF0b3IKICAgIGNvbnN0IHZhbGlkYXRpb24gPSBEYXRhVmFsaWRhdG9yLnZhbGlkYXRlUHJvZHVjdCh7IGVhbiwgcHJvZHVjdE5hbWUsIG9jY3VwYW5jeVBlcmNlbnRhZ2UgfSkKICAgIGlmICghdmFsaWRhdGlvbi5pc1ZhbGlkKSB7CiAgICAgIGNvbnNvbGUubG9nKCLinYwgRXJybyBkZSB2YWxpZGHDp8OjbzoiLCB2YWxpZGF0aW9uLmVycm9yc1swXS5tZXNzYWdlKQogICAgICByZXR1cm4geyBtZXNzYWdlOiB2YWxpZGF0aW9uLmVycm9yc1swXS5tZXNzYWdlLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgLy8gVXNhciBjYXRlZ29yaWEgZGEgcGxhbmlsaGEgc2UgZGlzcG9uw612ZWwsIHNlbsOjbyB1c2FyIGRldGVjw6fDo28gYXV0b23DoXRpY2EKICAgIGNvbnN0IGZpbmFsQ2F0ZWdvcnkgPQogICAgICBwcm9kdWN0Q2F0ZWdvcnkgJiYgcHJvZHVjdENhdGVnb3J5LnRyaW0oKSAhPT0gIiIKICAgICAgICA/IHByb2R1Y3RDYXRlZ29yeS50b1VwcGVyQ2FzZSgpCiAgICAgICAgOiBkZXRlY3RQcm9kdWN0Q2F0ZWdvcnkocHJvZHVjdE5hbWUpCgogICAgY29uc29sZS5sb2coIvCfj7fvuI8gQ2F0ZWdvcmlhIGZpbmFsIGRldGVybWluYWRhOiIsIGZpbmFsQ2F0ZWdvcnkpCgogICAgY29uc29sZS5sb2coIvCfkr4gQ2hhbWFuZG8gdXBkYXRlU2hlbGYgY29tIGRhZG9zOiIsIHsKICAgICAgc2hlbGZJZCwKICAgICAgZWFuOiBlYW4udHJpbSgpLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgIHByb2R1Y3ROYW1lOiBwcm9kdWN0TmFtZS50cmltKCksCiAgICAgIG9jY3VwYW5jeVBlcmNlbnRhZ2UsCiAgICAgIGZpbmFsQ2F0ZWdvcnksCiAgICAgIGVhbjEzOiBwcm9kdWN0RWFuPy50cmltKCkgfHwgIiIsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8KICAgIH0pCgogICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHVwZGF0ZVNoZWxmKAogICAgICBzaGVsZklkLAogICAgICBlYW4udHJpbSgpLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgIHByb2R1Y3ROYW1lLnRyaW0oKSwKICAgICAgb2NjdXBhbmN5UGVyY2VudGFnZSwKICAgICAgZmluYWxDYXRlZ29yeSwKICAgICAgcHJvZHVjdEVhbj8udHJpbSgpIHx8ICIiLCAvLyBFQU4gcmVhbCBkbyBwcm9kdXRvIChFQU4xMykKICAgICkKCiAgICBjb25zb2xlLmxvZygi8J+TiiBSZXN1bHRhZG8gZG8gdXBkYXRlU2hlbGY6IiwgdXBkYXRlZCkKCiAgICBpZiAoIXVwZGF0ZWQpIHsKICAgICAgY29uc29sZS5sb2coIuKdjCBQcmF0ZWxlaXJhIG7Do28gZW5jb250cmFkYSIpCiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJQcmF0ZWxlaXJhIG7Do28gZW5jb250cmFkYS4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc29sZS5sb2coIuKchSBQcmF0ZWxlaXJhIGF0dWFsaXphZGEgY29tIHN1Y2Vzc28hIikKCiAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZCh1cGRhdGVkLmFpc2xlSWQpCiAgICBjb25zb2xlLmxvZygi8J+PoiBBaXNsZSBlbmNvbnRyYWRhOiIsIGFpc2xlKQoKICAgIGlmIChhaXNsZT8ud2FyZWhvdXNlSWQpIHsKICAgICAgY29uc29sZS5sb2coIvCflIQgUmV2YWxpZGFuZG8gcGF0aHMgcGFyYSB3YXJlaG91c2U6IiwgYWlzbGUud2FyZWhvdXNlSWQpCiAgICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyhhaXNsZS53YXJlaG91c2VJZCkKICAgIH0KCiAgICBjb25zdCBzdWNjZXNzTWVzc2FnZSA9ICJQcm9kdXRvIGF0cmlidcOtZG8gY29tIHN1Y2Vzc28hIgogICAgY29uc29sZS5sb2coIvCfjokgUmV0b3JuYW5kbyBzdWNlc3NvOiIsIHN1Y2Nlc3NNZXNzYWdlKQoKICAgIHJldHVybiB7IG1lc3NhZ2U6IHN1Y2Nlc3NNZXNzYWdlLCBzdWNjZXNzOiB0cnVlIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAiYXRyaWJ1aXIgcHJvZHV0byIpCiAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gdmVyaWZ5UGFsbGV0QWN0aW9uKHBhbGxldElkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3QgdmFsaWRhdGlvbiA9IERhdGFWYWxpZGF0b3IudmFsaWRhdGVQcm9kdWN0KHsgZWFuOiAiZHVtbXkiLCBwcm9kdWN0TmFtZTogImR1bW15IiB9KSAvLyBTaW1wbGlmaWVkIHZhbGlkYXRpb24gZm9yIHBhbGxldElkIHByZXNlbmNlCiAgICBpZiAoIXBhbGxldElkIHx8IHBhbGxldElkLnRyaW0oKSA9PT0gIiIpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIklEIGRvIHBhbGV0ZSDDqSBvYnJpZ2F0w7NyaW8uIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCB2ZXJpZnlQYWxsZXQocGFsbGV0SWQpCiAgICBpZiAoIXVwZGF0ZWQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlBhbGV0ZSBuw6NvIGVuY29udHJhZG8uIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IGFpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKHVwZGF0ZWQuYWlzbGVJZCkKICAgIGlmIChhaXNsZT8ud2FyZWhvdXNlSWQpIHsKICAgICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKGFpc2xlLndhcmVob3VzZUlkKQogICAgfQoKICAgIHJldHVybiB7IG1lc3NhZ2U6ICJQYWxldGUgdmVyaWZpY2FkbyBjb20gc3VjZXNzbyEiLCBzdWNjZXNzOiB0cnVlIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAidmVyaWZpY2FyIHBhbGV0ZSIpCiAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gdmVyaWZ5U2hlbGZBY3Rpb24oc2hlbGZJZDogc3RyaW5nLCBwcmV2U3RhdGU6IGFueSwgZm9ybURhdGE6IEZvcm1EYXRhKSB7CiAgdHJ5IHsKICAgIGNvbnN0IHZhbGlkYXRpb24gPSBEYXRhVmFsaWRhdG9yLnZhbGlkYXRlUHJvZHVjdCh7IGVhbjogImR1bW15IiwgcHJvZHVjdE5hbWU6ICJkdW1teSIgfSkgLy8gU2ltcGxpZmllZCB2YWxpZGF0aW9uIGZvciBzaGVsZklkIHByZXNlbmNlCiAgICBpZiAoIXNoZWxmSWQgfHwgc2hlbGZJZC50cmltKCkgPT09ICIiKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJJRCBkYSBwcmF0ZWxlaXJhIMOpIG9icmlnYXTDs3Jpby4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHZlcmlmeVNoZWxmKHNoZWxmSWQpCiAgICBpZiAoIXVwZGF0ZWQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlByYXRlbGVpcmEgbsOjbyBlbmNvbnRyYWRhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZCh1cGRhdGVkLmFpc2xlSWQpCiAgICBpZiAoYWlzbGU/LndhcmVob3VzZUlkKSB7CiAgICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyhhaXNsZS53YXJlaG91c2VJZCkKICAgIH0KCiAgICByZXR1cm4geyBtZXNzYWdlOiAiUHJhdGVsZWlyYSB2ZXJpZmljYWRhIGNvbSBzdWNlc3NvISIsIHN1Y2Nlc3M6IHRydWUgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gaGFuZGxlQWN0aW9uRXJyb3IoZXJyb3IsICJ2ZXJpZmljYXIgcHJhdGVsZWlyYSIpCiAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVvcmRlclBhbGxldHNBY3Rpb24oCiAgYWlzbGVJZDogc3RyaW5nLAogIG5ld1BhbGxldE9yZGVySWRzOiBzdHJpbmdbXSwKKTogUHJvbWlzZTx7IG1lc3NhZ2U6IHN0cmluZzsgc3VjY2VzczogYm9vbGVhbiB9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IHZhbGlkYXRpb24gPSBEYXRhVmFsaWRhdG9yLnZhbGlkYXRlQWlzbGUoeyBuYW1lOiAiZHVtbXkiLCB3YXJlaG91c2VJZDogImR1bW15Iiwgc3RvcmFnZVR5cGU6ICJwYWxsZXQiIH0pIC8vIFNpbXBsaWZpZWQgdmFsaWRhdGlvbiBmb3IgYWlzbGVJZCBwcmVzZW5jZQogICAgaWYgKCFhaXNsZUlkIHx8IGFpc2xlSWQudHJpbSgpID09PSAiIikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiSUQgZGEgcnVhIMOpIG9icmlnYXTDs3Jpby4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgaWYgKCFBcnJheS5pc0FycmF5KG5ld1BhbGxldE9yZGVySWRzKSB8fCBuZXdQYWxsZXRPcmRlcklkcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIkxpc3RhIGRlIHBhbGV0ZXMgaW52w6FsaWRhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgcmVvcmRlclBhbGxldHMoYWlzbGVJZCwgbmV3UGFsbGV0T3JkZXJJZHMpCiAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIkZhbGhhIGFvIHJlb3JkZW5hciBwYWxldGVzLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZChhaXNsZUlkKQogICAgaWYgKGFpc2xlPy53YXJlaG91c2VJZCkgewogICAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoYWlzbGUud2FyZWhvdXNlSWQpCiAgICB9CgogICAgcmV0dXJuIHsgbWVzc2FnZTogIlBhbGV0ZXMgcmVvcmRlbmFkb3MgY29tIHN1Y2Vzc28hIiwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgInJlb3JkZW5hciBwYWxldGVzIikKICB9Cn0KCmludGVyZmFjZSBTZWFyY2hTdGF0ZSB7CiAgbWVzc2FnZTogc3RyaW5nCiAgc3VjY2VzczogYm9vbGVhbgogIHJlc3VsdHM/OiBTZWFyY2hSZXN1bHRbXQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gc2VhcmNoUHJvZHVjdEJ5RUFOKHByZXZTdGF0ZTogU2VhcmNoU3RhdGUsIGZvcm1EYXRhOiBGb3JtRGF0YSk6IFByb21pc2U8U2VhcmNoU3RhdGU+IHsKICB0cnkgewogICAgY29uc3Qgc2VhcmNoVGVybSA9IGZvcm1EYXRhLmdldCgiZWFuIikgYXMgc3RyaW5nCgogICAgaWYgKCFzZWFyY2hUZXJtIHx8IHNlYXJjaFRlcm0udHJpbSgpID09PSAiIikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiUG9yIGZhdm9yLCBpbnNpcmEgdW0gRUFOIG91IElEIHBhcmEgcGVzcXVpc2FyLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICAvLyBWYWxpZGHDp8OjbyBkbyBFQU4KICAgIGNvbnN0IHZhbGlkYXRpb24gPSBEYXRhVmFsaWRhdG9yLnZhbGlkYXRlRUFOKHNlYXJjaFRlcm0pCiAgICBpZiAoIXZhbGlkYXRpb24uaXNWYWxpZCkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiB2YWxpZGF0aW9uLmVycm9yc1swXS5tZXNzYWdlLCBzdWNjZXNzOiBmYWxzZSwgcmVzdWx0czogW10gfQogICAgfQoKICAgIGNvbnNvbGUubG9nKGBbQUNUSU9OXSBCdXNjYW5kbyBwcm9kdXRvIGNvbSB0ZXJtbzogIiR7c2VhcmNoVGVybX0iYCkKCiAgICAvLyBQcmltZWlybyB0ZW50YXIgYnVzY2FyIHBvciBJRCAoY29sdW5hIEUpIC0gYnVzY2EgZXhhdGEgbm8gc2lzdGVtYSBpbnRlcm5vCiAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IGZpbmRQcm9kdWN0QnlFQU4oc2VhcmNoVGVybS50cmltKCkpCgogICAgLy8gU2UgbsOjbyBlbmNvbnRyb3UgcG9yIElELCB0ZW50YXIgYnVzY2FyIHBvciBFQU4gcmVhbCBuYSBwbGFuaWxoYSBkZSBwcm9kdXRvcwogICAgaWYgKHJlc3VsdHMubGVuZ3RoID09PSAwKSB7CiAgICAgIGNvbnNvbGUubG9nKGBbQUNUSU9OXSBOw6NvIGVuY29udHJhZG8gcG9yIElELCB0ZW50YW5kbyBidXNjYXIgcG9yIEVBTiBuYSBwbGFuaWxoYS4uLmApCgogICAgICB0cnkgewogICAgICAgIC8vIEJ1c2NhciBuYSBwbGFuaWxoYSBkZSBwcm9kdXRvcyBwb3IgRUFOCiAgICAgICAgY29uc3QgcHJvZHVjdCA9IGF3YWl0IHByb2R1Y3RzU2hlZXRzU2VydmljZS5maW5kUHJvZHVjdEJ5RUFOKHNlYXJjaFRlcm0udHJpbSgpKQoKICAgICAgICBpZiAocHJvZHVjdCAmJiBwcm9kdWN0LmlkKSB7CiAgICAgICAgICBjb25zb2xlLmxvZyhgW0FDVElPTl0gUHJvZHV0byBlbmNvbnRyYWRvIG5hIHBsYW5pbGhhIHBvciBFQU4sIGJ1c2NhbmRvIHBvciBJRDogJHtwcm9kdWN0LmlkfWApCiAgICAgICAgICAvLyBTZSBlbmNvbnRyb3UgbmEgcGxhbmlsaGEsIGJ1c2NhciBubyBzaXN0ZW1hIHVzYW5kbyBvIElECiAgICAgICAgICByZXN1bHRzID0gYXdhaXQgZmluZFByb2R1Y3RCeUVBTihwcm9kdWN0LmlkKQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJbQUNUSU9OXSBFcnJvIGFvIGJ1c2NhciBuYSBwbGFuaWxoYSBkZSBwcm9kdXRvczoiLCBlcnJvcikKICAgICAgfQogICAgfQoKICAgIC8vIEJ1c2NhciB3YXJlaG91c2UgSUQgcGFyYSBjYWRhIHJlc3VsdGFkbwogICAgY29uc3QgcmVzdWx0c1dpdGhXYXJlaG91c2VJZCA9IGF3YWl0IFByb21pc2UuYWxsKAogICAgICByZXN1bHRzLm1hcChhc3luYyAocmVzdWx0KSA9PiB7CiAgICAgICAgY29uc3Qgd2FyZWhvdXNlSWQgPSBhd2FpdCBmaW5kV2FyZWhvdXNlSWRCeUFpc2xlSWQocmVzdWx0LmFpc2xlSWQpCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIC4uLnJlc3VsdCwKICAgICAgICAgIHdhcmVob3VzZUlkLAogICAgICAgIH0KICAgICAgfSksCiAgICApCgogICAgaWYgKHJlc3VsdHNXaXRoV2FyZWhvdXNlSWQubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6IGBOZW5odW0gcHJvZHV0byBlbmNvbnRyYWRvIGNvbSBvIHRlcm1vOiAke3NlYXJjaFRlcm19YCwgc3VjY2VzczogdHJ1ZSwgcmVzdWx0czogW10gfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIG1lc3NhZ2U6IGAke3Jlc3VsdHNXaXRoV2FyZWhvdXNlSWQubGVuZ3RofSBwcm9kdXRvKHMpIGVuY29udHJhZG8ocykuYCwKICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgcmVzdWx0czogcmVzdWx0c1dpdGhXYXJlaG91c2VJZCwKICAgIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcigiW0FDVElPTl0gRXJybyBhbyBidXNjYXIgcHJvZHV0bzoiLCBlcnJvcikKICAgIHJldHVybiB7IG1lc3NhZ2U6ICJFcnJvIGFvIGJ1c2NhciBwcm9kdXRvLiBUZW50ZSBub3ZhbWVudGUuIiwgc3VjY2VzczogZmFsc2UsIHJlc3VsdHM6IFtdIH0KICB9Cn0KCmludGVyZmFjZSBBZGRyZXNzU2VhcmNoU3RhdGUgewogIG1lc3NhZ2U6IHN0cmluZwogIHN1Y2Nlc3M6IGJvb2xlYW4KICByZXN1bHQ/OiBBZGRyZXNzU2VhcmNoUmVzdWx0IHwgbnVsbAp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gc2VhcmNoQnlBZGRyZXNzKHByZXZTdGF0ZTogQWRkcmVzc1NlYXJjaFN0YXRlLCBmb3JtRGF0YTogRm9ybURhdGEpOiBQcm9taXNlPEFkZHJlc3NTZWFyY2hTdGF0ZT4gewogIHRyeSB7CiAgICBjb25zdCBhZGRyZXNzID0gZm9ybURhdGEuZ2V0KCJhZGRyZXNzIikgYXMgc3RyaW5nCgogICAgaWYgKCFhZGRyZXNzIHx8IGFkZHJlc3MudHJpbSgpID09PSAiIikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiUG9yIGZhdm9yLCBpbnNpcmEgdW0gZW5kZXJlw6dvIHBhcmEgcGVzcXVpc2FyLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICAvLyBWYWxpZGHDp8OjbyBkbyBlbmRlcmXDp28KICAgIGNvbnN0IHZhbGlkYXRpb24gPSBEYXRhVmFsaWRhdG9yLnZhbGlkYXRlQWRkcmVzcyhhZGRyZXNzKQogICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogdmFsaWRhdGlvbi5lcnJvcnNbMF0ubWVzc2FnZSwgc3VjY2VzczogZmFsc2UsIHJlc3VsdDogbnVsbCB9CiAgICB9CgogICAgY29uc29sZS5sb2coYFtBQ1RJT05dIEJ1c2NhbmRvIGVuZGVyZcOnbzogIiR7YWRkcmVzc30iYCkKCiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmaW5kQnlBZGRyZXNzKGFkZHJlc3MudHJpbSgpKQoKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgbWVzc2FnZTogYEVuZGVyZcOnbyBuw6NvIGVuY29udHJhZG86ICR7YWRkcmVzc30uIFZlcmlmaXF1ZSBvIGZvcm1hdG8gKGV4OiBBMTdSMVAyIG91IEExN1IxUDJBMSkuYCwKICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICByZXN1bHQ6IG51bGwsCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gewogICAgICBtZXNzYWdlOiAiRW5kZXJlw6dvIGVuY29udHJhZG8gY29tIHN1Y2Vzc28hIiwKICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgcmVzdWx0OiByZXN1bHQsCiAgICB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImJ1c2NhciBlbmRlcmXDp28iKSBhcyBBZGRyZXNzU2VhcmNoU3RhdGUKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVBaXNsZUNhcGFjaXR5QWN0aW9uKGFpc2xlSWQ6IHN0cmluZywgcHJldlN0YXRlOiBhbnksIGZvcm1EYXRhOiBGb3JtRGF0YSkgewogIHRyeSB7CiAgICBjb25zdCBjYXBhY2l0eSA9IE51bWJlcihmb3JtRGF0YS5nZXQoImNhcGFjaXR5IikpCgogICAgY29uc3QgdmFsaWRhdGlvbiA9IERhdGFWYWxpZGF0b3IudmFsaWRhdGVBaXNsZSh7IG5hbWU6ICJkdW1teSIsIHdhcmVob3VzZUlkOiAiZHVtbXkiLCBzdG9yYWdlVHlwZTogInBhbGxldCIgfSkgLy8gU2ltcGxpZmllZCB2YWxpZGF0aW9uIGZvciBhaXNsZUlkIHByZXNlbmNlCiAgICBpZiAoIWFpc2xlSWQgfHwgYWlzbGVJZC50cmltKCkgPT09ICIiKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJJRCBkYSBydWEgw6kgb2JyaWdhdMOzcmlvLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBpZiAoaXNOYU4oY2FwYWNpdHkpIHx8IGNhcGFjaXR5IDwgMCkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiQ2FwYWNpZGFkZSBpbnbDoWxpZGEuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IGV4aXN0aW5nQWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQoYWlzbGVJZCkKICAgIGlmICghZXhpc3RpbmdBaXNsZSkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiUnVhIG7Do28gZW5jb250cmFkYS4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHVwZGF0ZUFpc2xlQ2FwYWNpdHkoYWlzbGVJZCwgY2FwYWNpdHkpCiAgICBpZiAoIXVwZGF0ZWQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIkZhbGhhIGFvIGF0dWFsaXphciBjYXBhY2lkYWRlLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoZXhpc3RpbmdBaXNsZS53YXJlaG91c2VJZCkKICAgIHJldHVybiB7IG1lc3NhZ2U6ICJDYXBhY2lkYWRlIGF0dWFsaXphZGEgY29tIHN1Y2Vzc28hIiwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImF0dWFsaXphciBjYXBhY2lkYWRlIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1bmFzc2lnblByb2R1Y3RGcm9tUGFsbGV0KHBhbGxldElkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3QgdmFsaWRhdGlvbiA9IERhdGFWYWxpZGF0b3IudmFsaWRhdGVQcm9kdWN0KHsgZWFuOiAiZHVtbXkiLCBwcm9kdWN0TmFtZTogImR1bW15IiB9KSAvLyBTaW1wbGlmaWVkIHZhbGlkYXRpb24gZm9yIHBhbGxldElkIHByZXNlbmNlCiAgICBpZiAoIXBhbGxldElkIHx8IHBhbGxldElkLnRyaW0oKSA9PT0gIiIpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIklEIGRvIHBhbGV0ZSDDqSBvYnJpZ2F0w7NyaW8uIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCByZW1vdmVQcm9kdWN0RnJvbVBhbGxldE9yaWdpbmFsKHBhbGxldElkKQogICAgaWYgKCF1cGRhdGVkKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJQYWxldGUgbsOjbyBlbmNvbnRyYWRvLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZCh1cGRhdGVkLmFpc2xlSWQpCiAgICBpZiAoYWlzbGU/LndhcmVob3VzZUlkKSB7CiAgICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyhhaXNsZS53YXJlaG91c2VJZCkKICAgIH0KCiAgICByZXR1cm4geyBtZXNzYWdlOiAiUHJvZHV0byByZW1vdmlkbyBkbyBwYWxldGUgY29tIHN1Y2Vzc28hIiwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgInJlbW92ZXIgcHJvZHV0byBkbyBwYWxldGUiKQogIH0KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVuYXNzaWduUHJvZHVjdEZyb21TaGVsZihzaGVsZklkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3QgdmFsaWRhdGlvbiA9IERhdGFWYWxpZGF0b3IudmFsaWRhdGVQcm9kdWN0KHsgZWFuOiAiZHVtbXkiLCBwcm9kdWN0TmFtZTogImR1bW15IiB9KSAvLyBTaW1wbGlmaWVkIHZhbGlkYXRpb24gZm9yIHNoZWxmSWQgcHJlc2VuY2UKICAgIGlmICghc2hlbGZJZCB8fCBzaGVsZklkLnRyaW0oKSA9PT0gIiIpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIklEIGRhIHByYXRlbGVpcmEgw6kgb2JyaWdhdMOzcmlvLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgcmVtb3ZlUHJvZHVjdEZyb21TaGVsZk9yaWdpbmFsKHNoZWxmSWQpCiAgICBpZiAoIXVwZGF0ZWQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlByYXRlbGVpcmEgbsOjbyBlbmNvbnRyYWRhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZCh1cGRhdGVkLmFpc2xlSWQpCiAgICBpZiAoYWlzbGU/LndhcmVob3VzZUlkKSB7CiAgICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyhhaXNsZS53YXJlaG91c2VJZCkKICAgIH0KCiAgICByZXR1cm4geyBtZXNzYWdlOiAiUHJvZHV0byByZW1vdmlkbyBkYSBwcmF0ZWxlaXJhIGNvbSBzdWNlc3NvISIsIHN1Y2Nlc3M6IHRydWUgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gaGFuZGxlQWN0aW9uRXJyb3IoZXJyb3IsICJyZW1vdmVyIHByb2R1dG8gZGEgcHJhdGVsZWlyYSIpCiAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gY2xlYXJQcm9kdWN0c0Zyb21BaXNsZXMoYWlzbGVJZHM6IHN0cmluZ1tdKTogUHJvbWlzZTx7IG1lc3NhZ2U6IHN0cmluZzsgc3VjY2VzczogYm9vbGVhbiB9PnsKICB0cnkgewogICAgaWYgKCFBcnJheS5pc0FycmF5KGFpc2xlSWRzKSB8fCBhaXNsZUlkcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIk5lbmh1bWEgcnVhIHNlbGVjaW9uYWRhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBsZXQgY2xlYXJlZCA9IDAKICAgIGNvbnN0IHdhcmVob3VzZXNUb1JldmFsaWRhdGUgPSBuZXcgU2V0PHN0cmluZz4oKQoKICAgIGZvciAoY29uc3QgYWlzbGVJZCBvZiBhaXNsZUlkcykgewogICAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZChhaXNsZUlkKQogICAgICBpZiAoIWFpc2xlKSBjb250aW51ZQogICAgICBpZiAoYWlzbGUud2FyZWhvdXNlSWQpIHdhcmVob3VzZXNUb1JldmFsaWRhdGUuYWRkKGFpc2xlLndhcmVob3VzZUlkKQoKICAgICAgaWYgKGFpc2xlLnN0b3JhZ2VUeXBlID09PSAicGFsbGV0IikgewogICAgICAgIGNvbnN0IHBhbGxldHMgPSBhd2FpdCBnZXRQYWxsZXRzQnlBaXNsZShhaXNsZUlkKQogICAgICAgIGZvciAoY29uc3QgcCBvZiBwYWxsZXRzKSB7CiAgICAgICAgICBpZiAoKHAuZWFuICYmIHAuZWFuLnRyaW0oKSAhPT0gIiIpIHx8IChwLnByb2R1Y3ROYW1lICYmIHAucHJvZHVjdE5hbWUudHJpbSgpICE9PSAiIikpIHsKICAgICAgICAgICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHJlbW92ZVByb2R1Y3RGcm9tUGFsbGV0T3JpZ2luYWwocC5pZCkKICAgICAgICAgICAgaWYgKHVwZGF0ZWQpIGNsZWFyZWQrKwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBzaGVsdmVzID0gYXdhaXQgZ2V0U2hlbHZlc0J5QWlzbGUoYWlzbGVJZCkKICAgICAgICBmb3IgKGNvbnN0IHMgb2Ygc2hlbHZlcykgewogICAgICAgICAgaWYgKChzLmVhbiAmJiBzLmVhbi50cmltKCkgIT09ICIiKSB8fCAocy5wcm9kdWN0TmFtZSAmJiBzLnByb2R1Y3ROYW1lLnRyaW0oKSAhPT0gIiIpKSB7CiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCByZW1vdmVQcm9kdWN0RnJvbVNoZWxmT3JpZ2luYWwocy5pZCkKICAgICAgICAgICAgaWYgKHVwZGF0ZWQpIGNsZWFyZWQrKwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZvciAoY29uc3Qgd2lkIG9mIHdhcmVob3VzZXNUb1JldmFsaWRhdGUpIHsKICAgICAgcmV2YWxpZGF0ZVBhdGgoYC93YXJlaG91c2VzLyR7d2lkfWApCiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgbWVzc2FnZTogY2xlYXJlZCA+IDAgPyBgUHJvZHV0b3MgcmVtb3ZpZG9zIGRlICR7Y2xlYXJlZH0gZW5kZXJlw6dvKHMpLmAgOiAiTmVuaHVtIHByb2R1dG8gcGFyYSByZW1vdmVyLiIsCiAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImxpbXBhciBwcm9kdXRvcyBkYXMgcnVhcyBzZWxlY2lvbmFkYXMiKQogIH0KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNsZWFyUHJvZHVjdHNGcm9tTG9jYXRpb25zKAogIGxvY2F0aW9uSWRzOiBzdHJpbmdbXSwKKTogUHJvbWlzZTx7IG1lc3NhZ2U6IHN0cmluZzsgc3VjY2VzczogYm9vbGVhbiB9PiB7CiAgdHJ5IHsKICAgIGlmICghQXJyYXkuaXNBcnJheShsb2NhdGlvbklkcykgfHwgbG9jYXRpb25JZHMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJOZW5odW0gaXRlbSBzZWxlY2lvbmFkby4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgbGV0IGNsZWFyZWQgPSAwCiAgICBjb25zdCB3YXJlaG91c2VzVG9SZXZhbGlkYXRlID0gbmV3IFNldDxzdHJpbmc+KCkKCiAgICBmb3IgKGNvbnN0IGlkIG9mIGxvY2F0aW9uSWRzKSB7CiAgICAgIC8vIFRlbnRhciBjb21vIHBhbGV0ZQogICAgICBjb25zdCBwYWxsZXQgPSBhd2FpdCBnZXRQYWxsZXRCeUlkKGlkKQogICAgICBpZiAocGFsbGV0KSB7CiAgICAgICAgaWYgKChwYWxsZXQuZWFuICYmIHBhbGxldC5lYW4udHJpbSgpICE9PSAiIikgfHwgKHBhbGxldC5wcm9kdWN0TmFtZSAmJiBwYWxsZXQucHJvZHVjdE5hbWUudHJpbSgpICE9PSAiIikpIHsKICAgICAgICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCByZW1vdmVQcm9kdWN0RnJvbVBhbGxldE9yaWdpbmFsKGlkKQogICAgICAgICAgaWYgKHVwZGF0ZWQpIHsKICAgICAgICAgICAgY2xlYXJlZCsrCiAgICAgICAgICAgIGNvbnN0IGFpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKHVwZGF0ZWQuYWlzbGVJZCkKICAgICAgICAgICAgaWYgKGFpc2xlPy53YXJlaG91c2VJZCkgd2FyZWhvdXNlc1RvUmV2YWxpZGF0ZS5hZGQoYWlzbGUud2FyZWhvdXNlSWQpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIC8vIFRlbnRhciBjb21vIHByYXRlbGVpcmEgKGFuZGFyKQogICAgICBjb25zdCBzaGVsZiA9IGF3YWl0IGdldFNoZWxmQnlJZChpZCkKICAgICAgaWYgKHNoZWxmKSB7CiAgICAgICAgaWYgKChzaGVsZi5lYW4gJiYgc2hlbGYuZWFuLnRyaW0oKSAhPT0gIiIpIHx8IChzaGVsZi5wcm9kdWN0TmFtZSAmJiBzaGVsZi5wcm9kdWN0TmFtZS50cmltKCkgIT09ICIiKSkgewogICAgICAgICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHJlbW92ZVByb2R1Y3RGcm9tU2hlbGZPcmlnaW5hbChpZCkKICAgICAgICAgIGlmICh1cGRhdGVkKSB7CiAgICAgICAgICAgIGNsZWFyZWQrKwogICAgICAgICAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZCh1cGRhdGVkLmFpc2xlSWQpCiAgICAgICAgICAgIGlmIChhaXNsZT8ud2FyZWhvdXNlSWQpIHdhcmVob3VzZXNUb1JldmFsaWRhdGUuYWRkKGFpc2xlLndhcmVob3VzZUlkKQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZvciAoY29uc3Qgd2lkIG9mIHdhcmVob3VzZXNUb1JldmFsaWRhdGUpIHsKICAgICAgcmV2YWxpZGF0ZVBhdGgoYC93YXJlaG91c2VzLyR7d2lkfWApCiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgbWVzc2FnZTogY2xlYXJlZCA+IDAgPyBgUHJvZHV0b3MgcmVtb3ZpZG9zIGRlICR7Y2xlYXJlZH0gZW5kZXJlw6dvKHMpLmAgOiAiTmVuaHVtIHByb2R1dG8gcGFyYSByZW1vdmVyLiIsCiAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImxpbXBhciBwcm9kdXRvcyBkb3MgaXRlbnMgc2VsZWNpb25hZG9zIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjbGVhclNoZWxmUG9zaXRpb25Qcm9kdWN0cygKICBhaXNsZUlkOiBzdHJpbmcsCiAgcG9zaXRpb246IG51bWJlciwKKTogUHJvbWlzZTx7IG1lc3NhZ2U6IHN0cmluZzsgc3VjY2VzczogYm9vbGVhbiB9PiB7CiAgdHJ5IHsKICAgIGlmICghYWlzbGVJZCB8fCAhcG9zaXRpb24pIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlBhcsOibWV0cm9zIGludsOhbGlkb3MuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IHNoZWx2ZXMgPSBhd2FpdCBnZXRTaGVsdmVzQnlBaXNsZShhaXNsZUlkKQogICAgY29uc3QgdGFyZ2V0U2hlbHZlcyA9IHNoZWx2ZXMuZmlsdGVyKChzKSA9PiBzLnBvc2l0aW9uID09PSBwb3NpdGlvbikKICAgIGxldCBjbGVhcmVkID0gMAogICAgZm9yIChjb25zdCBzIG9mIHRhcmdldFNoZWx2ZXMpIHsKICAgICAgaWYgKChzLmVhbiAmJiBzLmVhbi50cmltKCkgIT09ICIiKSB8fCAocy5wcm9kdWN0TmFtZSAmJiBzLnByb2R1Y3ROYW1lLnRyaW0oKSAhPT0gIiIpKSB7CiAgICAgICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHJlbW92ZVByb2R1Y3RGcm9tU2hlbGZPcmlnaW5hbChzLmlkKQogICAgICAgIGlmICh1cGRhdGVkKSBjbGVhcmVkKysKICAgICAgfQogICAgfQoKICAgIGNvbnN0IGFpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKGFpc2xlSWQpCiAgICBpZiAoYWlzbGU/LndhcmVob3VzZUlkKSB7CiAgICAgIHJldmFsaWRhdGVQYXRoKGAvd2FyZWhvdXNlcy8ke2Fpc2xlLndhcmVob3VzZUlkfWApCiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgbWVzc2FnZTogY2xlYXJlZCA+IDAgPyBgUHJvZHV0b3MgcmVtb3ZpZG9zIGRhIHByYXRlbGVpcmEgJHtwb3NpdGlvbn0uYCA6ICJQcmF0ZWxlaXJhIGrDoSBlc3TDoSB2YXppYS4iLAogICAgICBzdWNjZXNzOiB0cnVlLAogICAgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gaGFuZGxlQWN0aW9uRXJyb3IoZXJyb3IsICJsaW1wYXIgcHJvZHV0b3MgZGEgcHJhdGVsZWlyYSIpCiAgfQp9CgovLyBOb3ZhcyBhw6fDtWVzIHBhcmEgcmVzc3VwcmltZW50bwpleHBvcnQgYXN5bmMgZnVuY3Rpb24gbm90aWZ5UmVzdXBwbHlBY3Rpb24ocHJldlN0YXRlOiBhbnksIGZvcm1EYXRhOiBGb3JtRGF0YSkgewogIHRyeSB7CiAgICBjb25zdCBwcm9kdWN0SWQgPSBmb3JtRGF0YS5nZXQoInByb2R1Y3RJZCIpIGFzIHN0cmluZwogICAgY29uc3QgcHJvZHVjdE5hbWUgPSBmb3JtRGF0YS5nZXQoInByb2R1Y3ROYW1lIikgYXMgc3RyaW5nCiAgICBjb25zdCBlYW4xMyA9IGZvcm1EYXRhLmdldCgiZWFuMTMiKSBhcyBzdHJpbmcKICAgIGNvbnN0IGNhdGVnb3J5ID0gZm9ybURhdGEuZ2V0KCJjYXRlZ29yeSIpIGFzIHN0cmluZwogICAgY29uc3QgbG9jYXRpb25JZCA9IGZvcm1EYXRhLmdldCgibG9jYXRpb25JZCIpIGFzIHN0cmluZwogICAgY29uc3QgbG9jYXRpb25UeXBlID0gZm9ybURhdGEuZ2V0KCJsb2NhdGlvblR5cGUiKSBhcyAicGFsbGV0IiB8ICJzaGVsZiIKICAgIGNvbnN0IGFkZHJlc3MgPSBmb3JtRGF0YS5nZXQoImFkZHJlc3MiKSBhcyBzdHJpbmcKICAgIGNvbnN0IHdhcmVob3VzZUlkID0gZm9ybURhdGEuZ2V0KCJ3YXJlaG91c2VJZCIpIGFzIHN0cmluZwogICAgY29uc3Qgd2FyZWhvdXNlTmFtZSA9IGZvcm1EYXRhLmdldCgid2FyZWhvdXNlTmFtZSIpIGFzIHN0cmluZwogICAgY29uc3QgYWlzbGVJZCA9IGZvcm1EYXRhLmdldCgiYWlzbGVJZCIpIGFzIHN0cmluZwogICAgY29uc3QgYWlzbGVOYW1lID0gZm9ybURhdGEuZ2V0KCJhaXNsZU5hbWUiKSBhcyBzdHJpbmcKICAgIGNvbnN0IHBvc2l0aW9uID0gTnVtYmVyKGZvcm1EYXRhLmdldCgicG9zaXRpb24iKSkKICAgIGNvbnN0IGxldmVsID0gZm9ybURhdGEuZ2V0KCJsZXZlbCIpID8gTnVtYmVyKGZvcm1EYXRhLmdldCgibGV2ZWwiKSkgOiB1bmRlZmluZWQKCiAgICBjb25zdCB2YWxpZGF0aW9uID0gRGF0YVZhbGlkYXRvci52YWxpZGF0ZVByb2R1Y3QoeyBlYW46IHByb2R1Y3RJZCwgcHJvZHVjdE5hbWUgfSkgLy8gU2ltcGxpZmllZCB2YWxpZGF0aW9uIGZvciBwcm9kdWN0IGRhdGEKICAgIGlmICghcHJvZHVjdElkIHx8ICFwcm9kdWN0TmFtZSB8fCAhbG9jYXRpb25JZCB8fCAhbG9jYXRpb25UeXBlIHx8ICFhZGRyZXNzIHx8ICF3YXJlaG91c2VJZCB8fCAhYWlzbGVJZCkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiQ2FtcG9zIG9icmlnYXTDs3Jpb3MgcGFyYSBub3RpZmljYcOnw6NvIGRlIHJlc3N1cHJpbWVudG8gZXN0w6NvIGZhbHRhbmRvLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBub3RpZmljYXRpb24gPSBhd2FpdCBhZGRSZXN1cHBseU5vdGlmaWNhdGlvbih7CiAgICAgIHByb2R1Y3RJZCwKICAgICAgcHJvZHVjdE5hbWUsCiAgICAgIGVhbjEzOiBlYW4xMyB8fCB1bmRlZmluZWQsCiAgICAgIGNhdGVnb3J5OiBjYXRlZ29yeSB8fCB1bmRlZmluZWQsCiAgICAgIGxvY2F0aW9uSWQsCiAgICAgIGxvY2F0aW9uVHlwZSwKICAgICAgYWRkcmVzcywKICAgICAgd2FyZWhvdXNlSWQsCiAgICAgIHdhcmVob3VzZU5hbWUsCiAgICAgIGFpc2xlSWQsCiAgICAgIGFpc2xlTmFtZSwKICAgICAgcG9zaXRpb24sCiAgICAgIGxldmVsLAogICAgICBzdGF0dXM6ICJwZW5kaW5nIiwKICAgIH0pCgogICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKCkKICAgIHJldHVybiB7CiAgICAgIG1lc3NhZ2U6IGBQcm9kdXRvICIke3Byb2R1Y3ROYW1lfSIgbm90aWZpY2FkbyBwYXJhIHJlc3N1cHJpbWVudG8gY29tIHN1Y2Vzc28hYCwKICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgbm90aWZpY2F0aW9uSWQ6IG5vdGlmaWNhdGlvbi5pZCwKICAgIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAibm90aWZpY2FyIHJlc3N1cHJpbWVudG8iKQogIH0KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVJlc3VwcGx5U3RhdHVzQWN0aW9uKHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3Qgbm90aWZpY2F0aW9uSWQgPSBmb3JtRGF0YS5nZXQoIm5vdGlmaWNhdGlvbklkIikgYXMgc3RyaW5nCiAgICBjb25zdCBzdGF0dXMgPSBmb3JtRGF0YS5nZXQoInN0YXR1cyIpIGFzIFJlc3VwcGx5Tm90aWZpY2F0aW9uWyJzdGF0dXMiXQogICAgY29uc3Qgbm90ZXMgPSBmb3JtRGF0YS5nZXQoIm5vdGVzIikgYXMgc3RyaW5nCgogICAgaWYgKCFub3RpZmljYXRpb25JZCB8fCAhc3RhdHVzKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJJRCBkYSBub3RpZmljYcOnw6NvIGUgc3RhdHVzIHPDo28gb2JyaWdhdMOzcmlvcy4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgaWYgKCFbInBlbmRpbmciLCAiaW5fcHJvZ3Jlc3MiLCAiY29tcGxldGVkIiwgIm91dF9vZl9zdG9jayJdLmluY2x1ZGVzKHN0YXR1cykpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlN0YXR1cyBpbnbDoWxpZG8uIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCB1cGRhdGVSZXN1cHBseVN0YXR1cyhub3RpZmljYXRpb25JZCwgc3RhdHVzLCBub3RlcyB8fCB1bmRlZmluZWQpCiAgICBpZiAoIXVwZGF0ZWQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIk5vdGlmaWNhw6fDo28gbsOjbyBlbmNvbnRyYWRhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoKQoKICAgIGNvbnN0IHN0YXR1c0xhYmVscyA9IHsKICAgICAgcGVuZGluZzogIlBlbmRlbnRlIiwKICAgICAgaW5fcHJvZ3Jlc3M6ICJFbSBBbmRhbWVudG8iLAogICAgICBjb21wbGV0ZWQ6ICJDb25jbHXDrWRvIiwKICAgICAgb3V0X29mX3N0b2NrOiAiRW0gRmFsdGEiLAogICAgfQoKICAgIHJldHVybiB7CiAgICAgIG1lc3NhZ2U6IGBTdGF0dXMgYXR1YWxpemFkbyBwYXJhICIke3N0YXR1c0xhYmVsc1tzdGF0dXNdfSIgY29tIHN1Y2Vzc28hYCwKICAgICAgc3VjY2VzczogdHJ1ZSwKICAgIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAiYXR1YWxpemFyIHN0YXR1cyIpCiAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVtb3ZlSW5kaXZpZHVhbFByb2R1Y3RGcm9tUGFsbGV0KAogIHBhbGxldElkOiBzdHJpbmcsCiAgcHJvZHVjdEVhbjogc3RyaW5nLAogIHByZXZTdGF0ZTogYW55LAogIGZvcm1EYXRhOiBGb3JtRGF0YSwKKSB7CiAgdHJ5IHsKICAgIGlmICghcGFsbGV0SWQgfHwgIXByb2R1Y3RFYW4pIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIklEIGRvIHBhbGV0ZSBlIEVBTiBkbyBwcm9kdXRvIHPDo28gb2JyaWdhdMOzcmlvcy4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgcGFsbGV0ID0gYXdhaXQgZ2V0UGFsbGV0QnlJZChwYWxsZXRJZCkKICAgIGlmICghcGFsbGV0KSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJQYWxldGUgbsOjbyBlbmNvbnRyYWRvLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBpZiAoIXBhbGxldC5lYW4gfHwgIXBhbGxldC5wcm9kdWN0TmFtZSkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiUGFsZXRlIG7Do28gcG9zc3VpIHByb2R1dG9zLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBjdXJyZW50RWFucyA9IHBhbGxldC5lYW4KICAgICAgLnNwbGl0KCI7IikKICAgICAgLm1hcCgoZWFuKSA9PiBlYW4udHJpbSgpKQogICAgICAuZmlsdGVyKChlYW4pID0+IGVhbi5sZW5ndGggPiAwKQogICAgY29uc3QgY3VycmVudE5hbWVzID0gcGFsbGV0LnByb2R1Y3ROYW1lCiAgICAgIC5zcGxpdCgiOyIpCiAgICAgIC5tYXAoKG5hbWUpID0+IG5hbWUudHJpbSgpKQogICAgICAuZmlsdGVyKChuYW1lKSA9PiBuYW1lLmxlbmd0aCA+IDApCgogICAgY29uc3QgcHJvZHVjdEluZGV4ID0gY3VycmVudEVhbnMuaW5kZXhPZihwcm9kdWN0RWFuLnRyaW0oKSkKICAgIGlmIChwcm9kdWN0SW5kZXggPT09IC0xKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJQcm9kdXRvIG7Do28gZW5jb250cmFkbyBubyBwYWxldGUuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGN1cnJlbnRFYW5zLnNwbGljZShwcm9kdWN0SW5kZXgsIDEpCiAgICBjdXJyZW50TmFtZXMuc3BsaWNlKHByb2R1Y3RJbmRleCwgMSkKCiAgICBjb25zdCBuZXdFYW4gPSBjdXJyZW50RWFucy5sZW5ndGggPiAwID8gY3VycmVudEVhbnMuam9pbigiOyAiKSA6ICIiCiAgICBjb25zdCBuZXdQcm9kdWN0TmFtZSA9IGN1cnJlbnROYW1lcy5sZW5ndGggPiAwID8gY3VycmVudE5hbWVzLmpvaW4oIjsgIikgOiAiIgogICAgY29uc3QgbmV3Q2F0ZWdvcnkgPSBjdXJyZW50RWFucy5sZW5ndGggPiAwID8gcGFsbGV0LmNhdGVnb3J5IDogIiIKICAgIGNvbnN0IG5ld0VhbjEzID0gY3VycmVudEVhbnMubGVuZ3RoID4gMCA/IHBhbGxldC5lYW4xMyA6ICIiCgogICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHVwZGF0ZVBhbGxldChwYWxsZXRJZCwgbmV3RWFuLCBuZXdQcm9kdWN0TmFtZSwgbmV3Q2F0ZWdvcnksIG5ld0VhbjEzKQogICAgaWYgKCF1cGRhdGVkKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJGYWxoYSBhbyBhdHVhbGl6YXIgcGFsZXRlLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZCh1cGRhdGVkLmFpc2xlSWQpCiAgICBpZiAoYWlzbGU/LndhcmVob3VzZUlkKSB7CiAgICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyhhaXNsZS53YXJlaG91c2VJZCkKICAgIH0KCiAgICByZXR1cm4geyBtZXNzYWdlOiAiUHJvZHV0byByZW1vdmlkbyBjb20gc3VjZXNzbyEiLCBzdWNjZXNzOiB0cnVlIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAicmVtb3ZlciBwcm9kdXRvIGluZGl2aWR1YWwgZG8gcGFsZXRlIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW1vdmVJbmRpdmlkdWFsUHJvZHVjdEZyb21TaGVsZigKICBzaGVsZklkOiBzdHJpbmcsCiAgcHJvZHVjdEVhbjogc3RyaW5nLAogIHByZXZTdGF0ZTogYW55LAogIGZvcm1EYXRhOiBGb3JtRGF0YSwKKSB7CiAgdHJ5IHsKICAgIGlmICghc2hlbGZJZCB8fCAhcHJvZHVjdEVhbikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiSUQgZGEgcHJhdGVsZWlyYSBlIEVBTiBkbyBwcm9kdXRvIHPDo28gb2JyaWdhdMOzcmlvcy4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3Qgc2hlbGYgPSBhd2FpdCBnZXRTaGVsZkJ5SWQoc2hlbGZJZCkKICAgIGlmICghc2hlbGYpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlByYXRlbGVpcmEgbsOjbyBlbmNvbnRyYWRhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBpZiAoIXNoZWxmLmVhbiB8fCAhc2hlbGYucHJvZHVjdE5hbWUpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIkFuZGFyIG7Do28gcG9zc3VpIHByb2R1dG9zLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBjdXJyZW50RWFucyA9IHNoZWxmLmVhbgogICAgICAuc3BsaXQoIjsiKQogICAgICAubWFwKChlYW4pID0+IGVhbi50cmltKCkpCiAgICAgIC5maWx0ZXIoKGVhbikgPT4gZWFuLmxlbmd0aCA+IDApCiAgICBjb25zdCBjdXJyZW50TmFtZXMgPSBzaGVsZi5wcm9kdWN0TmFtZQogICAgICAuc3BsaXQoIjsiKQogICAgICAubWFwKChuYW1lKSA9PiBuYW1lLnRyaW0oKSkKICAgICAgLmZpbHRlcigobmFtZSkgPT4gbmFtZS5sZW5ndGggPiAwKQoKICAgIGNvbnN0IHByb2R1Y3RJbmRleCA9IGN1cnJlbnRFYW5zLmluZGV4T2YocHJvZHVjdEVhbi50cmltKCkpCiAgICBpZiAocHJvZHVjdEluZGV4ID09PSAtMSkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiUHJvZHV0byBuw6NvIGVuY29udHJhZG8gbm8gYW5kYXIuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGN1cnJlbnRFYW5zLnNwbGljZShwcm9kdWN0SW5kZXgsIDEpCiAgICBjdXJyZW50TmFtZXMuc3BsaWNlKHByb2R1Y3RJbmRleCwgMSkKCiAgICBjb25zdCBuZXdFYW4gPSBjdXJyZW50RWFucy5sZW5ndGggPiAwID8gY3VycmVudEVhbnMuam9pbigiOyAiKSA6ICIiCiAgICBjb25zdCBuZXdQcm9kdWN0TmFtZSA9IGN1cnJlbnROYW1lcy5sZW5ndGggPiAwID8gY3VycmVudE5hbWVzLmpvaW4oIjsgIikgOiAiIgogICAgY29uc3QgbmV3Q2F0ZWdvcnkgPSBjdXJyZW50RWFucy5sZW5ndGggPiAwID8gc2hlbGYuY2F0ZWdvcnkgOiAiIgogICAgY29uc3QgbmV3RWFuMTMgPSBjdXJyZW50RWFucy5sZW5ndGggPiAwID8gc2hlbGYuZWFuMTMgOiAiIgogICAgY29uc3Qgb2NjdXBhbmN5UGVyY2VudGFnZSA9IGN1cnJlbnRFYW5zLmxlbmd0aCA+IDAgPyBzaGVsZi5vY2N1cGFuY3lQZXJjZW50YWdlIDogMAoKICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCB1cGRhdGVTaGVsZihzaGVsZklkLCBuZXdFYW4sIG5ld1Byb2R1Y3ROYW1lLCBvY2N1cGFuY3lQZXJjZW50YWdlLCBuZXdDYXRlZ29yeSwgbmV3RWFuMTMpCiAgICBpZiAoIXVwZGF0ZWQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIkZhbGhhIGFvIGF0dWFsaXphciBwcmF0ZWxlaXJhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZCh1cGRhdGVkLmFpc2xlSWQpCiAgICBpZiAoYWlzbGU/LndhcmVob3VzZUlkKSB7CiAgICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyhhaXNsZS53YXJlaG91c2VJZCkKICAgIH0KCiAgICByZXR1cm4geyBtZXNzYWdlOiAiUHJvZHV0byByZW1vdmlkbyBjb20gc3VjZXNzbyEiLCBzdWNjZXNzOiB0cnVlIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAicmVtb3ZlciBwcm9kdXRvIGluZGl2aWR1YWwgZGEgcHJhdGVsZWlyYSIpCiAgfQp9CgpleHBvcnQgeyBhZGRTaW5nbGVTaGVsZiBhcyBhZGRTaW5nbGVTaGVsZkFjdGlvbiB9Cg=="}