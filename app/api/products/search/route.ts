{"data":"aW1wb3J0IHsgdHlwZSBOZXh0UmVxdWVzdCwgTmV4dFJlc3BvbnNlIH0gZnJvbSAibmV4dC9zZXJ2ZXIiCmltcG9ydCB7IHByb2R1Y3RzU2hlZXRzU2VydmljZSB9IGZyb20gIkAvbGliL3Byb2R1Y3RzLXNoZWV0cyIKCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBHRVQocmVxdWVzdDogTmV4dFJlcXVlc3QpIHsKICB0cnkgewogICAgY29uc3QgeyBzZWFyY2hQYXJhbXMgfSA9IG5ldyBVUkwocmVxdWVzdC51cmwpCiAgICBjb25zdCBlYW5QYXJhbSA9IHNlYXJjaFBhcmFtcy5nZXQoImVhbiIpCiAgICBjb25zdCBpZFBhcmFtID0gc2VhcmNoUGFyYW1zLmdldCgiaWQiKQogICAgY29uc3QgcXVlcnlQYXJhbSA9IHNlYXJjaFBhcmFtcy5nZXQoInF1ZXJ5IikKCiAgICBjb25zb2xlLmxvZyhgW0FQSV0gUmVjZWJpZGEgcmVxdWlzacOnw6NvIC0gRUFOOiAiJHtlYW5QYXJhbX0iLCBJRDogIiR7aWRQYXJhbX0iLCBRdWVyeTogIiR7cXVlcnlQYXJhbX0iYCkKCiAgICBpZiAoZWFuUGFyYW0pIHsKICAgICAgLy8gUHJvY2Vzc2FyIG3Dumx0aXBsb3MgRUFOcyBzZXBhcmFkb3MgcG9yIHbDrXJndWxhCiAgICAgIGNvbnN0IHNlYXJjaFRlcm1zID0gZWFuUGFyYW0KICAgICAgICAuc3BsaXQoIiwiKQogICAgICAgIC5tYXAoKHRlcm0pID0+IHRlcm0udHJpbSgpKQogICAgICAgIC5maWx0ZXIoKHRlcm0pID0+IHRlcm0ubGVuZ3RoID4gMCkKICAgICAgY29uc3QgYWxsUHJvZHVjdHM6IGFueVtdID0gW10KCiAgICAgIGlmIChzZWFyY2hUZXJtcy5sZW5ndGggPT09IDApIHsKICAgICAgICBjb25zb2xlLmxvZyhgW0FQSV0g4p2MIEVBTiB2YXppbyBhcMOzcyBzcGxpdDogIiR7ZWFuUGFyYW19ImApCiAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgc3VjY2VzczogZmFsc2UsIG1lc3NhZ2U6ICJFQU4gbsOjbyBwb2RlIGVzdGFyIHZhemlvIiB9KQogICAgICB9CgogICAgICBjb25zb2xlLmxvZyhgW0FQSV0gUHJvY2Vzc2FuZG8gJHtzZWFyY2hUZXJtcy5sZW5ndGh9IHRlcm1vKHMpIGRlIGJ1c2NhOiAke3NlYXJjaFRlcm1zLmpvaW4oIiwgIil9YCkKCiAgICAgIGZvciAoY29uc3Qgc2VhcmNoVGVybSBvZiBzZWFyY2hUZXJtcykgewogICAgICAgIGNvbnNvbGUubG9nKGBbQVBJXSBQcm9jZXNzYW5kbyB0ZXJtbyBpbmRpdmlkdWFsOiAiJHtzZWFyY2hUZXJtfSJgKQoKICAgICAgICAvLyBUZW50YXRpdmEgMTogQnVzY2FyIHBvciBFQU4gZXhhdG8gKGNvbHVuYSBBKQogICAgICAgIGNvbnNvbGUubG9nKGBbQVBJXSBUZW50YXRpdmEgMTogQnVzY2FyIHBvciBFQU4gZXhhdG86ICIke3NlYXJjaFRlcm19ImApCiAgICAgICAgY29uc3QgcHJvZHVjdHNCeUVBTiA9IGF3YWl0IHByb2R1Y3RzU2hlZXRzU2VydmljZS5maW5kQWxsUHJvZHVjdHNCeUVBTihzZWFyY2hUZXJtKQoKICAgICAgICBpZiAocHJvZHVjdHNCeUVBTi5sZW5ndGggPiAwKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgICAgYFtBUEldIOKchSAke3Byb2R1Y3RzQnlFQU4ubGVuZ3RofSBwcm9kdXRvKHMpIGVuY29udHJhZG8ocykgcG9yIEVBTiBleGF0byBwYXJhICIke3NlYXJjaFRlcm19IjpgLAogICAgICAgICAgICBwcm9kdWN0c0J5RUFOLm1hcCgocCkgPT4gKHsgZWFuOiBwLmVhbiwgaWQ6IHAuaWQsIGRlc2NyaXB0aW9uOiBwLmRlc2NyaXB0aW9uPy5zdWJzdHJpbmcoMCwgMzApICsgIi4uLiIgfSkpLAogICAgICAgICAgKQogICAgICAgICAgYWxsUHJvZHVjdHMucHVzaCguLi5wcm9kdWN0c0J5RUFOKQogICAgICAgICAgY29udGludWUgLy8gUHLDs3hpbW8gdGVybW8gc2UgZW5jb250cm91CiAgICAgICAgfQoKICAgICAgICAvLyBUZW50YXRpdmEgMjogQnVzY2FyIHBvciBJRCAoY29sdW5hIEUpIGNvbW8gZmFsbGJhY2sKICAgICAgICBjb25zb2xlLmxvZyhgW0FQSV0gVGVudGF0aXZhIDI6IEJ1c2NhciBwb3IgSUQgKGZhbGxiYWNrKTogIiR7c2VhcmNoVGVybX0iYCkKICAgICAgICBjb25zdCBwcm9kdWN0QnlJRCA9IGF3YWl0IHByb2R1Y3RzU2hlZXRzU2VydmljZS5maW5kUHJvZHVjdEJ5SUQoc2VhcmNoVGVybSkKCiAgICAgICAgaWYgKHByb2R1Y3RCeUlEKSB7CiAgICAgICAgICBjb25zb2xlLmxvZyhgW0FQSV0g4pyFIFByb2R1dG8gZW5jb250cmFkbyBwb3IgSUQgKGZhbGxiYWNrKSBwYXJhICIke3NlYXJjaFRlcm19IjpgLCB7CiAgICAgICAgICAgIGVhbjogcHJvZHVjdEJ5SUQuZWFuLAogICAgICAgICAgICBpZDogcHJvZHVjdEJ5SUQuaWQsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBwcm9kdWN0QnlJRC5kZXNjcmlwdGlvbj8uc3Vic3RyaW5nKDAsIDMwKSArICIuLi4iLAogICAgICAgICAgfSkKICAgICAgICAgIGFsbFByb2R1Y3RzLnB1c2gocHJvZHVjdEJ5SUQpCiAgICAgICAgICBjb250aW51ZSAvLyBQcsOzeGltbyB0ZXJtbyBzZSBlbmNvbnRyb3UKICAgICAgICB9CgogICAgICAgIC8vIFRlbnRhdGl2YSAzOiBCdXNjYSBwYXJjaWFsIHBvciB0ZXJtbwogICAgICAgIGNvbnNvbGUubG9nKGBbQVBJXSBUZW50YXRpdmEgMzogQnVzY2EgcGFyY2lhbCBwb3IgdGVybW86ICIke3NlYXJjaFRlcm19ImApCiAgICAgICAgY29uc3QgcGFydGlhbFNlYXJjaFJlc3VsdHMgPSBhd2FpdCBwcm9kdWN0c1NoZWV0c1NlcnZpY2Uuc2VhcmNoUHJvZHVjdHMoc2VhcmNoVGVybSwgNSkKCiAgICAgICAgaWYgKHBhcnRpYWxTZWFyY2hSZXN1bHRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgICBgW0FQSV0g4pyFICR7cGFydGlhbFNlYXJjaFJlc3VsdHMubGVuZ3RofSBwcm9kdXRvKHMpIGVuY29udHJhZG8ocykgcG9yIGJ1c2NhIHBhcmNpYWwgcGFyYSAiJHtzZWFyY2hUZXJtfSJgLAogICAgICAgICAgKQogICAgICAgICAgYWxsUHJvZHVjdHMucHVzaCguLi5wYXJ0aWFsU2VhcmNoUmVzdWx0cykKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS5sb2coYFtBUEldIOKdjCBOZW5odW0gcHJvZHV0byBlbmNvbnRyYWRvIHBhcmEgdGVybW86ICIke3NlYXJjaFRlcm19ImApCiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBSZW1vdmVyIGR1cGxpY2F0YXMgYmFzZWFkbyBubyBJRCDDum5pY28KICAgICAgY29uc3QgdW5pcXVlUHJvZHVjdHNNYXAgPSBuZXcgTWFwKCkKICAgICAgZm9yIChjb25zdCBwcm9kdWN0IG9mIGFsbFByb2R1Y3RzKSB7CiAgICAgICAgY29uc3QgdW5pcXVlS2V5ID0gcHJvZHVjdC5pZCB8fCBwcm9kdWN0LmVhbiB8fCBgJHtwcm9kdWN0LmVhbn0tJHtwcm9kdWN0LmRlc2NyaXB0aW9ufWAKICAgICAgICBpZiAoIXVuaXF1ZVByb2R1Y3RzTWFwLmhhcyh1bmlxdWVLZXkpKSB7CiAgICAgICAgICB1bmlxdWVQcm9kdWN0c01hcC5zZXQodW5pcXVlS2V5LCBwcm9kdWN0KQogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCB1bmlxdWVQcm9kdWN0cyA9IEFycmF5LmZyb20odW5pcXVlUHJvZHVjdHNNYXAudmFsdWVzKCkpCgogICAgICBpZiAodW5pcXVlUHJvZHVjdHMubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgYFtBUEldIOKchSBUb3RhbCBkZSAke3VuaXF1ZVByb2R1Y3RzLmxlbmd0aH0gcHJvZHV0byhzKSDDum5pY28ocykgZW5jb250cmFkbyhzKSBwYXJhIEVBTihzKTogIiR7ZWFuUGFyYW19ImAsCiAgICAgICAgKQogICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7CiAgICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICAgICAgcHJvZHVjdHM6IHVuaXF1ZVByb2R1Y3RzLAogICAgICAgICAgY291bnQ6IHVuaXF1ZVByb2R1Y3RzLmxlbmd0aCwKICAgICAgICAgIHByb2R1Y3Q6IHVuaXF1ZVByb2R1Y3RzWzBdLCAvLyBQcmltZWlybyBwcm9kdXRvIHBhcmEgY29tcGF0aWJpbGlkYWRlCiAgICAgICAgICBzZWFyY2hUeXBlOiAiZWFuX2NvbWJpbmVkIiwKICAgICAgICB9KQogICAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUubG9nKGBbQVBJXSDinYwgTmVuaHVtIHByb2R1dG8gZW5jb250cmFkbyBwYXJhIEVBTihzKTogIiR7ZWFuUGFyYW19ImApCiAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsKICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgICAgbWVzc2FnZTogIk5lbmh1bSBwcm9kdXRvIGVuY29udHJhZG8iLAogICAgICAgICAgc2VhcmNoVGVybTogZWFuUGFyYW0sCiAgICAgICAgICBzZWFyY2hUeXBlOiAiZWFuX2NvbWJpbmVkIiwKICAgICAgICB9KQogICAgICB9CiAgICB9IGVsc2UgaWYgKGlkUGFyYW0pIHsKICAgICAgY29uc3Qgbm9ybWFsaXplZElEID0gaWRQYXJhbS50cmltKCkKICAgICAgY29uc29sZS5sb2coYFtBUEldIEJ1c2NhbmRvIHByb2R1dG8gcG9yIElEOiAiJHtub3JtYWxpemVkSUR9ImApCgogICAgICBpZiAobm9ybWFsaXplZElELmxlbmd0aCA8IDEpIHsKICAgICAgICBjb25zb2xlLmxvZyhgW0FQSV0g4p2MIElEIHZhemlvOiAiJHtub3JtYWxpemVkSUR9ImApCiAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgc3VjY2VzczogZmFsc2UsIG1lc3NhZ2U6ICJJRCBuw6NvIHBvZGUgZXN0YXIgdmF6aW8iIH0pCiAgICAgIH0KCiAgICAgIGNvbnN0IHByb2R1Y3QgPSBhd2FpdCBwcm9kdWN0c1NoZWV0c1NlcnZpY2UuZmluZFByb2R1Y3RCeUlEKG5vcm1hbGl6ZWRJRCkKCiAgICAgIGlmIChwcm9kdWN0KSB7CiAgICAgICAgY29uc29sZS5sb2coYFtBUEldIOKchSBQcm9kdXRvIGVuY29udHJhZG8gcG9yIElEOmAsIHsKICAgICAgICAgIGVhbjogcHJvZHVjdC5lYW4sCiAgICAgICAgICBpZDogcHJvZHVjdC5pZCwKICAgICAgICAgIGRlc2NyaXB0aW9uOiBwcm9kdWN0LmRlc2NyaXB0aW9uPy5zdWJzdHJpbmcoMCwgNTApICsgIi4uLiIsCiAgICAgICAgICBicmFuZDogcHJvZHVjdC5icmFuZCwKICAgICAgICB9KQogICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7CiAgICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICAgICAgcHJvZHVjdCwKICAgICAgICAgIHByb2R1Y3RzOiBbcHJvZHVjdF0sCiAgICAgICAgICBjb3VudDogMSwKICAgICAgICAgIHNlYXJjaFR5cGU6ICJpZF9leGFjdCIsCiAgICAgICAgfSkKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmxvZyhgW0FQSV0g4p2MIFByb2R1dG8gbsOjbyBlbmNvbnRyYWRvIHBhcmEgSUQ6ICIke25vcm1hbGl6ZWRJRH0iYCkKICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oewogICAgICAgICAgc3VjY2VzczogZmFsc2UsCiAgICAgICAgICBtZXNzYWdlOiAiUHJvZHV0byBuw6NvIGVuY29udHJhZG8iLAogICAgICAgICAgc2VhcmNoVGVybTogbm9ybWFsaXplZElELAogICAgICAgICAgc2VhcmNoVHlwZTogImlkIiwKICAgICAgICB9KQogICAgICB9CiAgICB9IGVsc2UgaWYgKHF1ZXJ5UGFyYW0pIHsKICAgICAgY29uc3Qgbm9ybWFsaXplZFF1ZXJ5ID0gcXVlcnlQYXJhbS50cmltKCkKICAgICAgY29uc29sZS5sb2coYFtBUEldIEJ1c2NhbmRvIHByb2R1dG9zIHBvciBxdWVyeTogIiR7bm9ybWFsaXplZFF1ZXJ5fSJgKQoKICAgICAgaWYgKG5vcm1hbGl6ZWRRdWVyeS5sZW5ndGggPCAyKSB7CiAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsKICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgICAgbWVzc2FnZTogIlF1ZXJ5IGRldmUgdGVyIHBlbG8gbWVub3MgMiBjYXJhY3RlcmVzIiwKICAgICAgICB9KQogICAgICB9CgogICAgICBjb25zdCBwcm9kdWN0cyA9IGF3YWl0IHByb2R1Y3RzU2hlZXRzU2VydmljZS5zZWFyY2hQcm9kdWN0cyhub3JtYWxpemVkUXVlcnksIDEwKQogICAgICBjb25zb2xlLmxvZyhgW0FQSV0gRW5jb250cmFkb3MgJHtwcm9kdWN0cy5sZW5ndGh9IHByb2R1dG9zIHBvciBxdWVyeWApCgogICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oewogICAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgICAgcHJvZHVjdHMsCiAgICAgICAgY291bnQ6IHByb2R1Y3RzLmxlbmd0aCwKICAgICAgICBzZWFyY2hUeXBlOiAicXVlcnkiLAogICAgICB9KQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsKICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICBtZXNzYWdlOiAiUGFyw6JtZXRybyBlYW4sIGlkIG91IHF1ZXJ5IMOpIG9icmlnYXTDs3JpbyIsCiAgICAgIH0pCiAgICB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIltBUEldIEVycm8gbmEgQVBJIGRlIHByb2R1dG9zOiIsIGVycm9yKQoKICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIltBUEldIFN0YWNrIHRyYWNlOiIsIGVycm9yLnN0YWNrKQogICAgfQoKICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbigKICAgICAgewogICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgIG1lc3NhZ2U6ICJFcnJvIGludGVybm8gZG8gc2Vydmlkb3IiLAogICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICJFcnJvIGRlc2NvbmhlY2lkbyIsCiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksCiAgICAgIH0sCiAgICAgIHsgc3RhdHVzOiA1MDAgfSwKICAgICkKICB9Cn0K"}