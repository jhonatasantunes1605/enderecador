{"data":"InVzZSBzZXJ2ZXIiCgppbXBvcnQgeyByZXZhbGlkYXRlUGF0aCB9IGZyb20gIm5leHQvY2FjaGUiCmltcG9ydCB7CiAgYWRkQWlzbGUsCiAgYWRkUGFsbGV0LAogIGFkZFNoZWxmLAogIGFkZFdhcmVob3VzZSwKICB1cGRhdGVQYWxsZXQsCiAgdXBkYXRlU2hlbGYsCiAgZGVsZXRlUGFsbGV0LAogIGRlbGV0ZVNoZWxmLAogIGRlbGV0ZUFpc2xlLAogIGdldFBhbGxldHNCeUFpc2xlLAogIGdldFNoZWx2ZXNCeUFpc2xlLAogIGdldEFpc2xlQnlJZCwKICBnZXRQYWxsZXRCeUlkLAogIGdldFNoZWxmQnlJZCwKICBkZWxldGVXYXJlaG91c2UsCiAgZmluZFByb2R1Y3RCeUVBTiwKICBmaW5kV2FyZWhvdXNlSWRCeUFpc2xlSWQsCiAgdmVyaWZ5UGFsbGV0LAogIHZlcmlmeVNoZWxmLAogIHJlb3JkZXJQYWxsZXRzLAogIHVwZGF0ZUFpc2xlTm90ZXMsCiAgdXBkYXRlQWlzbGVDYXBhY2l0eSwKICB1cGRhdGVBaXNsZVN0b3JhZ2VDb25maWcsCiAgdW5hc3NpZ25Qcm9kdWN0RnJvbVBhbGxldCBhcyByZW1vdmVQcm9kdWN0RnJvbVBhbGxldE9yaWdpbmFsLAogIHVuYXNzaWduUHJvZHVjdEZyb21TaGVsZiBhcyByZW1vdmVQcm9kdWN0RnJvbVNoZWxmT3JpZ2luYWwsCiAgZmluZEJ5QWRkcmVzcywKICB0eXBlIFNlYXJjaFJlc3VsdCwKICB0eXBlIEFkZHJlc3NTZWFyY2hSZXN1bHQsCn0gZnJvbSAiQC9saWIvZGF0YS1maXhlZCIKaW1wb3J0IHsgZGV0ZWN0UHJvZHVjdENhdGVnb3J5IH0gZnJvbSAiQC9saWIvY2F0ZWdvcnktdXRpbHMiCmltcG9ydCB7IHByb2R1Y3RzU2hlZXRzU2VydmljZSB9IGZyb20gIkAvbGliL3Byb2R1Y3RzLXNoZWV0cyIKaW1wb3J0IHsgYWRkUmVzdXBwbHlOb3RpZmljYXRpb24sIHVwZGF0ZVJlc3VwcGx5U3RhdHVzLCB0eXBlIFJlc3VwcGx5Tm90aWZpY2F0aW9uIH0gZnJvbSAiQC9saWIvcmVzdXBwbHktZGF0YSIKaW1wb3J0IHsgRGF0YVZhbGlkYXRvciwgVmFsaWRhdGlvbkVycm9yIH0gZnJvbSAiQC9saWIvZGF0YS12YWxpZGF0aW9uIgoKLy8gRnVuw6fDo28gaGVscGVyIHBhcmEgdmFsaWRhw6fDo28gZGUgZGFkb3MKZnVuY3Rpb24gdmFsaWRhdGVSZXF1aXJlZChkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LCBmaWVsZHM6IHN0cmluZ1tdKTogc3RyaW5nIHwgbnVsbCB7CiAgZm9yIChjb25zdCBmaWVsZCBvZiBmaWVsZHMpIHsKICAgIGlmICghZGF0YVtmaWVsZF0gfHwgKHR5cGVvZiBkYXRhW2ZpZWxkXSA9PT0gInN0cmluZyIgJiYgZGF0YVtmaWVsZF0udHJpbSgpID09PSAiIikpIHsKICAgICAgcmV0dXJuIGBDYW1wbyAke2ZpZWxkfSDDqSBvYnJpZ2F0w7NyaW8uYAogICAgfQogIH0KICByZXR1cm4gbnVsbAp9CgovLyBGdW7Dp8OjbyBoZWxwZXIgcGFyYSByZXZhbGlkYcOnw6NvIGRlIHBhdGhzCmZ1bmN0aW9uIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyh3YXJlaG91c2VJZD86IHN0cmluZykgewogIHJldmFsaWRhdGVQYXRoKCIvIikKICByZXZhbGlkYXRlUGF0aCgiL3Jlc3VwcGx5IikKICBpZiAod2FyZWhvdXNlSWQpIHsKICAgIHJldmFsaWRhdGVQYXRoKGAvd2FyZWhvdXNlcy8ke3dhcmVob3VzZUlkfWApCiAgfQp9CgovLyBGdW7Dp8OjbyBoZWxwZXIgcGFyYSB0cmF0YW1lbnRvIGRlIGVycm9zCmZ1bmN0aW9uIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yOiB1bmtub3duLCBvcGVyYXRpb246IHN0cmluZykgewogIGNvbnNvbGUuZXJyb3IoYFtBQ1RJT05dIEVycm8gZW0gJHtvcGVyYXRpb259OmAsIGVycm9yKQoKICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBWYWxpZGF0aW9uRXJyb3IpIHsKICAgIHJldHVybiB7IG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsIHN1Y2Nlc3M6IGZhbHNlIH0KICB9CgogIGNvbnN0IGVycm9yTWVzc2FnZSA9IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogIkVycm8gZGVzY29uaGVjaWRvIgogIHJldHVybiB7IG1lc3NhZ2U6IGBFcnJvIGVtICR7b3BlcmF0aW9ufTogJHtlcnJvck1lc3NhZ2V9YCwgc3VjY2VzczogZmFsc2UgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlV2FyZWhvdXNlKHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3QgbmFtZSA9IGZvcm1EYXRhLmdldCgibmFtZSIpIGFzIHN0cmluZwoKICAgIC8vIFZhbGlkYcOnw6NvIHVzYW5kbyBEYXRhVmFsaWRhdG9yCiAgICBjb25zdCB2YWxpZGF0aW9uID0gRGF0YVZhbGlkYXRvci52YWxpZGF0ZVdhcmVob3VzZSh7IG5hbWUgfSkKICAgIGlmICghdmFsaWRhdGlvbi5pc1ZhbGlkKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6IHZhbGlkYXRpb24uZXJyb3JzWzBdLm1lc3NhZ2UsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBhd2FpdCBhZGRXYXJlaG91c2UobmFtZS50cmltKCkpCiAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoKQogICAgcmV0dXJuIHsgbWVzc2FnZTogIkdhbHDDo28gY3JpYWRvIGNvbSBzdWNlc3NvISIsIHN1Y2Nlc3M6IHRydWUgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gaGFuZGxlQWN0aW9uRXJyb3IoZXJyb3IsICJjcmlhciBnYWxww6NvIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVBaXNsZSh3YXJlaG91c2VJZDogc3RyaW5nLCBwcmV2U3RhdGU6IGFueSwgZm9ybURhdGE6IEZvcm1EYXRhKSB7CiAgdHJ5IHsKICAgIGNvbnN0IG5hbWUgPSBmb3JtRGF0YS5nZXQoIm5hbWUiKSBhcyBzdHJpbmcKICAgIGNvbnN0IG5vdGVzID0gZm9ybURhdGEuZ2V0KCJub3RlcyIpIGFzIHN0cmluZyB8IG51bGwKICAgIGNvbnN0IGNhcGFjaXR5ID0gTnVtYmVyKGZvcm1EYXRhLmdldCgiY2FwYWNpdHkiKSkgfHwgMAogICAgY29uc3Qgc3RvcmFnZVR5cGUgPSAoZm9ybURhdGEuZ2V0KCJzdG9yYWdlVHlwZSIpIGFzICJwYWxsZXQiIHwgInNoZWxmIikgfHwgInBhbGxldCIKICAgIGNvbnN0IHNoZWxmTGV2ZWxzID0gTnVtYmVyKGZvcm1EYXRhLmdldCgic2hlbGZMZXZlbHMiKSkgfHwgMQoKICAgIC8vIFZhbGlkYcOnw6NvIHVzYW5kbyBEYXRhVmFsaWRhdG9yCiAgICBjb25zdCB2YWxpZGF0aW9uID0gRGF0YVZhbGlkYXRvci52YWxpZGF0ZUFpc2xlKHsKICAgICAgbmFtZSwKICAgICAgd2FyZWhvdXNlSWQsCiAgICAgIHN0b3JhZ2VUeXBlLAogICAgICBjYXBhY2l0eSwKICAgICAgc2hlbGZMZXZlbHMsCiAgICB9KQogICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogdmFsaWRhdGlvbi5lcnJvcnNbMF0ubWVzc2FnZSwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGF3YWl0IGFkZEFpc2xlKHdhcmVob3VzZUlkLCBuYW1lLnRyaW0oKSwgbm90ZXM/LnRyaW0oKSB8fCBudWxsLCBjYXBhY2l0eSwgc3RvcmFnZVR5cGUsIHNoZWxmTGV2ZWxzKQogICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKHdhcmVob3VzZUlkKQogICAgcmV0dXJuIHsgbWVzc2FnZTogIlJ1YSBjcmlhZGEgY29tIHN1Y2Vzc28hIiwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImNyaWFyIHJ1YSIpCiAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gYWRkU2luZ2xlUGFsbGV0KGFpc2xlSWQ6IHN0cmluZywgcHJldlN0YXRlOiBhbnksIGZvcm1EYXRhOiBGb3JtRGF0YSkgewogIHRyeSB7CiAgICBjb25zdCB2YWxpZGF0aW9uRXJyb3IgPSB2YWxpZGF0ZVJlcXVpcmVkKHsgYWlzbGVJZCB9LCBbImFpc2xlSWQiXSkKICAgIGlmICh2YWxpZGF0aW9uRXJyb3IpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogdmFsaWRhdGlvbkVycm9yLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgYWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQoYWlzbGVJZCkKICAgIGlmICghYWlzbGUpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlJ1YSBuw6NvIGVuY29udHJhZGEuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGlmIChhaXNsZS5zdG9yYWdlVHlwZSAhPT0gInBhbGxldCIpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIkVzdGEgcnVhIG7Do28gw6kgY29uZmlndXJhZGEgcGFyYSBwYWxldGVzLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBleGlzdGluZ1BhbGxldHMgPSBhd2FpdCBnZXRQYWxsZXRzQnlBaXNsZShhaXNsZUlkKQogICAgY29uc3QgbmV4dFBvc2l0aW9uID0gZXhpc3RpbmdQYWxsZXRzLmxlbmd0aCA+IDAgPyBNYXRoLm1heCguLi5leGlzdGluZ1BhbGxldHMubWFwKChwKSA9PiBwLnBvc2l0aW9uKSkgKyAxIDogMQoKICAgIGF3YWl0IGFkZFBhbGxldChhaXNsZUlkLCBuZXh0UG9zaXRpb24pCiAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoYWlzbGUud2FyZWhvdXNlSWQpCiAgICByZXR1cm4geyBtZXNzYWdlOiBgUGFsZXRlICR7bmV4dFBvc2l0aW9ufSBhZGljaW9uYWRvIGNvbSBzdWNlc3NvIWAsIHN1Y2Nlc3M6IHRydWUgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gaGFuZGxlQWN0aW9uRXJyb3IoZXJyb3IsICJhZGljaW9uYXIgcGFsZXRlIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhZGRTaW5nbGVTaGVsZihhaXNsZUlkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3QgdmFsaWRhdGlvbkVycm9yID0gdmFsaWRhdGVSZXF1aXJlZCh7IGFpc2xlSWQgfSwgWyJhaXNsZUlkIl0pCiAgICBpZiAodmFsaWRhdGlvbkVycm9yKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6IHZhbGlkYXRpb25FcnJvciwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IGFpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKGFpc2xlSWQpCiAgICBpZiAoIWFpc2xlKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJSdWEgbsOjbyBlbmNvbnRyYWRhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBpZiAoYWlzbGUuc3RvcmFnZVR5cGUgIT09ICJzaGVsZiIpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIkVzdGEgcnVhIG7Do28gw6kgY29uZmlndXJhZGEgcGFyYSBwcmF0ZWxlaXJhcy4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgZXhpc3RpbmdTaGVsdmVzID0gYXdhaXQgZ2V0U2hlbHZlc0J5QWlzbGUoYWlzbGVJZCkKICAgIGNvbnN0IHBvc2l0aW9ucyA9IGV4aXN0aW5nU2hlbHZlcy5tYXAoKHMpID0+IHMucG9zaXRpb24pCiAgICBjb25zdCBuZXh0UG9zaXRpb24gPSBwb3NpdGlvbnMubGVuZ3RoID4gMCA/IE1hdGgubWF4KC4uLnBvc2l0aW9ucykgKyAxIDogMQoKICAgIC8vIENyaWFyIHRvZG9zIG9zIGFuZGFyZXMgZGEgcHJhdGVsZWlyYQogICAgZm9yIChsZXQgbGV2ZWwgPSAxOyBsZXZlbCA8PSBhaXNsZS5zaGVsZkxldmVsczsgbGV2ZWwrKykgewogICAgICBhd2FpdCBhZGRTaGVsZihhaXNsZUlkLCBuZXh0UG9zaXRpb24sIGxldmVsKQogICAgfQoKICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyhhaXNsZS53YXJlaG91c2VJZCkKICAgIHJldHVybiB7CiAgICAgIG1lc3NhZ2U6IGBQcmF0ZWxlaXJhICR7bmV4dFBvc2l0aW9ufSBjb20gJHthaXNsZS5zaGVsZkxldmVsc30gYW5kYXJlcyBhZGljaW9uYWRhIGNvbSBzdWNlc3NvIWAsCiAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImFkaWNpb25hciBwcmF0ZWxlaXJhIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhZGRQYWxsZXRzVG9BaXNsZShhaXNsZUlkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3QgY291bnQgPSBOdW1iZXIoZm9ybURhdGEuZ2V0KCJjb3VudCIpKQoKICAgIGlmICghY291bnQgfHwgY291bnQgPD0gMCB8fCBjb3VudCA+IDUwKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJOw7ptZXJvIGRlIHBhbGV0ZXMgZGV2ZSBlc3RhciBlbnRyZSAxIGUgNTAuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IHZhbGlkYXRpb25FcnJvciA9IHZhbGlkYXRlUmVxdWlyZWQoeyBhaXNsZUlkIH0sIFsiYWlzbGVJZCJdKQogICAgaWYgKHZhbGlkYXRpb25FcnJvcikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiB2YWxpZGF0aW9uRXJyb3IsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZChhaXNsZUlkKQogICAgaWYgKCFhaXNsZSkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiUnVhIG7Do28gZW5jb250cmFkYS4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgaWYgKGFpc2xlLnN0b3JhZ2VUeXBlICE9PSAicGFsbGV0IikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiRXN0YSBydWEgbsOjbyDDqSBjb25maWd1cmFkYSBwYXJhIHBhbGV0ZXMuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IGV4aXN0aW5nUGFsbGV0cyA9IGF3YWl0IGdldFBhbGxldHNCeUFpc2xlKGFpc2xlSWQpCiAgICBsZXQgbmV4dFBvc2l0aW9uID0gZXhpc3RpbmdQYWxsZXRzLmxlbmd0aCA+IDAgPyBNYXRoLm1heCguLi5leGlzdGluZ1BhbGxldHMubWFwKChwKSA9PiBwLnBvc2l0aW9uKSkgKyAxIDogMQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICBhd2FpdCBhZGRQYWxsZXQoYWlzbGVJZCwgbmV4dFBvc2l0aW9uKyspCiAgICB9CgogICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKGFpc2xlLndhcmVob3VzZUlkKQogICAgcmV0dXJuIHsgbWVzc2FnZTogYCR7Y291bnR9IHBhbGV0ZXMgYWRpY2lvbmFkb3MgY29tIHN1Y2Vzc28hYCwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImFkaWNpb25hciBwYWxldGVzIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhZGRTaGVsdmVzVG9BaXNsZShhaXNsZUlkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3QgY291bnQgPSBOdW1iZXIoZm9ybURhdGEuZ2V0KCJjb3VudCIpKQoKICAgIGlmICghY291bnQgfHwgY291bnQgPD0gMCB8fCBjb3VudCA+IDUwKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJOw7ptZXJvIGRlIHByYXRlbGVpcmFzIGRldmUgZXN0YXIgZW50cmUgMSBlIDUwLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCB2YWxpZGF0aW9uRXJyb3IgPSB2YWxpZGF0ZVJlcXVpcmVkKHsgYWlzbGVJZCB9LCBbImFpc2xlSWQiXSkKICAgIGlmICh2YWxpZGF0aW9uRXJyb3IpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogdmFsaWRhdGlvbkVycm9yLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgYWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQoYWlzbGVJZCkKICAgIGlmICghYWlzbGUpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlJ1YSBuw6NvIGVuY29udHJhZGEuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGlmIChhaXNsZS5zdG9yYWdlVHlwZSAhPT0gInNoZWxmIikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiRXN0YSBydWEgbsOjbyDDqSBjb25maWd1cmFkYSBwYXJhIHByYXRlbGVpcmFzLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBleGlzdGluZ1NoZWx2ZXMgPSBhd2FpdCBnZXRTaGVsdmVzQnlBaXNsZShhaXNsZUlkKQogICAgY29uc3QgcG9zaXRpb25zID0gZXhpc3RpbmdTaGVsdmVzLm1hcCgocykgPT4gcy5wb3NpdGlvbikKICAgIGxldCBuZXh0UG9zaXRpb24gPSBwb3NpdGlvbnMubGVuZ3RoID4gMCA/IE1hdGgubWF4KC4uLnBvc2l0aW9ucykgKyAxIDogMQoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAvLyBDcmlhciB0b2RvcyBvcyBhbmRhcmVzIHBhcmEgY2FkYSBwcmF0ZWxlaXJhCiAgICAgIGZvciAobGV0IGxldmVsID0gMTsgbGV2ZWwgPD0gYWlzbGUuc2hlbGZMZXZlbHM7IGxldmVsKyspIHsKICAgICAgICBhd2FpdCBhZGRTaGVsZihhaXNsZUlkLCBuZXh0UG9zaXRpb24sIGxldmVsKQogICAgICB9CiAgICAgIG5leHRQb3NpdGlvbisrCiAgICB9CgogICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKGFpc2xlLndhcmVob3VzZUlkKQogICAgcmV0dXJuIHsKICAgICAgbWVzc2FnZTogYCR7Y291bnR9IHByYXRlbGVpcmFzIGNvbSAke2Fpc2xlLnNoZWxmTGV2ZWxzfSBhbmRhcmVzIGNhZGEgYWRpY2lvbmFkYXMgY29tIHN1Y2Vzc28hYCwKICAgICAgc3VjY2VzczogdHJ1ZSwKICAgIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAiYWRpY2lvbmFyIHByYXRlbGVpcmFzIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVBaXNsZU5vdGVzQWN0aW9uKGFpc2xlSWQ6IHN0cmluZywgcHJldlN0YXRlOiBhbnksIGZvcm1EYXRhOiBGb3JtRGF0YSkgewogIHRyeSB7CiAgICBjb25zdCBub3RlcyA9IGZvcm1EYXRhLmdldCgibm90ZXMiKSBhcyBzdHJpbmcKCiAgICBjb25zdCB2YWxpZGF0aW9uRXJyb3IgPSB2YWxpZGF0ZVJlcXVpcmVkKHsgYWlzbGVJZCB9LCBbImFpc2xlSWQiXSkKICAgIGlmICh2YWxpZGF0aW9uRXJyb3IpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogdmFsaWRhdGlvbkVycm9yLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgZXhpc3RpbmdBaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZChhaXNsZUlkKQogICAgaWYgKCFleGlzdGluZ0Fpc2xlKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJSdWEgbsOjbyBlbmNvbnRyYWRhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgdXBkYXRlQWlzbGVOb3RlcyhhaXNsZUlkLCBub3RlcyB8fCAiIikKICAgIGlmICghdXBkYXRlZCkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiRmFsaGEgYW8gYXR1YWxpemFyIG9ic2VydmHDp8O1ZXMuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyhleGlzdGluZ0Fpc2xlLndhcmVob3VzZUlkKQogICAgcmV0dXJuIHsgbWVzc2FnZTogIk9ic2VydmHDp8O1ZXMgYXR1YWxpemFkYXMgY29tIHN1Y2Vzc28hIiwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImF0dWFsaXphciBvYnNlcnZhw6fDtWVzIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVBaXNsZVN0b3JhZ2VDb25maWdBY3Rpb24oYWlzbGVJZDogc3RyaW5nLCBwcmV2U3RhdGU6IGFueSwgZm9ybURhdGE6IEZvcm1EYXRhKSB7CiAgdHJ5IHsKICAgIGNvbnN0IHN0b3JhZ2VUeXBlID0gZm9ybURhdGEuZ2V0KCJzdG9yYWdlVHlwZSIpIGFzICJwYWxsZXQiIHwgInNoZWxmIgogICAgY29uc3Qgc2hlbGZMZXZlbHMgPSBOdW1iZXIoZm9ybURhdGEuZ2V0KCJzaGVsZkxldmVscyIpKSB8fCAxCgogICAgY29uc3QgdmFsaWRhdGlvbkVycm9yID0gdmFsaWRhdGVSZXF1aXJlZCh7IGFpc2xlSWQsIHN0b3JhZ2VUeXBlIH0sIFsiYWlzbGVJZCIsICJzdG9yYWdlVHlwZSJdKQogICAgaWYgKHZhbGlkYXRpb25FcnJvcikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiB2YWxpZGF0aW9uRXJyb3IsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBpZiAoIVsicGFsbGV0IiwgInNoZWxmIl0uaW5jbHVkZXMoc3RvcmFnZVR5cGUpKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJUaXBvIGRlIGFybWF6ZW5hbWVudG8gaW52w6FsaWRvLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBpZiAoc3RvcmFnZVR5cGUgPT09ICJzaGVsZiIgJiYgKHNoZWxmTGV2ZWxzIDwgMSB8fCBzaGVsZkxldmVscyA+IDEwKSkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiTsO6bWVybyBkZSBhbmRhcmVzIGRldmUgZXN0YXIgZW50cmUgMSBlIDEwLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBleGlzdGluZ0Fpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKGFpc2xlSWQpCiAgICBpZiAoIWV4aXN0aW5nQWlzbGUpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlJ1YSBuw6NvIGVuY29udHJhZGEuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCB1cGRhdGVBaXNsZVN0b3JhZ2VDb25maWcoYWlzbGVJZCwgc3RvcmFnZVR5cGUsIHNoZWxmTGV2ZWxzKQogICAgaWYgKCF1cGRhdGVkKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJGYWxoYSBhbyBhdHVhbGl6YXIgY29uZmlndXJhw6fDo28uIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocyhleGlzdGluZ0Fpc2xlLndhcmVob3VzZUlkKQogICAgcmV0dXJuIHsgbWVzc2FnZTogIkNvbmZpZ3VyYcOnw6NvIGF0dWFsaXphZGEgY29tIHN1Y2Vzc28hIiwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImF0dWFsaXphciBjb25maWd1cmHDp8OjbyIpCiAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlUGFsbGV0QWN0aW9uKHBhbGxldElkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3QgdmFsaWRhdGlvbkVycm9yID0gdmFsaWRhdGVSZXF1aXJlZCh7IHBhbGxldElkIH0sIFsicGFsbGV0SWQiXSkKICAgIGlmICh2YWxpZGF0aW9uRXJyb3IpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogdmFsaWRhdGlvbkVycm9yLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgcGFsbGV0ID0gYXdhaXQgZ2V0UGFsbGV0QnlJZChwYWxsZXRJZCkKICAgIGlmICghcGFsbGV0KSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJQYWxldGUgbsOjbyBlbmNvbnRyYWRvLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZChwYWxsZXQuYWlzbGVJZCkKICAgIGlmICghYWlzbGUpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlJ1YSBuw6NvIGVuY29udHJhZGEuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IGRlbGV0ZWQgPSBhd2FpdCBkZWxldGVQYWxsZXQocGFsbGV0SWQpCiAgICBpZiAoIWRlbGV0ZWQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIkZhbGhhIGFvIGV4Y2x1aXIgcGFsZXRlLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoYWlzbGUud2FyZWhvdXNlSWQpCiAgICByZXR1cm4geyBtZXNzYWdlOiBgUGFsZXRlICR7cGFsbGV0LnBvc2l0aW9ufSBleGNsdcOtZG8gY29tIHN1Y2Vzc28hYCwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImV4Y2x1aXIgcGFsZXRlIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWxldGVTaGVsZkFjdGlvbihzaGVsZklkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3QgdmFsaWRhdGlvbkVycm9yID0gdmFsaWRhdGVSZXF1aXJlZCh7IHNoZWxmSWQgfSwgWyJzaGVsZklkIl0pCiAgICBpZiAodmFsaWRhdGlvbkVycm9yKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6IHZhbGlkYXRpb25FcnJvciwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IHNoZWxmID0gYXdhaXQgZ2V0U2hlbGZCeUlkKHNoZWxmSWQpCiAgICBpZiAoIXNoZWxmKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJQcmF0ZWxlaXJhIG7Do28gZW5jb250cmFkYS4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgYWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQoc2hlbGYuYWlzbGVJZCkKICAgIGlmICghYWlzbGUpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlJ1YSBuw6NvIGVuY29udHJhZGEuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIC8vIFNlIGZvciBvIHByaW1laXJvIGFuZGFyIChBMSksIGV4Y2x1aXIgdG9kYSBhIHByYXRlbGVpcmEgKHRvZG9zIG9zIGFuZGFyZXMpCiAgICBpZiAoc2hlbGYubGV2ZWwgPT09IDEpIHsKICAgICAgLy8gQnVzY2FyIHRvZG9zIG9zIGFuZGFyZXMgZGVzdGEgcHJhdGVsZWlyYQogICAgICBjb25zdCBhbGxTaGVsdmVzID0gYXdhaXQgZ2V0U2hlbHZlc0J5QWlzbGUoc2hlbGYuYWlzbGVJZCkKICAgICAgY29uc3Qgc2hlbHZlc1RvRGVsZXRlID0gYWxsU2hlbHZlcy5maWx0ZXIoKHMpID0+IHMucG9zaXRpb24gPT09IHNoZWxmLnBvc2l0aW9uKQoKICAgICAgLy8gRXhjbHVpciB0b2RvcyBvcyBhbmRhcmVzCiAgICAgIGxldCBkZWxldGVkQ291bnQgPSAwCiAgICAgIGZvciAoY29uc3Qgc2hlbGZUb0RlbGV0ZSBvZiBzaGVsdmVzVG9EZWxldGUpIHsKICAgICAgICBjb25zdCBkZWxldGVkID0gYXdhaXQgZGVsZXRlU2hlbGYoc2hlbGZUb0RlbGV0ZS5pZCkKICAgICAgICBpZiAoZGVsZXRlZCkgewogICAgICAgICAgZGVsZXRlZENvdW50KysKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChkZWxldGVkQ291bnQgPiAwKSB7CiAgICAgICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKGFpc2xlLndhcmVob3VzZUlkKQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBtZXNzYWdlOiBgUHJhdGVsZWlyYSAke3NoZWxmLnBvc2l0aW9ufSBjb21wbGV0YSAoJHtkZWxldGVkQ291bnR9IGFuZGFyZXMpIGV4Y2x1w61kYSBjb20gc3VjZXNzbyFgLAogICAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJPcGVyYcOnw6NvIG7Do28gcGVybWl0aWRhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICByZXR1cm4geyBtZXNzYWdlOiAiRmFsaGEgYW8gZXhjbHVpciBwcmF0ZWxlaXJhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAiZXhjbHVpciBwcmF0ZWxlaXJhIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWxldGVXYXJlaG91c2VBY3Rpb24od2FyZWhvdXNlSWQ6IHN0cmluZywgcHJldlN0YXRlOiBhbnksIGZvcm1EYXRhOiBGb3JtRGF0YSkgewogIHRyeSB7CiAgICBjb25zdCB2YWxpZGF0aW9uRXJyb3IgPSB2YWxpZGF0ZVJlcXVpcmVkKHsgd2FyZWhvdXNlSWQgfSwgWyJ3YXJlaG91c2VJZCJdKQogICAgaWYgKHZhbGlkYXRpb25FcnJvcikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiB2YWxpZGF0aW9uRXJyb3IsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBkZWxldGVkID0gYXdhaXQgZGVsZXRlV2FyZWhvdXNlKHdhcmVob3VzZUlkKQogICAgaWYgKCFkZWxldGVkKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJGYWxoYSBhbyBleGNsdWlyIGdhbHDDo28uIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocygpCiAgICByZXR1cm4geyBtZXNzYWdlOiAiR2FscMOjbyBleGNsdcOtZG8gY29tIHN1Y2Vzc28hIiwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImV4Y2x1aXIgZ2FscMOjbyIpCiAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlQWlzbGVBY3Rpb24oYWlzbGVJZDogc3RyaW5nLCBwcmV2U3RhdGU6IGFueSwgZm9ybURhdGE6IEZvcm1EYXRhKSB7CiAgdHJ5IHsKICAgIGNvbnN0IHZhbGlkYXRpb25FcnJvciA9IHZhbGlkYXRlUmVxdWlyZWQoeyBhaXNsZUlkIH0sIFsiYWlzbGVJZCJdKQogICAgaWYgKHZhbGlkYXRpb25FcnJvcikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiB2YWxpZGF0aW9uRXJyb3IsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCBhaXNsZSA9IGF3YWl0IGdldEFpc2xlQnlJZChhaXNsZUlkKQogICAgaWYgKCFhaXNsZSkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiUnVhIG7Do28gZW5jb250cmFkYS4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgZGVsZXRlZCA9IGF3YWl0IGRlbGV0ZUFpc2xlKGFpc2xlSWQpCiAgICBpZiAoIWRlbGV0ZWQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIkZhbGhhIGFvIGV4Y2x1aXIgcnVhLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoYWlzbGUud2FyZWhvdXNlSWQpCiAgICByZXR1cm4geyBtZXNzYWdlOiBgUnVhICIke2Fpc2xlLm5hbWV9IiBleGNsdcOtZGEgY29tIHN1Y2Vzc28hYCwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImV4Y2x1aXIgcnVhIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhc3NpZ25Qcm9kdWN0VG9QYWxsZXQocGFsbGV0SWQ6IHN0cmluZywgcHJldlN0YXRlOiBhbnksIGZvcm1EYXRhOiBGb3JtRGF0YSkgewogIGNvbnNvbGUubG9nKCLwn5qAIFtBQ1RJT05dIGFzc2lnblByb2R1Y3RUb1BhbGxldCBpbmljaWFkYSIpCiAgY29uc29sZS5sb2coIvCfk50gUGFyw6JtZXRyb3MgcmVjZWJpZG9zOiIsIHsKICAgIHBhbGxldElkLAogICAgcHJldlN0YXRlLAogICAgZm9ybURhdGFFbnRyaWVzOiBPYmplY3QuZnJvbUVudHJpZXMoZm9ybURhdGEuZW50cmllcygpKSwKICB9KQoKICB0cnkgewogICAgY29uc3QgZWFuID0gZm9ybURhdGEuZ2V0KCJlYW4iKSBhcyBzdHJpbmcgLy8gRXN0ZSDDqSBvIElEIGRvIHByb2R1dG8gKGNvbHVuYSBFKQogICAgY29uc3QgcHJvZHVjdE5hbWUgPSBmb3JtRGF0YS5nZXQoInByb2R1Y3ROYW1lIikgYXMgc3RyaW5nCiAgICBjb25zdCBwcm9kdWN0Q2F0ZWdvcnkgPSBmb3JtRGF0YS5nZXQoInByb2R1Y3RDYXRlZ29yeSIpIGFzIHN0cmluZwogICAgY29uc3QgcHJvZHVjdEJyYW5kID0gZm9ybURhdGEuZ2V0KCJwcm9kdWN0QnJhbmQiKSBhcyBzdHJpbmcKICAgIGNvbnN0IHByb2R1Y3RFYW4gPSBmb3JtRGF0YS5nZXQoInByb2R1Y3RFYW4iKSBhcyBzdHJpbmcgLy8gRXN0ZSDDqSBvIEVBTiByZWFsIChjb2x1bmEgQSkgLSBhZ29yYSBzZXLDoSBzYWx2byBjb21vIEVBTjEzCgogICAgY29uc29sZS5sb2coIvCfk4sgRGFkb3MgZXh0cmHDrWRvcyBkbyBGb3JtRGF0YToiLCB7CiAgICAgIGVhbiwgLy8gSUQgZG8gcHJvZHV0bwogICAgICBwcm9kdWN0TmFtZSwKICAgICAgcHJvZHVjdENhdGVnb3J5LAogICAgICBwcm9kdWN0QnJhbmQsCiAgICAgIHByb2R1Y3RFYW4sIC8vIEVBTiByZWFsIHF1ZSBzZXLDoSBzYWx2byBjb21vIEVBTjEzCiAgICB9KQoKICAgIC8vIFZhbGlkYcOnw6NvIHVzYW5kbyBEYXRhVmFsaWRhdG9yCiAgICBjb25zdCB2YWxpZGF0aW9uID0gRGF0YVZhbGlkYXRvci52YWxpZGF0ZVByb2R1Y3QoeyBlYW4sIHByb2R1Y3ROYW1lIH0pCiAgICBpZiAoIXZhbGlkYXRpb24uaXNWYWxpZCkgewogICAgICBjb25zb2xlLmxvZygi4p2MIEVycm8gZGUgdmFsaWRhw6fDo286IiwgdmFsaWRhdGlvbi5lcnJvcnNbMF0ubWVzc2FnZSkKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogdmFsaWRhdGlvbi5lcnJvcnNbMF0ubWVzc2FnZSwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIC8vIFVzYXIgY2F0ZWdvcmlhIGRhIHBsYW5pbGhhIHNlIGRpc3BvbsOtdmVsLCBzZW7Do28gdXNhciBkZXRlY8Onw6NvIGF1dG9tw6F0aWNhCiAgICBjb25zdCBmaW5hbENhdGVnb3J5ID0KICAgICAgcHJvZHVjdENhdGVnb3J5ICYmIHByb2R1Y3RDYXRlZ29yeS50cmltKCkgIT09ICIiCiAgICAgICAgPyBwcm9kdWN0Q2F0ZWdvcnkudG9VcHBlckNhc2UoKQogICAgICAgIDogZGV0ZWN0UHJvZHVjdENhdGVnb3J5KHByb2R1Y3ROYW1lKQoKICAgIGNvbnNvbGUubG9nKCLwn4+377iPIENhdGVnb3JpYSBmaW5hbCBkZXRlcm1pbmFkYToiLCBmaW5hbENhdGVnb3J5KQoKICAgIGNvbnNvbGUubG9nKCLwn5K+IENoYW1hbmRvIHVwZGF0ZVBhbGxldCBjb20gZGFkb3M6IiwgewogICAgICBwYWxsZXRJZCwKICAgICAgZWFuOiBlYW4udHJpbSgpLCAvLyBJRCBkbyBwcm9kdXRvCiAgICAgIHByb2R1Y3ROYW1lOiBwcm9kdWN0TmFtZS50cmltKCksCiAgICAgIGZpbmFsQ2F0ZWdvcnksCiAgICAgIGVhbjEzOiBwcm9kdWN0RWFuPy50cmltKCkgfHwgIiIsIC8vIEVBTiByZWFsIGRvIHByb2R1dG8gKEVBTjEzKQogICAgfSkKCiAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgdXBkYXRlUGFsbGV0KAogICAgICBwYWxsZXRJZCwKICAgICAgZWFuLnRyaW0oKSwgLy8gSUQgZG8gcHJvZHV0bwogICAgICBwcm9kdWN0TmFtZS50cmltKCksCiAgICAgIGZpbmFsQ2F0ZWdvcnksCiAgICAgIHByb2R1Y3RFYW4/LnRyaW0oKSB8fCAiIiwgLy8gRUFOIHJlYWwgZG8gcHJvZHV0byAoRUFOMTMpCiAgICApCgogICAgY29uc29sZS5sb2coIvCfk4ogUmVzdWx0YWRvIGRvIHVwZGF0ZVBhbGxldDoiLCB1cGRhdGVkKQoKICAgIGlmICghdXBkYXRlZCkgewogICAgICBjb25zb2xlLmxvZygi4p2MIFBhbGV0ZSBuw6NvIGVuY29udHJhZG8iKQogICAgICByZXR1cm4geyBtZXNzYWdlOiAiUGFsZXRlIG7Do28gZW5jb250cmFkby4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc29sZS5sb2coIuKchSBQYWxldGUgYXR1YWxpemFkbyBjb20gc3VjZXNzbyEiKQoKICAgIGNvbnN0IGFpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKHVwZGF0ZWQuYWlzbGVJZCkKICAgIGNvbnNvbGUubG9nKCLwn4+iIEFpc2xlIGVuY29udHJhZGE6IiwgYWlzbGUpCgogICAgaWYgKGFpc2xlPy53YXJlaG91c2VJZCkgewogICAgICBjb25zb2xlLmxvZygi8J+UhCBSZXZhbGlkYW5kbyBwYXRocyBwYXJhIHdhcmVob3VzZToiLCBhaXNsZS53YXJlaG91c2VJZCkKICAgICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKGFpc2xlLndhcmVob3VzZUlkKQogICAgfQoKICAgIGNvbnN0IHN1Y2Nlc3NNZXNzYWdlID0gIlByb2R1dG8gYXRyaWJ1w61kbyBjb20gc3VjZXNzbyEiCiAgICBjb25zb2xlLmxvZygi8J+OiSBSZXRvcm5hbmRvIHN1Y2Vzc286Iiwgc3VjY2Vzc01lc3NhZ2UpCgogICAgcmV0dXJuIHsgbWVzc2FnZTogc3VjY2Vzc01lc3NhZ2UsIHN1Y2Nlc3M6IHRydWUgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gaGFuZGxlQWN0aW9uRXJyb3IoZXJyb3IsICJhdHJpYnVpciBwcm9kdXRvIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhc3NpZ25Qcm9kdWN0VG9TaGVsZihzaGVsZklkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICBjb25zb2xlLmxvZygi8J+agCBbQUNUSU9OXSBhc3NpZ25Qcm9kdWN0VG9TaGVsZiBpbmljaWFkYSIpCiAgY29uc29sZS5sb2coIvCfk50gUGFyw6JtZXRyb3MgcmVjZWJpZG9zOiIsIHsKICAgIHNoZWxmSWQsCiAgICBwcmV2U3RhdGUsCiAgICBmb3JtRGF0YUVudHJpZXM6IE9iamVjdC5mcm9tRW50cmllcyhmb3JtRGF0YS5lbnRyaWVzKCkpLAogIH0pCgogIHRyeSB7CiAgICBjb25zdCBlYW4gPSBmb3JtRGF0YS5nZXQoImVhbiIpIGFzIHN0cmluZyAvLyBFc3RlIMOpIG8gSUQgZG8gcHJvZHV0byAoY29sdW5hIEUpCiAgICBjb25zdCBwcm9kdWN0TmFtZSA9IGZvcm1EYXRhLmdldCgicHJvZHVjdE5hbWUiKSBhcyBzdHJpbmcKICAgIGNvbnN0IG9jY3VwYW5jeVBlcmNlbnRhZ2UgPSBOdW1iZXIoZm9ybURhdGEuZ2V0KCJvY2N1cGFuY3lQZXJjZW50YWdlIikpIHx8IDI1CiAgICBjb25zdCBwcm9kdWN0Q2F0ZWdvcnkgPSBmb3JtRGF0YS5nZXQoInByb2R1Y3RDYXRlZ29yeSIpIGFzIHN0cmluZwogICAgY29uc3QgcHJvZHVjdEJyYW5kID0gZm9ybURhdGEuZ2V0KCJwcm9kdWN0QnJhbmQiKSBhcyBzdHJpbmcKICAgIGNvbnN0IHByb2R1Y3RFYW4gPSBmb3JtRGF0YS5nZXQoInByb2R1Y3RFYW4iKSBhcyBzdHJpbmcgLy8gRXN0ZSDDqSBvIEVBTiByZWFsIChjb2x1bmEgQSkgLSBhZ29yYSBzZXLDoSBzYWx2byBjb21vIEVBTjEzCgogICAgY29uc29sZS5sb2coIvCfk4sgRGFkb3MgZXh0cmHDrWRvcyBkbyBGb3JtRGF0YToiLCB7CiAgICAgIGVhbiwgLy8gSUQgZG8gcHJvZHV0bwogICAgICBwcm9kdWN0TmFtZSwKICAgICAgb2NjdXBhbmN5UGVyY2VudGFnZSwKICAgICAgcHJvZHVjdENhdGVnb3J5LAogICAgICBwcm9kdWN0QnJhbmQsCiAgICAgIHByb2R1Y3RFYW4sIC8vIEVBTiByZWFsIHF1ZSBzZXLDoSBzYWx2byBjb21vIEVBTjEzCiAgICB9KQoKICAgIC8vIFZhbGlkYcOnw6NvIHVzYW5kbyBEYXRhVmFsaWRhdG9yCiAgICBjb25zdCB2YWxpZGF0aW9uID0gRGF0YVZhbGlkYXRvci52YWxpZGF0ZVByb2R1Y3QoeyBlYW4sIHByb2R1Y3ROYW1lLCBvY2N1cGFuY3lQZXJjZW50YWdlIH0pCiAgICBpZiAoIXZhbGlkYXRpb24uaXNWYWxpZCkgewogICAgICBjb25zb2xlLmxvZygi4p2MIEVycm8gZGUgdmFsaWRhw6fDo286IiwgdmFsaWRhdGlvbi5lcnJvcnNbMF0ubWVzc2FnZSkKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogdmFsaWRhdGlvbi5lcnJvcnNbMF0ubWVzc2FnZSwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIC8vIFVzYXIgY2F0ZWdvcmlhIGRhIHBsYW5pbGhhIHNlIGRpc3BvbsOtdmVsLCBzZW7Do28gdXNhciBkZXRlY8Onw6NvIGF1dG9tw6F0aWNhCiAgICBjb25zdCBmaW5hbENhdGVnb3J5ID0KICAgICAgcHJvZHVjdENhdGVnb3J5ICYmIHByb2R1Y3RDYXRlZ29yeS50cmltKCkgIT09ICIiCiAgICAgICAgPyBwcm9kdWN0Q2F0ZWdvcnkudG9VcHBlckNhc2UoKQogICAgICAgIDogZGV0ZWN0UHJvZHVjdENhdGVnb3J5KHByb2R1Y3ROYW1lKQoKICAgIGNvbnNvbGUubG9nKCLwn4+377iPIENhdGVnb3JpYSBmaW5hbCBkZXRlcm1pbmFkYToiLCBmaW5hbENhdGVnb3J5KQoKICAgIGNvbnNvbGUubG9nKCLwn5K+IENoYW1hbmRvIHVwZGF0ZVNoZWxmIGNvbSBkYWRvczoiLCB7CiAgICAgIHNoZWxmSWQsCiAgICAgIGVhbjogZWFuLnRyaW0oKSwgLy8gSUQgZG8gcHJvZHV0bwogICAgICBwcm9kdWN0TmFtZTogcHJvZHVjdE5hbWUudHJpbSgpLAogICAgICBvY2N1cGFuY3lQZXJjZW50YWdlLAogICAgICBmaW5hbENhdGVnb3J5LAogICAgICBlYW4xMzogcHJvZHVjdEVhbj8udHJpbSgpIHx8ICIiLCAvLyBFQU4gcmVhbCBkbyBwcm9kdXRvCiAgICB9KQoKICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCB1cGRhdGVTaGVsZigKICAgICAgc2hlbGZJZCwKICAgICAgZWFuLnRyaW0oKSwgLy8gSUQgZG8gcHJvZHV0bwogICAgICBwcm9kdWN0TmFtZS50cmltKCksCiAgICAgIG9jY3VwYW5jeVBlcmNlbnRhZ2UsCiAgICAgIGZpbmFsQ2F0ZWdvcnksCiAgICAgIHByb2R1Y3RFYW4/LnRyaW0oKSB8fCAiIiwgLy8gRUFOIHJlYWwgZG8gcHJvZHV0byAoRUFOMTMpCiAgICApCgogICAgY29uc29sZS5sb2coIvCfk4ogUmVzdWx0YWRvIGRvIHVwZGF0ZVNoZWxmOiIsIHVwZGF0ZWQpCgogICAgaWYgKCF1cGRhdGVkKSB7CiAgICAgIGNvbnNvbGUubG9nKCLinYwgUHJhdGVsZWlyYSBuw6NvIGVuY29udHJhZGEiKQogICAgICByZXR1cm4geyBtZXNzYWdlOiAiUHJhdGVsZWlyYSBuw6NvIGVuY29udHJhZGEuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnNvbGUubG9nKCLinIUgUHJhdGVsZWlyYSBhdHVhbGl6YWRhIGNvbSBzdWNlc3NvISIpCgogICAgY29uc3QgYWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQodXBkYXRlZC5haXNsZUlkKQogICAgY29uc29sZS5sb2coIvCfj6IgQWlzbGUgZW5jb250cmFkYToiLCBhaXNsZSkKCiAgICBpZiAoYWlzbGU/LndhcmVob3VzZUlkKSB7CiAgICAgIGNvbnNvbGUubG9nKCLwn5SEIFJldmFsaWRhbmRvIHBhdGhzIHBhcmEgd2FyZWhvdXNlOiIsIGFpc2xlLndhcmVob3VzZUlkKQogICAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoYWlzbGUud2FyZWhvdXNlSWQpCiAgICB9CgogICAgY29uc3Qgc3VjY2Vzc01lc3NhZ2UgPSAiUHJvZHV0byBhdHJpYnXDrWRvIGNvbSBzdWNlc3NvISIKICAgIGNvbnNvbGUubG9nKCLwn46JIFJldG9ybmFuZG8gc3VjZXNzbzoiLCBzdWNjZXNzTWVzc2FnZSkKCiAgICByZXR1cm4geyBtZXNzYWdlOiBzdWNjZXNzTWVzc2FnZSwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImF0cmlidWlyIHByb2R1dG8iKQogIH0KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHZlcmlmeVBhbGxldEFjdGlvbihwYWxsZXRJZDogc3RyaW5nLCBwcmV2U3RhdGU6IGFueSwgZm9ybURhdGE6IEZvcm1EYXRhKSB7CiAgdHJ5IHsKICAgIGNvbnN0IHZhbGlkYXRpb25FcnJvciA9IHZhbGlkYXRlUmVxdWlyZWQoeyBwYWxsZXRJZCB9LCBbInBhbGxldElkIl0pCiAgICBpZiAodmFsaWRhdGlvbkVycm9yKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6IHZhbGlkYXRpb25FcnJvciwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCB2ZXJpZnlQYWxsZXQocGFsbGV0SWQpCiAgICBpZiAoIXVwZGF0ZWQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlBhbGV0ZSBuw6NvIGVuY29udHJhZG8uIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IGFpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKHVwZGF0ZWQuYWlzbGVJZCkKICAgIGlmIChhaXNsZT8ud2FyZWhvdXNlSWQpIHsKICAgICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKGFpc2xlLndhcmVob3VzZUlkKQogICAgfQoKICAgIHJldHVybiB7IG1lc3NhZ2U6ICJQYWxldGUgdmVyaWZpY2FkbyBjb20gc3VjZXNzbyEiLCBzdWNjZXNzOiB0cnVlIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAidmVyaWZpY2FyIHBhbGV0ZSIpCiAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gdmVyaWZ5U2hlbGZBY3Rpb24oc2hlbGZJZDogc3RyaW5nLCBwcmV2U3RhdGU6IGFueSwgZm9ybURhdGE6IEZvcm1EYXRhKSB7CiAgdHJ5IHsKICAgIGNvbnN0IHZhbGlkYXRpb25FcnJvciA9IHZhbGlkYXRlUmVxdWlyZWQoeyBzaGVsZklkIH0sIFsic2hlbGZJZCJdKQogICAgaWYgKHZhbGlkYXRpb25FcnJvcikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiB2YWxpZGF0aW9uRXJyb3IsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgdmVyaWZ5U2hlbGYoc2hlbGZJZCkKICAgIGlmICghdXBkYXRlZCkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiUHJhdGVsZWlyYSBuw6NvIGVuY29udHJhZGEuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IGFpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKHVwZGF0ZWQuYWlzbGVJZCkKICAgIGlmIChhaXNsZT8ud2FyZWhvdXNlSWQpIHsKICAgICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKGFpc2xlLndhcmVob3VzZUlkKQogICAgfQoKICAgIHJldHVybiB7IG1lc3NhZ2U6ICJQcmF0ZWxlaXJhIHZlcmlmaWNhZGEgY29tIHN1Y2Vzc28hIiwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgInZlcmlmaWNhciBwcmF0ZWxlaXJhIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW9yZGVyUGFsbGV0c0FjdGlvbigKICBhaXNsZUlkOiBzdHJpbmcsCiAgbmV3UGFsbGV0T3JkZXJJZHM6IHN0cmluZ1tdLAopOiBQcm9taXNlPHsgbWVzc2FnZTogc3RyaW5nOyBzdWNjZXNzOiBib29sZWFuIH0+IHsKICB0cnkgewogICAgY29uc3QgdmFsaWRhdGlvbkVycm9yID0gdmFsaWRhdGVSZXF1aXJlZCh7IGFpc2xlSWQgfSwgWyJhaXNsZUlkIl0pCiAgICBpZiAodmFsaWRhdGlvbkVycm9yKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6IHZhbGlkYXRpb25FcnJvciwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGlmICghQXJyYXkuaXNBcnJheShuZXdQYWxsZXRPcmRlcklkcykgfHwgbmV3UGFsbGV0T3JkZXJJZHMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJMaXN0YSBkZSBwYWxldGVzIGludsOhbGlkYS4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IHJlb3JkZXJQYWxsZXRzKGFpc2xlSWQsIG5ld1BhbGxldE9yZGVySWRzKQogICAgaWYgKCFzdWNjZXNzKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJGYWxoYSBhbyByZW9yZGVuYXIgcGFsZXRlcy4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgYWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQoYWlzbGVJZCkKICAgIGlmIChhaXNsZT8ud2FyZWhvdXNlSWQpIHsKICAgICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKGFpc2xlLndhcmVob3VzZUlkKQogICAgfQoKICAgIHJldHVybiB7IG1lc3NhZ2U6ICJQYWxldGVzIHJlb3JkZW5hZG9zIGNvbSBzdWNlc3NvISIsIHN1Y2Nlc3M6IHRydWUgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gaGFuZGxlQWN0aW9uRXJyb3IoZXJyb3IsICJyZW9yZGVuYXIgcGFsZXRlcyIpCiAgfQp9CgppbnRlcmZhY2UgU2VhcmNoU3RhdGUgewogIG1lc3NhZ2U6IHN0cmluZwogIHN1Y2Nlc3M6IGJvb2xlYW4KICByZXN1bHRzPzogU2VhcmNoUmVzdWx0W10KfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlYXJjaFByb2R1Y3RCeUVBTihwcmV2U3RhdGU6IFNlYXJjaFN0YXRlLCBmb3JtRGF0YTogRm9ybURhdGEpOiBQcm9taXNlPFNlYXJjaFN0YXRlPiB7CiAgdHJ5IHsKICAgIGNvbnN0IHNlYXJjaFRlcm0gPSBmb3JtRGF0YS5nZXQoImVhbiIpIGFzIHN0cmluZwoKICAgIGlmICghc2VhcmNoVGVybSB8fCBzZWFyY2hUZXJtLnRyaW0oKSA9PT0gIiIpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlBvciBmYXZvciwgaW5zaXJhIHVtIEVBTiBvdSBJRCBwYXJhIHBlc3F1aXNhci4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgLy8gVmFsaWRhw6fDo28gZG8gRUFOCiAgICBjb25zdCB2YWxpZGF0aW9uID0gRGF0YVZhbGlkYXRvci52YWxpZGF0ZUVBTihzZWFyY2hUZXJtKQogICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogdmFsaWRhdGlvbi5lcnJvcnNbMF0ubWVzc2FnZSwgc3VjY2VzczogZmFsc2UsIHJlc3VsdHM6IFtdIH0KICAgIH0KCiAgICBjb25zb2xlLmxvZyhgW0FDVElPTl0gQnVzY2FuZG8gcHJvZHV0byBjb20gdGVybW86ICIke3NlYXJjaFRlcm19ImApCgogICAgLy8gUHJpbWVpcm8gdGVudGFyIGJ1c2NhciBwb3IgSUQgKGNvbHVuYSBFKSAtIGJ1c2NhIGV4YXRhIG5vIHNpc3RlbWEgaW50ZXJubwogICAgbGV0IHJlc3VsdHMgPSBhd2FpdCBmaW5kUHJvZHVjdEJ5RUFOKHNlYXJjaFRlcm0udHJpbSgpKQoKICAgIC8vIFNlIG7Do28gZW5jb250cm91IHBvciBJRCwgdGVudGFyIGJ1c2NhciBwb3IgRUFOIHJlYWwgbmEgcGxhbmlsaGEgZGUgcHJvZHV0b3MKICAgIGlmIChyZXN1bHRzLmxlbmd0aCA9PT0gMCkgewogICAgICBjb25zb2xlLmxvZyhgW0FDVElPTl0gTsOjbyBlbmNvbnRyYWRvIHBvciBJRCwgdGVudGFuZG8gYnVzY2FyIHBvciBFQU4gbmEgcGxhbmlsaGEuLi5gKQoKICAgICAgdHJ5IHsKICAgICAgICAvLyBCdXNjYXIgbmEgcGxhbmlsaGEgZGUgcHJvZHV0b3MgcG9yIEVBTgogICAgICAgIGNvbnN0IHByb2R1Y3QgPSBhd2FpdCBwcm9kdWN0c1NoZWV0c1NlcnZpY2UuZmluZFByb2R1Y3RCeUVBTihzZWFyY2hUZXJtLnRyaW0oKSkKCiAgICAgICAgaWYgKHByb2R1Y3QgJiYgcHJvZHVjdC5pZCkgewogICAgICAgICAgY29uc29sZS5sb2coYFtBQ1RJT05dIFByb2R1dG8gZW5jb250cmFkbyBuYSBwbGFuaWxoYSBwb3IgRUFOLCBidXNjYW5kbyBwb3IgSUQ6ICR7cHJvZHVjdC5pZH1gKQogICAgICAgICAgLy8gU2UgZW5jb250cm91IG5hIHBsYW5pbGhhLCBidXNjYXIgbm8gc2lzdGVtYSB1c2FuZG8gbyBJRAogICAgICAgICAgcmVzdWx0cyA9IGF3YWl0IGZpbmRQcm9kdWN0QnlFQU4ocHJvZHVjdC5pZCkKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiW0FDVElPTl0gRXJybyBhbyBidXNjYXIgbmEgcGxhbmlsaGEgZGUgcHJvZHV0b3M6IiwgZXJyb3IpCiAgICAgIH0KICAgIH0KCiAgICAvLyBCdXNjYXIgd2FyZWhvdXNlIElEIHBhcmEgY2FkYSByZXN1bHRhZG8KICAgIGNvbnN0IHJlc3VsdHNXaXRoV2FyZWhvdXNlSWQgPSBhd2FpdCBQcm9taXNlLmFsbCgKICAgICAgcmVzdWx0cy5tYXAoYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgIGNvbnN0IHdhcmVob3VzZUlkID0gYXdhaXQgZmluZFdhcmVob3VzZUlkQnlBaXNsZUlkKHJlc3VsdC5haXNsZUlkKQogICAgICAgIHJldHVybiB7CiAgICAgICAgICAuLi5yZXN1bHQsCiAgICAgICAgICB3YXJlaG91c2VJZCwKICAgICAgICB9CiAgICAgIH0pLAogICAgKQoKICAgIGlmIChyZXN1bHRzV2l0aFdhcmVob3VzZUlkLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiBgTmVuaHVtIHByb2R1dG8gZW5jb250cmFkbyBjb20gbyB0ZXJtbzogJHtzZWFyY2hUZXJtfWAsIHN1Y2Nlc3M6IHRydWUsIHJlc3VsdHM6IFtdIH0KICAgIH0KCiAgICByZXR1cm4gewogICAgICBtZXNzYWdlOiBgJHtyZXN1bHRzV2l0aFdhcmVob3VzZUlkLmxlbmd0aH0gcHJvZHV0byhzKSBlbmNvbnRyYWRvKHMpLmAsCiAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgIHJlc3VsdHM6IHJlc3VsdHNXaXRoV2FyZWhvdXNlSWQsCiAgICB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoIltBQ1RJT05dIEVycm8gYW8gYnVzY2FyIHByb2R1dG86IiwgZXJyb3IpCiAgICByZXR1cm4geyBtZXNzYWdlOiAiRXJybyBhbyBidXNjYXIgcHJvZHV0by4gVGVudGUgbm92YW1lbnRlLiIsIHN1Y2Nlc3M6IGZhbHNlLCByZXN1bHRzOiBbXSB9CiAgfQp9CgppbnRlcmZhY2UgQWRkcmVzc1NlYXJjaFN0YXRlIHsKICBtZXNzYWdlOiBzdHJpbmcKICBzdWNjZXNzOiBib29sZWFuCiAgcmVzdWx0PzogQWRkcmVzc1NlYXJjaFJlc3VsdCB8IG51bGwKfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlYXJjaEJ5QWRkcmVzcyhwcmV2U3RhdGU6IEFkZHJlc3NTZWFyY2hTdGF0ZSwgZm9ybURhdGE6IEZvcm1EYXRhKTogUHJvbWlzZTxBZGRyZXNzU2VhcmNoU3RhdGU+IHsKICB0cnkgewogICAgY29uc3QgYWRkcmVzcyA9IGZvcm1EYXRhLmdldCgiYWRkcmVzcyIpIGFzIHN0cmluZwoKICAgIGlmICghYWRkcmVzcyB8fCBhZGRyZXNzLnRyaW0oKSA9PT0gIiIpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlBvciBmYXZvciwgaW5zaXJhIHVtIGVuZGVyZcOnbyBwYXJhIHBlc3F1aXNhci4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgLy8gVmFsaWRhw6fDo28gZG8gZW5kZXJlw6dvCiAgICBjb25zdCB2YWxpZGF0aW9uID0gRGF0YVZhbGlkYXRvci52YWxpZGF0ZUFkZHJlc3MoYWRkcmVzcykKICAgIGlmICghdmFsaWRhdGlvbi5pc1ZhbGlkKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6IHZhbGlkYXRpb24uZXJyb3JzWzBdLm1lc3NhZ2UsIHN1Y2Nlc3M6IGZhbHNlLCByZXN1bHQ6IG51bGwgfQogICAgfQoKICAgIGNvbnNvbGUubG9nKGBbQUNUSU9OXSBCdXNjYW5kbyBlbmRlcmXDp286ICIke2FkZHJlc3N9ImApCgogICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZmluZEJ5QWRkcmVzcyhhZGRyZXNzLnRyaW0oKSkKCiAgICBpZiAoIXJlc3VsdCkgewogICAgICByZXR1cm4gewogICAgICAgIG1lc3NhZ2U6IGBFbmRlcmXDp28gbsOjbyBlbmNvbnRyYWRvOiAke2FkZHJlc3N9LiBWZXJpZmlxdWUgbyBmb3JtYXRvIChleDogQTE3UjFQMiBvdSBBMTdSMVAyQTEpLmAsCiAgICAgICAgc3VjY2VzczogZmFsc2UsCiAgICAgICAgcmVzdWx0OiBudWxsLAogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgbWVzc2FnZTogIkVuZGVyZcOnbyBlbmNvbnRyYWRvIGNvbSBzdWNlc3NvISIsCiAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgIHJlc3VsdDogcmVzdWx0LAogICAgfQogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gaGFuZGxlQWN0aW9uRXJyb3IoZXJyb3IsICJidXNjYXIgZW5kZXJlw6dvIikgYXMgQWRkcmVzc1NlYXJjaFN0YXRlCiAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlQWlzbGVDYXBhY2l0eUFjdGlvbihhaXNsZUlkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3QgY2FwYWNpdHkgPSBOdW1iZXIoZm9ybURhdGEuZ2V0KCJjYXBhY2l0eSIpKQoKICAgIGNvbnN0IHZhbGlkYXRpb25FcnJvciA9IHZhbGlkYXRlUmVxdWlyZWQoeyBhaXNsZUlkIH0sIFsiYWlzbGVJZCJdKQogICAgaWYgKHZhbGlkYXRpb25FcnJvcikgewogICAgICByZXR1cm4geyBtZXNzYWdlOiB2YWxpZGF0aW9uRXJyb3IsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBpZiAoaXNOYU4oY2FwYWNpdHkpIHx8IGNhcGFjaXR5IDwgMCkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiQ2FwYWNpZGFkZSBpbnbDoWxpZGEuIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IGV4aXN0aW5nQWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQoYWlzbGVJZCkKICAgIGlmICghZXhpc3RpbmdBaXNsZSkgewogICAgICByZXR1cm4geyBtZXNzYWdlOiAiUnVhIG7Do28gZW5jb250cmFkYS4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHVwZGF0ZUFpc2xlQ2FwYWNpdHkoYWlzbGVJZCwgY2FwYWNpdHkpCiAgICBpZiAoIXVwZGF0ZWQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIkZhbGhhIGFvIGF0dWFsaXphciBjYXBhY2lkYWRlLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoZXhpc3RpbmdBaXNsZS53YXJlaG91c2VJZCkKICAgIHJldHVybiB7IG1lc3NhZ2U6ICJDYXBhY2lkYWRlIGF0dWFsaXphZGEgY29tIHN1Y2Vzc28hIiwgc3VjY2VzczogdHJ1ZSB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImF0dWFsaXphciBjYXBhY2lkYWRlIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1bmFzc2lnblByb2R1Y3RGcm9tUGFsbGV0KHBhbGxldElkOiBzdHJpbmcsIHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3QgdmFsaWRhdGlvbkVycm9yID0gdmFsaWRhdGVSZXF1aXJlZCh7IHBhbGxldElkIH0sIFsicGFsbGV0SWQiXSkKICAgIGlmICh2YWxpZGF0aW9uRXJyb3IpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogdmFsaWRhdGlvbkVycm9yLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHJlbW92ZVByb2R1Y3RGcm9tUGFsbGV0T3JpZ2luYWwocGFsbGV0SWQpCiAgICBpZiAoIXVwZGF0ZWQpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogIlBhbGV0ZSBuw6NvIGVuY29udHJhZG8uIiwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGNvbnN0IGFpc2xlID0gYXdhaXQgZ2V0QWlzbGVCeUlkKHVwZGF0ZWQuYWlzbGVJZCkKICAgIGlmIChhaXNsZT8ud2FyZWhvdXNlSWQpIHsKICAgICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKGFpc2xlLndhcmVob3VzZUlkKQogICAgfQoKICAgIHJldHVybiB7IG1lc3NhZ2U6ICJQcm9kdXRvIHJlbW92aWRvIGRvIHBhbGV0ZSBjb20gc3VjZXNzbyEiLCBzdWNjZXNzOiB0cnVlIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAicmVtb3ZlciBwcm9kdXRvIGRvIHBhbGV0ZSIpCiAgfQp9CgpleHBvcnQgYXN5bmMgZnVuY3Rpb24gdW5hc3NpZ25Qcm9kdWN0RnJvbVNoZWxmKHNoZWxmSWQ6IHN0cmluZywgcHJldlN0YXRlOiBhbnksIGZvcm1EYXRhOiBGb3JtRGF0YSkgewogIHRyeSB7CiAgICBjb25zdCB2YWxpZGF0aW9uRXJyb3IgPSB2YWxpZGF0ZVJlcXVpcmVkKHsgc2hlbGZJZCB9LCBbInNoZWxmSWQiXSkKICAgIGlmICh2YWxpZGF0aW9uRXJyb3IpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogdmFsaWRhdGlvbkVycm9yLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHJlbW92ZVByb2R1Y3RGcm9tU2hlbGZPcmlnaW5hbChzaGVsZklkKQogICAgaWYgKCF1cGRhdGVkKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJQcmF0ZWxlaXJhIG7Do28gZW5jb250cmFkYS4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3QgYWlzbGUgPSBhd2FpdCBnZXRBaXNsZUJ5SWQodXBkYXRlZC5haXNsZUlkKQogICAgaWYgKGFpc2xlPy53YXJlaG91c2VJZCkgewogICAgICByZXZhbGlkYXRlV2FyZWhvdXNlUGF0aHMoYWlzbGUud2FyZWhvdXNlSWQpCiAgICB9CgogICAgcmV0dXJuIHsgbWVzc2FnZTogIlByb2R1dG8gcmVtb3ZpZG8gZGEgcHJhdGVsZWlyYSBjb20gc3VjZXNzbyEiLCBzdWNjZXNzOiB0cnVlIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGhhbmRsZUFjdGlvbkVycm9yKGVycm9yLCAicmVtb3ZlciBwcm9kdXRvIGRhIHByYXRlbGVpcmEiKQogIH0KfQoKLy8gTm92YXMgYcOnw7VlcyBwYXJhIHJlc3N1cHJpbWVudG8KZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG5vdGlmeVJlc3VwcGx5QWN0aW9uKHByZXZTdGF0ZTogYW55LCBmb3JtRGF0YTogRm9ybURhdGEpIHsKICB0cnkgewogICAgY29uc3QgcHJvZHVjdElkID0gZm9ybURhdGEuZ2V0KCJwcm9kdWN0SWQiKSBhcyBzdHJpbmcKICAgIGNvbnN0IHByb2R1Y3ROYW1lID0gZm9ybURhdGEuZ2V0KCJwcm9kdWN0TmFtZSIpIGFzIHN0cmluZwogICAgY29uc3QgZWFuMTMgPSBmb3JtRGF0YS5nZXQoImVhbjEzIikgYXMgc3RyaW5nCiAgICBjb25zdCBjYXRlZ29yeSA9IGZvcm1EYXRhLmdldCgiY2F0ZWdvcnkiKSBhcyBzdHJpbmcKICAgIGNvbnN0IGxvY2F0aW9uSWQgPSBmb3JtRGF0YS5nZXQoImxvY2F0aW9uSWQiKSBhcyBzdHJpbmcKICAgIGNvbnN0IGxvY2F0aW9uVHlwZSA9IGZvcm1EYXRhLmdldCgibG9jYXRpb25UeXBlIikgYXMgInBhbGxldCIgfCAic2hlbGYiCiAgICBjb25zdCBhZGRyZXNzID0gZm9ybURhdGEuZ2V0KCJhZGRyZXNzIikgYXMgc3RyaW5nCiAgICBjb25zdCB3YXJlaG91c2VJZCA9IGZvcm1EYXRhLmdldCgid2FyZWhvdXNlSWQiKSBhcyBzdHJpbmcKICAgIGNvbnN0IHdhcmVob3VzZU5hbWUgPSBmb3JtRGF0YS5nZXQoIndhcmVob3VzZU5hbWUiKSBhcyBzdHJpbmcKICAgIGNvbnN0IGFpc2xlSWQgPSBmb3JtRGF0YS5nZXQoImFpc2xlSWQiKSBhcyBzdHJpbmcKICAgIGNvbnN0IGFpc2xlTmFtZSA9IGZvcm1EYXRhLmdldCgiYWlzbGVOYW1lIikgYXMgc3RyaW5nCiAgICBjb25zdCBwb3NpdGlvbiA9IE51bWJlcihmb3JtRGF0YS5nZXQoInBvc2l0aW9uIikpCiAgICBjb25zdCBsZXZlbCA9IGZvcm1EYXRhLmdldCgibGV2ZWwiKSA/IE51bWJlcihmb3JtRGF0YS5nZXQoImxldmVsIikpIDogdW5kZWZpbmVkCgogICAgY29uc3QgdmFsaWRhdGlvbkVycm9yID0gdmFsaWRhdGVSZXF1aXJlZCgKICAgICAgeyBwcm9kdWN0SWQsIHByb2R1Y3ROYW1lLCBsb2NhdGlvbklkLCBsb2NhdGlvblR5cGUsIGFkZHJlc3MsIHdhcmVob3VzZUlkLCBhaXNsZUlkIH0sCiAgICAgIFsicHJvZHVjdElkIiwgInByb2R1Y3ROYW1lIiwgImxvY2F0aW9uSWQiLCAibG9jYXRpb25UeXBlIiwgImFkZHJlc3MiLCAid2FyZWhvdXNlSWQiLCAiYWlzbGVJZCJdLAogICAgKQoKICAgIGlmICh2YWxpZGF0aW9uRXJyb3IpIHsKICAgICAgcmV0dXJuIHsgbWVzc2FnZTogdmFsaWRhdGlvbkVycm9yLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgY29uc3Qgbm90aWZpY2F0aW9uID0gYXdhaXQgYWRkUmVzdXBwbHlOb3RpZmljYXRpb24oewogICAgICBwcm9kdWN0SWQsCiAgICAgIHByb2R1Y3ROYW1lLAogICAgICBlYW4xMzogZWFuMTMgfHwgdW5kZWZpbmVkLAogICAgICBjYXRlZ29yeTogY2F0ZWdvcnkgfHwgdW5kZWZpbmVkLAogICAgICBsb2NhdGlvbklkLAogICAgICBsb2NhdGlvblR5cGUsCiAgICAgIGFkZHJlc3MsCiAgICAgIHdhcmVob3VzZUlkLAogICAgICB3YXJlaG91c2VOYW1lLAogICAgICBhaXNsZUlkLAogICAgICBhaXNsZU5hbWUsCiAgICAgIHBvc2l0aW9uLAogICAgICBsZXZlbCwKICAgICAgc3RhdHVzOiAicGVuZGluZyIsCiAgICB9KQoKICAgIHJldmFsaWRhdGVXYXJlaG91c2VQYXRocygpCiAgICByZXR1cm4gewogICAgICBtZXNzYWdlOiBgUHJvZHV0byAiJHtwcm9kdWN0TmFtZX0iIG5vdGlmaWNhZG8gcGFyYSByZXNzdXByaW1lbnRvIGNvbSBzdWNlc3NvIWAsCiAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgIG5vdGlmaWNhdGlvbklkOiBub3RpZmljYXRpb24uaWQsCiAgICB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgIm5vdGlmaWNhciByZXNzdXByaW1lbnRvIikKICB9Cn0KCmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVSZXN1cHBseVN0YXR1c0FjdGlvbihwcmV2U3RhdGU6IGFueSwgZm9ybURhdGE6IEZvcm1EYXRhKSB7CiAgdHJ5IHsKICAgIGNvbnN0IG5vdGlmaWNhdGlvbklkID0gZm9ybURhdGEuZ2V0KCJub3RpZmljYXRpb25JZCIpIGFzIHN0cmluZwogICAgY29uc3Qgc3RhdHVzID0gZm9ybURhdGEuZ2V0KCJzdGF0dXMiKSBhcyBSZXN1cHBseU5vdGlmaWNhdGlvblsic3RhdHVzIl0KICAgIGNvbnN0IG5vdGVzID0gZm9ybURhdGEuZ2V0KCJub3RlcyIpIGFzIHN0cmluZwoKICAgIGNvbnN0IHZhbGlkYXRpb25FcnJvciA9IHZhbGlkYXRlUmVxdWlyZWQoeyBub3RpZmljYXRpb25JZCwgc3RhdHVzIH0sIFsibm90aWZpY2F0aW9uSWQiLCAic3RhdHVzIl0pCiAgICBpZiAodmFsaWRhdGlvbkVycm9yKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6IHZhbGlkYXRpb25FcnJvciwgc3VjY2VzczogZmFsc2UgfQogICAgfQoKICAgIGlmICghWyJwZW5kaW5nIiwgImluX3Byb2dyZXNzIiwgImNvbXBsZXRlZCIsICJvdXRfb2Zfc3RvY2siXS5pbmNsdWRlcyhzdGF0dXMpKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJTdGF0dXMgaW52w6FsaWRvLiIsIHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KCiAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgdXBkYXRlUmVzdXBwbHlTdGF0dXMobm90aWZpY2F0aW9uSWQsIHN0YXR1cywgbm90ZXMgfHwgdW5kZWZpbmVkKQogICAgaWYgKCF1cGRhdGVkKSB7CiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICJOb3RpZmljYcOnw6NvIG7Do28gZW5jb250cmFkYS4iLCBzdWNjZXNzOiBmYWxzZSB9CiAgICB9CgogICAgcmV2YWxpZGF0ZVdhcmVob3VzZVBhdGhzKCkKCiAgICBjb25zdCBzdGF0dXNMYWJlbHMgPSB7CiAgICAgIHBlbmRpbmc6ICJQZW5kZW50ZSIsCiAgICAgIGluX3Byb2dyZXNzOiAiRW0gQW5kYW1lbnRvIiwKICAgICAgY29tcGxldGVkOiAiQ29uY2x1w61kbyIsCiAgICAgIG91dF9vZl9zdG9jazogIkVtIEZhbHRhIiwKICAgIH0KCiAgICByZXR1cm4gewogICAgICBtZXNzYWdlOiBgU3RhdHVzIGF0dWFsaXphZG8gcGFyYSAiJHtzdGF0dXNMYWJlbHNbc3RhdHVzXX0iIGNvbSBzdWNlc3NvIWAsCiAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICB9CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBoYW5kbGVBY3Rpb25FcnJvcihlcnJvciwgImF0dWFsaXphciBzdGF0dXMiKQogIH0KfQo="}